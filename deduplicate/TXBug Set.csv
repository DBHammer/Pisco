Database, Bug ID,Bug URL,Bug Summary,Bug Description,Bug Status,Buggy Version,Fixed Version,Fixed Patch Link,Submitted Date,Severity,,,,,Table1 Data Amount,Table2 Data Amount,Table3 Data Amount,Table4 Data Amount,Table5 Data Amount,# Transaction,"Transaction 1
1. auto
2. explicit
3. XA
(autocommit, explicit, XA transaction)",# Statements of Transaction 1,"Transaction 2
1. auto
2. explicit
3. XA",# Statements of Transaction 2,"Transaction 3
1. auto
2. explicit
3. XA",# Statements of Transaction 3,"Transaction 4
1. auto
2. explicit
3. XA",# Statements of Transaction 4,"Transaction 5
1. auto
2. explicit
3. XA",# Statements of Transaction 5,"Statement Type in Transaction (BEGIN)
1. Yes
2. -","Statement Type in Transaction (START TRANSACTION / XA START)
1. Yes
2. -","Statement Type in Transaction (START TRANSACTION WITH CONSISTENT SNAPSHOT / START TRANSACTION READ ONLY)
1. Yes
2. -","Statement Type in Transaction (SET AUTOCOMMIT=0)
1. Yes
2. -","Statement Type in Transaction (COMMIT / XA COMMIT)
1. Yes
2. -","Statement Type in Transaction (ROLLBACK / XA ROLLBACK)
1. Yes
2. -","Statement Type in Transaction (SELECT)
1. Yes
2. -","Statement Type in Transaction (SELECT ... FOR SHARE)
1. Yes
2. -","Statement Type in Transaction (SELECT ... FOR UPDATE / FOR UPDATE SKIP LOCKED)
1. Yes
2. -","Statement Type in Transaction (INSERT)
1. Yes
2. -","Statement Type in Transaction (REPLACE / REPLACE ... SELECT)
1. Yes
2. -","Statement Type in Transaction (UPDATE)
1. Yes
2. -","Statement Type in Transaction (DELETE)
1. Yes
2. -","Statement Type in Transaction (ALTER)
1. Yes
2. -","Statement Type in Transaction (CREATE / DROP TABLE / TABLESPACE / TEMPORARY TABLE / SEQUENCE)
1. Yes
2. -","Statement Type in Transaction (CHECK TABLE)
1. Yes
2. -","Statement Type in Transaction (SHOW)
1. Yes
2. -","Statement Type in Transaction (SET)
1. Yes
2. -","Statement Type in Transaction (COMMENT ON)
1. Yes
2. -","Statement Type in Transaction (RESET)
1. Yes
2. -","Statement Type in Transaction (SAVEPOINT / ROLLBACK TO)
1. Yes
2. -","Statement Type in Transaction (ANALYZE)
1. Yes
2. -","Statement Type in Transaction (ADMIN)
1. Yes
2. -","Statement Type in Transaction (EXPLAIN)
1. Yes
2. -","Cond (Config)
1. Set ENGINE=InnoDB
2. Set adaptive hash index = ON
3. global innodb_deadlock_detect=off
4. **","Cond (inject fault)
1. inject crash, 
2. kill connection
3. **","Cond (produce specified database state)
1. produce lock wait timeout
2. FLUSH ...
3. **","Cond (produce specified data)
e.g., insert an existent row, PRIMARY KEY of a record is being updated to a smaller value
1. Yes
2. -","Cond (Cluster)
e.g., master and slave
1. Yes
2. -","Key
e.g., KV, Primary Key, Unique Key, Composite Key
1. Yes
2. -","Index
e.g., Index, Clustered index, Nonclustered index, Key
1. Yes
2. -","Special Table
e.g., Temporary table, Virtual table
1. Yes
2. -","System table
1. Yes
2. -","CHARSET and COLLATE
e.g., CHARSET=utf8mb4 COLLATE=utf8_unicode_ci
1. Yes
2. -","Data Constraint
1. NOT NULL
2. DEFAULT ...
3. AUTO_INCREMENT
4. Generated always as identity
5. REFERENCES
6. **","Partition
1. Yes
2. -",,,,,,"Fix Pattern
1. Document fix
2. Code fix
3. -","Fix Size
1. e.g., 16 changed files with 115 additions and 85 deletions
2. -",# patch,# file,# additions,# deletions,# Modified LOC,Fix Duration,,"Detectable by Transaction Verification Approaches?
1. Yes
2. If No, why?
2.1. not key-value data structures
2.2. involve complex operations other than read(key) and write(key, value) 
2.3. history does not reflect the problem","Detectable by DT2?
1. Yes
2. If No, why?
2.1. DBMS-specific
2.2. same behavior","Detectable by Troc?
1. Yes
2. If No, why?
2.1 unsupported features
2.2 not detectable failure symptoms",,Unnamed: 85,id
MySQL,103672,https://bugs.mysql.com/bug.php?id=103672,Binlog compression Transaction_payload event exceeds max allowed packet,"1. set binlog_transaction_compression=ON, zstd level is the default 3
2. create table t1 (c text);
3. START TRANSACTION; Insert 5 million rows of data into t1 values(repeat(md5(rand()),5)); COMMIT; 
4. Then you will have a huge Transaction_payload event
5. SHOW BINLOG EVENTS or set up a binlog replication, you will notice the above errors. ",Fixed,8.0.23,doc,"https://dev.mysql.com/doc/refman/8.0/en/binary-log-transaction-compression.html in the section ""5.4.4.5.1 Behaviors When Binary Log Transaction Compression is Enabled""",2021/5/12,S2 (Serious),"I turned on binlog_transaction_compression and ran a large transaction. The Transaction_payload event exceeds the max event log size, which is 64MB by default. I can see the following error from SHOW BINLOG EVENTS: 

mysql> show binlog events in `mysql-binlog.000001`;
ERROR 1220 (HY000): Error when executing command SHOW BINLOG EVENTS: Event too big

If the Transaction_payload event is larger than slave_max_allowed_packet, it breaks the binlog replication

Last_IO_Errno: 13114
Last_IO_Error: Got fatal error 1236 from master when reading data from binary log: `log event entry exceeded max_allowed_packet; Increase max_allowed_packet on master; 

1. set binlog_transaction_compression=ON, zstd level is the default 3
2. create table t1 (c text);
3. START TRANSACTION; Insert 5 million rows of data into t1 values(repeat(md5(rand()),5)); COMMIT; 
4. Then you will have a huge Transaction_payload event
5. SHOW BINLOG EVENTS or set up a binlog replication, you will notice the errors. ",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,"set binlog_transaction_compression=ON, zstd level is the default 3",-,-,-,Yes,-,-,-,-,-,-,-,Yes,Operation error,Consistency: DBMS state,S2 (Serious),Yes,Document fix,-,-,-,-,-,-,22,-,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_103672
MySQL,101706,https://bugs.mysql.com/bug.php?id=101706,Check table can`t find duplicate error in table,"-- Prepare test data
CREATE TABLE t (
  `c1` int(11) NOT NULL AUTO_INCREMENT,
  `c2` int(11) DEFAULT NULL,
  PRIMARY KEY (`c1`),
  UNIQUE KEY `c2` (`c2`)
) ENGINE`=InnoDB AUTO_INCREMENT`=10;

insert into t values(10, 9);
insert into t values(12, 5);

-- session 1
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> delete from t where c2=5;
Query OK, 1 row affected (0.00 sec)

-- session 2
mysql> insert into t select 2,5;

-- session 3
mysql> insert into t select 1,5;

-- session 1
mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t;
+----+------+
| c1 | c2   |
+----+------+
|  1 |    5 |
|  2 |    5 |
| 10 |    9 |
+----+------+
3 rows in set (0.00 sec)

mysql> check table t;
+--------+-------+----------+----------+
| Table  | Op    | Msg_type | Msg_text |
+--------+-------+----------+----------+
| test.t | check | status   | OK       |
+--------+-------+----------+----------+
1 row in set (0.00 sec)",Closed,8,-,-,2020/11/21,S3 (Non-critical),"-- Prepare test data
CREATE TABLE `t` (
  `c1` int(11) NOT NULL AUTO_INCREMENT,
  `c2` int(11) DEFAULT NULL,
  PRIMARY KEY (`c1`),
  UNIQUE KEY `c2` (`c2`)
) ENGINE=InnoDB AUTO_INCREMENT=10;

insert into t values(10, 9);
insert into t values(12, 5);

-- session 1
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> delete from t where c2=5;
Query OK, 1 row affected (0.00 sec)

-- session 2
mysql> insert into t select 2,5;

-- session 3
mysql> insert into t select 1,5;

-- session 1
mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t;
+----+------+
| c1 | c2   |
+----+------+
|  1 |    5 |
|  2 |    5 |
| 10 |    9 |
+----+------+
3 rows in set (0.00 sec)

mysql> check table t;
+--------+-------+----------+----------+
| Table  | Op    | Msg_type | Msg_text |
+--------+-------+----------+----------+
| test.t | check | status   | OK       |
+--------+-------+----------+----------+
1 row in set (0.00 sec)

I find the ""check table"" can`t find the duplicate key error in the table",unspecified,Pessimistic,1,2,-,-,-,-,4,explicit,3,auto,1,auto,1,auto,2,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,Yes,-,-,-,-,"NOT NULL
DEFAULT NULL
AUTO_INCREMENT",-,Yes,Incorrect database state,Consistency: data constraint,S3 (Non-critical),Yes,Code fix,-,-,-,-,-,-,12,-,"No, involve complex operations other than read(key) and write(key, value)",Yes,Yes,,,MySQL_101706
MySQL,99174,https://bugs.mysql.com/bug.php?id=99174,Prepare transaction won`t rollback if server crash after online ddl prepare stag,"CREATE TABLE t (a INT PRIMARY KEY, b INT NOT NULL) ENGINE=InnoDB;
INSERT INTO t VALUES(1,1), (2,2), (3,3), (4,4);
FLUSH BINARY LOGS;
SHOW BINARY LOGS;
Log_name        File_size       Encrypted
binlog.000001   732     No
binlog.000002   155     No
SET DEBUG_SYNC=`alter_table_inplace_after_lock_downgrade WAIT_FOR m`;
ALTER TABLE t DROP COLUMN b;
# Crash right after flushing InnoDB redo log
SET SESSION DEBUG=""+d,crash_after_flush_engine_log"";
BEGIN;
INSERT INTO t VALUES(10, 10);
COMMIT;
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
# Restart the master server
SELECT * FROM t;
a       b
1       1
2       2
3       3
4       4
10      10
SHOW BINARY LOGS;
Log_name        File_size       Encrypted
binlog.000001   732     No
binlog.000002   155     No
binlog.000003   155     No",Fixed,8.0.*,8.0.27 release,-,2020/4/3,S1 (Critical),"First, download the leatest version 8.0.19 which recently commit id is ea7d2e2d16ac03afdd9cb72a972a95981107bf51.

Second, copy this mtr file to mysql-test/suite/innodb/t/innodb_bug99174.test

```mtr
-- source include/have_debug.inc
--source include/have_debug_sync.inc
--source include/have_log_bin.inc

connect (con1,localhost,root,,);

connection default;

CREATE TABLE t (a INT PRIMARY KEY, b INT NOT NULL) ENGINE=InnoDB;
INSERT INTO t VALUES(1,1), (2,2), (3,3), (4,4);

FLUSH BINARY LOGS;

SHOW BINARY LOGS;

SET DEBUG_SYNC=`alter_table_inplace_after_lock_downgrade WAIT_FOR m`;

--send
ALTER TABLE t DROP COLUMN b;

connection con1;

--exec echo ""wait"" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--echo # Crash right after flushing InnoDB redo log
SET SESSION DEBUG=""+d,crash_after_flush_engine_log"";
BEGIN;
INSERT INTO t VALUES(10, 10);
# 2013 - CR_SERVER_LOST
--error 2013
COMMIT;
--source include/wait_until_disconnected.inc

connection default;
--error 2013
--reap

--enable_reconnect
--echo # Restart the master server
--exec echo ""restart"" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--source include/wait_until_connected_again.inc
--disable_reconnect

SELECT * FROM t;

SHOW BINARY LOGS;

# Cleanup
DROP TABLE t;

```

Third, run mtr test :

```bash
./mtr --nocheck-testcases innodb_bug99174
```

and we can generate the result file : 

```mtr result
CREATE TABLE t (a INT PRIMARY KEY, b INT NOT NULL) ENGINE=InnoDB;
INSERT INTO t VALUES(1,1), (2,2), (3,3), (4,4);
FLUSH BINARY LOGS;
SHOW BINARY LOGS;
Log_name        File_size       Encrypted
binlog.000001   732     No
binlog.000002   155     No
SET DEBUG_SYNC=`alter_table_inplace_after_lock_downgrade WAIT_FOR m`;
ALTER TABLE t DROP COLUMN b;
# Crash right after flushing InnoDB redo log
SET SESSION DEBUG=""+d,crash_after_flush_engine_log"";
BEGIN;
INSERT INTO t VALUES(10, 10);
COMMIT;
ERROR HY000: Lost connection to MySQL server during query
ERROR HY000: Lost connection to MySQL server during query
# Restart the master server
SELECT * FROM t;
a       b
1       1
2       2
3       3
4       4
10      10
SHOW BINARY LOGS;
Log_name        File_size       Encrypted
binlog.000001   732     No
binlog.000002   155     No
binlog.000003   155     No
DROP TABLE t;
[100%] innodb.innodb_bug99174                    [ pass ]   3468
```

The problem is table t have the value of (10, 10) after restart. But the binary log `binlog.000002` does not have the events of (10, 10) insertion. ",REPEATABLE READ,Pessimistic,1,4,-,-,-,-,3,auto,2,explicit,3,auto,2,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,ENGINE=InnoDB,inject crash,FLUSH BINARY LOGS;,-,Yes,Yes,-,-,-,-,NOT NULL,-,"No, need control (inject crash)",Incorrect database state,Consistency: DBMS state,S1 (Critical),Yes,Code fix,5 changed files with 161 additions and 35 deletions,1,5,161,35,196,496,-,"No, history does not reflect the problem","No, DBMS-specific","No, depolying cluster",,,MySQL_99174
MySQL,98642,https://bugs.mysql.com/bug.php?id=98642,Consistent snapshot can be corrupted by other transactions,"CREATE TABLE `bug_consistent_read` (
  `clientid` bigint(20) unsigned NOT NULL,
  `ticketid` bigint(20) unsigned NOT NULL,
  `state` int(11) NOT NULL,
  `modifed` timestamp(6) NULL DEFAULT NULL,
  `border` smallint(6) DEFAULT `0`,
  PRIMARY KEY (`clientid`,`ticketid`),
  KEY `ix_ticketid` (`ticketid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

open a session A

START TRANSACTION WITH CONSISTENT SNAPSHOT ;

SELECT count(*) as cnt   FROM test.bug_consistent_read  WHERE  (  (  ( `clientid`  >   XXXXX )  ) or (  ( `ticketid`  >=  YYYYYYY )  and ( `clientid` = XXXXX  )  )  )  AND
                                                               (  (  ( `clientid`  <   AAAAAAAA )  ) or (  ( `ticketid`  <=  BBBBBBB )  and ( `clientid` = AAAAAAAAA )  )  )  ;

open a session B

source file bug_create_buggy.sql

this file will pouplate bug_consistent_read with some row of bug_consistent_read_feed

back to session A

SELECT count(*) as cnt   FROM test.bug_consistent_read  WHERE  (  (  ( `clientid`  >   XXXXX )  ) or (  ( `ticketid`  >=  YYYYYYY )  and ( `clientid` = XXXXX  )  )  )  AND
                                                               (  (  ( `clientid`  <   AAAAAAAA )  ) or (  ( `ticketid`  <=  BBBBBBB )  and ( `clientid` = AAAAAAAAA )  )  )  ;",Fixed,"5.6 after 5.6.38, 5.7 after 5.7.18","5.6.50, 5.7.32, 8.0.22 release",-,2020/2/18,S2 (Serious),"During a long session created with  START TRANSACTION WITH CONSISTENT SNAPSHOT ;
and in parallel with activities on the table , the long session can have a response truncated , when doing a query of a range .

The definition of the table is :

CREATE TABLE `bug_consistent_read` (
  `clientid` bigint(20) unsigned NOT NULL,
  `ticketid` bigint(20) unsigned NOT NULL,
  `state` int(11) NOT NULL,
  `modifed` timestamp(6) NULL DEFAULT NULL,
  `border` smallint(6) DEFAULT `0`,
  PRIMARY KEY (`clientid`,`ticketid`),
  KEY `ix_ticketid` (`ticketid`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

The query is :

SELECT count(*) as cnt   FROM test.bug_consistent_read  WHERE  (  (  ( `clientid`  >   XXXXX )  ) or (  ( `ticketid`  >=  YYYYYYY )  and ( `clientid` = XXXXX  )  )  )  AND
                                                               (  (  ( `clientid`  <   AAAAAAAA )  ) or (  ( `ticketid`  <=  BBBBBBB )  and ( `clientid` = AAAAAAAAA )  )  )  ;

I created a dataset ( https://github.com/ErwanMAS/consistent-read-mysql-bug/ )

0) load data :

   bzcat mysqldump/dump_bug_consistent_read.bz2       | mysql test
   bzcat mysqldump/dump_bug_consistent_read_feed.bz2  | mysql test

1)    open a session A

source bug_buggy_chunks.sql ; (10 statements)

must return always a rounded number ( 2000 , 5000 , 10000 , 15000 , 20000 )

2)    open a session B

start a consistent snapshot with

START TRANSACTION WITH CONSISTENT SNAPSHOT ;

source bug_buggy_chunks.sql ;

must return always a rounded number ( 2000 , 5000 , 10000 , 15000 , 20000 )

3)    now back on session A

source file bug_create_buggy.sql (5 statements)

this file will pouplate bug_consistent_read with some row of bug_consistent_read_feed

when is done

4)    back to session B

run again the script and you will see many values not rounded

source bug_buggy_chunks.sql ;",REPEATABLE READ,Pessimistic,2,20000,1500000,-,-,-,2,auto,15,explicit,21,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,Yes,Yes,-,-,Yes,"NOT NULL
DEFAULT NULL
DEFAULT `0`",-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),Yes,Code fix,1 changed file with 2 additions and 1 deletion,1,1,2,1,3,176,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,MySQL_98642
MySQL,107898,https://bugs.mysql.com/bug.php?id=107898,Incorrect SELECT results found by transaction comparison,"---------- Test case 1 ----------

conn_0> /usr/local/mysql/bin/mysql -uroot -Dtestdb 

conn_0> START TRANSACTION;
conn_1> START TRANSACTION; 
delete from t_8fhx8c;
ROLLBACK;

conn_0> select *
  from
    t_8fhx8c as ref_1
  where ref_1.c_0byzvd not in (
    select
        nullif(19, 19) as c0
      from
        (select
              ref_2.c_zov5kd as c0
            from
              t_8fhx8c as ref_2
            ) as subq_0
      window w_u6cwrd as (partition by subq_0.c0));

conn_0> commit;

** Output of SELECT statement in conn_0 (Test case 1) **

+------+-------+----------+----------+----------+----------+----------+
| wkey | pkey  | c_0byzvd | c_iskisc | c_zov5kd | c_gcqkxd | c_qhs9nb |
+------+-------+----------+----------+----------+----------+----------+
|    2 | 14000 |       97 |    84.74 | wa2sbb   |       95 |    89.41 |
|    2 | 15000 |       86 |    21.11 | zronkb   |       55 |     45.8 |
|    2 | 16000 |       14 |     19.5 | c2gzzd   |       32 |    85.98 |
|  ... |   ... |      ... |      ... |    ...   |      ... |      ... |
|   12 | 75000 |       94 |    57.76 | l1ei4c   |     NULL |    58.27 |
+------+-------+----------+----------+----------+----------+----------+
34 rows in set (0.00 sec)

---------- Test case 2 ----------

conn_0> /usr/local/mysql/bin/mysql -uroot -Dtestdb

conn_0> START TRANSACTION;
conn_0> select *
  from
    t_8fhx8c as ref_1
  where ref_1.c_0byzvd not in (
    select
        nullif(19, 19) as c0
      from
        (select
              ref_2.c_zov5kd as c0
            from
              t_8fhx8c as ref_2
            ) as subq_0
      window w_u6cwrd as (partition by subq_0.c0));
conn_0> COMMIT;

** Output of SELECT statement in conn_0 (Test case 2) **

Empty set (0.00 sec)

--------------------",Verified,8,-,-,2022/7/16,S2 (Serious),"we use test case 1 and test case 2 to test MySQL separately under the environment we set up. They should return the same results but they did not.

---------- Test case 1 ----------

conn_0> /usr/local/mysql/bin/mysql -uroot -Dtestdb < mysql_bk.sql (mysql_bk.sql is in the attached)
DROP TABLE IF EXISTS `t_8fhx8c`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!50503 SET character_set_client = utf8mb4 */;
CREATE TABLE `t_8fhx8c` (
  `wkey` int DEFAULT NULL,
  `pkey` int NOT NULL,
  `c_0byzvd` int DEFAULT NULL,
  `c_iskisc` double DEFAULT NULL,
  `c_zov5kd` text,
  `c_gcqkxd` int DEFAULT NULL,
  `c_qhs9nb` double DEFAULT NULL,
  PRIMARY KEY (`pkey`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Dumping data for table `t_8fhx8c`
--
INSERT INTO `t_8fhx8c` VALUES (2,14000,97,84.74,`wa2sbb`,95,89.41),(2,15000,86,21.11,`zronkb`,55,45.8),(2,16000,14,19.5,`c2gzzd`,32,85.98),(2,17000,23,33.44,`mobljd`,66,23.38),(3,18000,50,NULL,`pturvb`,12,80.12),(3,19000,12,3.67,`if_bxd`,1,52.88),(3,20000,43,23.93,NULL,20,9.64),(3,21000,66,53.85,`n_wqod`,1,86.49),(3,22000,35,32.75,`0mbqjc`,44,66.48),(4,23000,14,NULL,`ucm2td`,8,35.2),(4,24000,46,29.29,`tkrorb`,13,23.69),(4,25000,57,58.4,`la5xxd`,42,80.53),(4,26000,11,71.71,`emyb3b`,32,19.24),(4,27000,18,16.46,`cuf0n`,62,91.78),(4,28000,90,80.69,`cgded`,75,66.99),(4,29000,42,4.37,`yuhutd`,61,11.3),(4,30000,63,97.37,`shdmzb`,3,44.82),(10,59000,33,5.21,NULL,NULL,81.83),(10,60000,95,35.57,NULL,NULL,26.78),(10,61000,24,13.46,NULL,NULL,97.26),(10,62000,35,84.89,NULL,NULL,44.5),(10,63000,83,69.34,NULL,NULL,14.19),(10,64000,26,29.59,NULL,NULL,60.27),(11,65000,8,NULL,`8ppsvb`,84,97.47),(11,66000,55,NULL,`naaqhd`,38,4.17),(11,67000,78,NULL,`sm4vmb`,60,98.6),(12,68000,98,24.37,`y9oowb`,NULL,79.54),(12,69000,97,50.1,`qqabc`,NULL,62.34),(12,70000,18,87.87,`wkf9h`,NULL,76.7),(12,71000,37,5.2,`npgb8`,NULL,95.63),(12,72000,48,83.8,`xhx3rb`,NULL,51.53),(12,73000,30,5.4,`yfdncd`,NULL,33.34),(12,74000,82,10.2,`jmvq9d`,NULL,63.46),(12,75000,94,57.76,`l1ei4c`,NULL,58.27);

conn_0> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb
conn_0> SET LOCAL TRANSACTION ISOLATION LEVEL READ COMMITTED; --- set to READ COMMITTED isolation level
conn_1> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb
conn_1> SET LOCAL TRANSACTION ISOLATION LEVEL READ COMMITTED; --- set to READ COMMITTED isolation level

conn_0> START TRANSACTION;
conn_1> START TRANSACTION; 

delete from t_8fhx8c;

ROLLBACK;

#Note: copy these three statements (START, DELETE, and ROLLBACK) at once, and then paste them to the terminal directly.

conn_0> select *
  from
    t_8fhx8c as ref_1
  where ref_1.c_0byzvd not in (
    select
        nullif(19, 19) as c0
      from
        (select
              ref_2.c_zov5kd as c0
            from
              t_8fhx8c as ref_2
            ) as subq_0
      window w_u6cwrd as (partition by subq_0.c0));

#Note: this SELECT should be inputted to connection 1 as soon as possible after conn_1 has rollbacked.

conn_0> commit;

** Output of SELECT statement in conn_0 (Test case 1) **

+------+-------+----------+----------+----------+----------+----------+
| wkey | pkey  | c_0byzvd | c_iskisc | c_zov5kd | c_gcqkxd | c_qhs9nb |
+------+-------+----------+----------+----------+----------+----------+
|    2 | 14000 |       97 |    84.74 | wa2sbb   |       95 |    89.41 |
|    2 | 15000 |       86 |    21.11 | zronkb   |       55 |     45.8 |
|    2 | 16000 |       14 |     19.5 | c2gzzd   |       32 |    85.98 |
|  ... |   ... |      ... |      ... |    ...   |      ... |      ... |
|   12 | 75000 |       94 |    57.76 | l1ei4c   |     NULL |    58.27 |
+------+-------+----------+----------+----------+----------+----------+
34 rows in set (0.00 sec)

---------- Test case 2 ----------

conn_0> /usr/local/mysql/bin/mysql -uroot -Dtestdb < mysql_bk.sql (mysql_bk.sql is in the attached)
conn_0> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb

conn_0> START TRANSACTION;
conn_0> select *
  from
    t_8fhx8c as ref_1
  where ref_1.c_0byzvd not in (
    select
        nullif(19, 19) as c0
      from
        (select
              ref_2.c_zov5kd as c0
            from
              t_8fhx8c as ref_2
            ) as subq_0
      window w_u6cwrd as (partition by subq_0.c0));
conn_0> COMMIT;

** Output of SELECT statement in conn_0 (Test case 2) **

Empty set (0.00 sec)

--------------------

The SELECT statement print different results in test case 1 and test case 2, while they should be the same ideally. 
",READ COMMITTED,Pessimistic,1,30,-,-,-,-,3,explicit,3,explicit,3,explicit,3,-,-,-,-,-,Yes,-,-,Yes,Yes,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,Yes,-,-,-,Yes,"NOT NULL
DEFAULT NULL",-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,169,"No, not key-value data structures","No, same behavior","No, unsupported statements",,,MySQL_107898
MySQL,107066,https://bugs.mysql.com/bug.php?id=107066,ROLLBACK transaction affects the result of COMMIT transaction,"CREATE TABLE `t_zcfqb` (
  `wkey` int(11) DEFAULT NULL,
  `pkey` int(11) NOT NULL AUTO_INCREMENT,
  `c_rvm_p` text DEFAULT NULL,
  `c_dl_pmd` int(11) DEFAULT NULL,
  `c_avevqc` text DEFAULT NULL,
  `c_ywxlqb` double DEFAULT NULL,
  `c_sqqbbd` int(11) DEFAULT NULL,
  `c_2wz8nc` text DEFAULT NULL,
  `c_qyxu0` double DEFAULT NULL,
  `c_slu2bd` int(11) DEFAULT NULL,
  `c_ph8nh` text DEFAULT NULL,
  PRIMARY KEY (`pkey`) 
);

** Test case 1 **

conn_1> BEGIN OPTIMISTIC;
conn_0> BEGIN OPTIMISTIC;
conn_1> insert into t_zcfqb (wkey, pkey, c_dl_pmd, c_avevqc, c_sqqbbd, c_2wz8nc, c_qyxu0, c_slu2bd) values
          (182, 264000, null, `biiumc`, null, `dwzl6d`, 93.90, null);
conn_0> insert into t_zcfqb (wkey, c_rvm_p, c_avevqc, c_ywxlqb, c_sqqbbd, c_2wz8nc, c_qyxu0, c_ph8nh)
          select
              121 as c0,
              ref_0.c_h1m_zb as c1,
              ref_0.c_gsbzrd as c2,
              ref_0.c_hdnifc as c3,
              (select wkey from t_nvues order by wkey limit 1 offset 5)
                 as c4,
              ref_0.c_h1m_zb as c5,
              ref_0.c_hdnifc as c6,
              ref_0.c_h1m_zb as c7
            from
              t_nvues as ref_0
            where (0 <> 0)
              or (ref_0.wkey is not NULL);
conn_0> select pkey from t_zcfqb where wkey = 121;
conn_1> ROLLBACK;
conn_0> COMMIT;

** Output of SELECT statement in conn_0 (Test case 1) **

+--------+
| pkey   |
+--------+
| 264001 |
| 264002 |
| 264003 |
|   ...  |
| 264049 |
+--------+
49 rows in set (0.00 sec)

** Test case 2 **

conn_0> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb

conn_0> BEGIN OPTIMISTIC;
conn_0> insert into t_zcfqb (wkey, c_rvm_p, c_avevqc, c_ywxlqb, c_sqqbbd, c_2wz8nc, c_qyxu0, c_ph8nh)
          select
              121 as c0,
              ref_0.c_h1m_zb as c1,
              ref_0.c_gsbzrd as c2,
              ref_0.c_hdnifc as c3,
              (select wkey from t_nvues order by wkey limit 1 offset 5)
                 as c4,
              ref_0.c_h1m_zb as c5,
              ref_0.c_hdnifc as c6,
              ref_0.c_h1m_zb as c7
            from
              t_nvues as ref_0
            where (0 <> 0)
              or (ref_0.wkey is not NULL);
conn_0> select pkey from t_zcfqb where wkey = 121;
conn_0> COMMIT;

** Output of SELECT statement in conn_0 (Test case 2) **

+-------+
| pkey  |
+-------+
| 77001 |
| 77002 |
| 77003 |
|  ...  |
| 77049 |
+-------+
49 rows in set (0.01 sec)",Verified,"8.0.28, 5.7.37",-,-,2022/4/20,S2 (Serious),"ROLLBACK transaction affects the result of COMMIT transaction
CREATE TABLE `t_zcfqb` (
  `wkey` int(11) DEFAULT NULL,
  `pkey` int(11) NOT NULL AUTO_INCREMENT,
  `c_rvm_p` text DEFAULT NULL,
  `c_dl_pmd` int(11) DEFAULT NULL,
  `c_avevqc` text DEFAULT NULL,
  `c_ywxlqb` double DEFAULT NULL,
  `c_sqqbbd` int(11) DEFAULT NULL,
  `c_2wz8nc` text DEFAULT NULL,
  `c_qyxu0` double DEFAULT NULL,
  `c_slu2bd` int(11) DEFAULT NULL,
  `c_ph8nh` text DEFAULT NULL,
  PRIMARY KEY (`pkey`) 
);

Note that pkey is an auto-increment primary key.

Then, we use test case 1 and test case 2 to test MySQL under the environment we set up. They should return the same results but they did not.

** Test case 1 **

// setup two connection, conn_0 and conn_1
conn_0> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb
conn_1> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb

conn_1> BEGIN OPTIMISTIC;
conn_0> BEGIN OPTIMISTIC;
conn_1> insert into t_zcfqb (wkey, pkey, c_dl_pmd, c_avevqc, c_sqqbbd, c_2wz8nc, c_qyxu0, c_slu2bd) values
          (182, 264000, null, `biiumc`, null, `dwzl6d`, 93.90, null);
conn_0> insert into t_zcfqb (wkey, c_rvm_p, c_avevqc, c_ywxlqb, c_sqqbbd, c_2wz8nc, c_qyxu0, c_ph8nh)
          select
              121 as c0,
              ref_0.c_h1m_zb as c1,
              ref_0.c_gsbzrd as c2,
              ref_0.c_hdnifc as c3,
              (select wkey from t_nvues order by wkey limit 1 offset 5)
                 as c4,
              ref_0.c_h1m_zb as c5,
              ref_0.c_hdnifc as c6,
              ref_0.c_h1m_zb as c7
            from
              t_nvues as ref_0
            where (0 <> 0)
              or (ref_0.wkey is not NULL);
conn_0> select pkey from t_zcfqb where wkey = 121;
conn_1> ROLLBACK;
conn_0> COMMIT;

** Output of SELECT statement in conn_0 (Test case 1) **

+--------+
| pkey   |
+--------+
| 264001 |
| 264002 |
| 264003 |
|   ...  |
| 264049 |
+--------+
49 rows in set (0.00 sec)

** Test case 2 **

conn_0> mysql -h ""127.0.0.1"" -u root -P 4000 -D testdb

conn_0> BEGIN OPTIMISTIC;
conn_0> insert into t_zcfqb (wkey, c_rvm_p, c_avevqc, c_ywxlqb, c_sqqbbd, c_2wz8nc, c_qyxu0, c_ph8nh)
          select
              121 as c0,
              ref_0.c_h1m_zb as c1,
              ref_0.c_gsbzrd as c2,
              ref_0.c_hdnifc as c3,
              (select wkey from t_nvues order by wkey limit 1 offset 5)
                 as c4,
              ref_0.c_h1m_zb as c5,
              ref_0.c_hdnifc as c6,
              ref_0.c_h1m_zb as c7
            from
              t_nvues as ref_0
            where (0 <> 0)
              or (ref_0.wkey is not NULL);
conn_0> select pkey from t_zcfqb where wkey = 121;
conn_0> COMMIT;

** Output of SELECT statement in conn_0 (Test case 2) **

+-------+
| pkey  |
+-------+
| 77001 |
| 77002 |
| 77003 |
|  ...  |
| 77049 |
+-------+
49 rows in set (0.01 sec)
The ROLLBACK transaction can affect the result of COMMIT transaction by changing the value of ""auto_increment"" columns (primary key in our test case).",unspecified,Pessimistic,2,50,30,-,-,-,3,explicit,3,explicit,4,explicit,4,-,-,-,-,Yes,-,-,-,Yes,Yes,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,Yes,-,-,-,Yes,"NOT NULL
DEFAULT NULL
AUTO_INCREMENT",-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,256,"No, not key-value data structures","No, same behavior","No, unsupported statements",,,MySQL_107066
MySQL,106818,https://bugs.mysql.com/bug.php?id=106818,Replication may fail when XA transactions use replace into statements,"CREATE TABLE t (
  id INT NOT NULL AUTO_INCREMENT,
  k VARCHAR(20),
	c VARCHAR(20),
  PRIMARY KEY(id),
	UNIQUE KEY uk(k)
) ENGINE=InnoDB;

INSERT INTO t VALUES(1, `aaa`, `aaaaa`);
INSERT INTO t VALUES(2, `bbb`, `bbbbb`);
INSERT INTO t VALUES(3, `ccc`, `ccccc`);

SELECT * FROM t;

CREATE USER user1;
GRANT SELECT, UPDATE, DELETE, INSERT ON test.* to user1;

--connect(conn1,localhost,user1)
--connect(conn2,localhost,user1)
--connect(conn3,localhost,user1)

--echo
--echo # 2. Start a tansaction and don`t end it. This will prevent the purge thread from running.

--connection conn1
BEGIN;
SET SESSION TRANSACTION_ISOLATION = `REPEATABLE-READ`;
SELECT * FROM t;

--echo
--echo # 3. Delete the record of k = `bbb`. It won`t be purged by master but it will be replicated to slave and will be purged on slave.

--connection conn2
DELETE FROM t WHERE k = `bbb`;

--source include/rpl_sync.inc

--echo sleep 5 seconds to wait for slave to purge the deleted record.
--sleep 5

--echo
--echo # 4. Execute XA transactions and replace the records of k = `aaa` and `ccc`

--connection conn2
XA START `XA1`;
REPLACE INTO t values(1, `aaa`, `xxxxx`);
XA END `XA1`;
XA PREPARE `XA1`;

--connection conn3
XA START `XA2`;
REPLACE INTO t values(3, `ccc`, `yyyyy`);
XA END `XA2`;
XA PREPARE `XA2`;

--echo
--echo # 5. Replication error occurs.

--let $rpl_connection_name= master
--source include/rpl_connection.inc

--sleep 1

--let $rpl_connection_name= slave
--source include/rpl_connection.inc

select @@global.innodb_lock_wait_timeout;

--echo
--echo There is a lock wait in SHOW ENGINE INNODB STATUS.
query_vertical SHOW ENGINE INNODB STATUS;

--echo sleep 5 seconds to wait for lock wait timeout.
--sleep 5

--echo
--echo SHOW SLAVE STATUS shows lock wait timeout.
query_vertical SHOW SLAVE STATUS;

=======",Verified,"5.7, 8.0, 5.7.37",-,-,2022/3/24,S2 (Serious),"In a master-slave replication scenario, when master executes XA transactions with replace into statements, replication may fail with lock wait timeout. 

The following conditions are required to cause the replication failure:
(1) A table with unique key.
(2) XA transactions.
(3) Replace into statements in XA transactions cause the replacement of existing unique key records. 
(4) The records replaced by replace into statements have not been purged due to a high workload or the need to read the replaced records by other readviews. 

When a replace into statement encounters an existing duplicate unique key record, it locks the next record of this unique key record even the next record is delete-marked and has not been purged yet.

Assume a, b, c are the consecutive unique key records of a table. Replication error happens when:
(1) Session1 deletes unique key `b` and commits the transaction;
(2) Unique key `b` is not purged on master for some reason(noted above);
(3) The delete statement is replicated to slave and executed by slave;
(4) Unique key `b` is purged by slave;
(5) Session1 executes an XA transaction(called XA1) and replaces unique key `a`, causing the lock of the delete-marked unique key `b`. Then session1 prepares the XA transaction. Note that unique key `c` is not locked by the transaction because it is not the next record of `a`;
(6) Session2 executes an XA transaction(called XA2) and replaces unique key `c`.
(7) The two XA transactions are replicated to slave. Since `b` is purged on slave, `c` is the next record of `a`. So XA1 locks unique key `c`, XA2 will never get the lock of `c`. Replication fails.

How to repeat:
Testcase:

(1) master opt file:

issue_rpl_lock_wait_timeout_when_replace_into_and_xa_transactions-master.opt

--gtid_mode=ON
--enforce_gtid_consistency=ON
--binlog_format=row
--binlog_transaction_dependency_tracking=COMMIT_ORDER

(2) slave opt file:

issue_rpl_lock_wait_timeout_when_replace_into_and_xa_transactions-slave.opt

--gtid_mode=ON
--enforce_gtid_consistency=ON
--binlog_format=row
--binlog_transaction_dependency_tracking=COMMIT_ORDER
--innodb_lock_wait_timeout=3
--slave_transaction_retries=0
--slave_parallel_workers=0
--innodb_status_output_locks=ON

(3) testcase file

issue_rpl_lock_wait_timeout_when_replace_into_and_xa_transactions.test

# Replication fails with lock wait timeout in the following case.

-- source include/master-slave.inc

--echo # 1. Prepare

--let $rpl_connection_name= master
--source include/rpl_connection.inc

select @@global.binlog_transaction_dependency_tracking;

CREATE TABLE t (
  id INT NOT NULL AUTO_INCREMENT,
  k VARCHAR(20),
 c VARCHAR(20),
  PRIMARY KEY(id),
 UNIQUE KEY uk(k)
) ENGINE=InnoDB;

INSERT INTO t VALUES(1, `aaa`, `aaaaa`);
INSERT INTO t VALUES(2, `bbb`, `bbbbb`);
INSERT INTO t VALUES(3, `ccc`, `ccccc`);

SELECT * FROM t;

CREATE USER user1;
GRANT SELECT, UPDATE, DELETE, INSERT ON test.* to user1;

--connect(conn1,localhost,user1)
--connect(conn2,localhost,user1)
--connect(conn3,localhost,user1)

--echo
--echo # 2. Start a tansaction and don`t end it. This will prevent the purge thread from running.

--connection conn1
BEGIN;
SET SESSION TRANSACTION_ISOLATION = `REPEATABLE-READ`;
SELECT * FROM t;

--echo
--echo # 3. Delete the record of k = `bbb`. It won`t be purged by master but it will be replicated to slave and will be purged on slave.

--connection conn2
DELETE FROM t WHERE k = `bbb`;

--source include/rpl_sync.inc

--echo sleep 5 seconds to wait for slave to purge the deleted record.
--sleep 5

--echo
--echo # 4. Execute XA transactions and replace the records of k = `aaa` and `ccc`

--connection conn2
XA START `XA1`;
REPLACE INTO t values(1, `aaa`, `xxxxx`);
XA END `XA1`;
XA PREPARE `XA1`;

--connection conn3
XA START `XA2`;
REPLACE INTO t values(3, `ccc`, `yyyyy`);
XA END `XA2`;
XA PREPARE `XA2`;

--echo
--echo # 5. Replication error occurs.

--let $rpl_connection_name= master
--source include/rpl_connection.inc

--sleep 1

--let $rpl_connection_name= slave
--source include/rpl_connection.inc

select @@global.innodb_lock_wait_timeout;

--echo
--echo There is a lock wait in SHOW ENGINE INNODB STATUS.
query_vertical SHOW ENGINE INNODB STATUS;

--echo sleep 5 seconds to wait for lock wait timeout.
--sleep 5

--echo
--echo SHOW SLAVE STATUS shows lock wait timeout.
query_vertical SHOW SLAVE STATUS;",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,5,explicit,3,auto,1,XA,4,XA,4,auto,3,Yes,Yes,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,Yes,Yes,-,-,-,-,-,-,ENGINE=InnoDB,-,"sleep 3 times
produce lock wait timeout",Yes,Yes,Yes,-,-,-,-,"NOT NULL
AUTO_INCREMENT",-,"No, need control (sleep)",Operation error,Consistency: DBMS state,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,283,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_106818
MySQL,104245,https://bugs.mysql.com/bug.php?id=104245,Wrong row lock number in SEIS,"mysql [localhost:4679] {msandbox} (test) > select @@version ;
+-----------+
| @@version |
+-----------+
| 5.7.34    |
+-----------+
1 row in set (0.00 sec)

CREATE TABLE `t1` (
  `c1` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `c2` bigint(20) NOT NULL,
  `c3` bigint(20) NOT NULL,
  `c4` bigint(20) NOT NULL,
  `c5` bigint(20) NOT NULL,
  PRIMARY KEY (`c1`),
  UNIQUE KEY `UNIQUE_KEY` (`c2`,`c3`,`c4`)
) ENGINE=InnoDB ;

mysql [localhost:4679] {msandbox} (test) > INSERT IGNORE INTO t1 (c2, c3, c4, c5) values (1,1,1,1);
Query OK, 1 row affected (0.00 sec)

mysql [localhost:4679] {msandbox} (test) > BEGIN ;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:4679] {msandbox} (test) > INSERT IGNORE INTO t1 (c2, c3, c4, c5) values (1,1,1,1),(1,1,1,1),(1,1,1,1),(1,1,1,1),(1,1,1,1);
Query OK, 0 rows affected, 5 warnings (0.00 sec)
Records: 5  Duplicates: 5  Warnings: 5

mysql [localhost:4679] {msandbox} (test) > SHOW ENGINE INNODB STATUS\G
...
---TRANSACTION 1354, ACTIVE 24 sec
5 lock struct(s), heap size 1136, 10 row lock(s)
MySQL thread id 3, OS thread handle 140062776764160, query id 468 localhost msandbox starting

mysql [localhost:8025] {msandbox} (test) > select @@version ;
+-----------+
| @@version |
+-----------+
| 8.0.25    |
+-----------+
1 row in set (0.00 sec)

CREATE TABLE `t1` (
  `c1` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `c2` bigint(20) NOT NULL,
  `c3` bigint(20) NOT NULL,
  `c4` bigint(20) NOT NULL,
  `c5` bigint(20) NOT NULL,
  PRIMARY KEY (`c1`),
  UNIQUE KEY `UNIQUE_KEY` (`c2`,`c3`,`c4`)
) ENGINE=InnoDB ;

mysql [localhost:8025] {msandbox} (test) > INSERT IGNORE INTO t1 (c2, c3, c4, c5) values (1,1,1,1);
Query OK, 1 row affected (0.00 sec)

mysql [localhost:8025] {msandbox} (test) > BEGIN ;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:8025] {msandbox} (test) > INSERT IGNORE INTO t1 (c2, c3, c4, c5) values (1,1,1,1),(1,1,1,1),(1,1,1,1),(1,1,1,1),(1,1,1,1);
Query OK, 0 rows affected, 5 warnings (0.00 sec)
Records: 5  Duplicates: 5  Warnings: 5

mysql [localhost:8025] {msandbox} (test) > SHOW ENGINE INNODB STATUS\G
...
---TRANSACTION 1630, ACTIVE 20 sec
5 lock struct(s), heap size 1136, 2 row lock(s)
MySQL thread id 11, OS thread handle 140440135558912, query id 109 localhost msandbox starting",Verified,5.7.34,-,-,2021/7/7,S3 (Non-critical),"While inserting an existent row on a table within the same transaction row locks are duplicated after each insert. Probably these locks are related with MySQL locking the UK and PK at the same time. However, I can`t see the same behavior on 8.0.

How to repeat:
mysql [localhost:4679] {msandbox} (test) > select @@version ;
+-----------+
| @@version |
+-----------+
| 5.7.34    |
+-----------+
1 row in set (0.00 sec)

CREATE TABLE `t1` (
  `c1` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `c2` bigint(20) NOT NULL,
  `c3` bigint(20) NOT NULL,
  `c4` bigint(20) NOT NULL,
  `c5` bigint(20) NOT NULL,
  PRIMARY KEY (`c1`),
  UNIQUE KEY `UNIQUE_KEY` (`c2`,`c3`,`c4`)
) ENGINE=InnoDB ;

mysql [localhost:4679] {msandbox} (test) > INSERT IGNORE INTO t1 (c2, c3, c4, c5) values (1,1,1,1);
Query OK, 1 row affected (0.00 sec)

mysql [localhost:4679] {msandbox} (test) > BEGIN ;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:4679] {msandbox} (test) > INSERT IGNORE INTO t1 (c2, c3, c4, c5) values (1,1,1,1),(1,1,1,1),(1,1,1,1),(1,1,1,1),(1,1,1,1);
Query OK, 0 rows affected, 5 warnings (0.00 sec)
Records: 5  Duplicates: 5  Warnings: 5

mysql [localhost:4679] {msandbox} (test) > SHOW ENGINE INNODB STATUS\G
...
---TRANSACTION 1354, ACTIVE 24 sec
5 lock struct(s), heap size 1136, 10 row lock(s)
MySQL thread id 3, OS thread handle 140062776764160, query id 468 localhost msandbox starting",unspecified,Pessimistic,1,1,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,Yes,-,-,-,-,"NOT NULL
AUTO_INCREMENT",-,Yes,Low performance,Excessive isolation,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,543,"No, not key-value data structures","No, DBMS-specific","No, performance degradation",,,MySQL_104245
MySQL,102992,https://bugs.mysql.com/bug.php?id=102992,XA transactions do not update slave_relay_log_info table,"1- Create source and replica DBs.
2- Run the following statements on the source:
a) create database xarepl;
b) use xarepl
c) create table t1(id int primary key auto_increment)engine=innodb;
d) -- Run the following statement several times ...
XA START `xa_replication_check`; insert into t1(id) values(null); XA END `xa_replication_check`; XA COMMIT `xa_replication_check` ONE PHASE;
e) -- Check the table records
select COUNT(*) from t1;
3- Run the following statements on the replica:
a) -- Check the table records
select COUNT(*) from t1;
b) show slave status\G select Master_log_name,Master_log_pos from mysql.slave_relay_log_info;

This will show that the Relay_Master_Log_File and Exec_Master_Log_Pos in SHOW SLAVE STATUS output do not match the info in mysql.slave_relay_log_info table!

4- Crash the replica (pkill -9 mysql).",Verified,"5.7, 8.0, 5.7.33",-,-,2021/3/15,S3 (Non-critical),"1- Create source and replica DBs.
2- Run the following statements on the source:
a) create database xarepl;
b) use xarepl
c) create table t1(id int primary key auto_increment)engine=innodb;
d) -- Run the following statement several times ...
XA START `xa_replication_check`; insert into t1(id) values(null); XA END `xa_replication_check`; XA COMMIT `xa_replication_check` ONE PHASE;
e) -- Check the table records
select COUNT(*) from t1;
3- Run the following statements on the replica:
a) -- Check the table records
select COUNT(*) from t1;
b) show slave status\G select Master_log_name,Master_log_pos from mysql.slave_relay_log_info;

This will show that the Relay_Master_Log_File and Exec_Master_Log_Pos in SHOW SLAVE STATUS output do not match the info in mysql.slave_relay_log_info table!

4- Crash the replica (pkill -9 mysql).
When using crash safe replication settings (particularly, relay_log_info_repository=`TABLE`), the replica does not update the table mysql.slave_relay_log_info when XA transaction is executed on the source DB even though, the transaction itself was replicated. If the replica crashed before either the source`s binary log got rotated or non-XA transaction was executed (as these will trigger an update on the table), the replication will break after the DB start up as the used binary log coordinates will point to transactions that were already applied.",unspecified,Pessimistic,1,0,-,-,-,-,4,XA,4,auto,1,auto,2,auto,1,-,-,-,Yes,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,"relay_log_info_repository=`TABLE`
ENGINE=InnoDB","inject crash
kill connection",-,-,Yes,Yes,-,-,-,-,AUTO_INCREMENT,-,"No, need repeat",Incorrect DBMS state,Consistency: DBMS state,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,657,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_102992
MySQL,102967,https://bugs.mysql.com/bug.php?id=102967,deadlock transaction hang up when connection is broken,"set global innodb_deadlock_detect=off;
create table t1(f1 int);
create table t2(f1 int);

conn 1 conn 2
begin; begin;
select * from t1 for update; select * from t2 for update;
insert into t2 values (1); insert into t1 values (1);

kill conn1, conn2 client

conn 3
show processlist;",Verified,5.7.18,-,-,2021/3/15,S3 (Non-critical),"set global innodb_deadlock_detect=off;
create table t1(f1 int);
create table t2(f1 int);

conn 1 conn 2
begin; begin;
select * from t1 for update; select * from t2 for update;
insert into t2 values (1); insert into t1 values (1);

kill conn1, conn2 client

conn 3
show processlist;
When turn off dead lock detection, transactions hold locks and come along with dead lock. If transactoins client disconnect accidently, transactions will not rollback and hold locks until lock timed out. This will cause the followup blocking on the holding locks. Also if transaction is blocked by other transaction and disconnected accidently, this transaction will not release locks until timed out No matter what dead lock check is configed.
Deadlcok hangup can be solved by turning dead lock check on.
",unspecified,Pessimistic,2,0,0,-,-,-,3,explicit,3,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,set global innodb_deadlock_detect=off;,kill connection,-,-,-,-,-,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,657,"No, not key-value data structures","No, DBMS-specific","No, fault injection",,,MySQL_102967
MySQL,101667,https://bugs.mysql.com/bug.php?id=101667,REPEATABLE READ isolation level violation on second read from table with AHI=ON,"REPEATABLE READ isolation level violation on the second read from table.
(only with adaptive hash index = ON)

Example:
MySQL 5.6, 5.7, 8.0 with adaptive hash index = ON we can see this:

create table:

CREATE TABLE `t1` `id` varchar(16) NOT NULL,
                  PRIMARY KEY (`id`)
                 ) ENGINE=InnoDB"");
INSERT INTO `t1` VALUES (`foo`)

session 1: 
set autocommit = 0;  set transaction isolation level repeatable read; 
select * from t1 where id = `foo`; select * from t1 where id = `foo`;

session 2:
set autocommit = 0;  set transaction isolation level repeatable read; 
delete from t1 where id = `foo`; rollback;

In this case session 1 should always see the ORIGINAL value as the second trx never commits.

Problem:
when running 2 (or more) of the above threads in parallel, 
second select will show 0 rows. (first select is fine).
This only happens when adaptive hash index = ON (default).

When disabling AHI it fixes the issue.",Verified,"5.6, 5.7, 8.0, 5.7.32, 8.0.22",-,-,2020/11/18,S2 (Serious),"REPEATABLE READ isolation level violation on the second read from table.
(only with adaptive hash index = ON)

Example:
MySQL 5.6, 5.7, 8.0 with adaptive hash index = ON we can see this:

create table:

CREATE TABLE `t1` `id` varchar(16) NOT NULL,
                  PRIMARY KEY (`id`)
                 ) ENGINE=InnoDB"");
INSERT INTO `t1` VALUES (`foo`)

session 1: 
set autocommit = 0;  set transaction isolation level repeatable read; 
select * from t1 where id = `foo`; select * from t1 where id = `foo`;

session 2:
set autocommit = 0;  set transaction isolation level repeatable read; 
delete from t1 where id = `foo`; rollback;

In this case session 1 should always see the ORIGINAL value as the second trx never commits.

Problem:
when running 2 (or more) of the above threads in parallel, 
second select will show 0 rows. (first select is fine).
This only happens when adaptive hash index = ON (default).
When disabling AHI it fixes the issue.",REPEATABLE READ,Pessimistic,1,1,-,-,-,-,2,explicit,4,explicit,4,-,-,-,-,-,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,"adaptive hash index = ON
ENGINE=InnoDB",-,-,-,-,Yes,-,-,-,-,NOT NULL,-,"No, need repeat",Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,774,"No, not key-value data structures","No, DBMS-specific",Yes,,,MySQL_101667
MySQL,101351,https://bugs.mysql.com/bug.php?id=101351,Replication failure(errno 1399) on dml in XA tr after rollback on timeout,"1. set up two MySQL instance, and set innodb_rollback_on_timeout=on.

2. set up replication from one(master) to the other(slave).

3. prepare data(executed on master node):
create database test;
use test;
create table Table1 (id bigint auto_increment primary key not null, str varchar(50));
insert into Table1(str) values(""a"");
insert into Table1(str) values(""b"");

4. create two connections on master node(connection 1 and connection 2).

5. connection 1:
use test;
xa start `xat1`;
select * from Table1 where id = 2 for update;
update Table1 set str = (select uuid()) where id = 2;

6. connection 2:
use test;
xa start `xat2`;
select * from Table1 where id = 1 for update;
update Table1 set str = (select uuid()) where id = 1;

7. connection 1:
select * from Table1 where id = 1 for update;
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
this select will fail.(innodb_lock_wait_timeout default value is 50, you can set it to a smaller value, such as 5)

8. connection 2:
xa end `xat2`;
xa prepare `xat2`;
xa commit `xat2`;

9. connection 1:
select * from Table1;
insert into Table1(str) values(""c"");  // Upon running this, MySQL replication slave shows error.
select * from Table1;
xa end `xat1`;
xa rollback `xat1`;   // after execute xa end, transaction is in ROLLBACK ONLY state. only can execute xa rollback.

10. connection 2:
select * from Table1;  // ""c"" is inserted.",Verified,"5.7, 5.7.32",-,-,2020/10/28,S2 (Serious),"If set innodb_rollback_on_timeout=on, replication may break upon executing a dml immediately after a transaction rollback due to timeout while in an XA transaction.

Regardless of whether or not the offending update is considered valid on the existing connection, it is expected that replication should still continue to work despite any errors due to transaction rollback.

How to repeat:
1. set up two MySQL instance, and set innodb_rollback_on_timeout=on.

2. set up replication from one(master) to the other(slave).

3. prepare data(executed on master node):
create database test;
use test;
create table Table1 (id bigint auto_increment primary key not null, str varchar(50));
insert into Table1(str) values(""a"");
insert into Table1(str) values(""b"");

4. create two connections on master node(connection 1 and connection 2).

5. connection 1:
use test;
xa start `xat1`;
select * from Table1 where id = 2 for update;
update Table1 set str = (select uuid()) where id = 2;

6. connection 2:
use test;
xa start `xat2`;
select * from Table1 where id = 1 for update;
update Table1 set str = (select uuid()) where id = 1;

7. connection 1:
select * from Table1 where id = 1 for update;
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
this select will fail.(innodb_lock_wait_timeout default value is 50, you can set it to a smaller value, such as 5)

8. connection 2:
xa end `xat2`;
xa prepare `xat2`;
xa commit `xat2`;

9. connection 1:
select * from Table1;
insert into Table1(str) values(""c"");  // Upon running this, MySQL replication slave shows error.
select * from Table1;
xa end `xat1`;
xa rollback `xat1`;   // after execute xa end, transaction is in ROLLBACK ONLY state. only can execute xa rollback.

10. connection 2:
select * from Table1;  // ""c"" is inserted.",unspecified,Pessimistic,1,2,-,-,-,-,4,XA,9,XA,6,auto,1,auto,1,-,-,-,Yes,-,-,Yes,Yes,Yes,-,Yes,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,set innodb_rollback_on_timeout=on,-,produce lock wait timeout,Yes,Yes,Yes,-,-,-,-,"NOT NULL
AUTO_INCREMENT",-,Yes,Operation error,Consistency: DBMS state,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,795,Yes,"No, DBMS-specific","No, depolying cluster",,,MySQL_101351
MySQL,100968,https://bugs.mysql.com/bug.php?id=100968,count star transaction doesn`t response to kill command,"[session 1]
mysql> use test_sj
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+---------------------+
| Tables_in_test_sj   |
+---------------------+
| user_card_info_hash |
+---------------------+
1 row in set (0.01 sec)

mysql> create table user_card_info_hash_1 like user_card_info_hash;
Query OK, 0 rows affected (0.11 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> insert into user_card_info_hash_1 select * from user_card_info_hash;
# here is a big table, so it keeps executing for hours....

# after several minutes
[session 2]
mysql> select count(*) from user_card_info_hash_1;

# after several seconds
[session 3]
mysql> show processlist;
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
| Id  | User            | Host            | db      | Command | Time    | State                  | Info                                                                |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
|   5 | system user     | connecting host | NULL    | Connect | 3295729 | Connecting to master   | NULL                                                                |
|  12 | event_scheduler | localhost       | NULL    | Daemon  | 3295729 | Waiting on empty queue | NULL                                                                |
| 198 | root            | localhost       | test_sj | Query   |      75 | executing              | select count(*) from user_card_info_hash_1                          |
| 199 | root            | localhost       | test_sj | Query   |    1156 | executing              | insert into user_card_info_hash_1 select * from user_card_info_hash |
| 201 | root            | localhost       | NULL    | Query   |       0 | starting               | show processlist                                                    |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
5 rows in set (0.00 sec)

we can see that, `insert select` and `select count(*)` transaction are all working

now kill the `select count(*)` connection.
mysql> kill 198;
Query OK, 0 rows affected (0.00 sec)

mysql> show processlist;
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
| Id  | User            | Host            | db      | Command | Time    | State                  | Info                                                                |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
|   5 | system user     | connecting host | NULL    | Connect | 3295738 | Connecting to master   | NULL                                                                |
|  12 | event_scheduler | localhost       | NULL    | Daemon  | 3295738 | Waiting on empty queue | NULL                                                                |
| 198 | root            | localhost       | test_sj | Killed  |      84 | executing              | select count(*) from user_card_info_hash_1                          |
| 199 | root            | localhost       | test_sj | Query   |    1165 | executing              | insert into user_card_info_hash_1 select * from user_card_info_hash |
| 201 | root            | localhost       | NULL    | Query   |       0 | starting               | show processlist                                                    |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
5 rows in set (0.00 sec)

we can see that Command of the `select count(*)` transaction has changed to `Killed`

wait, wait, wait ...
after 30 minutes ...

mysql> show processlist;
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
| Id  | User            | Host            | db      | Command | Time    | State                  | Info                                                                |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
|   5 | system user     | connecting host | NULL    | Connect | 3297528 | Connecting to master   | NULL                                                                |
|  12 | event_scheduler | localhost       | NULL    | Daemon  | 3297528 | Waiting on empty queue | NULL                                                                |
| 198 | root            | localhost       | test_sj | Killed  |    1874 | executing              | select count(*) from user_card_info_hash_1                          |
| 199 | root            | localhost       | test_sj | Query   |    2955 | executing              | insert into user_card_info_hash_1 select * from user_card_info_hash |
| 201 | root            | localhost       | NULL    | Query   |       0 | starting               | show processlist                                                    |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
5 rows in set (0.00 sec)

so, after 30 minutes, the `select count(*)` are still working ...",Duplicate,"8.0.20, 8.0.21",8.0.22,-,2020/9/27,S2 (Serious),"Here I found a case, kill command doesn`t works for `select count(*)` transaction. 

  (1) I execute `insert into t1 select * from f`, in which t is a big table.
  (2) After several minutes (maybe 1 or 2 minutes), I start a new session and execute `select count(*) from t1`.
  (3) Then after several seconds, start a new session to kill the `select count(*)` connection.
  (4) After I kill the `select count(*)` connection, the transaction still exists after 30 minutes, and goes on and on.
  Please reference `How to repeat` part for detail.

How to repeat:
[session 1]
mysql> use test_sj
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+---------------------+
| Tables_in_test_sj   |
+---------------------+
| user_card_info_hash |
+---------------------+
1 row in set (0.01 sec)

mysql> create table user_card_info_hash_1 like user_card_info_hash;
Query OK, 0 rows affected (0.11 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> insert into user_card_info_hash_1 select * from user_card_info_hash;
# here is a big table, so it keeps executing for hours....

# after several minutes
[session 2]
mysql> select count(*) from user_card_info_hash_1;

# after several seconds
[session 3]
mysql> show processlist;
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
| Id  | User            | Host            | db      | Command | Time    | State                  | Info                                                                |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
|   5 | system user     | connecting host | NULL    | Connect | 3295729 | Connecting to master   | NULL                                                                |
|  12 | event_scheduler | localhost       | NULL    | Daemon  | 3295729 | Waiting on empty queue | NULL                                                                |
| 198 | root            | localhost       | test_sj | Query   |      75 | executing              | select count(*) from user_card_info_hash_1                          |
| 199 | root            | localhost       | test_sj | Query   |    1156 | executing              | insert into user_card_info_hash_1 select * from user_card_info_hash |
| 201 | root            | localhost       | NULL    | Query   |       0 | starting               | show processlist                                                    |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
5 rows in set (0.00 sec)

we can see that, `insert select` and `select count(*)` transaction are all working

now kill the `select count(*)` connection.
mysql> kill 198;
Query OK, 0 rows affected (0.00 sec)

mysql> show processlist;
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
| Id  | User            | Host            | db      | Command | Time    | State                  | Info                                                                |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
|   5 | system user     | connecting host | NULL    | Connect | 3295738 | Connecting to master   | NULL                                                                |
|  12 | event_scheduler | localhost       | NULL    | Daemon  | 3295738 | Waiting on empty queue | NULL                                                                |
| 198 | root            | localhost       | test_sj | Killed  |      84 | executing              | select count(*) from user_card_info_hash_1                          |
| 199 | root            | localhost       | test_sj | Query   |    1165 | executing              | insert into user_card_info_hash_1 select * from user_card_info_hash |
| 201 | root            | localhost       | NULL    | Query   |       0 | starting               | show processlist                                                    |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
5 rows in set (0.00 sec)

we can see that Command of the `select count(*)` transaction has changed to `Killed`

wait, wait, wait ...
after 30 minutes ...

mysql> show processlist;
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
| Id  | User            | Host            | db      | Command | Time    | State                  | Info                                                                |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
|   5 | system user     | connecting host | NULL    | Connect | 3297528 | Connecting to master   | NULL                                                                |
|  12 | event_scheduler | localhost       | NULL    | Daemon  | 3297528 | Waiting on empty queue | NULL                                                                |
| 198 | root            | localhost       | test_sj | Killed  |    1874 | executing              | select count(*) from user_card_info_hash_1                          |
| 199 | root            | localhost       | test_sj | Query   |    2955 | executing              | insert into user_card_info_hash_1 select * from user_card_info_hash |
| 201 | root            | localhost       | NULL    | Query   |       0 | starting               | show processlist                                                    |
+-----+-----------------+-----------------+---------+---------+---------+------------------------+---------------------------------------------------------------------+
5 rows in set (0.00 sec)

so, after 30 minutes, the `select count(*)` are still working ...

CREATE TABLE `keyvalue` (
  `id` bigint(20) unsigned NOT NULL,
  `name1` varchar(250),
  `name2` varchar(250),
  `name3` varchar(250),
  `name4` varchar(250),
  PRIMARY KEY (`id`, name1(10))
) ENGINE=innodb STATS_SAMPLE_PAGES=10000;

create table keyvalue_1 like keyvalue;

insert into keyvalue_1 select * from keyvalue limit 10000000;
Query OK, 10000000 rows affected (4 min 10.89 sec)
Records: 10000000  Duplicates: 0  Warnings: 0",unspecified,Pessimistic,2,10000000,0,-,-,-,3,explicit,2,auto,1,auto,1,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,"ENGINE=InnoDB
STATS_SAMPLE_PAGES=10000",kill connection,-,-,-,Yes,-,-,-,-,NOT NULL,-,Yes,DBMS hang,Consistency: DBMS state,S2 (Serious),Yes,Code fix,-,-,-,-,-,-,26,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_100968
MySQL,100328,https://bugs.mysql.com/bug.php?id=100328,Inconsistent behavior with isolation levels when binlog enabled,"--enable_connect_log
create table t(a int, b int) engine=innodb;
insert into t values (1, 0), (2, 1), (3, 2);

set transaction isolation level repeatable read;
begin;
select * from t;

connect (addconroot1, localhost, root,,);
begin;
update t set a = 10 where b = 1;
commit;

connection default;
select * from t;
update t set a = 10 where a;
select * from t;
# The above returns (which is wrong!)
# a      b
# 10     0
# 2      1
# 10     2

commit;",Verified,"5.6, 5.7, 8.0",-,-,2020/7/27,S2 (Serious),"The following simple test case for MTR framework shows that the problem is repeatable without binary log enabled and without additional changes to code to adjust the read-set bitmap:

--enable_connect_log
create table t(a int, b int) engine=innodb;
insert into t values (1, 0), (2, 1), (3, 2);

set transaction isolation level repeatable read;
begin;
select * from t;

connect (addconroot1, localhost, root,,);
begin;
update t set a = 10 where b = 1;
commit;

connection default;
select * from t;
update t set a = 10 where a;
select * from t;
# The above returns (which is wrong!)
# a      b
# 10     0
# 2      1
# 10     2

commit;

In fact with this test case the problem is repeatable even in 5.5 tree (for 5.5.65-git to be exact).",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,2,explicit,6,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, hard to diagnose",-,-,-,-,-,-,-,-,888,"No, not key-value data structures","No, same behavior",Yes,,,MySQL_100328
MySQL,99082,https://bugs.mysql.com/bug.php?id=99082,"Problem with replication: XA transaction, temp tables and row based binlog","?- on the master
XA START `xatest1`;
  
drop temporary table if exists gm_midterm.test_temp_table;
create temporary table gm_midterm.test_temp_table ENGINE = MEMORY as select ""a"" from dual;
select * from gm_midterm.test_temp_table;
drop temporary table if exists gm_midterm.test_temp_table;

XA END `xatest1`;
XA PREPARE `xatest1`;
XA COMMIT `xatest1`;

-- on the slave after that
Last_SQL_Errno: 3227
               Last_SQL_Error: Error in Xid_log_event: Commit could not be completed, `The use of replication filters with XA transactions is not supported, and can lead to an undefined state in the replication slave.",Verified,"5.7.27, 5.7.29",-,-,2020/3/26,S1 (Critical),"The DB replication has been broken when you using XA transaction (used for enterprise solution typically), temporary tables (in some huge procedures) and row based bin log format.

How to repeat:
-- on the master
XA START `xatest1`;
  
drop temporary table if exists gm_midterm.test_temp_table;
create temporary table gm_midterm.test_temp_table ENGINE = MEMORY as select ""a"" from dual;
select * from gm_midterm.test_temp_table;
drop temporary table if exists gm_midterm.test_temp_table;

XA END `xatest1`;
XA PREPARE `xatest1`;
XA COMMIT `xatest1`;

-- on the slave after that
Last_SQL_Errno: 3227
               Last_SQL_Error: Error in Xid_log_event: Commit could not be completed, `The use of replication filters with XA transactions is not supported, and can lead to an undefined state in the replication slave.`",unspecified,Pessimistic,0,-,-,-,-,-,2,XA,8,auto,1,-,-,-,-,-,-,-,Yes,-,-,Yes,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,use row based bin log format,-,-,-,Yes,-,-,-,-,-,-,-,Yes,Operation error,Consistency: DBMS state,S1 (Critical),"No, unknown",-,-,-,-,-,-,-,-,1011,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_99082
MySQL,99045,https://bugs.mysql.com/bug.php?id=99045,deadlock during XA cause slave SQL thread XAER_RMFAIL error,"connection 1:
use test; 
CREATE TABLE t (i INT) ENGINE = InnoDB; 
INSERT INTO t (i) VALUES(1);
xa start `1`;
SELECT * FROM t WHERE i = 1 LOCK IN SHARE MODE;  # try to make a deadlock

connection 2:
use test;
xa start `2`;
update t set i=i+1 where i=1;  # blocked by connection 1

connection 1:
update t set i=i+1 where i=1; # cause connection 2 report a deadlock 
xa end `1`;xa prepare `1`;xa commit `1`; 

connection 2:
insert into t values (5); # illegal binlog is written
xa end `2`;
ERROR 1614 (XA102): XA_RBDEADLOCK: Transaction branch was rolled back: deadlock was detected

show binlog events in `mysql-bin.000001`;
...
| master-bin.000001 | 2457 | Anonymous_Gtid           |         1 |          79 | SET @@SESSION.GTID_NEXT= `ANONYMOUS`                                                  |
| master-bin.000001 | 2536 | Query                    |         1 |         169 | XA START X`32`,X``,1                                                                  |
| master-bin.000001 | 2626 | Table_map                |         1 |         216 | table_id: 114 (test.t)                                                                |
| master-bin.000001 | 2673 | Write_rows               |         1 |         256 | table_id: 114 flags: STMT_END_F                                                       |
| master-bin.000001 | 2713 | Query                    |         1 |         332 | COMMIT                                                                                |

Slave SQL thread reports an error when finding a COMMIT after XA START .",Verified,"5.7, 8.0, 5.7.29",-,-,2020/3/24,S2 (Serious),"1. execute another DML after a deadlock happens during XA.
2. master generates a illegal binlog sequence:
    ----
    SET @@SESSION.GTID_NEXT= `ANONYMOUS`
    XA START X`32`,X``,1 
    table_id: 114 (test.t)  
    table_id: 114 flags: STMT_END_F  
    COMMIT
    ----
3. slave SQL thread report error: XAER_RMFAIL: The command cannot be executed when global transaction is in the ACTIVE state` on query.

this can be reproduced in lastest version of 5.7/8.0

my.cnf:
binlog-format=ROW

How to repeat:
connection 1:
use test; 
CREATE TABLE t (i INT) ENGINE = InnoDB; 
INSERT INTO t (i) VALUES(1);
xa start `1`;
SELECT * FROM t WHERE i = 1 LOCK IN SHARE MODE;  # try to make a deadlock

connection 2:
use test;
xa start `2`;
update t set i=i+1 where i=1;  # blocked by connection 1

connection 1:
update t set i=i+1 where i=1; # cause connection 2 report a deadlock 
xa end `1`;xa prepare `1`;xa commit `1`; 

connection 2:
insert into t values (5); # illegal binlog is written
xa end `2`;
ERROR 1614 (XA102): XA_RBDEADLOCK: Transaction branch was rolled back: deadlock was detected

show binlog events in `mysql-bin.000001`;
...
| master-bin.000001 | 2457 | Anonymous_Gtid           |         1 |          79 | SET @@SESSION.GTID_NEXT= `ANONYMOUS`                                                  |
| master-bin.000001 | 2536 | Query                    |         1 |         169 | XA START X`32`,X``,1                                                                  |
| master-bin.000001 | 2626 | Table_map                |         1 |         216 | table_id: 114 (test.t)                                                                |
| master-bin.000001 | 2673 | Write_rows               |         1 |         256 | table_id: 114 flags: STMT_END_F                                                       |
| master-bin.000001 | 2713 | Query                    |         1 |         332 | COMMIT                                                                                |

Slave SQL thread reports an error when finding a COMMIT after XA START .",unspecified,Pessimistic,1,1,-,-,-,-,4,XA,6,XA,4,auto,1,auto,1,-,-,-,Yes,-,-,Yes,-,-,Yes,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,"ENGINE=InnoDB
binlog-format=ROW
",-,-,-,Yes,-,-,-,-,-,-,-,Yes,Operation error,Statement correctness: unexpected error,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,1013,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_99045
MySQL,98799,https://bugs.mysql.com/bug.php?id=98799,Replication failing on valid scenario,"I have a replication between nodeA (Master) and nodeB (Slave).

On nodeB I configured:
| slave_type_conversions | ALL_NON_LOSSY |

On nodeA I have:
CREATE TABLE `table1` (
  `id` mediumint(8) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=latin1

And this 2 tests:
test1:
INSERT INTO table1 VALUE();

test2:
BEGIN
INSERT INTO table1 VALUE();
INSERT INTO table1 VALUE();
INSERT INTO table1 VALUE();
COMMIT;

On nodeB
ALTER TABLE bug MODIFY COLUMN id INT unsigned AUTO_INCREMENT;

If I executed test 1 and test2 they work.

But if I execute on nodeA:
ALTER TABLE table1 AUTO_INCREMENT=12093336;
test1 works but test2 breaks the replication with:
               Last_SQL_Error: Could not execute Write_rows event on table test.table1; Duplicate entry `0` for key `PRIMARY`, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event`s master log nodeA-bin.000001, end_log_pos 4245

Doesn`t make sense to set 0 as primary key when the real value is there, but it is not working when the values are in the unsigned part.",Verified,"5.7, 5.7.29",-,-,2020/3/2,S2 (Serious),"I found an issue that breaks the replication when the primary key type of a table is different on the master (mediumint) and slave(int), we send some inserts inside a transaction and auto_increment value is in the unsigned zone ( values > 8388607 on mediumint )

How to repeat:
I have a replication between nodeA (Master) and nodeB (Slave).

On nodeB I configured:
| slave_type_conversions | ALL_NON_LOSSY |

On nodeA I have:
CREATE TABLE `table1` (
  `id` mediumint(8) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=latin1

And this 2 tests:
test1:
INSERT INTO table1 VALUE();

test2:
BEGIN
INSERT INTO table1 VALUE();
INSERT INTO table1 VALUE();
INSERT INTO table1 VALUE();
COMMIT;

On nodeB
ALTER TABLE bug MODIFY COLUMN id INT unsigned AUTO_INCREMENT;

If I executed test 1 and test2 they work.

But if I execute on nodeA:
ALTER TABLE table1 AUTO_INCREMENT=12093336;
test1 works but test2 breaks the replication with:
               Last_SQL_Error: Could not execute Write_rows event on table test.table1; Duplicate entry `0` for key `PRIMARY`, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event`s master log nodeA-bin.000001, end_log_pos 4245",unspecified,Pessimistic,1,0,-,-,-,-,4,auto,3,auto,3,explicit,5,explicit,5,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,"set a master and a slave
| slave_type_conversions | ALL_NON_LOSSY |
ENGINE=InnoDB",-,-,Yes,Yes,Yes,-,-,-,Yes,"NOT NULL
AUTO_INCREMENT",-,Yes,Operation error,Consistency: DBMS state,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,1035,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_98799
MySQL,95049,https://bugs.mysql.com/bug.php?id=95049,Modified rows are not locked after rolling back to savepoint,"Assume that there are 2 transactions: left and right, I executed the following SQL commands:

    # connect command
    connect: mysql -ujohnlinp -psecret somedb

    # create table and populate data
    left: DROP TABLE IF EXISTS person;
    left: CREATE TABLE person (id INT NOT NULL AUTO_INCREMENT, name VARCHAR(255) NOT NULL, age INT NOT NULL, PRIMARY KEY (id));
    left: INSERT INTO person (name, age) VALUES (`John Lin`, 29);

    # start left transaction
    left: BEGIN;
    left: SAVEPOINT somepoint;
    left: UPDATE person SET age = 30 WHERE id = 1;
    left: ROLLBACK TO somepoint;

    # start right transaction
    right: BEGIN;
    right: UPDATE person SET age = 40 WHERE id = 1;

I expected the last SQL command on the right should freeze until timeout, but it was successfully executed right away.

Note: the code block above can be executed by duosql: https://github.com/johnlinp/duosql",Verified,"5.7.25, 8.0.15",-,-,2019/4/18,S3 (Non-critical),"DROP TABLE IF EXISTS person;
CREATE TABLE person (id INT NOT NULL AUTO_INCREMENT, name VARCHAR(255) NOT NULL, age INT NOT NULL, PRIMARY KEY (id));
INSERT INTO person (name, age) VALUES (`John Lin`, 29);

TXN1:
BEGIN;
SAVEPOINT somepoint;
UPDATE person SET age = 30 WHERE id = 1;
ROLLBACK TO somepoint;

TXN2:
BEGIN;
UPDATE person SET age = 40 WHERE id = 1; --- Should be blocked but not.

when I tried to rollback a modified row with ""ROLLBACK TO"", the modified row is not locked and can be modified directly.",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,4,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,set savepoint,-,-,Yes,-,-,-,-,"NOT NULL
AUTO_INCREMENT",-,Yes,Missing blocking,Insufficient isolation: missing blocking,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,1354,"No, not key-value data structures",Yes,"No, unsupported statements",,,MySQL_95049
MySQL,94338,https://bugs.mysql.com/bug.php?id=94338,Dirty read-like behavior in READ COMMITTED transaction,"-- Preparation
mysql> SELECT version();
+-----------+
| version() |
+-----------+
| 5.7.25    |
+-----------+
1 row in set (0.00 sec)

mysql> CREATE TABLE `t1` (
  `a_id` bigint(20) NOT NULL,
  `b_id` bigint(20) NOT NULL
) ENGINE=InnoDB;
Query OK, 0 rows affected (0.07 sec)

mysql> CREATE TABLE `t2` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `a_id` bigint(20) NOT NULL,
  `b_id` bigint(20) NOT NULL,
  `c_code` char(1) CHARACTER SET ascii COLLATE ascii_bin NOT NULL,
  `c_id` bigint(20) NOT NULL,
  `state` tinyint(1) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `secondary` (`a_id`,`b_id`,`c_code`,`c_id`,`state`)
) ENGINE=InnoDB;
Query OK, 0 rows affected (0.08 sec)

mysql> INSERT INTO t1 (a_id, b_id) VALUES (1,18), (1,19);
Query OK, 2 rows affected (0.01 sec)
Records: 2  Duplicates: 0  Warnings: 0

mysql> INSERT INTO t2 (a_id, b_id, c_code, c_id, state) VALUES
  (1,18,`B`,10,1),
  (1,19,`B`,10,1),
  (1,20,`B`,10,1),
  (1,21,`B`,10,1),
  (1,18,`B`,11,0),
  (1,19,`B`,11,0),
  (1,20,`B`,11,0),
  (1,21,`B`,11,0),
  (1,18,`C`,12,1),
  (1,19,`C`,12,1),
  (1,21,`C`,12,1),
  (1,18,`C`,13,1);
Query OK, 12 rows affected (0.02 sec)
Records: 12  Duplicates: 0  Warnings: 0

mysql> ANALYZE TABLE t1, t2;
+---------+---------+----------+----------+
| Table   | Op      | Msg_type | Msg_text |
+---------+---------+----------+----------+
| test.t1 | analyze | status   | OK       |
| test.t2 | analyze | status   | OK       |
+---------+---------+----------+----------+
2 rows in set (0.05 sec)

-- Transaction 1
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;

-- Transaction 2
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;

-- Transaction 1
mysql> SELECT t1.b_id
  FROM t1
  WHERE (
    t1.a_id = 1
    AND IFNULL(1 = (
      SELECT state
      FROM t2 FORCE INDEX(secondary)
      WHERE
        a_id = 1
        AND b_id = t1.b_id
        AND ((c_code = `A` AND c_id = 11) OR (c_code = `B` AND c_id = 11))
      ORDER BY state LIMIT 1), 1))
  LIMIT 10;
Empty set (0.00 sec)

-- Transaction 2
mysql> INSERT INTO t2 (a_id, b_id, c_code, c_id, state) VALUES
  (1,22,`B`,10,1),
  (1,23,`B`,10,1),
  (1,24,`B`,10,1),
  (1,25,`B`,10,1),
  (1,26,`B`,10,1),
  (1,27,`B`,10,1),
  (1,28,`B`,10,1),
  (1,29,`B`,10,1),
  (1,30,`B`,10,1),
  (1,31,`B`,10,1),
  (1,32,`B`,10,1),
  (1,33,`B`,10,1),
  (1,34,`B`,10,1),
  (1,35,`B`,10,1),
  (1,36,`B`,10,1),
  (1,37,`B`,10,1),
  (1,38,`B`,10,1),
  (1,39,`B`,10,1),
  (1,40,`B`,10,1),
  (1,41,`B`,10,1),
  (1,42,`B`,10,1),
  (1,43,`B`,10,1),
  (1,44,`B`,10,1),
  (1,45,`B`,10,1),
  (1,46,`B`,10,1),
  (1,22,`B`,11,0),
  (1,23,`B`,11,0),
  (1,24,`B`,11,0),
  (1,25,`B`,11,0),
  (1,26,`B`,11,0),
  (1,27,`B`,11,0),
  (1,28,`B`,11,0),
  (1,29,`B`,11,0),
  (1,30,`B`,11,0),
  (1,31,`B`,11,0),
  (1,32,`B`,11,0),
  (1,33,`B`,11,0),
  (1,34,`B`,11,0),
  (1,35,`B`,11,0),
  (1,36,`B`,11,0),
  (1,37,`B`,11,0),
  (1,38,`B`,11,0),
  (1,39,`B`,11,0),
  (1,40,`B`,11,0),
  (1,41,`B`,11,0),
  (1,42,`B`,11,0),
  (1,43,`B`,11,0),
  (1,44,`B`,11,0),
  (1,45,`B`,11,0),
  (1,46,`B`,11,0),
  (1,23,`C`,12,1),
  (1,25,`C`,12,1),
  (1,26,`C`,12,1),
  (1,29,`C`,12,1),
  (1,32,`C`,12,1),
  (1,34,`C`,12,1),
  (1,35,`C`,12,1),
  (1,36,`C`,12,1),
  (1,37,`C`,12,1),
  (1,38,`C`,12,1),
  (1,39,`C`,12,1),
  (1,42,`C`,12,1),
  (1,43,`C`,12,1),
  (1,44,`C`,12,1),
  (1,46,`C`,12,1),
  (1,28,`C`,13,1),
  (1,29,`C`,13,1),
  (1,31,`C`,13,1),
  (1,33,`C`,13,1),
  (1,35,`C`,13,1),
  (1,36,`C`,13,1),
  (1,38,`C`,13,1),
  (1,39,`C`,13,1),
  (1,43,`C`,13,1),
  (1,46,`C`,14,1),
  (1,22,`C`,15,1),
  (1,24,`C`,15,1),
  (1,27,`C`,15,1),
  (1,28,`C`,15,1),
  (1,30,`C`,15,1),
  (1,31,`C`,15,1),
  (1,33,`C`,15,1),
  (1,40,`C`,15,1),
  (1,41,`C`,15,1),
  (1,45,`C`,15,1),
  (1,24,`C`,16,1),
  (1,26,`C`,16,1),
  (1,27,`C`,16,1),
  (1,34,`C`,16,1),
  (1,40,`C`,16,1),
  (1,42,`C`,16,1);
Query OK, 91 rows affected (0.00 sec)
Records: 91  Duplicates: 0  Warnings: 0

-- Transaction 1
mysql> SELECT t1.b_id
  FROM t1
  WHERE (
    t1.a_id = 1
    AND IFNULL(1 = (
      SELECT state
      FROM t2 FORCE INDEX(secondary)
      WHERE
        a_id = 1
        AND b_id = t1.b_id
        AND ((c_code = `A` AND c_id = 11) OR (c_code = `B` AND c_id = 11))
      ORDER BY state LIMIT 1), 1))
  LIMIT 10;
+------+
| b_id |
+------+
|   19 |
+------+
1 row in set (0.00 sec)

-- Transaction 2
mysql> COMMIT;
Query OK, 0 rows affected (0.00 sec)

-- Transaction 1
mysql> SELECT t1.b_id
  FROM t1
  WHERE (
    t1.a_id = 1
    AND IFNULL(1 = (
      SELECT state
      FROM t2 FORCE INDEX(secondary)
      WHERE
        a_id = 1
        AND b_id = t1.b_id
        AND ((c_code = `A` AND c_id = 11) OR (c_code = `B` AND c_id = 11))
      ORDER BY state LIMIT 1), 1))
  LIMIT 10;
Empty set (0.00 sec)",Verified,"5.6.43, 5.7.25",-,-,2019/2/15,S2 (Serious),"CREATE TABLE `t1` (
  `a_id` bigint(20) NOT NULL,
  `b_id` bigint(20) NOT NULL
) ENGINE=InnoDB;
CREATE TABLE `t2` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `a_id` bigint(20) NOT NULL,
  `b_id` bigint(20) NOT NULL,
  `c_code` char(1) CHARACTER SET ascii COLLATE ascii_bin NOT NULL,
  `c_id` bigint(20) NOT NULL,
  `state` tinyint(1) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `secondary` (`a_id`,`b_id`,`c_code`,`c_id`,`state`)
) ENGINE=InnoDB;
INSERT INTO t1 (a_id, b_id) VALUES (1,18), (1,19);
INSERT INTO t2 (a_id, b_id, c_code, c_id, state) VALUES
  (1,18,`B`,10,1),
  (1,19,`B`,10,1),
  (1,20,`B`,10,1),
  (1,21,`B`,10,1),
  (1,18,`B`,11,0),
  (1,19,`B`,11,0),
  (1,20,`B`,11,0),
  (1,21,`B`,11,0),
  (1,18,`C`,12,1),
  (1,19,`C`,12,1),
  (1,21,`C`,12,1),
  (1,18,`C`,13,1);
ANALYZE TABLE t1, t2;

TXN1:
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;

TXN2:
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;

TXN1:
SELECT t1.b_id
  FROM t1
  WHERE (
    t1.a_id = 1
    AND IFNULL(1 = (
      SELECT state
      FROM t2 FORCE INDEX(secondary)
      WHERE
        a_id = 1
        AND b_id = t1.b_id
        AND ((c_code = `A` AND c_id = 11) OR (c_code = `B` AND c_id = 11))
      ORDER BY state LIMIT 1), 1))
  LIMIT 10;

TXN2:
INSERT INTO t2 (a_id, b_id, c_code, c_id, state) VALUES
  (1,22,`B`,10,1),
  (1,23,`B`,10,1),
  (1,24,`B`,10,1),
  (1,25,`B`,10,1),
  (1,26,`B`,10,1),
  (1,27,`B`,10,1),
  (1,28,`B`,10,1),
  (1,29,`B`,10,1),
  (1,30,`B`,10,1),
  (1,31,`B`,10,1),
  (1,32,`B`,10,1),
  (1,33,`B`,10,1),
  (1,34,`B`,10,1),
  (1,35,`B`,10,1),
  (1,36,`B`,10,1),
  (1,37,`B`,10,1),
  (1,38,`B`,10,1),
  (1,39,`B`,10,1),
  (1,40,`B`,10,1),
  (1,41,`B`,10,1),
  (1,42,`B`,10,1),
  (1,43,`B`,10,1),
  (1,44,`B`,10,1),
  (1,45,`B`,10,1),
  (1,46,`B`,10,1),
  (1,22,`B`,11,0),
  (1,23,`B`,11,0),
  (1,24,`B`,11,0),
  (1,25,`B`,11,0),
  (1,26,`B`,11,0),
  (1,27,`B`,11,0),
  (1,28,`B`,11,0),
  (1,29,`B`,11,0),
  (1,30,`B`,11,0),
  (1,31,`B`,11,0),
  (1,32,`B`,11,0),
  (1,33,`B`,11,0),
  (1,34,`B`,11,0),
  (1,35,`B`,11,0),
  (1,36,`B`,11,0),
  (1,37,`B`,11,0),
  (1,38,`B`,11,0),
  (1,39,`B`,11,0),
  (1,40,`B`,11,0),
  (1,41,`B`,11,0),
  (1,42,`B`,11,0),
  (1,43,`B`,11,0),
  (1,44,`B`,11,0),
  (1,45,`B`,11,0),
  (1,46,`B`,11,0),
  (1,23,`C`,12,1),
  (1,25,`C`,12,1),
  (1,26,`C`,12,1),
  (1,29,`C`,12,1),
  (1,32,`C`,12,1),
  (1,34,`C`,12,1),
  (1,35,`C`,12,1),
  (1,36,`C`,12,1),
  (1,37,`C`,12,1),
  (1,38,`C`,12,1),
  (1,39,`C`,12,1),
  (1,42,`C`,12,1),
  (1,43,`C`,12,1),
  (1,44,`C`,12,1),
  (1,46,`C`,12,1),
  (1,28,`C`,13,1),
  (1,29,`C`,13,1),
  (1,31,`C`,13,1),
  (1,33,`C`,13,1),
  (1,35,`C`,13,1),
  (1,36,`C`,13,1),
  (1,38,`C`,13,1),
  (1,39,`C`,13,1),
  (1,43,`C`,13,1),
  (1,46,`C`,14,1),
  (1,22,`C`,15,1),
  (1,24,`C`,15,1),
  (1,27,`C`,15,1),
  (1,28,`C`,15,1),
  (1,30,`C`,15,1),
  (1,31,`C`,15,1),
  (1,33,`C`,15,1),
  (1,40,`C`,15,1),
  (1,41,`C`,15,1),
  (1,45,`C`,15,1),
  (1,24,`C`,16,1),
  (1,26,`C`,16,1),
  (1,27,`C`,16,1),
  (1,34,`C`,16,1),
  (1,40,`C`,16,1),
  (1,42,`C`,16,1);

TXN1:
SELECT t1.b_id
  FROM t1
  WHERE (
    t1.a_id = 1
    AND IFNULL(1 = (
      SELECT state
      FROM t2 FORCE INDEX(secondary)
      WHERE
        a_id = 1
        AND b_id = t1.b_id
        AND ((c_code = `A` AND c_id = 11) OR (c_code = `B` AND c_id = 11))
      ORDER BY state LIMIT 1), 1))
  LIMIT 10; ---- Read 1 row 19; Incorrect

TXN2:
COMMIT;

TXN1:
SELECT t1.b_id
  FROM t1
  WHERE (
    t1.a_id = 1
    AND IFNULL(1 = (
      SELECT state
      FROM t2 FORCE INDEX(secondary)
      WHERE
        a_id = 1
        AND b_id = t1.b_id
        AND ((c_code = `A` AND c_id = 11) OR (c_code = `B` AND c_id = 11))
      ORDER BY state LIMIT 1), 1))
  LIMIT 10; ---- Read empty set. Correct",READ COMMITTED,Pessimistic,2,2,12,-,-,-,2,explicit,4,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,Yes,Yes,-,-,Yes,"NOT NULL
AUTO_INCREMENT",-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,1416,"No, not key-value data structures",Yes,"No, unsupported statements",,,MySQL_94338
MySQL,93572,https://bugs.mysql.com/bug.php?id=93572,parallel workers+slave_preserve_commit_order+flushtables with read lock deadlock,"Prepare your environment with master-slave replication and open parallel slave sql workers.

step 0
on master 
create table ashe(id int not null auto_increment primary key,name varchar(10));
create table delay_table(id int);

step1

1.1 Generate  2 transaction that can be apply on slave in parallel.
session1                                                               session2
set binlog_format=statement;                            set binlog_format=statement;
begin;                                                                   begin;
insert into tt select sleep(10);                            
insert into ashe values(40,`aaa`);                       insert into ashe values(41,`aaa`);
commit;                                                                commit

step 2
on slave
flush tables with read lock .

and then you will see that on slave instance.

mysql> show processlist;
+----+-------------+-----------+----------------+---------+------+--------------------------------------------------------+---------------------------------------+
| Id | User        | Host      | db             | Command | Time | State                                                  | Info                                  |
+----+-------------+-----------+----------------+---------+------+--------------------------------------------------------+---------------------------------------+
|  3 | root        | localhost | NULL           | Query   |   13 | Waiting for commit lock                                | flush  tables with read lock          |
| 22 | root        | localhost | NULL           | Query   |    0 | starting                                               | show processlist                      |
| 41 | root        | localhost | NULL           | Sleep   | 1493 |                                                        | NULL                                  |
| 48 | system user |           | NULL           | Connect |  688 | Waiting for master to send event                       | NULL                                  |
| 49 | system user |           | NULL           | Connect |   20 | Slave has read all relay log; waiting for more updates | NULL                                  |
| 50 | system user |           | test_dead_lock | Connect |   25 | Waiting for global read lock                           | insert into ashe(name) values(`aaaa`) |
| 51 | system user |           | NULL           | Connect |   33 | Waiting for preceding transaction to commit            | NULL                                  |
| 52 | system user |           | NULL           | Connect |  657 | Waiting for an event from Coordinator                  | NULL                                  |
Legal PoliciesYour Privacy Rig",Verified,5.7.18,"8.0, 8.0.23",-,2018/12/12,S3 (Non-critical),"MASTER:
create table ashe(id int not null auto_increment primary key,name varchar(10));
create table delay_table(id int);

Slave1:
set binlog_format=statement;
begin;
insert into tt select sleep(10);
insert into ashe values(40, `aaa`);
commit;
flush tables with read lock;

Slave2:
set binlog_format=statement;
begin;
insert into ashe values(41, `aaa`);
commit;
flush tables with read lock;
show processlist; ---deadlock",unspecified,Pessimistic,2,0,0,-,-,-,3,explicit,4,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,set binlog_format=statement,-,flush tables with read lock,-,Yes,Yes,-,-,-,-,"NOT NULL
AUTO_INCREMENT",-,Yes,Incorrect DBMS state,Excessive isolation,S3 (Non-critical),Yes,Code fix,-,-,-,-,-,-,1423,-,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_93572
MySQL,92993,https://bugs.mysql.com/bug.php?id=92993,"Assertion ""all .. .xs->is_binlogged""","sql:
CREATE DATABASE test;
USE test;
SET GLOBAL general_log=ON;
create table t1(a1 int)partition by range (a1) (partition p0 values less than (3),partition p1 values less than (6),partition p2 values less than (9));
drop table mysql.general_log;
xa start `test1`;
INSERT INTO t1 VALUES();
XA END `test1`;
XA PREPARE `test1`;
SET @@global.log_output=`TABLE`;
xa rollback `tx1`;

On release build last statement results in:
mysql> xa rollback `tx1`;
ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed when global transaction is in the  PREPARED state",Verified,"5.7.24, 8.0.13",-,-,2018/10/29,S6 (Debug Builds),"SET GLOBAL general_log=ON;
create table t1(a1 int)partition by range (a1) (partition p0 values less than (3),partition p1 values less than (6),partition p2 values less than (9));
drop table mysql.general_log;
xa start `test1`;
INSERT INTO t1 VALUES();
XA END `test1`;
XA PREPARE `test1`;
SET @@global.log_output=`TABLE`;
xa rollback `tx1`; -- ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed when global transaction is in the  PREPARED state",unspecified,Pessimistic,1,0,-,-,-,-,1,XA,6,-,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,"SET GLOBAL general_log=ON;
drop table mysql.general_log;",-,-,-,-,-,-,-,-,-,-,Yes,Yes,Assertion failure,Statement correctness: assertion failure,S6 (Debug Builds),"No, unknown",-,-,-,-,-,-,-,-,1525,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_92993
MySQL,92558,https://bugs.mysql.com/bug.php?id=92558,information_schema.innodb_trx trx_is_read_only not set for all RO transactions,"mysql [localhost] {msandbox} (db1) > select @@version,@@version_comment;
+-----------+------------------------------+
| @@version | @@version_comment            |
+-----------+------------------------------+
| 8.0.12    | MySQL Community Server - GPL |
+-----------+------------------------------+
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT name, comment, status, count FROM information_schema.innodb_metrics   WHERE name like `trx%comm%`;
+---------------------------+--------------------------------------------------------------------+---------+-------+
| name                      | comment                                                            | status  | count |
+---------------------------+--------------------------------------------------------------------+---------+-------+
| trx_rw_commits            | Number of read-write transactions  committed                       | enabled |     0 |
| trx_ro_commits            | Number of read-only transactions committed                         | enabled |     0 |
| trx_nl_ro_commits         | Number of non-locking auto-commit read-only transactions committed | enabled |     0 |
| trx_commits_insert_update | Number of transactions committed with inserts and updates          | enabled |     0 |
+---------------------------+--------------------------------------------------------------------+---------+-------+
4 rows in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > START TRANSACTION; SELECT count(*) FROM db1.t1;
Query OK, 0 rows affected (0.00 sec)

+----------+
| count(*) |
+----------+
|        3 |
+----------+
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > select * from information_schema.innodb_trx\G
*************************** 1. row ***************************
                    trx_id: 421988493944672
                 trx_state: RUNNING
               trx_started: 2018-09-25 13:57:41
     trx_requested_lock_id: NULL
          trx_wait_started: NULL
                trx_weight: 0
       trx_mysql_thread_id: 8
                 trx_query: select * from information_schema.innodb_trx
       trx_operation_state: NULL
         trx_tables_in_use: 0
         trx_tables_locked: 0
          trx_lock_structs: 0
     trx_lock_memory_bytes: 1136
           trx_rows_locked: 0
         trx_rows_modified: 0
   trx_concurrency_tickets: 0
       trx_isolation_level: REPEATABLE READ
         trx_unique_checks: 1
    trx_foreign_key_checks: 1
trx_last_foreign_key_error: NULL
 trx_adaptive_hash_latched: 0
 trx_adaptive_hash_timeout: 0
          trx_is_read_only: 0
trx_autocommit_non_locking: 0
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > commit;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT name, comment, status, count FROM information_schema.innodb_metrics   WHERE name like `trx%comm%`;
+---------------------------+--------------------------------------------------------------------+---------+-------+
| name                      | comment                                                            | status  | count |
+---------------------------+--------------------------------------------------------------------+---------+-------+
| trx_rw_commits            | Number of read-write transactions  committed                       | enabled |     0 |
| trx_ro_commits            | Number of read-only transactions committed                         | enabled |     1 |
| trx_nl_ro_commits         | Number of non-locking auto-commit read-only transactions committed | enabled |     0 |
| trx_commits_insert_update | Number of transactions committed with inserts and updates          | enabled |     0 |
+---------------------------+--------------------------------------------------------------------+---------+-------+
4 rows in set (0.00 sec)

-- and explicit one sets the attribute as expected:

mysql [localhost] {msandbox} (db1) > START TRANSACTION READ ONLY; SELECT count(*) FROM db1.t1;
Query OK, 0 rows affected (0.00 sec)

+----------+
| count(*) |
+----------+
|        3 |
+----------+
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > select * from information_schema.innodb_trx\G
*************************** 1. row ***************************
                    trx_id: 421988493944672
                 trx_state: RUNNING
               trx_started: 2018-09-25 13:59:12
     trx_requested_lock_id: NULL
          trx_wait_started: NULL
                trx_weight: 0
       trx_mysql_thread_id: 8
                 trx_query: select * from information_schema.innodb_trx
       trx_operation_state: NULL
         trx_tables_in_use: 0
         trx_tables_locked: 0
          trx_lock_structs: 0
     trx_lock_memory_bytes: 1136
           trx_rows_locked: 0
         trx_rows_modified: 0
   trx_concurrency_tickets: 0
       trx_isolation_level: REPEATABLE READ
         trx_unique_checks: 1
    trx_foreign_key_checks: 1
trx_last_foreign_key_error: NULL
 trx_adaptive_hash_latched: 0
 trx_adaptive_hash_timeout: 0
          trx_is_read_only: 1
trx_autocommit_non_locking: 0
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > commit;
Query OK, 0 rows affected (0.01 sec)

mysql [localhost] {msandbox} (db1) > SELECT name, comment, status, count FROM information_schema.innodb_metrics   WHERE name like `trx%comm%`;
+---------------------------+--------------------------------------------------------------------+---------+-------+
| name                      | comment                                                            | status  | count |
+---------------------------+--------------------------------------------------------------------+---------+-------+
| trx_rw_commits            | Number of read-write transactions  committed                       | enabled |     0 |
| trx_ro_commits            | Number of read-only transactions committed                         | enabled |     2 |
| trx_nl_ro_commits         | Number of non-locking auto-commit read-only transactions committed | enabled |     0 |
| trx_commits_insert_update | Number of transactions committed with inserts and updates          | enabled |     0 |
+---------------------------+--------------------------------------------------------------------+---------+-------+
4 rows in set (0.00 sec)",Verified,"5.7.23, 8.0.12",-,-,2018/9/25,S3 (Non-critical),"select @@version,@@version_comment;
SELECT name, comment, status, count FROM information_schema.innodb_metrics   WHERE name like `trx%comm%`;
START TRANSACTION; SELECT count(*) FROM db1.t1;
select * from information_schema.innodb_trx\G
commit;
SELECT name, comment, status, count FROM information_schema.innodb_metrics   WHERE name like `trx%comm%`; --- 1 read-only transactions committed
START TRANSACTION READ ONLY; SELECT count(*) FROM db1.t1;
select * from information_schema.innodb_trx\G
commit;
SELECT name, comment, status, count FROM information_schema.innodb_metrics   WHERE name like `trx%comm%`; --- 2 read-only transactions committed

Since 5.7, RO transactions optimization is used not only for explicit  START TRANSACTION READ ONLY and non-locking autocommit SELECTs, but also for any started transaction that hasn`t done any lock or write yet.

For some reason, trx_is_read_only attribute of innodb_trx view is not set for this last type of RO transactions, which is misleading.",unspecified,Pessimistic,1,3,-,-,-,-,3,auto,3,explicit,4,explicit,4,-,-,-,-,-,Yes,Yes,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,1559,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_92558
MySQL,92364,https://bugs.mysql.com/bug.php?id=92364,events_transactions_summary_global_by_event_name not working as expected,"mysql [localhost] {msandbox} (db1) > select @@version,@@version_comment,@@autocommit;
+-----------+------------------------------+--------------+
| @@version | @@version_comment            | @@autocommit |
+-----------+------------------------------+--------------+
| 8.0.12    | MySQL Community Server - GPL |            1 |
+-----------+------------------------------+--------------+
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT * FROM performance_schema.setup_consumers WHERE NAME LIKE `%transactions%`;
+----------------------------------+---------+
| NAME                             | ENABLED |
+----------------------------------+---------+
| events_transactions_current      | YES     |
| events_transactions_history      | YES     |
| events_transactions_history_long | YES     |
+----------------------------------+---------+
3 rows in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT * FROM performance_schema.setup_instruments WHERE NAME = `transaction`;
+-------------+---------+-------+------------+------------+---------------+
| NAME        | ENABLED | TIMED | PROPERTIES | VOLATILITY | DOCUMENTATION |
+-------------+---------+-------+------------+------------+---------------+
| transaction | YES     | YES   |            |          0 | NULL          |
+-------------+---------+-------+------------+------------+---------------+
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G
*************************** 1. row ***************************
      COUNT_STAR: 17
COUNT_READ_WRITE: 17
 COUNT_READ_ONLY: 0
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > select a from t1 where id=1;                                                                                                                                                  +-------+
| a     |
+-------+
| foobr |
+-------+
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G
*************************** 1. row ***************************
      COUNT_STAR: 18
COUNT_READ_WRITE: 18
 COUNT_READ_ONLY: 0
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > start transaction; commit;
Query OK, 0 rows affected (0.00 sec)

Query OK, 0 rows affected (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G
*************************** 1. row ***************************
      COUNT_STAR: 19
COUNT_READ_WRITE: 19
 COUNT_READ_ONLY: 0
1 row in set (0.00 sec)

mysql [localhost] {msandbox} (db1) > start transaction read only; commit;
Query OK, 0 rows affected (0.00 sec)

Query OK, 0 rows affected (0.00 sec)

mysql [localhost] {msandbox} (db1) > SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G
*************************** 1. row ***************************
      COUNT_STAR: 20
COUNT_READ_WRITE: 19
 COUNT_READ_ONLY: 1
1 row in set (0.00 sec)",Fixed,"5.7.22, 8.0.12",doc,https://dev.mysql.com/doc/mysql-perfschema-excerpt/8.0/en/transaction-summary-tables.html,2018/9/11,S3 (Non-critical),"SET GLOBAL innodb_monitor_enable = `trx%comm%`;
SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G---count_start: 17 count_read_write: 17 count_read_only:0
SELECT name, comment, count FROM information_schema.innodb_metrics WHERE name like `trx%comm%`;
select a from t1 where id=1;
SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G---count_start: 18 count_read_write: 18 count_read_only:0
SELECT name, comment, count FROM information_schema.innodb_metrics WHERE name like `trx%comm%`;
start transaction; commit;
SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G---count_start: 19 count_read_write: 19 count_read_only:0
SELECT name, comment, count FROM information_schema.innodb_metrics WHERE name like `trx%comm%`;
start transaction read only; commit;
SELECT COUNT_STAR,COUNT_READ_WRITE,COUNT_READ_ONLY FROM performance_schema.events_transactions_summary_global_by_event_name\G ---count_start: 20 count_read_write: 19 count_read_only:1",unspecified,Pessimistic,1,1,-,-,-,-,3,auto,9,explicit,2,explicit,3,-,-,-,-,-,Yes,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,SET GLOBAL innodb_monitor_enable = `trx%comm%`;,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,S3 (Non-critical),Yes,Document fix,-,-,-,-,-,-,170,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_92364
MySQL,91837,https://bugs.mysql.com/bug.php?id=91837,IS.innodb_trx results filtered by trx_started depends on timezone,"docker run --rm -it -e MYSQL_ALLOW_EMPTY_PASSWORD=1 --name m8 mysql:latest
it starts mysql with system timezone UTC.
in one session (docker exec -it m8 mysql) start long running transaction:
begin;select * from mysql.innodb_table_stats LIMIT 1;

in second session:
set session time_zone=`-09:00`;
mysql> select count(*) from information_schema.innodb_trx where trx_started < date_sub(now(), interval 5 second);
+----------+
| count(*) |
+----------+
|        0 |
+----------+

Expected results the same as before running time_zone:
mysql> select count(*) from information_schema.innodb_trx where trx_started < date_sub(now(), interval 5 second);
+----------+
| count(*) |
+----------+
|        1 |
+----------+",Verified,"5.7.23, 8.0.11, 8.0.12",-,-,2018/7/31,S3 (Non-critical),"Session1: --- timezone UTC
begin;select * from mysql.innodb_table_stats LIMIT 1;

Session2:
set session time_zone=`-09:00`; 
select count(*) from information_schema.innodb_trx where trx_started < date_sub(now(), interval 5 second); --- 0. Expected 1.
",unspecified,Pessimistic,0,-,-,-,-,-,2,explicit,2,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,"system timezone UTC
set session time_zone=`-09:00`; ",-,-,-,-,-,-,-,Yes,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,1615,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_91837
MySQL,91743,https://bugs.mysql.com/bug.php?id=91743,performance_schema.data_locks not working correctly,"mysql> show create table slowtech.t1\G
*************************** 1. row ***************************
       Table: t1
Create Table: CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `c1` int(11) DEFAULT NULL,
  `c2` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c1` (`c1`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
1 row in set (0.00 sec)

mysql> select * from slowtech.t1;
+----+------+------+
| id | c1   | c2   |
+----+------+------+
|  1 |   11 |   12 |
|  5 |   21 |   22 |
| 10 |   31 |   32 |
+----+------+------+
3 rows in set (0.00 sec)

set global innodb_table_locks=1;

session1> begin;
Query OK, 0 rows affected (0.00 sec)

session1> select connection_id();
+-----------------+
| connection_id() |
+-----------------+
|              39 |
+-----------------+
1 row in set (0.00 sec)

session1> insert into slowtech.t1 values(11,41,42);
Query OK, 1 row affected (0.00 sec)

then i check the ""TRANSACTIONS"" section in ""show engine innodb status"" and performance_schema.data_locks.

-------------------------------------------
[root@slowtech ~]# mysql -e ""show engine innodb status\G"" | awk `/TRANSACTIONS/,/FILE/` && mysql -e ""select engine_lock_id,thread_id,event_id,object_name,inde
x_name,lock_type,lock_mode,lock_status,lock_data from performance_schema.data_locks;""TRANSACTIONS
------------
Trx id counter 213929
Purge done for trx`s n:o < 213929 undo n:o < 0 state: running but idle
History list length 44
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421812853169808, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421812853168888, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 213924, ACTIVE 161 sec
1 lock struct(s), heap size 1136, 0 row lock(s), undo log entries 1
MySQL thread id 39, OS thread handle 140337863264000, query id 529 localhost root
TABLE LOCK table `slowtech`.`t1` trx id 213924 lock mode IX
--------
FILE I/O
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| engine_lock_id | thread_id | event_id | object_name | index_name | lock_type | lock_mode | lock_status | lock_data |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| 213924:1262    |        76 |       52 | t1          | NULL       | TABLE     | IX        | GRANTED     | NULL      |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+

-----------------------------------------------

it seems the insert get a implicit lock.

then i tried to insert another record

session2> select connection_id();
+-----------------+
| connection_id() |
+-----------------+
|             101 |
+-----------------+
1 row in set (0.00 sec)

session2> insert into slowtech.t1 values(11,41,42);
it blocked ...

check related info again

------------------------------------------
[root@slowtech ~]# mysql -e ""show engine innodb status\G"" | awk `/TRANSACTIONS/,/FILE/` && mysql -e ""select engine_lock_id,thread_id,event_id,object_name,inde
x_name,lock_type,lock_mode,lock_status,lock_data from performance_schema.data_locks;""TRANSACTIONS
------------
Trx id counter 213931
Purge done for trx`s n:o < 213929 undo n:o < 0 state: running but idle
History list length 44
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421812853169808, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 213930, ACTIVE 7 sec inserting
mysql tables in use 1, locked 1
LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)
MySQL thread id 101, OS thread handle 140337721857792, query id 550 localhost root update
insert into slowtech.t1 values(11,41,42)
------- TRX HAS BEEN WAITING 7 SEC FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 205 page no 4 n bits 72 index PRIMARY of table `slowtech`.`t1` trx id 213930 lock mode S waiting
Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000b; asc     ;;
 1: len 6; hex 0000000343a9; asc     C ;;
 2: len 7; hex 820000014e0110; asc     N  ;;
 3: len 4; hex 80000029; asc    );;
 4: len 4; hex 8000002a; asc    *;;

------------------
TABLE LOCK table `slowtech`.`t1` trx id 213930 lock mode IX
RECORD LOCKS space id 205 page no 4 n bits 72 index PRIMARY of table `slowtech`.`t1` trx id 213930 lock mode S waiting
Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000b; asc     ;;
 1: len 6; hex 0000000343a9; asc     C ;;
 2: len 7; hex 820000014e0110; asc     N  ;;
 3: len 4; hex 80000029; asc    );;
 4: len 4; hex 8000002a; asc    *;;

---TRANSACTION 213929, ACTIVE 99 sec
2 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 1
MySQL thread id 39, OS thread handle 140337863264000, query id 547 localhost root
TABLE LOCK table `slowtech`.`t1` trx id 213929 lock mode IX
RECORD LOCKS space id 205 page no 4 n bits 72 index PRIMARY of table `slowtech`.`t1` trx id 213929 lock_mode X locks rec but not gap
Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000b; asc     ;;
 1: len 6; hex 0000000343a9; asc     C ;;
 2: len 7; hex 820000014e0110; asc     N  ;;
 3: len 4; hex 80000029; asc    );;
 4: len 4; hex 8000002a; asc    *;;

--------
FILE I/O
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| engine_lock_id | thread_id | event_id | object_name | index_name | lock_type | lock_mode | lock_status | lock_data |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| 213930:1262    |       138 |       13 | t1          | NULL       | TABLE     | IX        | GRANTED     | NULL      |
| 213930:205:4:5 |       138 |       13 | t1          | PRIMARY    | RECORD    | S         | WAITING     | 11        |
| 213929:1262    |        76 |       68 | t1          | NULL       | TABLE     | IX        | GRANTED     | NULL      |
| 213929:205:4:5 |       138 |       13 | t1          | PRIMARY    | RECORD    | X         | GRANTED     | 11        |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+

----------------------------------

it seems ""show engine innodb status\G"" and performance_schema.data_locks get the different results

For ""show engine innodb status\G""

MySQL thread id 39,session 1 granted the ""lock_mode X locks rec but not gap""

But for performance_schema.data_locksit showed the session2 granted the x lock

Here is the relation between thread_id and processlist_id

session1> select THREAD_ID,PROCESSLIST_ID from performance_schema.threads where thread_id in (76,138);
+-----------+----------------+
| THREAD_ID | PROCESSLIST_ID |
+-----------+----------------+
|        76 |             39 |
|       138 |            101 |
+-----------+----------------+
2 rows in set (0.00 sec)",Fixed,8.0.11,doc,https://dev.mysql.com/doc/refman/8.0/en/data-locks-table.html,2018/7/20,S2 (Serious),"show create table slowtech.t1\G
CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `c1` int(11) DEFAULT NULL,
  `c2` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `c1` (`c1`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
select * from slowtech.t1;
+----+------+------+
| id | c1   | c2   |
+----+------+------+
|  1 |   11 |   12 |
|  5 |   21 |   22 |
| 10 |   31 |   32 |
+----+------+------+

set global innodb_table_locks=1;
session1> begin;
select connection_id();
+-----------------+
| connection_id() |
+-----------------+
|              39 |
+-----------------+
insert into slowtech.t1 values(11,41,42);

[root@slowtech ~]# mysql -e ""show engine innodb status\G"" | awk `/TRANSACTIONS/,/FILE/` && mysql -e ""select engine_lock_id,thread_id,event_id,object_name,inde
x_name,lock_type,lock_mode,lock_status,lock_data from performance_schema.data_locks;""TRANSACTIONS
------------
Trx id counter 213929
Purge done for trx`s n:o < 213929 undo n:o < 0 state: running but idle
History list length 44
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421812853169808, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421812853168888, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 213924, ACTIVE 161 sec
1 lock struct(s), heap size 1136, 0 row lock(s), undo log entries 1
MySQL thread id 39, OS thread handle 140337863264000, query id 529 localhost root
TABLE LOCK table `slowtech`.`t1` trx id 213924 lock mode IX
--------
FILE I/O
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| engine_lock_id | thread_id | event_id | object_name | index_name | lock_type | lock_mode | lock_status | lock_data |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| 213924:1262    |        76 |       52 | t1          | NULL       | TABLE     | IX        | GRANTED     | NULL      |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+

-----------------------------------------------

it seems the insert get a implicit lock.

then i tried to insert another record

session2> select connection_id();
+-----------------+
| connection_id() |
+-----------------+
|             101 |
+-----------------+
1 row in set (0.00 sec)

session2> insert into slowtech.t1 values(11,41,42);
it blocked ...

check related info again

------------------------------------------
[root@slowtech ~]# mysql -e ""show engine innodb status\G"" | awk `/TRANSACTIONS/,/FILE/` && mysql -e ""select engine_lock_id,thread_id,event_id,object_name,inde
x_name,lock_type,lock_mode,lock_status,lock_data from performance_schema.data_locks;""TRANSACTIONS
------------
Trx id counter 213931
Purge done for trx`s n:o < 213929 undo n:o < 0 state: running but idle
History list length 44
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421812853169808, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 213930, ACTIVE 7 sec inserting
mysql tables in use 1, locked 1
LOCK WAIT 2 lock struct(s), heap size 1136, 1 row lock(s)
MySQL thread id 101, OS thread handle 140337721857792, query id 550 localhost root update
insert into slowtech.t1 values(11,41,42)
------- TRX HAS BEEN WAITING 7 SEC FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 205 page no 4 n bits 72 index PRIMARY of table `slowtech`.`t1` trx id 213930 lock mode S waiting
Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000b; asc     ;;
 1: len 6; hex 0000000343a9; asc     C ;;
 2: len 7; hex 820000014e0110; asc     N  ;;
 3: len 4; hex 80000029; asc    );;
 4: len 4; hex 8000002a; asc    *;;

------------------
TABLE LOCK table `slowtech`.`t1` trx id 213930 lock mode IX
RECORD LOCKS space id 205 page no 4 n bits 72 index PRIMARY of table `slowtech`.`t1` trx id 213930 lock mode S waiting
Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000b; asc     ;;
 1: len 6; hex 0000000343a9; asc     C ;;
 2: len 7; hex 820000014e0110; asc     N  ;;
 3: len 4; hex 80000029; asc    );;
 4: len 4; hex 8000002a; asc    *;;

---TRANSACTION 213929, ACTIVE 99 sec
2 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 1
MySQL thread id 39, OS thread handle 140337863264000, query id 547 localhost root
TABLE LOCK table `slowtech`.`t1` trx id 213929 lock mode IX
RECORD LOCKS space id 205 page no 4 n bits 72 index PRIMARY of table `slowtech`.`t1` trx id 213929 lock_mode X locks rec but not gap
Record lock, heap no 5 PHYSICAL RECORD: n_fields 5; compact format; info bits 0
 0: len 4; hex 8000000b; asc     ;;
 1: len 6; hex 0000000343a9; asc     C ;;
 2: len 7; hex 820000014e0110; asc     N  ;;
 3: len 4; hex 80000029; asc    );;
 4: len 4; hex 8000002a; asc    *;;

--------
FILE I/O
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| engine_lock_id | thread_id | event_id | object_name | index_name | lock_type | lock_mode | lock_status | lock_data |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+
| 213930:1262    |       138 |       13 | t1          | NULL       | TABLE     | IX        | GRANTED     | NULL      |
| 213930:205:4:5 |       138 |       13 | t1          | PRIMARY    | RECORD    | S         | WAITING     | 11        |
| 213929:1262    |        76 |       68 | t1          | NULL       | TABLE     | IX        | GRANTED     | NULL      |
| 213929:205:4:5 |       138 |       13 | t1          | PRIMARY    | RECORD    | X         | GRANTED     | 11        |
+----------------+-----------+----------+-------------+------------+-----------+-----------+-------------+-----------+

----------------------------------

it seems ""show engine innodb status\G"" and performance_schema.data_locks get the different results

For ""show engine innodb status\G""

MySQL thread id 39,session 1 granted the ""lock_mode X locks rec but not gap""

But for performance_schema.data_locksit showed the session2 granted the x lock

Here is the relation between thread_id and processlist_id

session1> select THREAD_ID,PROCESSLIST_ID from performance_schema.threads where thread_id in (76,138);
+-----------+----------------+
| THREAD_ID | PROCESSLIST_ID |
+-----------+----------------+
|        76 |             39 |
|       138 |            101 |
+-----------+----------------+
2 rows in set (0.00 sec)
",unspecified,Pessimistic,1,3,-,-,-,-,3,explicit,3,auto,2,auto,2,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,"ENGINE=InnoDB
set global innodb_table_locks=1;",-,-,Yes,-,Yes,Yes,-,-,Yes,"NOT NULL
DEFAULT NULL",-,Yes,Incorrect DBMS state,Consistency: DBMS state,S2 (Serious),Yes,Document fix,-,-,-,-,-,-,116,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_91743
MySQL,91646,https://bugs.mysql.com/bug.php?id=91646,xa command still operation when super_read_only is true,"xa trx case:
session 1:
mysql>create database xatest;
Query OK, 1 row affected (0.01 sec)

mysql>use xatest;
Database changed
mysql>create table xatable (a int primary key);
Query OK, 0 rows affected (0.00 sec)

mysql>xa start `1`;
Query OK, 0 rows affected (0.00 sec)

mysql>insert into xatable values (1);
Query OK, 1 row affected (0.01 sec)

mysql>xa end `1`;
Query OK, 0 rows affected (0.00 sec)

session 2:
mysql>set global super_read_only=on;
Query OK, 0 rows affected (0.00 sec)

session 1:
mysql>xa prepare `1`;
Query OK, 0 rows affected (0.00 sec)

mysql>xa commit `1`;
Query OK, 0 rows affected (0.01 sec)

normal trx case:
session 1:
mysql>set global super_read_only=off;
Query OK, 0 rows affected (0.00 sec)

mysql>begin;
Query OK, 0 rows affected (0.00 sec)

mysql>insert into xatable values (11);
Query OK, 1 row affected (0.00 sec)

session 2:
mysql>set global super_read_only=on;
Query OK, 0 rows affected (0.00 sec)

session 1:
mysql>commit;
ERROR 1290 (HY000): The MySQL server is running with the --super-read-only option so it cannot execute this statement

session 2:
mysql>set global super_read_only=off;
Query OK, 0 rows affected (0.00 sec)

session 1:
mysql>commit;
Query OK, 0 rows affected (0.00 sec)",Verified,"5.7.22, 8.0.11",-,-,2018/7/16,S2 (Serious),"Session1:
xa start `1`;
insert into xatable values (1);
xa end `1`;

Session2:
set global super_read_only=on;

Session1:
xa prepare `1`;
xa commit `1`;

Session3:
set global super_read_only=off;
begin;
insert into xatable values (11);

Session4:
set global super_read_only=on;

Session3:
commit; ---ERROR 1290 (HY000): The MySQL server is running with the --super-read-only option so it cannot execute this statement

Session4:
set global super_read_only=off;

Session3:
commit;",unspecified,Pessimistic,1,0,-,-,-,-,4,XA,5,auto,1,explicit,4,auto,2,-,-,Yes,Yes,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,set global super_read_only=off;,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Missing error,Read-only constraint,S2 (Serious),"No, unknown",-,-,-,-,-,-,-,-,1630,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_91646
MySQL,90980,https://bugs.mysql.com/bug.php?id=90980,Duplicate error on Slave when drop temporary tables,"# Session 1 
master [localhost] {msandbox} ((none)) > use test ;
Database changed
master [localhost] {msandbox} (test) > CREATE TABLE t1 (a INT, primary key (a)) ENGINE=INNODB;
Query OK, 0 rows affected (0.00 sec)

master [localhost] {msandbox} (test) > CREATE TEMPORARY TABLE t2 (a INT auto_increment, b int, primary key (a)) ENGINE=INNODB;
Query OK, 0 rows affected (0.00 sec)

master [localhost] {msandbox} (test) > CREATE TABLE t3           (a INT AUTO_INCREMENT, b INT, primary key (a)) ENGINE=INNODB;
Query OK, 0 rows affected (0.00 sec)

master [localhost] {msandbox} (test) > insert into t3 (b) values (1);
Query OK, 1 row affected (0.00 sec)

master [localhost] {msandbox} (test) > insert into t3 (b) select b from t3 ;
Query OK, 1 row affected (0.00 sec)
Records: 1  Duplicates: 0  Warnings: 0

...

master [localhost] {msandbox} (test) > insert into t3 (b) select b from t3 ;
Query OK, 2097152 rows affected (20.09 sec)
Records: 2097152  Duplicates: 0  Warnings: 0

master [localhost] {msandbox} (test) > BEGIN;
Query OK, 0 rows affected (0.00 sec)

master [localhost] {msandbox} (test) > INSERT INTO t1 SELECT A from t3;

Query OK, 4194304 rows affected (37.65 sec)
Records: 4194304  Duplicates: 0  Warnings: 0

master [localhost] {msandbox} (test) > DROP TEMPORARY TABLE t2;
Query OK, 0 rows affected (0.00 sec)

master [localhost] {msandbox} (test) > ROLLBACK;
Query OK, 0 rows affected, 1 warning (38.48 sec)

# Session 2 - While the rollback statement is running following command is executed
master [localhost] {msandbox} (test) > insert into t1 values (4587467);
Query OK, 1 row affected (0.00 sec)

# Slave Errors:

Last_SQL_Error: Could not execute Write_rows event on table test.t1; Duplicate entry `4587467` for key `PRIMARY`, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event`s master log mysql-bin.000001, end_log_pos 58982461",Closed,"5.6, 5.7, 5.7.22",5.7 and 5.6 docs,-,2018/5/23,S3 (Non-critical),"Session1:
use test ;
CREATE TABLE t1 (a INT, primary key (a)) ENGINE=INNODB;
CREATE TEMPORARY TABLE t2 (a INT auto_increment, b int, primary key (a)) ENGINE=INNODB;
 CREATE TABLE t3 (a INT AUTO_INCREMENT, b INT, primary key (a)) ENGINE=INNODB;
insert into t3 (b) values (1);
insert into t3 (b) select b from t3; --- Repeatbly insert 2097152 rows
BEGIN;
INSERT INTO t1 SELECT A from t3;
DROP TEMPORARY TABLE t2;
ROLLBACK;

Session2:
insert into t1 values (4587467);

Slave > show slave status\G
errors:Last_SQL_Error: Could not execute Write_rows event on table test.t1; Duplicate entry `4587467` for key `PRIMARY`, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event`s master log mysql-bin.000001, end_log_pos 58982461
",unspecified,Pessimistic,3,0,0,4194304,-,-,3,explicit,4,auto,1,auto,1,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,Yes,Yes,-,Yes,-,-,AUTO_INCREMENT,-,Yes,Operation error,Consistency: DBMS state,S3 (Non-critical),Yes,Document fix,-,-,-,-,-,-,57,-,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_90980
MySQL,89272,https://bugs.mysql.com/bug.php?id=89272,Binlog and Engine become inconsistent when binlog cache file gets out of space,"1. Run MySQL instance with at least the following settings.

default_storage_engine = InnoDB
tmpdir = /tmp
# datadir and log_bin should be in different partitions from tmpdir
datadir = /data/mysql/3306/
log_bin = /binlogs/binary-logs-3306
gtid_mode = ON
enforce_gtid_consistency = ON
binlog_cache_size = 256K

2. Prepare a script that inserts many rows in a single transaction. Here is an example, to insert 10k rows in one transaction.

#!/usr/bin/perl

print ""begin;\n"";
for(my $i=1; $i<=10000; $i++) {
  print ""insert into t1 values ($i, $i, $i);\n"";
}
print ""commit;\n"";

3. Fill up tmpdir partition (e.g. dd command)

4. Run the following queries
create table t1 (id int primary key, value int, value2 int) engine=innodb;
begin;
source /data/insert.sql

# the source command will fail because of out of space. Then force commit like below.

commit;

5. Check binlog and engines.
select count(*) from t1;
-> many rows, like 9996 rows are there.

show master status;
-> nothing in the transaction is persisted -> mismatch",Fixed,5.6.39,"5.6.41, 5.7.23, and 8.0.12",-,2018/1/16,S2 (Serious),"default_storage_engine = InnoDB
tmpdir = /tmp
datadir = /data/mysql/3306/
log_bin = /binlogs/binary-logs-3306
gtid_mode = ON
enforce_gtid_consistency = ON
binlog_cache_size = 256K

Fill up tmpdir partition.

create table t1 (id int primary key, value int, value2 int) engine=innodb;
begin;
for(my $i=1; $i<=10000; $i++) {
  print ""insert into t1 values ($i, $i, $i);\n""; --- fail due to out of space
}
commit;

select count(*) from t1; -> many rows, like 9996 rows are there.
show master status; -> nothing in the transaction is persisted -> mismatch",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,10002,auto,2,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,"ENGINE=InnoDB
datadir and log_bin should be in different partitions from tmpdir
GTID is enabled",-,Fill up tmpdir partition (e.g. dd command),-,Yes,Yes,-,-,-,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,S2 (Serious),Yes,Code fix,-,-,-,-,-,-,111,-,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MySQL_89272
MySQL,100293,https://bugs.mysql.com/bug.php?id=100293,The SERIALIZABLE transactions are not blocked for query cache,"```
CREATE TABLE t(c1 INT);

INSERT INTO t VALUES(1),(2);

BEGIN;
SELECT * FROM t;
COMMIT;

flush status;
SHOW STATUS LIKE ""QCACHE_HITS"";
SET TRANSACTION_ISOLATION=`SERIALIZABLE`;
BEGIN;
SELECT * FROM t;
SHOW STATUS LIKE ""QCACHE_HITS"";

connect (con1, localhost, root);
connection con1;
INSERT INTO t VALUES(3);
connection default;
COMMIT;

disconnect con1;
DROP TABLE t;
```

query_cache_bug.result

```
CREATE TABLE t(c1 INT);
INSERT INTO t VALUES(1),(2);
BEGIN;
SELECT * FROM t;
c1
1
2
COMMIT;
flush status;
SHOW STATUS LIKE ""QCACHE_HITS"";
Variable_name Value
Qcache_hits 0
SET TRANSACTION_ISOLATION=`SERIALIZABLE`;
BEGIN;
SELECT * FROM t;
c1
1
2
SHOW STATUS LIKE ""QCACHE_HITS"";
Variable_name Value
Qcache_hits 1
INSERT INTO t VALUES(3);
COMMIT;
DROP TABLE t;
```",Verified,"5.7, 5.7.31, 5.7.30, 5.6.48",-,-,2020/7/22,S3 (Non-critical),"query_cache_type=1
CREATE TABLE t(c1 INT);
INSERT INTO t VALUES(1),(2);
BEGIN;
SELECT * FROM t; --- c1 1 2
COMMIT;
flush status;
SHOW STATUS LIKE ""QCACHE_HITS"";
Variable_name Value
Qcache_hits 0
SET TRANSACTION_ISOLATION=`SERIALIZABLE`;
BEGIN;
SELECT * FROM t; --- c1 1 2
SHOW STATUS LIKE ""QCACHE_HITS""; 

--- Variable_name Value Qcache_hits 1
connect (con1, localhost, root);
connection con1
INSERT INTO t VALUES(3); --- not blocked
connection default;
COMMIT;
disconnect con1;
DROP TABLE t;",SERIALIZABLE,Pessimistic,1,2,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,query_cache_type=1,-,FLUSH STATUS,-,-,-,-,-,-,-,-,-,Yes,Missing blocking,Insufficient isolation: missing blocking,S3 (Non-critical),"No, unknown",-,-,-,-,-,-,-,-,893,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_100293
MySQL,93806,https://bugs.mysql.com/bug.php?id=93806,"Document error about ""ON DUPLICATE KEY UPDATE ""","INSERT ... ON DUPLICATE KEY UPDATE differs from a simple INSERT in that an exclusive lock rather than a shared lock is placed on the row to be updated when a duplicate-key error occurs. An exclusive index-record lock is taken for a duplicate primary key value. An exclusive next-key lock is taken for a duplicate unique key value.

*An exclusive index-record lock is taken for a duplicate primary key value* seems to be an error.

My test:

--session A
create table t(id int primary key, a int)engine=innodb;
insert into t values(1,1),(5,5);

set transaction_isolation=`repeatable-read`;
begin;
insert into t values(5,5) ON DUPLICATE KEY UPDATE a=a+1;

--session B
set transaction_isolation=`repeatable-read`;
insert into t values(4,4);
(blocked here, shows the next-key lock (1,5] is hold by session A.  Not only   index-record lock)",Fixed,all,"5.7.26, 8.0.16",https://dev.mysql.com/doc/relnotes/mysql/8.0/en/news-8-0-16.html,2019/1/3,S3 (Non-critical),"Session 1:
create table t(id int primary key, a int)engine=innodb;
insert into t values(1,1),(5,5);
set transaction_isolation=`repeatable-read`;
begin;
insert into t values(5,5) ON DUPLICATE KEY UPDATE a=a+1;

Session 2:
set transaction_isolation=`repeatable-read`;
insert into t values(4,4); --- Blocked. shows the next-key lock (1,5] is hold by session A.  Not only index-record lock",REPEATABLE READ,Pessimistic,1,2,-,-,-,-,2,explicit,2,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,S3 (Non-critical),Yes,Code fix,-,-,-,-,-,-,603,-,"No, history does not reflect the problem",Yes,"No, unsupported statements",,,MySQL_93806
MySQL,102722,https://bugs.mysql.com/bug.php?id=102722,Unmatched second indexes are locked when index_condition_pushdown=ON,"mysql> show variables like `%isolation%`;
+-----------------------+----------------+
| Variable_name         | Value          |
+-----------------------+----------------+
| transaction_isolation | READ-COMMITTED |
+-----------------------+----------------+
1 row in set (0.01 sec)

1. create table ts(a int primary key, b int, c int, d int, index(b,c));
2. insert into ts values(1,1,1,1),(2,2,2,2),(3,3,3,3),(4,4,4,4),(5,5,5,5),(6,6,6,6),(7,7,7,7),(8,8,8,8),(9,9,9,9);

3. set index_condition_pushdown=OFF;
4. begin;
5. mysql>  select b,c,d from ts where b>=5 and b<8 and c=7 for update;
+------+------+------+
| b    | c    | d    |
+------+------+------+
|    7 |    7 |    7 |
+------+------+------+
1 row in set (0.00 sec)
6. mysql> select ENGINE,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS,LOCK_DATA from performance_schema.data_locks;
+--------+------------+-----------+---------------+-------------+-----------+
| ENGINE | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------+-----------+---------------+-------------+-----------+
| INNODB | NULL       | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 7, 7, 7   |
| INNODB | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 7         |
+--------+------------+-----------+---------------+-------------+-----------+
3 rows in set (0.00 sec)
7. commit;

8. set index_condition_pushdown=ON;
9. mysql> explain select b,c,d from ts where b>=5 and b<8 and c=7 for update;
+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | ts    | NULL       | range | b             | b    | 10      | NULL |    2 |    11.11 | Using index condition |
+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
1 row in set, 1 warning (0.00 sec)

10. begin;
11. mysql> select b,c,d from ts where b>=5 and b<8 and c=7 for update;
+------+------+------+
| b    | c    | d    |
+------+------+------+
|    7 |    7 |    7 |
+------+------+------+
1 row in set (0.00 sec)
12. mysql> select ENGINE,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS,LOCK_DATA from performance_schema.data_locks;
+--------+------------+-----------+---------------+-------------+-----------+
| ENGINE | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------+-----------+---------------+-------------+-----------+
| INNODB | NULL       | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 6, 6, 6   |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 7, 7, 7   |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 8, 8, 8   |
| INNODB | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 7         |
+--------+------------+-----------+---------------+-------------+-----------+
5 rows in set (0.00 sec)

Unmatched index records (6,6,6),(8,8,8) are still locked.",Fixed,8,8.0.28 docs,-,2021/2/24,S3 (Non-critical),"create table ts(a int primary key, b int, c int, d int, index(b,c));
insert into ts values(1,1,1,1),(2,2,2,2),(3,3,3,3),(4,4,4,4),(5,5,5,5),(6,6,6,6),(7,7,7,7),(8,8,8,8),(9,9,9,9);

set index_condition_pushdown=ON;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

mysql> explain select b,c,d from ts where b>=5 and b<8 and c=7 for update;
+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                 |
+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
|  1 | SIMPLE      | ts    | NULL       | range | b             | b    | 10      | NULL |    2 |    11.11 | Using index condition |
+----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+
1 row in set, 1 warning (0.00 sec)

begin;
mysql> select b,c,d from ts where b>=5 and b<8 and c=7 for update;
+------+------+------+
| b    | c    | d    |
+------+------+------+
|    7 |    7 |    7 |
+------+------+------+
1 row in set (0.00 sec)
mysql> select ENGINE,INDEX_NAME,LOCK_TYPE,LOCK_MODE,LOCK_STATUS,LOCK_DATA from performance_schema.data_locks;
+--------+------------+-----------+---------------+-------------+-----------+
| ENGINE | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |
+--------+------------+-----------+---------------+-------------+-----------+
| INNODB | NULL       | TABLE     | IX            | GRANTED     | NULL      |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 6, 6, 6   |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 7, 7, 7   |
| INNODB | b          | RECORD    | X,REC_NOT_GAP | GRANTED     | 8, 8, 8   |
| INNODB | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 7         |
+--------+------------+-----------+---------------+-------------+-----------+
5 rows in set (0.00 sec)
Unmatched index records (6,6,6),(8,8,8) are still locked.

commit;",READ COMMITTED,Pessimistic,1,9,-,-,-,-,2,explicit,4,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,set index_condition_pushdown=ON;,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,S3 (Non-critical),Yes,Document fix,-,-,-,-,-,-,503,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MySQL_102722
MySQL,90987,https://bugs.mysql.com/bug.php?id=90987,partition table index next same scan ineffective,"mysql> create table t4 (a int unsigned auto_increment primary key, b int, c int, key(b)) PARTITION BY LIST (murmurHashCodeAndMod(`a`,4))(PARTITION p0 VALUES IN (0), PARTITION p1 VALUES IN (1),PARTITION p2 VALUES IN (2) ,PARTITION p3 VALUES IN (3)  );
Query OK, 0 rows affected (0.21 sec)

mysql> insert into t4 (b,c) values(11,111),(12,112),(13,113),(14,114);
Query OK, 4 rows affected (0.02 sec)
Records: 4  Duplicates: 0  Warnings: 0

mysql> insert into t4 (b,c) values(15,115),(16,116),(17,117),(18,118);
Query OK, 4 rows affected (0.01 sec)
Records: 4  Duplicates: 0  Warnings: 0

mysql> select*from t4 partition(p0);
+---+------+------+
| a | b    | c    |
+---+------+------+
| 2 |   12 |  112 |
| 4 |   14 |  114 |
| 7 |   17 |  117 |
+---+------+------+
3 rows in set (0.00 sec)

mysql> select @@tx_isolation;
+----------------+
| @@tx_isolation |
+----------------+
| READ-COMMITTED |
+----------------+
1 row in set (0.00 sec)

mysql> begin; update t4 partition(p0) set c=c+1 where b=14;
Query OK, 0 rows affected (0.00 sec)

Query OK, 1 row affected (0.02 sec)
Rows matched: 1  Changed: 1  Warnings: 0

Then, open another session and execute these stmts:

mysql> select @@tx_isolation;
+----------------+
| @@tx_isolation |
+----------------+
| READ-COMMITTED |
+----------------+
1 row in set (0.00 sec)

mysql> begin;update t4 partition(p0) set c=c+1 where b=12;
Query OK, 0 rows affected (0.00 sec)

ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
mysql> ",Verified,5.7.17,-,-,2018/5/23,S5 (Performance),"1. in session 1, do these ops:
mysql> create table t4 (a int unsigned auto_increment , b int, c int, key(b), primary key(a,b)) PARTITION BY LIST (b)(partition p0 values in (0,1, 2 ,3, 4), partition p1 values in(5,6,7,8,9,10));
Query OK, 0 rows affected (0.02 sec)

mysql> insert into t4(b,c) values(1,11),(2,22),(3,33),(4,44),(5,55),(6,66),(7,77),(8,88),(9,99);
Query OK, 9 rows affected (0.01 sec)
Records: 9  Duplicates: 0  Warnings: 0

mysql> begin;update t4 set c=c+1 where b=3;                                                     
Query OK, 0 rows affected (0.00 sec)

Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> 

2. in session 2, do these ops:
mysql> begin; update t4 set c=c+1 where b=2;
Query OK, 0 rows affected (0.00 sec)

ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
mysql> 

session 2`s stmt is blocked and later the lock wait timeouts.
This should not happen because under RC isolevel, both T1 and T2 should only hold record lock on R1 and R2 respectively, and T1 should not block T2. Although the query result is correct, performance is not optimal --- more deadlocks can be caused by this issue and parallelism is degraded, so it is a performance bug.",READ COMMITTED,Pessimistic,1,8,-,-,-,-,2,explicit,2,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,Yes,-,-,-,AUTO_INCREMENT,Yes,Yes,Unnecessary blocking,Excessive isolation,S5 (Performance),"No, unknown",-,-,-,-,-,-,-,-,1684,"No, not key-value data structures",Yes,"No, unsupported statements",,,MySQL_90987
MySQL,104833,https://bugs.mysql.com/bug.php?id=104833,Inconsistent behaviors of UPDATE under Read Uncommitted,"/* init */ drop table if exists t;
/* init */ create table t(a int, b int);
/* init */ insert into t values(null, 1), (2, 2), (null, null), (null, 3), (4, null);

 -- TRANSACTION 1;
begin;
update t set a = 10 where 1;
commit;

 -- TRANSACTION 2;
begin;
update t set b = 20 where a;
commit;

-- Submit Order
/* s1 */ begin;
/* s1 */ update t set a = 10 where 1;
/* s2 */ begin;
/* s2 */ update t set b = 20 where a; -- blocked
/* s1 */ commit; -- s2 unblocked
/* s2 */ commit;

select * from t;

+------+------+
| a    | b    |
+------+------+
|   10 |    1 |
|   10 |   20 |
|   10 |   20 |
|   10 |   20 |
|   10 |   20 |
+------+------+

The field b of the first row is not updated but other rows are updated.",Verified,8.0.26,-,-,2021/9/6,S2 (Serious),"/* init */ drop table if exists t;
/* init */ create table t(a int, b int);
/* init */ insert into t values(null, 1), (2, 2), (null, null), (null, 3), (4, null);

 -- TRANSACTION 1;
begin;
update t set a = 10 where 1;
commit;

 -- TRANSACTION 2;
begin;
update t set b = 20 where a;
commit;

-- Submit Order
/* s1 */ begin;
/* s1 */ update t set a = 10 where 1;
/* s2 */ begin;
/* s2 */ update t set b = 20 where a; -- blocked
/* s1 */ commit; -- s2 unblocked
/* s2 */ commit;

select * from t;

+------+------+
| a    | b    |
+------+------+
|   10 |    1 |
|   10 |   20 |
|   10 |   20 |
|   10 |   20 |
|   10 |   20 |
+------+------+

The field b of the first row is not updated but other rows are updated","READ UNCOMMITTED
READ COMMITTED",Pessimistic,1,5,-,-,-,-,3,explicit,3,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect database state,Consistency: application state, S2 (Serious),"No, hard to diagnose",-,-,-,-,-,-,-,-,482,"No, not key-value data structures",Yes,Yes,,,MySQL_104833
MariaDB,MDEV-16675,https://jira.mariadb.org/browse/MDEV-16675,Unnecessary explicit lock acquisition during UPDATE or DELETE,"In InnoDB, an INSERT will not create an explicit lock object. Instead, the inserted record is initially implicitly locked by the transaction that wrote its trx_t::id to the hidden system column DB_TRX_ID. (Other transactions would check if DB_TRX_ID is referring to a transaction that has not been committed.)

If a record was inserted in the current transaction, it would be implicitly locked by that transaction. Only if some other transaction is requesting access to the record, the implicit lock should be converted to an explicit one, so that the waits-for graph can be constructed for detecting deadlocks and lock wait timeouts.

The bug is that currently, InnoDB would convert the implicit lock to an explicit one, even if no conflict exists. Here is an example:

--source include/have_innodb.inc
CREATE TABLE t1(id INT PRIMARY KEY, a INT, b CHAR(1), UNIQUE KEY u(a,b)) ENGINE=InnoDB;
BEGIN;
INSERT INTO t1 VALUES(1,1,`a`),(2,9999,`b`),(3,10000,`c`),(4,4,`d`);
DELETE FROM t1 WHERE a = 9999 AND b=`b`;
COMMIT;
DROP TABLE t1;
In this test, there is no conflict, and the DELETE statement should not convert the implicit lock into an explicit one. But, the function lock_rec_convert_impl_to_expl_for_trx() is being invoked during the test.",Fixed,"5.5, 10.0, 10.1, 10.2, 10.3",10.3.9,-,2018/7/3,Major,"--source include/have_innodb.inc
CREATE TABLE t1(id INT PRIMARY KEY, a INT, b CHAR(1), UNIQUE KEY u(a,b)) ENGINE=InnoDB;
BEGIN;
INSERT INTO t1 VALUES(1,1,`a`),(2,9999,`b`),(3,10000,`c`),(4,4,`d`);
DELETE FROM t1 WHERE a = 9999 AND b=`b`;
COMMIT;
DROP TABLE t1;",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,Major,Yes,Code fix,1 patches: 11 changed files with 157 additions and 82 deletions,1,11,157,82,239,1,-,"No, not key-value data structures",Yes,"No, unnecessary blocking",,,MariaDB_MDEV-16675
MariaDB,MDEV-16106,https://jira.mariadb.org/browse/MDEV-16106,"Record in index was not found on rollback, trying to insert: TUPLE","--source include/have_innodb.inc
 
CREATE TEMPORARY TABLE t1 (i INT, KEY (i)) ENGINE=InnoDB;
INSERT INTO t1 VALUES (NULL),(NULL);
UPDATE t1 SET i = 0;
START TRANSACTION;
UPDATE t1 SET i = 4;
UPDATE t1 SET i = 0;
ROLLBACK;
10.2 e44ca6cc9c

2018-05-07 18:09:02 139988084655872 [Warning] InnoDB: Record in index `i` of table `mysqld.1`.`#sql3893_9_0` was not found on rollback, trying to insert: TUPLE (info_bits=0, 2 fields): {[4]    (0x00000000),[6]      (0x000000000201)} at: COMPACT RECORD(info_bits=32, 2 fields): {NULL,[6]      (0x000000000201)}
2018-05-07 18:09:02 139988084655872 [Warning] InnoDB: Record in index `i` of table `mysqld.1`.`#sql3893_9_0` was not found on rollback, trying to insert: TUPLE (info_bits=0, 2 fields): {[4]    (0x00000000),[6]      (0x000000000200)} at: COMPACT RECORD(info_bits=32, 2 fields): {NULL,[6]      (0x000000000201)}
Options
",Fixed,"10.2.15, 10.3.7","10.2.15, 10.3.7",https://jira.mariadb.org/secure/attachment/45609/mdev-16106-10.3v1.patch,2018/5/7,Major,"--source include/have_innodb.inc
 
CREATE TEMPORARY TABLE t1 (i INT, KEY (i)) ENGINE=InnoDB;
INSERT INTO t1 VALUES (NULL),(NULL);
UPDATE t1 SET i = 0;
START TRANSACTION;
UPDATE t1 SET i = 4;
UPDATE t1 SET i = 0;
ROLLBACK;",unspecified,Pessimistic,1,2,-,-,-,-,2,auto,1,explicit,4,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,-,Yes,Yes,-,-,-,-,Yes,Assertion failure,Statement correctness: unexpected error,Major,Yes,Code fix,1 patches: 3 changed files with 27 additions and 8 deletions,1,3,27,8,35,1,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-16106
MariaDB,MDEV-16024,https://jira.mariadb.org/browse/MDEV-16024,transaction_registry.begin_timestamp is wrong for explicit transactions,"Reproduce
create or replace table t1 (
    x int(11) default null,
    row_start bigint(20) unsigned generated always as row start invisible,
    row_end bigint(20) unsigned generated always as row end invisible,
    period for system_time (row_start, row_end)
) engine=innodb with system versioning;
 
begin;
set @ts1= now(6);
select sleep(1);
insert into t1 values (1);
commit;
 
select row_start from t1 into @trx_id;
select trt_begin_ts(@trx_id) <= @ts1;
Result
trt_begin_ts(@trx_id) is time of last executed statement (commit).

Expected
trt_begin_ts(@trx_id) is time of begin statement.",Fixed,10.3.6,10.3.7,-,2018/4/25,Major,"create or replace table t1 (
    x int(11) default null,
    row_start bigint(20) unsigned generated always as row start invisible,
    row_end bigint(20) unsigned generated always as row end invisible,
    period for system_time (row_start, row_end)
) engine=innodb with system versioning;
 
begin;
set @ts1= now(6);
select sleep(1);
insert into t1 values (1);
commit;
 
select row_start from t1 into @trx_id;
select trt_begin_ts(@trx_id) <= @ts1;",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,5,auto,2,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,"ENGINE=InnoDB 
WITH SYSTEM VERSIONING
some row are invisible",-,select sleep(1);,-,-,-,-,-,-,-,DEFAULT NULL,-,Yes,Incorrect DBMS state,Consistency: DBMS state,Major,Yes,Code fix,1 patches: 6 changed files with 50 additions and 3 deletions,1,6,50,3,53,17,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-16024
MariaDB,MDEV-14868,https://jira.mariadb.org/browse/MDEV-14868,MariaDB server crashes after using ROLLBACK TO when encrypt_tmp_files=ON,"On a server started with encrypt-tmp-files=ON and binlog-format=row
ROLLBACK TO sp
causes server to crash in the follow-up COMMIT

CREATE TABLE t (a TEXT) ENGINE = InnoDB;
BEGIN;
  INSERT INTO t VALUES (REPEAT(`a`, 20000));
  SAVEPOINT sp;
  INSERT INTO t VALUES (REPEAT(`a`, 20000));
  ROLLBACK TO sp;
COMMIT;
#0  0x00007ffff63011f7 in raise () from /lib64/libc.so.6
#1  0x00007ffff63028e8 in abort () from /lib64/libc.so.6
#2  0x00007ffff62fa266 in __assert_fail_base () from /lib64/libc.so.6
#3  0x00007ffff62fa312 in __assert_fail () from /lib64/libc.so.6
#4  0x0000555555dce308 in MYSQL_BIN_LOG::write_cache (this=this@entry=0x555556edc200 <mysql_bin_log>, thd=<optimized out>, cache=cache@entry=0x7fff9402ffc8) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:7051
#5  0x0000555555dcea9e in MYSQL_BIN_LOG::write_transaction_or_stmt (this=this@entry=0x555556edc200 <mysql_bin_log>, entry=entry@entry=0x7fffec271110, commit_id=commit_id@entry=0) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:8059
#6  0x0000555555dd6c60 in MYSQL_BIN_LOG::trx_group_commit_leader (this=this@entry=0x555556edc200 <mysql_bin_log>, leader=leader@entry=0x7fffec271110) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:7796
#7  0x0000555555dd7469 in MYSQL_BIN_LOG::write_transaction_to_binlog_events (this=this@entry=0x555556edc200 <mysql_bin_log>, entry=entry@entry=0x7fffec271110) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:7593
#8  0x0000555555dd79f2 in MYSQL_BIN_LOG::write_transaction_to_binlog (this=this@entry=0x555556edc200 <mysql_bin_log>, thd=thd@entry=0x7fff94000b00, cache_mngr=cache_mngr@entry=0x7fff9402fe20, end_ev=end_ev@entry=0x7fffec2712a0, all=all@entry=true, using_stmt_cache=using_stmt_cache@entry=true, using_trx_cache=using_trx_cache@entry=true) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:7267
#9  0x0000555555dd7ba2 in binlog_flush_cache (thd=thd@entry=0x7fff94000b00, cache_mngr=cache_mngr@entry=0x7fff9402fe20, end_ev=end_ev@entry=0x7fffec2712a0, all=all@entry=true, using_stmt=using_stmt@entry=true, using_trx=using_trx@entry=true) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:1785
#10 0x0000555555dd7dc8 in binlog_commit_flush_xid_caches (thd=thd@entry=0x7fff94000b00, cache_mngr=cache_mngr@entry=0x7fff9402fe20, all=all@entry=true, xid=xid@entry=9) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:1891
#11 0x0000555555dd7fde in MYSQL_BIN_LOG::log_and_order (this=<optimized out>, thd=0x7fff94000b00, xid=9, all=<optimized out>, need_prepare_ordered=<optimized out>, need_commit_ordered=<optimized out>) at /mnt/hgfs/repos/mariadb-server/sql/log.cc:9530
#12 0x0000555555cd3d59 in ha_commit_trans (thd=thd@entry=0x7fff94000b00, all=all@entry=true) at /mnt/hgfs/repos/mariadb-server/sql/handler.cc:1465
#13 0x0000555555bc4dd7 in trans_commit (thd=thd@entry=0x7fff94000b00) at /mnt/hgfs/repos/mariadb-server/sql/transaction.cc:306
#14 0x0000555555ac745b in mysql_execute_command (thd=thd@entry=0x7fff94000b00) at /mnt/hgfs/repos/mariadb-server/sql/sql_parse.cc:5756
#15 0x0000555555aca3bd in mysql_parse (thd=thd@entry=0x7fff94000b00, rawbuf=<optimized out>, length=6, parser_state=parser_state@entry=0x7fffec273510, is_com_multi=is_com_multi@entry=false, is_next_command=is_next_command@entry=false) at /mnt/hgfs/repos/mariadb-server/sql/sql_parse.cc:7966
#16 0x0000555555acc20f in dispatch_command (command=command@entry=COM_QUERY, thd=thd@entry=0x7fff94000b00, packet=packet@entry=0x7fff9400b161 ""COMMIT"", packet_length=packet_length@entry=6, is_com_multi=is_com_multi@entry=false, is_next_command=is_next_command@entry=false) at /mnt/hgfs/repos/mariadb-server/sql/sql_parse.cc:1824
#17 0x0000555555ace3d6 in do_command (thd=0x7fff94000b00) at /mnt/hgfs/repos/mariadb-server/sql/sql_parse.cc:1369
#18 0x0000555555bb7828 in do_handle_one_connection (connect=connect@entry=0x555557ec5390) at /mnt/hgfs/repos/mariadb-server/sql/sql_connect.cc:1420
#19 0x0000555555bb7955 in handle_one_connection (arg=arg@entry=0x555557ec5390) at /mnt/hgfs/repos/mariadb-server/sql/sql_connect.cc:1326
#20 0x000055555636dd8a in pfs_spawn_thread (arg=0x555557ecdb90) at /mnt/hgfs/repos/mariadb-server/storage/perfschema/pfs.cc:1863
#21 0x00007ffff7bc6e25 in start_thread () from /lib64/libpthread.so.0
#22 0x00007ffff63c434d in clone () from /lib64/libc.so.6
Steps to reproduce:

put the attached files `a000.test` and `a000-master.opt` into `encryption` MTR test suite (`mysql-test/suite/encryption/t`)
run `./mysql-test/mtr --debug-server encryption.a000`",Fixed,"10.1, 10.2","10.1.32, 10.2.13",-,2018/1/4,Critical,"On a server started with encrypt-tmp-files=ON and binlog-format=row
ROLLBACK TO sp
causes server to crash in the follow-up COMMIT

CREATE TABLE t (a TEXT) ENGINE = InnoDB;
BEGIN;
  INSERT INTO t VALUES (REPEAT(`a`, 20000));
  SAVEPOINT sp;
  INSERT INTO t VALUES (REPEAT(`a`, 20000));
  ROLLBACK TO sp;
COMMIT;",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,6,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,"encrypt-tmp-files=ON
binlog-format=row
ENGINE=InnoDB",-,set savepoint,Yes,-,-,-,-,-,-,-,-,Yes,Crash,Consistency: DBMS state,Critical,Yes,Code fix,2 patches: 5 changed files with 85 additions and 15 deletions,2,5,85,15,100,35,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-14868
MariaDB,MDEV-19535,https://jira.mariadb.org/browse/MDEV-19535,sql_mode=ORACLE: `SELECT INTO @var FOR UPDATE` does not lock the table,"I run this test:

--source include/have_innodb.inc
 
SET sql_mode=``;
CREATE TABLE t1 (a INT NOT NULL PRIMARY KEY) engine=innodb;
INSERT INTO t1 VALUES (1);
START TRANSACTION;
SELECT a AS a_con1 FROM t1 INTO @a FOR UPDATE;
 
--connect(con2,localhost,root,,)
SET sql_mode=``;
START TRANSACTION;
--send SELECT a AS a_con2 FROM t1 INTO @a FOR UPDATE;
 
--connection default
UPDATE t1 SET a=a+100;
COMMIT;
 
--connection con2
--reap
SELECT a AS con2 FROM t1;
COMMIT;
 
--connection default
DROP TABLE t1;
It returns this fragment in the end of the output:

con2
101
Now I change sql_mode to `ORACLE` in the test (in two places):

--source include/have_innodb.inc
 
SET sql_mode=`ORACLE`;
CREATE TABLE t1 (a INT NOT NULL PRIMARY KEY) engine=innodb;
INSERT INTO t1 VALUES (1);
START TRANSACTION;
SELECT a AS a_con1 FROM t1 INTO @a FOR UPDATE;
 
--connect(con2,localhost,root,,)
SET sql_mode=`ORACLE`;
START TRANSACTION;
--send SELECT a AS a_con2 FROM t1 INTO @a FOR UPDATE;
 
--connection default
UPDATE t1 SET a=a+100;
COMMIT;
 
--connection con2
--reap
SELECT a AS con2 FROM t1;
COMMIT;
 
--connection default
DROP TABLE t1;
and rerun the test. The fragment changes to:

con2
1
Notice, it ignores the FOR UPDATE clause.

The problem resides in this grammar:

select:
          query_expression_body
          {
            if (Lex->push_select($1->fake_select_lex ?
                                 $1->fake_select_lex :
                                 $1->first_select()))
              MYSQL_YYABORT;
          }
          opt_procedure_or_into
          {
            Lex->pop_select();
            if ($1->set_lock_to_the_last_select($3))
              MYSQL_YYABORT;
            if (Lex->select_finalize($1))
              MYSQL_YYABORT;
          }
        | with_clause query_expression_body
          {
            if (Lex->push_select($2->fake_select_lex ?
                                 $2->fake_select_lex :
                                 $2->first_select()))
              MYSQL_YYABORT;
          }
          opt_procedure_or_into
          {
            Lex->pop_select();
            $2->set_with_clause($1);
            $1->attach_to($2->first_select());
            if ($2->set_lock_to_the_last_select($4))
              MYSQL_YYABORT;
            if (Lex->select_finalize($2))
              MYSQL_YYABORT;
          }
        ;
The sql_yacc.yy version looks correct. The same grammar in sql_yacc_ora.yy missed these lines:

            if ($1->set_lock_to_the_last_select($3))
              MYSQL_YYABORT;",Fixed,10.4,10.4.6,-,2019/5/21,Major,"test1?--source include/have_innodb.inc
 
SET sql_mode=``;
CREATE TABLE t1 (a INT NOT NULL PRIMARY KEY) engine=innodb;
INSERT INTO t1 VALUES (1);
START TRANSACTION;
SELECT a AS a_con1 FROM t1 INTO @a FOR UPDATE;
 
--connect(con2,localhost,root,,)
SET sql_mode=``;
START TRANSACTION;
--send SELECT a AS a_con2 FROM t1 INTO @a FOR UPDATE;
 
--connection default
UPDATE t1 SET a=a+100;
COMMIT;
 
--connection con2
--reap
SELECT a AS con2 FROM t1;
COMMIT;
 
--connection default
DROP TABLE t1;

It returns this fragment in the end of the output:

con2
101

test2
--source include/have_innodb.inc
 
SET sql_mode=`ORACLE`;
CREATE TABLE t1 (a INT NOT NULL PRIMARY KEY) engine=innodb;
INSERT INTO t1 VALUES (1);
START TRANSACTION;
SELECT a AS a_con1 FROM t1 INTO @a FOR UPDATE;
 
--connect(con2,localhost,root,,)
SET sql_mode=`ORACLE`;
START TRANSACTION;
--send SELECT a AS a_con2 FROM t1 INTO @a FOR UPDATE;
 
--connection default
UPDATE t1 SET a=a+100;
COMMIT;
 
--connection con2
--reap
SELECT a AS con2 FROM t1;
COMMIT;
 
--connection default
DROP TABLE t1;

and rerun the test. The fragment changes to:

con2
1

",unspecified,Pessimistic,1,1,-,-,-,-,4,explicit,4,explicit,3,explicit,4,explicit,3,-,-,-,Yes,-,-,Yes,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,"""session1:set:sql_mode=` `; 
session3:set sql_mode=`ORACLE`;""
ENGINE=InnoDB",-,-,-,-,Yes,-,-,-,-,NOT NULL,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Major,Yes,Code fix,1 patch: 6 changed files with 65 additions and 8 deletions,1,6,65,8,73,1,-,"No, not key-value data structures","No, DBMS-specific",Yes,,,MariaDB_19535
MariaDB,MDEV-24463,https://jira.mariadb.org/browse/MDEV-24463,"galera.galera_sst_mysqldump_with_key MTR failed: `INSERT failed: 1213: Deadlock found when trying to get lock
","galera.galera_sst_mysqldump_with_key failed on BB 10.4 CS: ""galera_sst_mysqldump_with_key.test at line 27:
At line 17: query `INSERT INTO t1 VALUES (`node2_committed_before`)` failed: 1213: Deadlock found when trying to get lock;"".
It seems to be a sporadic issue.

stdio.log:

10.4.18, 4addd31531f722438b8b702c9cd00c28b61efce3, kvm-deb-xenial-amd64

galera.galera_sst_mysqldump_with_key `innodb,release` [ fail ]
        Test ended at 2020-12-11 12:06:58
 
CURRENT_TEST: galera.galera_sst_mysqldump_with_key
mysqltest: In included file ""./suite/galera/include/galera_st_kill_slave.inc"": 
included from /usr/share/mysql/mysql-test/suite/galera/t/galera_sst_mysqldump_with_key.test at line 27:
At line 17: query `INSERT INTO t1 VALUES (`node2_committed_before`)` failed: 1213: Deadlock found when trying to get lock; try restarting transaction
 
The result from queries just before the failure was:
< snip >
COUNT(*) = 0
1
DROP TABLE t1;
COMMIT;
SET AUTOCOMMIT=ON;
Performing State Transfer on a server that has been killed and restarted
connection node_1;
CREATE TABLE t1 (f1 CHAR(255)) ENGINE=InnoDB;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
COMMIT;
connection node_2;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
INSERT INTO t1 VALUES (`node2_committed_before`);",Fixed,10.4.18,"10.4.18, 10.5.9",-,2020/12/21,Major,"DROP TABLE t1;
COMMIT;
SET AUTOCOMMIT=ON;
Performing State Transfer on a server that has been killed and restarted
connection node_1;
CREATE TABLE t1 (f1 CHAR(255)) ENGINE=InnoDB;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
INSERT INTO t1 VALUES (`node1_committed_before`);
COMMIT;
connection node_2;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
INSERT INTO t1 VALUES (`node2_committed_before`);",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,8,explicit,3,-,-,-,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,Yes,-,-,-,-,-,-,-,"No, need repeat",Unexpected error,Excessive isolation,Major,Yes,Code fix,1 patches: 3 changed files with 30 additions and 16 deletions,1,3,30,16,46,33,-,"No, not key-value data structures","No, DBMS-specific","No, unnecessary blocking",,,MariaDB_MDEV-24463
MariaDB,MDEV-24224,https://jira.mariadb.org/browse/MDEV-24224,Gap lock on delete in 10.5 using READ COMMITTED,"During regression testing of our application on MariaDB 10.5 we hit a gap lock that doesn`t occur in previous versions. Our transactions use isolation level READ COMMITTED so there shouldn`t be any gap locks.

Test:

DROP TABLE IF EXISTS `test`;
CREATE TABLE `test` (
	ID varchar(40) NOT NULL,
	TEST1 varchar(40) DEFAULT NULL,
	TEST2 varchar(15) NOT NULL,
	TEST3 bigint(20) DEFAULT NULL,
	KEY `IDX_TEST` (TEST1, TEST2, TEST3) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;
 
INSERT INTO test (ID, TEST1, TEST2, TEST3) VALUES (`row_a`, `A.123`, `C`, 3);
INSERT INTO test (ID, TEST1, TEST2, TEST3) VALUES (`row_a`, `B.456`, `C`, 3);
 
SET GLOBAL INNODB_STATUS_OUTPUT_LOCKS = `ON`;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN; 
DELETE FROM test WHERE TEST1 = `A.123a` and TEST2 = `C` and TEST3 = 3;
SHOW ENGINE INNODB STATUS\G
The delete statement matches 0 rows, but creates a gap lock.

Using a different delete statement doesn`t create a gap lock.

DELETE FROM test WHERE TEST1 = `G.123a` and TEST2 = `X` and TEST3 = 31;
Expected Behavior:
no gap lock on the delete statement.",Fixed,"10.5.0, 10.5.8",10.5.9,-,2020/11/16,Major,"DROP TABLE IF EXISTS `test`;
CREATE TABLE `test` (
 ID varchar(40) NOT NULL,
 TEST1 varchar(40) DEFAULT NULL,
 TEST2 varchar(15) NOT NULL,
 TEST3 bigint(20) DEFAULT NULL,
 KEY `IDX_TEST` (TEST1, TEST2, TEST3) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8 ROW_FORMAT=DYNAMIC;
 
INSERT INTO test (ID, TEST1, TEST2, TEST3) VALUES (`row_a`, `A.123`, `C`, 3);
INSERT INTO test (ID, TEST1, TEST2, TEST3) VALUES (`row_a`, `B.456`, `C`, 3);
 
SET GLOBAL INNODB_STATUS_OUTPUT_LOCKS = `ON`;
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN; 
DELETE FROM test WHERE TEST1 = `A.123a` and TEST2 = `C` and TEST3 = 3;
SHOW ENGINE INNODB STATUS\G
The delete statement matches 0 rows, but creates a gap lock.

Using a different delete statement doesn`t create a gap lock.

DELETE FROM test WHERE TEST1 = `G.123a` and TEST2 = `X` and TEST3 = 31;
Expected Behavior:
no gap lock on the delete statement.",READ COMMITTED,Pessimistic,1,2,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,"ENGINE=INNODB
SET GLOBAL INNODB_STATUS_OUTPUT_LOCKS = `ON`",-,-,Yes,-,-,Yes,-,-,Yes,"NOT NULL
DEFAULT NULL",-,Yes,Low performance,Excessive isolation,Major,Yes,Code fix,1 patches: 5 changed files with 78 additions and 27 deletions,1,5,78,27,105,2,-,"No, not key-value data structures","No, DBMS-specific","No, unnecessary blocking",,,MariaDB_MDEV-24224
MariaDB,MDEV-24083,https://jira.mariadb.org/browse/MDEV-24083,"Contrary to documentation, DDL for temp tables doesn`t work inside read-only transactions","According to the documentation for ""START TRANSACTION"":

READ ONLY mode allows the storage engine to apply optimizations that cannot be used for transactions which write data. The only exception to this rule is that read only transactions can perform DDL statements on temporary tables.

Except it doesn`t work:

SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION READ ONLY;
 
CREATE TEMPORARY TABLE t (id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,val int unsigned NOT NULL);
INSERT INTO t (val) VALUES (22),(96),(47),(5),(22);
SELECT * FROM t;
DROP TEMPORARY TABLE t;
 
COMMIT;
...Fails with ""#1792 - Cannot execute statement in a READ ONLY transaction"" on the CREATE TEMPORARY TABLE statement.",Confirmed,"10.0, 10.1, 10.3.25, 10.2, 10.3, 10.4, 10.5",-,-,2020/11/1,Major,"SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION READ ONLY;
 
CREATE TEMPORARY TABLE t (id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,val int unsigned NOT NULL);
INSERT INTO t (val) VALUES (22),(96),(47),(5),(22);
SELECT * FROM t;
DROP TEMPORARY TABLE t;
 
COMMIT;",REPEATABLE READ,Pessimistic,0,-,-,-,-,-,1,explicit,6,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,Yes,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Read-only constraint,Major,"No, unknown",-,-,-,-,-,-,-,-,791,"No, not key-value data structures",Yes,"No, unsupported statements",,,MariaDB_MDEV-24083
MariaDB,MDEV-24082,https://jira.mariadb.org/browse/MDEV-24082,Can`t update a temporay table joined with a non-temporary inside a read-only transaction,"Similarly to MDEV-18507, there seems to be a problem updating a temporary table when it`s joined to a non-temporary, even if the latter isn`t being updated.

On version 10.3.25, this fails with ""#1792 - Cannot execute statement in a READ ONLY transaction"", despite only attempting to update the temporary table:

CREATE TEMPORARY TABLE t (id int unsigned NOT NULL PRIMARY KEY,flag tinyint NOT NULL DEFAULT 0);
CREATE TABLE p (id int unsigned NOT NULL PRIMARY KEY);
INSERT INTO p VALUES (2);
INSERT INTO t (id) VALUES (1),(2),(3),(4),(5);
 
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION READ ONLY;
 
UPDATE t INNER JOIN p USING (id) SET t.flag=1;
 
COMMIT;
DROP TABLE p;
DROP TEMPORARY TABLE t;

However, if you modify the UPDATE to use a subquery instead of a join, it now works:

UPDATE t SET t.flag=1 WHERE id IN (SELECT id FROM p);

I think both should work?",Confirmed,"10.0, 10.1, 10.3.25, 10.2, 10.3, 10.4, 10.5",-,-,2020/11/1,Major,"Similarly to MDEV-18507, there seems to be a problem updating a temporary table when it`s joined to a non-temporary, even if the latter isn`t being updated.

On version 10.3.25, this fails with ""#1792 - Cannot execute statement in a READ ONLY transaction"", despite only attempting to update the temporary table:

CREATE TEMPORARY TABLE t (id int unsigned NOT NULL PRIMARY KEY,flag tinyint NOT NULL DEFAULT 0);
CREATE TABLE p (id int unsigned NOT NULL PRIMARY KEY);
INSERT INTO p VALUES (2);
INSERT INTO t (id) VALUES (1),(2),(3),(4),(5);
 
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
START TRANSACTION READ ONLY;
 
UPDATE t INNER JOIN p USING (id) SET t.flag=1;
 
COMMIT;
DROP TABLE p;
DROP TEMPORARY TABLE t;

However, if you modify the UPDATE to use a subquery instead of a join, it now works:

UPDATE t SET t.flag=1 WHERE id IN (SELECT id FROM p);",REPEATABLE READ,Pessimistic,2,1,5,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,"NOT NULL
DEFAULT 0",-,Yes,Unexpected error,Read-only constraint,Major,"No, unknown",-,-,-,-,-,-,-,-,791,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-24082
MariaDB,MDEV-23608,https://jira.mariadb.org/browse/MDEV-23608,galera_sr.GCF-597 MTR failed: query `ROLLBACK` succeeded - should have failed with errno 1213,"galera_sr.GCF-597 failed on BB 10.4 and BB 10.5: ""query `ROLLBACK` succeeded - should have failed with errno 1213"".
It seems to be a sporadic issue.

stdio.log:

10.4.15 88e70f4caea34e0d7677b1fa646151b8b87dd3ab

galera_sr.GCF-597 `innodb`               w2 [ fail ]
        Test ended at 2020-08-25 08:20:17
 
CURRENT_TEST: galera_sr.GCF-597
mysqltest: At line 27: query `ROLLBACK` succeeded - should have failed with errno 1213...
 
The result from queries just before the failure was:
< snip >
connection node_1;
connection node_1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY AUTO_INCREMENT) ENGINE=InnoDB;
SET wsrep_trx_fragment_size = 1;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
connection node_2;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
INSERT INTO t1 VALUES (1);
connection node_1;
INSERT INTO t1 VALUES (1);
INSERT INTO t1 VALUES (2);
INSERT INTO t1 VALUES (3);
INSERT INTO t1 VALUES (4);
INSERT INTO t1 VALUES (5);
connection node_2;
ROLLBACK;",Fixed,"10.4.15, 10.5.6","10.4.16, 10.5.7, 10.6.0",-,2020/8/27,Major,"connection node_1;
connection node_1;
CREATE TABLE t1 (f1 INTEGER PRIMARY KEY AUTO_INCREMENT) ENGINE=InnoDB;
SET wsrep_trx_fragment_size = 1;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
connection node_2;
SET AUTOCOMMIT=OFF;
START TRANSACTION;
INSERT INTO t1 VALUES (1);
connection node_1;
INSERT INTO t1 VALUES (1);
INSERT INTO t1 VALUES (2);
INSERT INTO t1 VALUES (3);
INSERT INTO t1 VALUES (4);
INSERT INTO t1 VALUES (5);
connection node_2;
ROLLBACK;",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,7,explicit,4,-,-,-,-,-,-,-,Yes,-,Yes,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,"ENGINE=InnoDB
SET wsrep_trx_fragment_size = 1;",-,-,Yes,Yes,Yes,-,-,-,-,AUTO_INCREMENT,-,Yes,Missing error,Statement correctness: missing error,Major,Yes,Code fix,1 patch: 2 changed files with 20 additions and 1 deletion,1,2,20,1,21,14,-,"No, not key-value data structures","No, DBMS-specific","No, depolying cluster",,,MariaDB_MDEV-23608
MariaDB,MDEV-21650,https://jira.mariadb.org/browse/MDEV-21650,Non-empty statement transaction on global rollback after TRT update error,"Note: There seems to be many things in this test which should be redundant (like, for example, attempt to create an already existing application period in ALTER, and more), but I can`t get rid of any of them.

Assertion `thd->transaction.stmt.ha_list == __null || trans == &thd->transaction.stmt` failed in ha_rollback_trans with versioned tables

--source include/have_innodb.inc
 
CREATE TABLE t1 (s DATE, e DATE, PERIOD FOR app(s,e)) ENGINE=InnoDB;
ALTER TABLE t1
    ADD row_start BIGINT UNSIGNED AS ROW START,
    ADD row_end BIGINT UNSIGNED AS ROW END,
    ADD PERIOD FOR SYSTEM_TIME(row_start,row_end),
    WITH SYSTEM VERSIONING,
    ADD PERIOD IF NOT EXISTS FOR app(x,y);
 
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
START TRANSACTION;
INSERT INTO t1 (s,e) VALUES (`2021-07-04`,`2024-08-18`);
 
--connect (con1,localhost,root,,test)
START TRANSACTION;
INSERT INTO t1 (s,e) VALUES (`2018-06-01`,`2021-09-15`);
 
--connection default
--error ER_VERS_NO_TRX_ID
SELECT * FROM t1 FOR SYSTEM_TIME AS OF NOW();
 
--connection con1
SET innodb_lock_wait_timeout= 1, lock_wait_timeout= 1;
# Can be existing or non-existing table, does not matter
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE xx;
 
# Cleanup
--disconnect con1
--connection default
DROP TABLE t1;
10.4 b615d275

mysqld: /data/src/10.4/sql/handler.cc:1836: int ha_rollback_trans(THD*, bool): Assertion `thd->transaction.stmt.ha_list == __null || trans == &thd->transaction.stmt` failed.
200204  1:57:22 [ERROR] mysqld got signal 6 ;
 
#7  0x00007fe5237bcf12 in __GI___assert_fail (assertion=0x55903473a140 ""thd->transaction.stmt.ha_list == __null || trans == &thd->transaction.stmt"", file=0x559034739ad1 ""/data/src/10.4/sql/handler.cc"", line=1836, function=0x55903473c9a0 <ha_rollback_trans(THD*, bool)::__PRETTY_FUNCTION__> ""int ha_rollback_trans(THD*, bool)"") at assert.c:101
#8  0x0000559033bf6f2b in ha_rollback_trans (thd=0x7fe4c4000af0, all=true) at /data/src/10.4/sql/handler.cc:1835
#9  0x0000559033bf689b in ha_commit_trans (thd=0x7fe4c4000af0, all=true) at /data/src/10.4/sql/handler.cc:1690
#10 0x0000559033a2f201 in trans_commit_implicit (thd=0x7fe4c4000af0) at /data/src/10.4/sql/transaction.cc:301
#11 0x0000559033894690 in mysql_execute_command (thd=0x7fe4c4000af0) at /data/src/10.4/sql/sql_parse.cc:3709
#12 0x00005590338a38e3 in mysql_parse (thd=0x7fe4c4000af0, rawbuf=0x7fe4c4011dd8 ""ALTER TABLE xx"", length=14, parser_state=0x7fe51cb1a160, is_com_multi=false, is_next_command=false) at /data/src/10.4/sql/sql_parse.cc:7901
#13 0x000055903388eab0 in dispatch_command (command=COM_QUERY, thd=0x7fe4c4000af0, packet=0x7fe4c40083a1 ""ALTER TABLE xx"", packet_length=14, is_com_multi=false, is_next_command=false) at /data/src/10.4/sql/sql_parse.cc:1842
#14 0x000055903388d13d in do_command (thd=0x7fe4c4000af0) at /data/src/10.4/sql/sql_parse.cc:1360
#15 0x0000559033a16357 in do_handle_one_connection (connect=0x55903733c050) at /data/src/10.4/sql/sql_connect.cc:1412
#16 0x0000559033a160a6 in handle_one_connection (arg=0x55903733c050) at /data/src/10.4/sql/sql_connect.cc:1316
#17 0x000055903441e9c9 in pfs_spawn_thread (arg=0x559037260020) at /data/src/10.4/storage/perfschema/pfs.cc:1869
#18 0x00007fe5257454a4 in start_thread (arg=0x7fe51cb1b700) at pthread_create.c:456
#19 0x00007fe523879d0f in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:97
Reproducible on 10.4, 10.5.
The test case is not applicable to 10.3 because of the application period (see comments in regard to 10.3).
No obvious problem on a non-debug build, but there can be hidden ones.",Fixed,"10.4, 10.5, 10.6, 10.7","10.4.23, 10.5.14, 10.6.6, 10.7.2, 10.8.1",-,2020/2/4,Major,"--source include/have_innodb.inc
 
CREATE TABLE t1 (s DATE, e DATE, PERIOD FOR app(s,e)) ENGINE=InnoDB;
ALTER TABLE t1
    ADD row_start BIGINT UNSIGNED AS ROW START,
    ADD row_end BIGINT UNSIGNED AS ROW END,
    ADD PERIOD FOR SYSTEM_TIME(row_start,row_end),
    WITH SYSTEM VERSIONING,
    ADD PERIOD IF NOT EXISTS FOR app(x,y);
 
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
START TRANSACTION;
INSERT INTO t1 (s,e) VALUES (`2021-07-04`,`2024-08-18`);
 
--connect (con1,localhost,root,,test)
START TRANSACTION;
INSERT INTO t1 (s,e) VALUES (`2018-06-01`,`2021-09-15`);
 
--connection default
--error ER_VERS_NO_TRX_ID
SELECT * FROM t1 FOR SYSTEM_TIME AS OF NOW();
 
--connection con1
SET innodb_lock_wait_timeout= 1, lock_wait_timeout= 1;
# Can be existing or non-existing table, does not matter
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE xx;
 
# Cleanup
--disconnect con1
--connection default
DROP TABLE t1;",SERIALIZABLE,Pessimistic,1,0,-,-,-,-,3,auto,1,explicit,3,explicit,4,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,Yes,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,-,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,Major,Yes,Code fix,1 patch: 5 changed files with 67 additions and 5 deletions,1,5,67,5,72,709,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-21650
MariaDB,MDEV-21516,https://jira.mariadb.org/browse/MDEV-21516,"Assertion `lock_rec_find_set_bit(lock) == ((ulint)(-1))` failed in lock_rec_free_all_from_discard_page_low on ROLLBACK of SPATIAL INDEX
","I tried (and failed) to create a test case for MDEV-21512. This test will hit an assertion failure in locking code:

--source include/have_innodb.inc
--source include/have_debug.inc
--source include/have_sequence.inc
 
SET @save_limit = @@innodb_limit_optimistic_insert_debug;
 
create table t1(a serial, b geometry not null, spatial index(b)) engine=innodb;
SET GLOBAL innodb_limit_optimistic_insert_debug = 2;
begin;
insert into t1 select seq, Point(1,1) from seq_1_to_5;
rollback;
 
check table t1;
drop table t1;
 
SET GLOBAL innodb_limit_optimistic_insert_debug = @save_limit;
Without the MDEV-21512 fix, inserting 4 records suffices. With the fix, the test would pass with 4 records and fail with 5.
The failure looks like this:

10.2 c4195305b2a8431f39a4c75cc1c66ba43685f7a0

mysqltest: At line 11: query `rollback` failed: 2013: Lost connection to MySQL server during query
?mysqld: /mariadb/10.2o/storage/innobase/lock/lock0lock.cc:2480: void lock_rec_free_all_from_discard_page_low(ulint, ulint, hash_table_t *): Assertion `lock_rec_find_set_bit(lock) == ((ulint)(-1))` failed.
?#7  0x000055b0776a0daf in lock_rec_free_all_from_discard_page_low (space=<optimized out>, page_no=<optimized out>, lock_hash=<optimized out>) at /mariadb/10.2o/storage/innobase/lock/lock0lock.cc:2480
#8  0x000055b0776a5b69 in lock_update_discard (heir_block=0x7f506217cde0, heir_heap_no=<optimized out>, block=0x7f506217d0f0) at /mariadb/10.2o/storage/innobase/lock/lock0lock.cc:3454
#9  0x000055b077834752 in btr_discard_page (cursor=<optimized out>, mtr=<optimized out>) at /mariadb/10.2o/storage/innobase/include/mach0data.ic:84
#10 0x000055b07785940d in btr_cur_pessimistic_delete (err=0x7f5061e9e394, has_reserved_extents=<optimized out>, cursor=0x7f5061e9e3f8, flags=16, rollback=<optimized out>, mtr=0x7f5061e9ea78) at /mariadb/10.2o/storage/innobase/btr/btr0cur.cc:5292
#11 0x000055b0779709b7 in rtr_node_ptr_delete (index=<optimized out>, cursor=0x7f5061e9e3f8, block=<optimized out>, mtr=0x7f5061e9ea78) at /mariadb/10.2o/storage/innobase/gis/gis0rtree.cc:1741
#12 0x000055b0778341f8 in btr_discard_page (cursor=<optimized out>, mtr=<optimized out>) at /mariadb/10.2o/storage/innobase/btr/btr0btr.cc:4181
#13 0x000055b07785940d in btr_cur_pessimistic_delete (err=0x7f5061e9e7ec, has_reserved_extents=<optimized out>, cursor=0x7f5061e9e800, flags=0, rollback=<optimized out>, mtr=0x7f5061e9ea78) at /mariadb/10.2o/storage/innobase/btr/btr0cur.cc:5292
#14 0x000055b077985ad8 in row_undo_ins_remove_sec_low (mode=196641, index=0x7f501418c2b8, entry=0x7f501407b068, thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/row/row0uins.cc:255
#15 0x000055b07798403f in row_undo_ins_remove_sec (index=<optimized out>, entry=0x7f501407b068, thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/row/row0uins.cc:293
#16 row_undo_ins_remove_sec_rec (node=<optimized out>, thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/row/row0uins.cc:449
#17 row_undo_ins (node=<optimized out>, thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/row/row0uins.cc:503
#18 0x000055b07779ffc1 in row_undo (node=<optimized out>, thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/row/row0undo.cc:298
#19 row_undo_step (thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/row/row0undo.cc:351
#20 0x000055b077713f78 in que_thr_step (thr=<optimized out>) at /mariadb/10.2o/storage/innobase/que/que0que.cc:1038
#21 que_run_threads_low (thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/que/que0que.cc:1102
#22 que_run_threads (thr=0x7f501418c850) at /mariadb/10.2o/storage/innobase/que/que0que.cc:1142
#23 0x000055b0777f9566 in trx_rollback_to_savepoint_low (trx=0x7f5062a8b140, savept=0x0) at /mariadb/10.2o/storage/innobase/trx/trx0roll.cc:107
#24 0x000055b0777f9ce3 in trx_rollback_for_mysql (trx=0x7f5062a8b140) at /mariadb/10.2o/storage/innobase/trx/trx0roll.cc:242
#25 0x000055b07764a3b5 in innobase_rollback (hton=<optimized out>, thd=0x7f5014000ce8, rollback_trx=true) at /mariadb/10.2o/storage/innobase/handler/ha_innodb.cc:4834
#26 0x000055b077479ca5 in ha_rollback_trans (thd=0x7f5014000ce8, all=true) at /mariadb/10.2o/sql/handler.cc:1707
#27 0x000055b0773a956f in trans_rollback (thd=0x7f5014000ce8) at /mariadb/10.2o/sql/transaction.cc:415
#28 0x000055b0772a21e2 in mysql_execute_command (thd=0x7f5014000ce8) at /mariadb/10.2o/sql/sql_parse.cc:5358
#29 0x000055b07729e0f4 in mysql_parse (thd=0x7f5014000ce8, rawbuf=0x7f5014011920 ""rollback"", length=<optimized out>, parser_state=0x7f5061ea1300, is_com_multi=<optimized out>, is_next_command=false) at /mariadb/10.2o/sql/sql_parse.cc:7740
Note: on MySQL 5.7, have_sequence.inc is not available, and you will have to dumb down the test case, something like this:

begin;
insert into t1 (b) values (Point(1,1)),(Point(1,1)),(Point(1,1)),(Point(1,1)),(Point(1,1));
rollback;",Confirmed,"10.2, 10.3, 10.4, 10.5, 10.6",-,-,2020/1/17,Major,"SET @save_limit = @@innodb_limit_optimistic_insert_debug;
 
create table t1(a serial, b geometry not null, spatial index(b)) engine=innodb;
SET GLOBAL innodb_limit_optimistic_insert_debug = 2;
begin;
insert into t1 select seq, Point(1,1) from seq_1_to_5;
rollback;
 
check table t1;
drop table t1;
 
SET GLOBAL innodb_limit_optimistic_insert_debug = @save_limit;",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,-,Yes,-,-,-,NOT NULL,-,Yes,Assertion failure,Statement correctness: assertion failure,Major,"No, unknown",-,-,-,-,-,-,-,-,1080,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-21516
MariaDB,MDEV-26833,https://jira.mariadb.org/browse/MDEV-26833,"Missed statement rollback in case transaction drops or create temporary table
","Consider the following test case (based on real life issue and simplified by Andrei Elkin):

CREATE TABLE `ti_pk` (
`a` int(11) NOT NULL,
`b` int(11) DEFAULT NULL,
PRIMARY KEY (`a`)
) ENGINE=InnoDB;
 
# for the MIXED binlog format version of the bug (and it exists with ROW format as well) the direct logging needs to be non-default
set @@session.binlog_direct_non_transactional_updates=1;
set @@binlog_format=mixed;
# Bug
begin;
DROP TEMPORARY TABLE IF EXISTS `tmp_0`;
CREATE TEMPORARY TABLE tmp_0 (a int primary key);
insert into tmp_0 set a=1;
INSERT into ti_pk select a,1 from tmp_0;
INSERT into ti_pk set a=3;
# --error
INSERT into ti_pk values (2,1),(3,2) /* hit the dup key by the 2nd row */;
 
commit;
show binlog events; /* a=2 ROW event is there */
You should get error upon INSERT, but the event that causes the problem is in the binary log. Now check this output on master vs slave:

select count(*) = 0 from ti_pk where a = 2;
Slave is already out of sync and on every next event it may easily break/hit error that does not happen on master.",Fixed,"10.2, 10.3, 10.4, 10.5, 10.6","10.2.41, 10.3.32, 10.4.22",-,2021/10/14,Blocker,"CREATE TABLE `ti_pk` (
`a` int(11) NOT NULL,
`b` int(11) DEFAULT NULL,
PRIMARY KEY (`a`)
) ENGINE=InnoDB;
 
# for the MIXED binlog format version of the bug (and it exists with ROW format as well) the direct logging needs to be non-default
set @@session.binlog_direct_non_transactional_updates=1;
set @@binlog_format=mixed;
# Bug
begin;
DROP TEMPORARY TABLE IF EXISTS `tmp_0`;
CREATE TEMPORARY TABLE tmp_0 (a int primary key);
insert into tmp_0 set a=1;
INSERT into ti_pk select a,1 from tmp_0;
INSERT into ti_pk set a=3;
# --error
INSERT into ti_pk values (2,1),(3,2) /* hit the dup key by the 2nd row */;
 
commit;
show binlog events; /* a=2 ROW event is there */

You should get error upon INSERT, but the event that causes the problem is in the binary log. Now check this output on master vs slave:

select count(*) = 0 from ti_pk where a = 2;
Slave is already out of sync and on every next event it may easily break/hit error that does not happen on master.",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,8,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,"ENGINE=InnoDB
set @@session.binlog_direct_non_transactional_updates=1;
set @@binlog_format=mixed",-,-,-,Yes,Yes,-,-,-,-,"NOT NULL
DEFAULT NULL",-,Yes,Operation error,Consistency: DBMS state,Blocker,Yes,Code fix,"1 patch : 9 changed files with 1,211 additions and 51 deletions",1,9,1211,51,1262,14,-,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, depolying cluster",,,MariaDB_MDEV-26833
MariaDB,MDEV-26642,https://jira.mariadb.org/browse/MDEV-26642,"Weird SELECT view when a record is modified to the same value by two transactions
","Under REPEATABLE-READ isolation level, if two transactions concurrently modify the same row to the same value, the transaction that modifies later does not see the modified content.

/* init */ create table t(a int, b int);
/* init */ insert into t values (0, 0), (1, 1), (2, 2);
 
/* s1 */ begin;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s2 */ begin;
/* s2 */ update t set a = 10 where b = 1;
/* s2 */ commit;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s1 */ update t set a = 10 where true;
/* s1 */ select * from t;  -- [(10, 0), (1, 1), (10, 2)]
/* s1 */ commit;
The result of final SELECT should be (10, 0), (10, 1), (10, 2).

I think it is so weird for session 1 to see the second row is still (1, 1) after the successful execution of an UPDATE with the ""WHERE TRUE"" predicate.

So I think it will be better for s1 to see all records it updates regardless of whether the values before and after the UPDATE are the same.",Confirmed,"5.5, 10.0, 10.1, 10.5.12",-,-,2021/9/19,Critical,"/* init */ create table t(a int, b int);
/* init */ insert into t values (0, 0), (1, 1), (2, 2);
 
/* s1 */ begin;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s2 */ begin;
/* s2 */ update t set a = 10 where b = 1;
/* s2 */ commit;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s1 */ update t set a = 10 where true;
/* s1 */ select * from t;  -- [(10, 0), (1, 1), (10, 2)]
/* s1 */ commit;",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,2,explicit,6,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Critical,"No, unknown",-,-,-,-,-,-,-,-,469,"No, not key-value data structures","No, same behavior",Yes,,,MariaDB_26642
MariaDB,MCOL-4766,https://jira.mariadb.org/browse/MCOL-4766,UPDATE/INSERT in a transaction does not revert back extent ranges on a rollback,"If an UPDATE statement is performed in a transaction (autocommit=off), the extent ranges are updated to reflect the results of the UPDATE operation. However, if the transaction is rolled-back, the extent ranges are not-reverted back, causing simple WHERE predicates to fail. Here are steps to reproduce:

MariaDB [test]> drop table if exists t1;
Query OK, 0 rows affected, 1 warning (0.045 sec)
 
MariaDB [test]> create table t1 (a int)engine=columnstore;
Query OK, 0 rows affected (0.421 sec)
 
MariaDB [test]> insert into t1 values (1), (2);
Query OK, 2 rows affected (0.179 sec)
Records: 2  Duplicates: 0  Warnings: 0
 
MariaDB [test]> select * from t1;
+------+
| a    |
+------+
|    1 |
|    2 |
+------+
2 rows in set (0.046 sec)
 
MariaDB [test]> select * from t1 where a=1;
+------+
| a    |
+------+
|    1 |
+------+
1 row in set (0.010 sec)
 
MariaDB [test]> set autocommit=off;
Query OK, 0 rows affected (0.000 sec)
 
MariaDB [test]> update t1 set a=100 where a=1;
Query OK, 1 row affected (0.124 sec)
Rows matched: 1  Changed: 1  Warnings: 0
 
MariaDB [test]> select * from t1;
+------+
| a    |
+------+
|  100 |
|    2 |
+------+
2 rows in set (0.012 sec)
 
MariaDB [test]> rollback;
Query OK, 0 rows affected (0.038 sec)
 
MariaDB [test]> select * from t1;
+------+
| a    |
+------+
|    1 |
|    2 |
+------+
2 rows in set (0.007 sec)
The below incorrectly returns an empty set. The extent ranges are also out-of-sync after the rollback, which is the cause of the WHERE predicate failing.

MariaDB [test]> select * from t1 where a=1;
Empty set (0.006 sec)
 
MariaDB [test]> select c.table_schema, c.table_name, c.column_name, e.min_value, e.max_value from information_schema.columnstore_extents e, information_schema.columnstore_columns c where c.table_schema=`test` and c.table_name=`t1` and c.column_name=`a` and c.object_id=e.object_id;
+--------------+------------+-------------+-----------+-----------+
| table_schema | table_name | column_name | min_value | max_value |
+--------------+------------+-------------+-----------+-----------+
| test         | t1         | a           |         2 |       100 |
+--------------+------------+-------------+-----------+-----------+
1 row in set (0.024 sec)
Same is true for an INSERT in a transation; the extent ranges are out-of-sync with the actual data in the table on a rollback:

MariaDB [test]> drop table if exists t1;
Query OK, 0 rows affected, 1 warning (0.298 sec)
 
MariaDB [test]> create table t1 (a int)engine=columnstore;
Query OK, 0 rows affected (13.188 sec)
 
MariaDB [test]> insert into t1 values (1), (2);
Query OK, 2 rows affected (0.180 sec)
Records: 2  Duplicates: 0  Warnings: 0
 
MariaDB [test]> select * from t1;
+------+
| a    |
+------+
|    1 |
|    2 |
+------+
2 rows in set (0.039 sec)
 
MariaDB [test]> set autocommit=off;
Query OK, 0 rows affected (0.000 sec)
 
MariaDB [test]> insert into t1 values (-1), (100);
Query OK, 2 rows affected (0.082 sec)
Records: 2  Duplicates: 0  Warnings: 0
 
MariaDB [test]> select * from t1;
+------+
| a    |
+------+
|    1 |
|    2 |
|   -1 |
|  100 |
+------+
4 rows in set (0.010 sec)
 
MariaDB [test]> rollback;
Query OK, 0 rows affected (0.030 sec)
 
MariaDB [test]> select * from t1;
+------+
| a    |
+------+
|    1 |
|    2 |
+------+
2 rows in set (0.007 sec)
 
MariaDB [test]> select c.table_schema, c.table_name, c.column_name, e.min_value, e.max_value from information_schema.columnstore_extents e, information_schema.columnstore_columns c where c.table_schema=`test` and c.table_name=`t1` and c.column_name=`a` and c.object_id=e.object_id;
+--------------+------------+-------------+-----------+-----------+
| table_schema | table_name | column_name | min_value | max_value |
+--------------+------------+-------------+-----------+-----------+
| test         | t1         | a           |        -1 |       100 |
+--------------+------------+-------------+-----------+-----------+
As can be seen above, the min/max values of the extent are incorrectly set to -1 and 100. Correct values should be 1 and 2 respectively.",Fixed,6.1.1,6.1.1,-,2021/6/18,Blocker,"testcase1?drop table if exists t1;
create table t1 (a int)engine=columnstore;
insert into t1 values (1), (2);
select * from t1;
select * from t1 where a=1;
set autocommit=off;
update t1 set a=100 where a=1;
select * from t1;
rollback;
select * from t1;
select * from t1 where a=1;
select c.table_schema, c.table_name, c.column_name, e.min_value, e.max_value from information_schema.columnstore_extents e, information_schema.columnstore_columns c where c.table_schema=`test` and c.table_name=`t1` and c.column_name=`a` and c.object_id=e.object_id;

testcase2?drop table if exists t1;
create table t1 (a int)engine=columnstore;
insert into t1 values (1), (2);
select * from t1;
set autocommit=off;
insert into t1 values (-1), (100);
select * from t1;
rollback;
select * from t1;
 select c.table_schema, c.table_name, c.column_name, e.min_value, e.max_value from information_schema.columnstore_extents e, information_schema.columnstore_columns c where c.table_schema=`test` and c.table_name=`t1` and c.column_name=`a` and c.object_id=e.object_id;",unspecified,Pessimistic,1,2,-,-,-,-,2,explicit,4,auto,3,-,-,-,-,-,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=columnstore,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,Blocker,Yes,Code fix,1 patches: 9 changed files with 56 additions and 10 deletions,1,9,56,10,66,21,-,"No, not key-value data structures","No, DBMS-specific",Yes,,,MariaDB_MCOL-4766
MariaDB,MDEV-25546,https://jira.mariadb.org/browse/MDEV-25546,LIMIT partitioning does not respect ROLLBACK,"LIMIT partition temporarily populated in transaction is not used anymore after ROLLBACK
Note: There can be a race condition/non-determinism during MTR execution of the test case, as statistics on an InnoDB table is not precise (described in not-a-bug MDEV-23640). I can`t put ANALYZE in the test case, as it terminates the transaction. For reproducing, just re-run or put sleeps if necessary. For a regression suite, something smarter would need to be done to maintain determinism.

If we have several empty (not full) LIMIT partitions, rows are put in the first one first, when it`s overflows then next, etc ?that`s the expected behavior.
Same happens when partition population happens inside a transaction.
However if the transaction is rolled back and partitions again become empty, the orderly population does not happen anymore ?partitions which were once (over)filled remain ignored, and rows are put into the next ones.

It affects both explicit and implicit (including auto-created) partitions. The test case below is for explicit ones, to be applicable to all versions which support system versioning.

--source include/have_partition.inc
--source include/have_sequence.inc
--source include/have_innodb.inc
 
create or replace table t1 (pk int primary key) with system versioning
partition by system_time limit 100 (
  partition p0 history,
  partition p1 history,
  partition pn current);
insert into t1 select seq from seq_1_to_90;
 
start transaction;
# Puts 80 rows into p0
replace into t1 select seq from seq_1_to_80;
# Puts another 70 rows into p0
replace into t1 select seq from seq_1_to_70;
# Puts 60 rows into p1
replace into t1 select seq from seq_1_to_60;
 
select partition_name, table_rows
from information_schema.partitions
where table_name = `t1`; 
rollback;
 
select partition_name, table_rows
from information_schema.partitions
where table_name = `t1`;
 
# Should put 10 rows into the empty partition p0,
# but instead they go to p1
replace into t1 select seq from seq_1_to_10;
select partition_name, table_rows
from information_schema.partitions
where table_name = `t1`;
 # Cleanup
drop table t1;
10.3 4d412e98

replace into t1 select seq from seq_1_to_80;
replace into t1 select seq from seq_1_to_70;
replace into t1 select seq from seq_1_to_60;
select partition_name, table_rows from information_schema.partitions where table_name = `t1`;
partition_name	table_rows
p0	150
p1	60
pn	90
rollback;
select partition_name, table_rows from information_schema.partitions where table_name = `t1`;
partition_name	table_rows
p0	0
p1	0
pn	90
replace into t1 select seq from seq_1_to_10;
select partition_name, table_rows from information_schema.partitions where table_name = `t1`;
partition_name	table_rows
p0	0
p1	10
pn	90",Fixed,"10.3, 10.4, 10.5, 10.6","10.3.35, 10.4.25, 10.5.16",-,2021/4/27,Critical,"create or replace table t1 (pk int primary key) with system versioning
partition by system_time limit 100 (
  partition p0 history,
  partition p1 history,
  partition pn current);
insert into t1 select seq from seq_1_to_90;
 
start transaction;
# Puts 80 rows into p0
replace into t1 select seq from seq_1_to_80;
# Puts another 70 rows into p0
replace into t1 select seq from seq_1_to_70;
# Puts 60 rows into p1
replace into t1 select seq from seq_1_to_60;
 
select partition_name, table_rows
from information_schema.partitions
where table_name = `t1`; 
rollback;
 
select partition_name, table_rows
from information_schema.partitions
where table_name = `t1`;
 
# Should put 10 rows into the empty partition p0,
# but instead they go to p1
replace into t1 select seq from seq_1_to_10;
select partition_name, table_rows
from information_schema.partitions
where table_name = `t1`;
 # Cleanup
drop table t1;




replace into t1 select seq from seq_1_to_80;
replace into t1 select seq from seq_1_to_70;
replace into t1 select seq from seq_1_to_60;
select partition_name, table_rows from information_schema.partitions where table_name = `t1`;
partition_name table_rows
p0 150
p1 60
pn 90
rollback;
select partition_name, table_rows from information_schema.partitions where table_name = `t1`;
partition_name table_rows
p0 0
p1 0
pn 90
replace into t1 select seq from seq_1_to_10;
select partition_name, table_rows from information_schema.partitions where table_name = `t1`;
partition_name table_rows
p0 0
p1 10
pn 90",unspecified,Pessimistic,1,90,-,-,-,-,2,explicit,6,auto,3,-,-,-,-,-,-,-,Yes,-,-,-,Yes,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,WITH SYSTEM VERSIONING,-,-,Yes,-,Yes,-,-,-,-,-,Yes,Yes,Incorrect DBMS state,Consistency: DBMS state,Critical,Yes,Code fix,1 patches: 3 changed files with 86 additions and 5 deletions,1,3,86,5,91,360,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-25546
MariaDB,MDEV-25457,https://jira.mariadb.org/browse/MDEV-25457,Server crashes in row_undo_mod_clust_low upon rollback of read-only transaction,"--source include/have_innodb.inc
 
CREATE TEMPORARY TABLE t (a INT) ENGINE=InnoDB;
INSERT INTO t VALUES (1);
START TRANSACTION READ ONLY;
UPDATE t SET a = NULL;
ROLLBACK;
10.2 635b5ce3

#3  <signal handler called>
#4  0x000055629fb2feb7 in row_undo_mod_clust_low (node=0x7fd6d40a8bd0, offsets=0x7fd72c243b58, offsets_heap=0x7fd72c243b50, heap=0x7fd6d40a90e0, rebuilt_old_pk=0x7fd72c243b60, sys=0x7fd72c243b83 """", thr=0x7fd6d4036878, mtr=0x7fd72c243b90, mode=2) at /data/src/10.2/storage/innobase/row/row0umod.cc:110
#5  0x000055629fb306af in row_undo_mod_clust (node=0x7fd6d40a8bd0, thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/row/row0umod.cc:298
#6  0x000055629fb32d63 in row_undo_mod (node=0x7fd6d40a8bd0, thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/row/row0umod.cc:1277
#7  0x000055629f94eed6 in row_undo (node=0x7fd6d40a8bd0, thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/row/row0undo.cc:303
#8  0x000055629f94f037 in row_undo_step (thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/row/row0undo.cc:351
#9  0x000055629f8b2c91 in que_thr_step (thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/que/que0que.cc:1039
#10 0x000055629f8b2eb1 in que_run_threads_low (thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/que/que0que.cc:1103
#11 0x000055629f8b307b in que_run_threads (thr=0x7fd6d4036878) at /data/src/10.2/storage/innobase/que/que0que.cc:1143
#12 0x000055629f9adbfd in trx_rollback_to_savepoint_low (trx=0x7fd72c5b5120, savept=0x0) at /data/src/10.2/storage/innobase/trx/trx0roll.cc:107
#13 0x000055629f9adee6 in trx_rollback_for_mysql_low (trx=0x7fd72c5b5120) at /data/src/10.2/storage/innobase/trx/trx0roll.cc:169
#14 0x000055629f9ae1f2 in trx_rollback_for_mysql (trx=0x7fd72c5b5120) at /data/src/10.2/storage/innobase/trx/trx0roll.cc:200
#15 0x000055629f7bb501 in innobase_rollback (hton=0x5562a1e8fd80, thd=0x7fd6d4000d90, rollback_trx=true) at /data/src/10.2/storage/innobase/handler/ha_innodb.cc:4832
#16 0x000055629f5b779f in ha_rollback_trans (thd=0x7fd6d4000d90, all=true) at /data/src/10.2/sql/handler.cc:1708
#17 0x000055629f49bd35 in trans_rollback (thd=0x7fd6d4000d90) at /data/src/10.2/sql/transaction.cc:415
#18 0x000055629f33770d in mysql_execute_command (thd=0x7fd6d4000d90) at /data/src/10.2/sql/sql_parse.cc:5411
#19 0x000055629f33e562 in mysql_parse (thd=0x7fd6d4000d90, rawbuf=0x7fd6d40126f8 ""ROLLBACK"", length=8, parser_state=0x7fd72c245570, is_com_multi=false, is_next_command=false) at /data/src/10.2/sql/sql_parse.cc:7796
#20 0x000055629f32c78c in dispatch_command (command=COM_QUERY, thd=0x7fd6d4000d90, packet=0x7fd6d4008b51 ""ROLLBACK"", packet_length=8, is_com_multi=false, is_next_command=false) at /data/src/10.2/sql/sql_parse.cc:1827
#21 0x000055629f32b287 in do_command (thd=0x7fd6d4000d90) at /data/src/10.2/sql/sql_parse.cc:1381
#22 0x000055629f485e36 in do_handle_one_connection (connect=0x5562a23dca80) at /data/src/10.2/sql/sql_connect.cc:1336
#23 0x000055629f485b9b in handle_one_connection (arg=0x5562a23dca80) at /data/src/10.2/sql/sql_connect.cc:1241
#24 0x000055629fcb0cec in pfs_spawn_thread (arg=0x5562a247fcd0) at /data/src/10.2/storage/perfschema/pfs.cc:1869
#25 0x00007fd731bd9609 in start_thread (arg=<optimized out>) at pthread_create.c:477
#26 0x00007fd7317b5293 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
The failure started happening in its current form after this commit:

commit a3871cd2832dec43ca4ad6592646f58a7acf6630 7fa12b1e34d3d561baed9e7f2aacb0d6a3eb7062
Author:     Eugene Kosov
AuthorDate: Wed Mar 31 16:36:36 2021 +0300
Commit:     Eugene Kosov <claprix@yandex.ru>
CommitDate: Thu Apr 15 17:53:33 2021 +0300
 
    MDEV-22255 SIGABRT: Assertion `id` failed in trx_write_trx_id on INSERT | Assertion `id > 0` failed in trx_write_trx_id | Assertion `val > 0` failed in row_upd_index_entry_sys_field | Assertion `thr_get_trx(thr)->id || index->table->no_rollback()` failed.
Before the patch, the test case would fail on UPDATE with an assertion MDEV-22257. It got fixed along with MDEV-22255 as expected, but now we have a crash upon rollback instead.

It doesn`t crash on non-debug builds on my machine, but with SIGSEGV it can be just the matter of luck (unless it happens in debug-specific code of course).

The patch hasn`t yet been merged into higher versions, so 10.3+ aren`t affected yet.",Fixed,10.2,"10.2.38, 10.3.29, 10.4.19, 10.5.10",-,2021/4/19,Critical,"CREATE TEMPORARY TABLE t (a INT) ENGINE=InnoDB;
INSERT INTO t VALUES (1);
START TRANSACTION READ ONLY;
UPDATE t SET a = NULL;
ROLLBACK;",unspecified,Pessimistic,1,1,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,-,-,Yes,-,-,-,-,Yes,Crash,Consistency: DBMS state,Critical,Yes,Code fix,1 patches: 3 changed files with 13 additions and 1 deletion,1,3,13,1,14,2,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-25457
MariaDB,MDEV-25297,https://jira.mariadb.org/browse/MDEV-25297,InnoDB: Failing assertion: trx->roll_limit <= trx->undo_no in trx_rollback_start,"Note tables are InnoDB (CLI created)

SET sql_mode=``;
SET unique_checks=0;
SET foreign_key_checks=0;
CREATE TABLE ti (b INT,c INT,e INT,id INT,KEY (b),KEY (e),PRIMARY KEY(id));
INSERT INTO ti VALUES(0,0,0,0);
ALTER TABLE ti CHANGE COLUMN c c BINARY (1);
XA START `a`;
CREATE TEMPORARY TABLE t(a INT);
INSERT INTO t VALUES(1);
SAVEPOINT a3;
CREATE OR REPLACE TEMPORARY TABLE t (a INT,b INT);
INSERT INTO t VALUES(0,0);
INSERT INTO ti VALUES(0,0,0,0);
ROLLBACK TO SAVEPOINT a3;
Leads to:

10.6.0 356c149603285086d964c8a51107be97b981c15c (Debug)

InnoDB: Failing assertion: trx->roll_limit <= trx->undo_no
10.6.0 356c149603285086d964c8a51107be97b981c15c (Debug)

Core was generated by `/test/MD270321-mariadb-10.6.0-linux-x86_64-dbg/bin/mysqld --no-defaults --core-`.
Program terminated with signal SIGABRT, Aborted.
#0  __pthread_kill (threadid=<optimized out>, signo=signo@entry=6)
    at ../sysdeps/unix/sysv/linux/pthread_kill.c:56
[Current thread is 1 (Thread 0x14d5607c4700 (LWP 3602388))]
(gdb) bt
#0  __pthread_kill (threadid=<optimized out>, signo=signo@entry=6) at ../sysdeps/unix/sysv/linux/pthread_kill.c:56
#1  0x000055969b0bd343 in my_write_core (sig=sig@entry=6) at /test/10.6_dbg/mysys/stacktrace.c:424
#2  0x000055969a85dd1d in handle_fatal_signal (sig=6) at /test/10.6_dbg/sql/signal_handler.cc:331
#3  <signal handler called>
#4  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#5  0x000014d569c29859 in __GI_abort () at abort.c:79
#6  0x000055969aea265c in ut_dbg_assertion_failed (expr=expr@entry=0x55969b4cff50 ""trx->roll_limit <= trx->undo_no"", file=file@entry=0x55969b4cfeb8 ""/test/10.6_dbg/storage/innobase/trx/trx0roll.cc"", line=line@entry=869) at /test/10.6_dbg/storage/innobase/ut/ut0dbg.cc:60
#7  0x000055969ae79acf in trx_rollback_start (roll_limit=1, trx=0x14d560a7e168) at /test/10.6_dbg/storage/innobase/trx/trx0roll.cc:869
#8  trx_rollback_step (thr=thr@entry=0x14d50c024678) at /test/10.6_dbg/storage/innobase/trx/trx0roll.cc:935
#9  0x000055969ad70653 in que_thr_step (thr=0x14d50c024678) at /test/10.6_dbg/storage/innobase/que/que0que.cc:659
#10 que_run_threads_low (thr=0x14d50c024678) at /test/10.6_dbg/storage/innobase/que/que0que.cc:709
#11 que_run_threads (thr=thr@entry=0x14d50c024678) at /test/10.6_dbg/storage/innobase/que/que0que.cc:729
#12 0x000055969ae7d34d in trx_t::rollback_low (this=this@entry=0x14d560a7e168, savept=savept@entry=0x14d50c0080a0) at /test/10.6_dbg/storage/innobase/trx/trx0roll.cc:116
#13 0x000055969ae79ca0 in trx_t::rollback (this=this@entry=0x14d560a7e168, savept=savept@entry=0x14d50c0080a0) at /test/10.6_dbg/storage/innobase/trx/trx0roll.cc:164
#14 0x000055969ae7ba4d in trx_rollback_to_savepoint_for_mysql_low (mysql_binlog_cache_pos=0x14d5607c2cd8, savep=0x14d50c008098, trx=0x14d560a7e168) at /test/10.6_dbg/storage/innobase/trx/trx0roll.cc:419
#15 trx_rollback_to_savepoint_for_mysql (trx=trx@entry=0x14d560a7e168, savepoint_name=savepoint_name@entry=0x14d5607c2d00 ""84AJ5M0EG"", mysql_binlog_cache_pos=mysql_binlog_cache_pos@entry=0x14d5607c2cd8) at /test/10.6_dbg/storage/innobase/trx/trx0roll.cc:478
#16 0x000055969ac4745e in innobase_rollback_to_savepoint (hton=<optimized out>, thd=0x14d50c000db8, savepoint=0x14d50c019c88) at /test/10.6_dbg/storage/innobase/handler/ha_innodb.cc:4387
#17 0x000055969a863fa0 in ha_rollback_to_savepoint (thd=thd@entry=0x14d50c000db8, sv=sv@entry=0x14d50c019c50) at /test/10.6_dbg/sql/handler.cc:2502
#18 0x000055969a70b78c in trans_rollback_to_savepoint (thd=thd@entry=0x14d50c000db8, name=<optimized out>) at /test/10.6_dbg/sql/transaction.cc:697
#19 0x000055969a5a2b88 in mysql_execute_command (thd=thd@entry=0x14d50c000db8) at /test/10.6_dbg/sql/sql_parse.cc:5670
#20 0x000055969a58a264 in mysql_parse (thd=thd@entry=0x14d50c000db8, rawbuf=<optimized out>, length=<optimized out>, parser_state=parser_state@entry=0x14d5607c3410) at /test/10.6_dbg/sql/sql_parse.cc:8004
#21 0x000055969a598e6a in dispatch_command (command=command@entry=COM_QUERY, thd=thd@entry=0x14d50c000db8, packet=packet@entry=0x14d50c00b359 ""ROLLBACK TO SAVEPOINT a3"", packet_length=packet_length@entry=24, blocking=blocking@entry=true) at /test/10.6_dbg/sql/sql_class.h:1331
#22 0x000055969a59c245 in do_command (thd=0x14d50c000db8, blocking=blocking@entry=true) at /test/10.6_dbg/sql/sql_parse.cc:1399
#23 0x000055969a6f5452 in do_handle_one_connection (connect=<optimized out>, connect@entry=0x55969cc4c8a8, put_in_cache=put_in_cache@entry=true) at /test/10.6_dbg/sql/sql_connect.cc:1410
#24 0x000055969a6f5a57 in handle_one_connection (arg=arg@entry=0x55969cc4c8a8) at /test/10.6_dbg/sql/sql_connect.cc:1312
#25 0x000055969ab9fea5 in pfs_spawn_thread (arg=0x55969cb70f48) at /test/10.6_dbg/storage/perfschema/pfs.cc:2201
#26 0x000014d56a137609 in start_thread (arg=<optimized out>) at pthread_create.c:477
#27 0x000014d569d26293 in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
Bug confirmed present in:
MariaDB: 10.6.0 (dbg), 10.6.0 (opt)

Bug (or feature/syntax) confirmed not present in:
MariaDB: 10.2.38 (dbg), 10.2.38 (opt), 10.3.29 (dbg), 10.3.29 (opt), 10.4.19 (dbg), 10.4.19 (opt), 10.5.10 (dbg), 10.5.10 (opt)
MySQL: 5.5.62 (dbg), 5.5.62 (opt), 5.6.51 (dbg), 5.6.51 (opt), 5.7.33 (dbg), 5.7.33 (opt), 8.0.23 (dbg), 8.0.23 (opt)",Fixed,10.6,10.6.0,-,2021/3/30,Blocker,"SET sql_mode=``;
SET unique_checks=0;
SET foreign_key_checks=0;
CREATE TABLE ti (b INT,c INT,e INT,id INT,KEY (b),KEY (e),PRIMARY KEY(id));
INSERT INTO ti VALUES(0,0,0,0);
ALTER TABLE ti CHANGE COLUMN c c BINARY (1);
XA START `a`;
CREATE TEMPORARY TABLE t(a INT);
INSERT INTO t VALUES(1);
SAVEPOINT a3;
CREATE OR REPLACE TEMPORARY TABLE t (a INT,b INT);
INSERT INTO t VALUES(0,0);
INSERT INTO ti VALUES(0,0,0,0);
ROLLBACK TO SAVEPOINT a3;",unspecified,Pessimistic,1,1,-,-,-,-,2,auto,1,XA,8,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,Yes,Yes,-,-,-,-,-,Yes,-,-,-,"SET sql_mode=``;
SET unique_checks=0;
SET foreign_key_checks=0;",-,set savepoint,-,-,Yes,Yes,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,Blocker,Yes,Code fix,1 patches: 7 changed files with 65 additions and 33 deletions,1,7,65,33,98,10,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-25297
MariaDB,MDEV-18044,https://jira.mariadb.org/browse/MDEV-18044,select (consistent read) within IF block in store procedure locks rows,"I have a problem with blocking records when using SELECT and READ COMMITTED isolation level for InnoDB. The Document https://dev.mysql.com/doc/refman/8.0/en/innodb-consistent-read.htm says that READ COMMITTED isolation level provide non-blocking read, but MariaDB 10.5.8 violates this rule.
Following select under if statement locks records:

IF EXISTS( SELECT * FROM `test_table` )  THEN
		SELECT * FROM `test_table`;
	ELSE
		SELECT `there is nothing`;
	END IF;
I made a simple test to check the deadlock. There are two attached files:

test_schema.sql - database schema
locks_test_script.sql - scripts for test deadlock
Run scripts from locks_test_script.sql under two sessions. Run the script for session 1 first and after that run script for session 2:

-- session 1 -------------
USE `test`;
SET autocommit = 0;
COMMIT;
SHOW ENGINE INNODB STATUS;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
call READ_PROCEDURE();
SHOW ENGINE INNODB STATUS;
-- end session 1 -------------
-- session 2 ------------
USE `test`;
SET autocommit = 0;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
UPDATE `test_table` SET `test_table`.`strTextExtended` = `UPDATED`;
SHOW ENGINE INNODB STATUS;
-- end session 2 ------------
There are two locks after call READ_PROCEDURE:

---TRANSACTION 284064029008304, ACTIVE 0 sec
2 lock struct(s), heap size 1128, 1 row lock(s)
MySQL thread id 5, OS thread handle 29560, query id 136 localhost ::1 root starting
SHOW ENGINE INNODB STATUS
And the script for session 2 hangs up:

MariaDB [test]> UPDATE `test_table` SET `test_table`.`strTextExtended` = `UPDATED`;
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
call ""SHOW ENGINE INNODB STATUS;"" after UPDATE `test_table` ...

------------
TRANSACTIONS
------------
Trx id counter 119
Purge done for trx`s n:o < 118 undo n:o < 0 state: running
History list length 53
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 118, ACTIVE 118 sec
1 lock struct(s), heap size 1128, 2 row lock(s)
MySQL thread id 6, OS thread handle 29560, query id 143 localhost ::1 root starting
SHOW ENGINE INNODB STATUS
---TRANSACTION 284064029008304, ACTIVE 217 sec
2 lock struct(s), heap size 1128, 1 row lock(s)
MySQL thread id 5, OS thread handle 29560, query id 136 localhost ::1 root",Confirmed,"5.5, 10.0, 10.1, 10.2, 10.3, 10.4, 10.5",-,-,2018/12/20,Major,"SET NAMES `utf8` COLLATE `utf8_unicode_ci`\p;

DROP DATABASE IF EXISTS lock_test_db;
CREATE DATABASE lock_test_db;
USE lock_test_db;


CREATE TABLE `agent` (
  `id` smallint unsigned NOT NULL AUTO_INCREMENT,
  `agent_guid` varchar(64) COLLATE utf8_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6198 DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;

INSERT INTO agent (id, agent_guid) VALUES (1, `guid 1`);
INSERT INTO agent (id, agent_guid) VALUES (2, `guid 1`);
INSERT INTO agent (id, agent_guid) VALUES (3, `guid 2`);
INSERT INTO agent (id, agent_guid) VALUES (4, `guid 55`);
INSERT INTO agent (id, agent_guid) VALUES (5, `guid 2`);

delimiter $$

CREATE PROCEDURE lock_test
(
    IN  a_agent_id      smallint unsigned
,   IN  a_id_pack       bigint unsigned
)
l_proc:
BEGIN
    IF
        a_id_pack IN
        (
            SELECT id from agent where agent_guid = (SELECT agent_guid FROM agent WHERE id = a_agent_id)
        )
    THEN
      select 1;
    ELSE
      select 0;
    END IF;

END\p$$

SESSION 1.

MariaDB [lock_test_db]> set autocommit 0;
Query OK, 0 rows affected (0.00 sec)
 
MariaDB [lock_test_db]> call lock_test(1, 1);
+---+
| 1 |
+---+
| 1 |
+---+
1 row in set (0.00 sec)
 
Query OK, 0 rows affected (0.00 sec)
SESSION 2.

MariaDB [lock_test_db]> set autocommit 0;
Query OK, 0 rows affected (0.00 sec)
 
MariaDB [lock_test_db]> select * from agent where id = 1 lock in share mode;
+----+------------+
| id | agent_guid |
+----+------------+
|  1 | guid 1     |
+----+------------+
1 row in set (0.02 sec)
 
MariaDB [lock_test_db]> update agent set agent_guid = `new guid` where id = 1 ;
^CCtrl-C -- query killed. Continuing normally.
ERROR 1317 (70100): Query execution was interrupted
MariaDB [lock_test_db]> Ctrl-C -- exit!
","READ COMMITTED
REPEATABLE READ",Pessimistic,1,5,-,-,-,-,3,explicit,2,explicit,3,auto,2,-,-,-,-,-,-,-,Yes,-,-,Yes,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,"ENGINE=InnoDB
create procedure with if block",-,-,-,-,Yes,-,-,-,Yes,"NOT NULL
DEFAULT NULL
AUTO_INCREMENT",-,Yes,Unnecessary blocking,Excessive isolation,Major,"No, unknown",-,-,-,-,-,-,-,-,1473,"No, history does not reflect the problem","No, DBMS-specific","No, unnecessary blocking",,,MariaDB_MDEV-18044
MariaDB,MDEV-24545,https://jira.mariadb.org/browse/MDEV-24545,Sequence created by one connection remains invisible to another,"--source include/have_innodb.inc
 
CREATE TABLE t1 (a INT) ENGINE=InnoDB;
 
START TRANSACTION;
SELECT * FROM t1;
 
--connect (con1,localhost,root,,test)
CREATE SEQUENCE s1 ENGINE=InnoDB;
FLUSH TABLES;
--disconnect con1
 
--connection default
--error ER_TABLE_DEF_CHANGED,ER_NO_SUCH_TABLE
SELECT NEXTVAL(s1);
COMMIT;
 
SELECT NEXTVAL(s1);
 
# Cleanup
DROP TABLE t1;
DROP SEQUENCE s1;
In the test case above, connection default throws ER_NO_SUCH_TABLE upon NEXTVAL(s1) twice. The first time is a relatively minor offence. The connection is inside a transaction (with the default transaction isolation level) when the sequence s1 is created by another connection, and is still within the same transaction when it runs NEXTVAL(s1); if it were not a sequence but a select from a normal table, it would have failed anyway, only with ER_TABLE_DEF_CHANGED instead.

But then, the transaction is committed, the sequence should become visible and readable from, but it is not, it still causes ER_NO_SUCH_TABLE. That`s a real problem.

10.3 08b0b70d

connection default;
SELECT NEXTVAL(s1);
Got one of the listed errors
COMMIT;
SELECT NEXTVAL(s1);
bug.t `innodb`                           [ fail ]
        Test ended at 2021-01-07 19:37:44
 
CURRENT_TEST: bug.t
mysqltest: At line 18: query `SELECT NEXTVAL(s1)` failed: 1146: Table `test.s1` doesn`t exist
The important part in the test case is FLUSH TABLES issued after CREATE SEQUENCE. Without it, everything works as expected ?inside the transaction NEXTVAL causes ER_TABLE_DEF_CHANGED, and outside the transaction it works.",Fixed,"10.3, 10.4, 10.5","10.3.29, 10.4.19, 10.5.10, 10.6.1",-,2021/1/7,Major,"CREATE TABLE t1 (a INT) ENGINE=InnoDB;
 
START TRANSACTION;
SELECT * FROM t1;
 
--connect (con1,localhost,root,,test)
CREATE SEQUENCE s1 ENGINE=InnoDB;
FLUSH TABLES;
--disconnect con1
 
--connection default
--error ER_TABLE_DEF_CHANGED,ER_NO_SUCH_TABLE
SELECT NEXTVAL(s1);
COMMIT;
 
SELECT NEXTVAL(s1);
 
# Cleanup
DROP TABLE t1;
DROP SEQUENCE s1;

connection default;
SELECT NEXTVAL(s1);
Got one of the listed errors
COMMIT;
SELECT NEXTVAL(s1);
bug.t `innodb`                           [ fail ]
        Test ended at 2021-01-07 19:37:44
 
CURRENT_TEST: bug.t
mysqltest: At line 18: query `SELECT NEXTVAL(s1)` failed: 1146: Table `test.s1` doesn`t exist",unspecified,Pessimistic,1,0,-,-,-,-,3,explicit,4,auto,1,auto,1,-,-,-,-,-,Yes,-,-,Yes,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,FLUSH TABLES,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Consistency: application state,Major,Yes,Code fix,1 patches: 3 changed files with 33 additions and 1 deletion,1,3,33,1,34,110,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-24545
MariaDB,MDEV-29187,https://jira.mariadb.org/browse/MDEV-29187,Deadlock output in InnoDB status always shows transaction (0),"The deadlock section in SHOW ENGINE INNODB STATUS is always showing transaction 0 as being rolled back:

*** WE ROLL BACK TRANSACTION (0)
How to reproduce:

Use MariaDB 10.8 and generate a deadlock, then check SHOW ENGINE INNODB STATUS\G in the LATEST DETECTED DEADLOCK section.

mariadb session1> create table t1 (id int primary key, f1 int);
mariadb session1> insert into t1 values (1,1), (2,2);
mariadb session1> begin;
mariadb session1> update t1 set f1 = 3 where id = 1;
 
mariadb session2> begin;
mariadb session2> update t1 set f1 = 4 where id = 2;
 
mariadb session1> update t1 set f1 = 3 where id = 2;
 
mariadb session2> update t1 set f1 = 5 where id = 1;
?deadlock will be detected here. Check with:

mariadb> show engine innodb status\G
 
------------------------
LATEST DETECTED DEADLOCK
------------------------
2022-07-28 02:21:20 0x7f1ab00f9700
*** (1) TRANSACTION:
TRANSACTION 54, ACTIVE 15 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
MariaDB thread id 12, OS thread handle 139752599688960, query id 105 localhost root Updating
update t1 set f1 = 5 where id = 1
*** WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 54 lock_mode X locks rec but not gap waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 000000000035; asc      5;;
 2: len 7; hex 16000001480110; asc     H  ;;
 3: len 4; hex 80000003; asc     ;;
 
*** CONFLICTING WITH:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 53 lock_mode X locks rec but not gap
Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 000000000035; asc      5;;
 2: len 7; hex 16000001480110; asc     H  ;;
 3: len 4; hex 80000003; asc     ;;
 
 
*** (2) TRANSACTION:
TRANSACTION 53, ACTIVE 46 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
MariaDB thread id 13, OS thread handle 139752600917760, query id 104 localhost root Updating
update t1 set f1 = 3 where id = 2
*** WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 53 lock_mode X locks rec but not gap waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000002; asc     ;;
 1: len 6; hex 000000000036; asc      6;;
 2: len 7; hex 17000001490110; asc     I  ;;
 3: len 4; hex 80000004; asc     ;;
 
*** CONFLICTING WITH:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 54 lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000002; asc     ;;
 1: len 6; hex 000000000036; asc      6;;
 2: len 7; hex 17000001490110; asc     I  ;;
 3: len 4; hex 80000004; asc     ;;
 
*** WE ROLL BACK TRANSACTION (0)
As we can see there, there is no TRANSACTION listed with ID 0 in there.
This is the same if we generate a deadlock involving three transactions:

------------------------
LATEST DETECTED DEADLOCK
------------------------
2022-07-28 01:44:51 0x7f1ab018f700
*** (1) TRANSACTION:
TRANSACTION 36, ACTIVE 185 sec starting index read
...
*** (2) TRANSACTION:
TRANSACTION 37, ACTIVE 171 sec starting index read
...
*** (3) TRANSACTION:
TRANSACTION 38, ACTIVE 160 sec starting index read
 
*** WE ROLL BACK TRANSACTION (0)
Let me know if there is anything else I should provide here.

shell> mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 15
Server version: 10.8.3-MariaDB-log MariaDB Server
 
Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.
 
Type `help;` or `\h` for help. Type `\c` to clear the current input statement.",Fixed,"10.6, 10.7, 10.8, 10.9, 10.10","10.6.9, 10.7.5, 10.8.4, 10.9.2, 10.10.1",-,2022/7/28,Major,"The deadlock section in SHOW ENGINE INNODB STATUS is always showing transaction 0 as being rolled back:
Use MariaDB 10.8 and generate a deadlock, then check SHOW ENGINE INNODB STATUS\G in the LATEST DETECTED DEADLOCK section.

mariadb session1> create table t1 (id int primary key, f1 int);
mariadb session1> insert into t1 values (1,1), (2,2);
mariadb session1> begin;
mariadb session1> update t1 set f1 = 3 where id = 1;
 
mariadb session2> begin;
mariadb session2> update t1 set f1 = 4 where id = 2;
 
mariadb session1> update t1 set f1 = 3 where id = 2;
 
mariadb session2> update t1 set f1 = 5 where id = 1;
 deadlock will be detected here. Check with:

mariadb> show engine innodb status\G
 
------------------------
LATEST DETECTED DEADLOCK
------------------------
2022-07-28 02:21:20 0x7f1ab00f9700
*** (1) TRANSACTION:
TRANSACTION 54, ACTIVE 15 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
MariaDB thread id 12, OS thread handle 139752599688960, query id 105 localhost root Updating
update t1 set f1 = 5 where id = 1
*** WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 54 lock_mode X locks rec but not gap waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 000000000035; asc      5;;
 2: len 7; hex 16000001480110; asc     H  ;;
 3: len 4; hex 80000003; asc     ;;
 
*** CONFLICTING WITH:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 53 lock_mode X locks rec but not gap
Record lock, heap no 2 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000001; asc     ;;
 1: len 6; hex 000000000035; asc      5;;
 2: len 7; hex 16000001480110; asc     H  ;;
 3: len 4; hex 80000003; asc     ;;
 
 
*** (2) TRANSACTION:
TRANSACTION 53, ACTIVE 46 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1128, 2 row lock(s), undo log entries 1
MariaDB thread id 13, OS thread handle 139752600917760, query id 104 localhost root Updating
update t1 set f1 = 3 where id = 2
*** WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 53 lock_mode X locks rec but not gap waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000002; asc     ;;
 1: len 6; hex 000000000036; asc      6;;
 2: len 7; hex 17000001490110; asc     I  ;;
 3: len 4; hex 80000004; asc     ;;
 
*** CONFLICTING WITH:
RECORD LOCKS space id 6 page no 3 n bits 8 index PRIMARY of table `test`.`t1` trx id 54 lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 4; compact format; info bits 0
 0: len 4; hex 80000002; asc     ;;
 1: len 6; hex 000000000036; asc      6;;
 2: len 7; hex 17000001490110; asc     I  ;;
 3: len 4; hex 80000004; asc     ;;
 
*** WE ROLL BACK TRANSACTION (0)
As we can see there, there is no TRANSACTION listed with ID 0 in there.
This is the same if we generate a deadlock involving three transactions:

------------------------
LATEST DETECTED DEADLOCK
------------------------
2022-07-28 01:44:51 0x7f1ab018f700
*** (1) TRANSACTION:
TRANSACTION 36, ACTIVE 185 sec starting index read
...
*** (2) TRANSACTION:
TRANSACTION 37, ACTIVE 171 sec starting index read
...
*** (3) TRANSACTION:
TRANSACTION 38, ACTIVE 160 sec starting index read
 
*** WE ROLL BACK TRANSACTION (0)",unspecified,Pessimistic,1,2,-,-,-,-,3,explicit,3,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,Major,Yes,Code fix,1 changed file with 1 additions and 0 deletion,1,1,1,0,1,1,-,"No, history does not reflect the problem","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-29187
MariaDB,MDEV-28944,https://jira.mariadb.org/browse/MDEV-28944,XA assertions failing in binlog_rollback and binlog_commit,"CREATE TABLE t (a INT) ENGINE=MyISAM;
INSERT INTO t VALUES (1);
 
--connect (con1,localhost,root,,test)
XA START `xid`;
SELECT * FROM t;
 
--connection default
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t NOWAIT ADD KEY (a);
 
--connection con1
UPDATE t SET a = 2;
XA END `xid`;
XA ROLLBACK `xid`;
 
# Cleanup
DROP TABLE t;
--disconnect con1
bb-10.10-MDEV-16329 cb1f08bd1c

mariadbd: /data/src/preview-10.10-online-alter-gcov/sql/log.cc:2383: int binlog_rollback(handlerton*, THD*, bool): Assertion `thd->lex->sql_command != SQLCOM_XA_ROLLBACK` failed.
220625  1:32:43 [ERROR] mysqld got signal 6 ;
 
#7  0x00007f9af47c0662 in __GI___assert_fail (assertion=0x56064fb841a8 ""thd->lex->sql_command != SQLCOM_XA_ROLLBACK"", file=0x56064fb82e28 ""/data/src/preview-10.10-online-alter-gcov/sql/log.cc"", line=2383, function=0x56064fb84128 ""int binlog_rollback(handlerton*, THD*, bool)"") at assert.c:101
No locals.
#8  0x000056064ea565a1 in binlog_rollback (hton=0x560652519688, thd=0x7f9ad8000db8, all=true) at /data/src/preview-10.10-online-alter-gcov/sql/log.cc:2383
        _db_stack_frame_ = {func = 0x56064fb4ef02 ""ha_rollback_trans"", file = 0x56064fb4e080 ""/data/src/preview-10.10-online-alter-gcov/sql/handler.cc"", level = 2147483655, line = -1, prev = 0x7f9af00bdb10}
        is_ending_trans = true
        rollback_online = true
        error = 0
        cache_mngr = 0x0
        __PRETTY_FUNCTION__ = ""int binlog_rollback(handlerton*, THD*, bool)""
#9  0x000056064e7e6851 in ha_rollback_trans (thd=0x7f9ad8000db8, all=true) at /data/src/preview-10.10-online-alter-gcov/sql/handler.cc:2180
        err = -2116343448
        ht = 0x560652519688
        error = 0
        trans = 0x7f9ad8004770
        ha_info = 0x7f9ad80037e8
        ha_info_next = 0x56064fa05f60
        is_real_trans = true
        _db_stack_frame_ = {func = 0x56064fa06408 ""trans_xa_rollback"", file = 0x56064fa06018 ""/data/src/preview-10.10-online-alter-gcov/sql/xa.cc"", level = 2147483654, line = -1, prev = 0x7f9af00bdba0}
        __PRETTY_FUNCTION__ = ""int ha_rollback_trans(THD*, bool)""
#10 0x000056064e656a85 in xa_trans_force_rollback (thd=0x7f9ad8000db8) at /data/src/preview-10.10-online-alter-gcov/sql/xa.cc:393
        rc = false
#11 0x000056064e659c50 in trans_xa_rollback (thd=0x7f9ad8000db8) at /data/src/preview-10.10-online-alter-gcov/sql/xa.cc:821
        xid_state = @0x7f9ad80047a8: {xid_cache_element = 0x7f9ad8021a18}
        _db_stack_frame_ = {func = 0x56064f95c038 ""mysql_execute_command"", file = 0x56064f95b2e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483653, line = 821, prev = 0x7f9af00bdf30}
        __PRETTY_FUNCTION__ = ""bool trans_xa_rollback(THD*)""
        mdl_request = {type = 13, duration = MDL_STATEMENT, next_in_list = 0x21, prev_in_list = 0x7f9af3e11c40, ticket = 0x7f9ad8008430, key = {m_length = 3, m_db_name_length = 0, m_hash_value = 65537, m_ptr = ""\000\000\000O\006V\000\000 \334\v\360\232\177\000\000\024\002\000\000\000\000\000\000!\000\000\000\000\000\000\000\370\027\215R\006V\000\000\b\000\000\000\366\005\000\000\246jwO\006V\000\000@\334\v\360\232\177\000\000\305lwO\006V\000\000@\334\v\360\232\177\000\000\ba\000\330\232\177\000\000\240\335\v\360\232\177\000\000\231\316\rN\006V\000\000\000Q\000\330\232\177\000\000\270\r\000\330\232\177\000\000\220\334\v\360\232\177\000\000`\v\000\330\232\177\000\000\220\334\v\360\232\177\000\000\334\fxO\006V\000\000h{\v\364\232\177\000\000\300\251=R\000\000\000\000#\220\226O\006V\000\000\000\000\000\000\000\000\000\000\300\334\v\360\232\177\000\000\305lwO\000\000\001\000""...}, m_src_file = 0x56064fa06018 ""/data/src/preview-10.10-online-alter-gcov/sql/xa.cc"", m_src_line = 807}
#12 0x000056064e0f1065 in mysql_execute_command (thd=0x7f9ad8000db8, is_called_from_prepared_stmt=false) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:5879
        rollback_failed = 32
        res = 0
        up_result = 0
        lex = 0x7f9ad8005100
        select_lex = 0x7f9ad80059d8
        first_table = 0x0
        all_tables = 0x0
        unit = 0x7f9ad80051d8
        have_table_map_for_update = false
        rpl_filter = 0x5606502b3250 <vtable for Internal_error_handler+16>
        _db_stack_frame_ = {func = 0x56064f95d3cf ""mysql_parse"", file = 0x56064f95b2e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483652, line = -1, prev = 0x7f9af00be380}
        __PRETTY_FUNCTION__ = ""int mysql_execute_command(THD*, bool)""
        ots = {ctx = 0x7f9ad8004d98, traceable = false}
        orig_binlog_format = BINLOG_FORMAT_MIXED
        orig_current_stmt_binlog_format = BINLOG_FORMAT_STMT
#13 0x000056064e0fdc10 in mysql_parse (thd=0x7f9ad8000db8, rawbuf=0x7f9ad8013fe0 ""XA ROLLBACK `xid`"", length=17, parser_state=0x7f9af00be500) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:8036
        found_semicolon = 0x0
        error = 32666
        lex = 0x7f9ad8005100
        err = false
        _db_stack_frame_ = {func = 0x56064f95b879 ""dispatch_command"", file = 0x56064f95b2e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483651, line = -1, prev = 0x7f9af00be4e0}
        __PRETTY_FUNCTION__ = ""void mysql_parse(THD*, char*, uint, Parser_state*)""
#14 0x000056064e0d4f11 in dispatch_command (command=COM_QUERY, thd=0x7f9ad8000db8, packet=0x7f9ad800b9e9 ""XA ROLLBACK `xid`"", packet_length=17, blocking=true) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:1894
        packet_end = 0x7f9ad8013ff1 """"
        parser_state = {m_lip = {lookahead_token = -1, lookahead_yylval = 0x0, m_thd = 0x7f9ad8000db8, m_ptr = 0x7f9ad8013ff2 ""\004"", m_tok_start = 0x7f9ad8013ff2 ""\004"", m_tok_end = 0x7f9ad8013ff2 ""\004"", m_end_of_query = 0x7f9ad8013ff1 """", m_tok_start_prev = 0x7f9ad8013ff1 """", m_buf = 0x7f9ad8013fe0 ""XA ROLLBACK `xid`"", m_buf_length = 17, m_echo = true, m_echo_saved = false, m_cpp_buf = 0x7f9ad8014048 ""XA ROLLBACK `xid`"", m_cpp_ptr = 0x7f9ad8014059 """", m_cpp_tok_start = 0x7f9ad8014059 """", m_cpp_tok_start_prev = 0x7f9ad8014059 """", m_cpp_tok_end = 0x7f9ad8014059 """", m_body_utf8 = 0x0, m_body_utf8_ptr = 0x0, m_cpp_utf8_processed_ptr = 0x0, next_state = MY_LEX_END, found_semicolon = 0x0, ignore_space = false, stmt_prepare_mode = false, multi_statements = true, yylineno = 1, m_digest = 0x0, in_comment = NO_COMMENT, in_comment_saved = (DISCARD_COMMENT | unknown: 0x7f98), m_cpp_text_start = 0x7f9ad8014055 ""xid`"", m_cpp_text_end = 0x7f9ad8014058 ""`"", m_underscore_cs = 0x0}, m_yacc = {yacc_yyss = 0x0, yacc_yyvs = 0x0, m_set_signal_info = {m_item = {0x0 <repeats 13 times>}}, m_lock_type = TL_READ_DEFAULT, m_mdl_type = MDL_SHARED_READ}, m_digest_psi = 0x7f9ad8004b28}
        net = 0x7f9ad80010f0
        error = false
        do_end_of_statement = true
        _db_stack_frame_ = {func = 0x56064f95b4fd ""do_command"", file = 0x56064f95b2e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483650, line = -1, prev = 0x7f9af00bedc0}
        drop_more_results = false
        __PRETTY_FUNCTION__ = ""dispatch_command_return dispatch_command(enum_server_command, THD*, char*, uint, bool)""
        __FUNCTION__ = ""dispatch_command""
        res = <optimized out>
#15 0x000056064e0d20ea in do_command (thd=0x7f9ad8000db8, blocking=true) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:1407
        return_value = DISPATCH_COMMAND_SUCCESS
        packet = 0x7f9ad800b9e8 ""\003XA ROLLBACK `xid`""
        packet_length = 18
        net = 0x7f9ad80010f0
        command = COM_QUERY
        _db_stack_frame_ = {func = 0x56064fdd350b ""?func"", file = 0x56064fdd3511 ""?file"", level = 2147483649, line = -1, prev = 0x0}
        __PRETTY_FUNCTION__ = ""dispatch_command_return do_command(THD*, bool)""
        __FUNCTION__ = ""do_command""
#16 0x000056064e43dffd in do_handle_one_connection (connect=0x5606529c0168, put_in_cache=true) at /data/src/preview-10.10-online-alter-gcov/sql/sql_connect.cc:1418
        create_user = true
        thr_create_utime = 2532075869394
        thd = 0x7f9ad8000db8
        __PRETTY_FUNCTION__ = ""void do_handle_one_connection(CONNECT*, bool)""
#17 0x000056064e43d804 in handle_one_connection (arg=0x5606529c0168) at /data/src/preview-10.10-online-alter-gcov/sql/sql_connect.cc:1312
        connect = 0x5606529c0168
#18 0x000056064ed4bb95 in pfs_spawn_thread (arg=0x5606529c0248) at /data/src/preview-10.10-online-alter-gcov/storage/perfschema/pfs.cc:2201
        typed_arg = 0x5606529c0248
        user_arg = 0x5606529c0168
        user_start_routine = 0x56064e43d74f <handle_one_connection(void*)>
        pfs = 0x7f9af40b7240
        klass = 0x5606523f8580
#19 0x00007f9af4c8aea7 in start_thread (arg=<optimized out>) at pthread_create.c:477
        ret = <optimized out>
        pd = <optimized out>
        unwind_buf = {cancel_jmp_buf = {{jmp_buf = {140303429007104, -1768826005343688189, 140720454370494, 140720454370495, 140303429005184, 311296, 1749153715660794371, 1749146596737427971}, mask_was_saved = 0}}, priv = {pad = {0x0, 0x0, 0x0, 0x0}, data = {prev = 0x0, cleanup = 0x0, canceltype = 0}}}
        not_first_call = 0
#20 0x00007f9af4889def in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
Or, with XA COMMIT `xid` ONE PHASE; instead of ROLLBACK, otherwise identical test case:

CREATE TABLE t (a INT) ENGINE=MyISAM;
INSERT INTO t VALUES (1);
 
--connect (con1,localhost,root,,test)
XA START `xid`;
SELECT * FROM t;
 
--connection default
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t NOWAIT ADD KEY (a);
 
--connection con1
UPDATE t SET a = 2;
XA END `xid`;
XA COMMIT `xid` ONE PHASE;
 
# Cleanup
DROP TABLE t;
--disconnect con1
mariadbd: /data/src/preview-10.10-online-alter-gcov/sql/log.cc:2281: int binlog_commit(THD*, bool, bool): Assertion `(thd && (WSREP_PROVIDER_EXISTS_ && thd->variables.wsrep_on)) || (thd->lex->sql_command != SQLCOM_XA_PREPARE && !(thd->lex->sql_command == SQLCOM_XA_COMMIT && thd->lex->xa_opt == XA_ONE_PHASE))` failed.
220625  1:50:45 [ERROR] mysqld got signal 6 ;
 
#7  0x00007fa3f9d60662 in __GI___assert_fail (assertion=0x555c8b68dfb8 ""(thd && (WSREP_PROVIDER_EXISTS_ && thd->variables.wsrep_on)) || (thd->lex->sql_command != SQLCOM_XA_PREPARE && !(thd->lex->sql_command == SQLCOM_XA_COMMIT && thd->lex->xa_opt == XA_ONE_PHASE))"", file=0x555c8b68ce28 ""/data/src/preview-10.10-online-alter-gcov/sql/log.cc"", line=2281, function=0x555c8b68df90 ""int binlog_commit(THD*, bool, bool)"") at assert.c:101
No locals.
#8  0x0000555c8a55f9b7 in binlog_commit (thd=0x7fa3d8000db8, all=true, ro_1pc=true) at /data/src/preview-10.10-online-alter-gcov/sql/log.cc:2281
        error = 0
        org_stage = {m_key = 0, m_name = 0x7fa3d8000db8 ""\b\353\333\213\\U"", m_flags = -194256640}
        _db_stack_frame_ = {func = 0x555c8b658eef ""commit_one_phase_2"", file = 0x555c8b658080 ""/data/src/preview-10.10-online-alter-gcov/sql/handler.cc"", level = 2147483657, line = -1, prev = 0x7fa3f46be160}
        is_ending_transaction = true
        cache_mngr = 0x0
        __PRETTY_FUNCTION__ = ""int binlog_commit(THD*, bool, bool)""
#9  0x0000555c8a2efc4d in commit_one_phase_2 (thd=0x7fa3d8000db8, all=true, trans=0x7fa3d8004770, is_real_trans=true) at /data/src/preview-10.10-online-alter-gcov/sql/handler.cc:2059
        err = 21852
        error = 0
        count = 0
        ha_info = 0x7fa3d80037e8
        ha_info_next = 0x7fa3d800ae78
        _db_stack_frame_ = {func = 0x555c8b658edb ""ha_commit_one_phase"", file = 0x555c8b658080 ""/data/src/preview-10.10-online-alter-gcov/sql/handler.cc"", level = 2147483656, line = -1, prev = 0x7fa3f46be1c0}
#10 0x0000555c8a2ef856 in ha_commit_one_phase (thd=0x7fa3d8000db8, all=true) at /data/src/preview-10.10-online-alter-gcov/sql/handler.cc:2021
        trans = 0x7fa3d8004770
        is_real_trans = true
        res = 0
        _db_stack_frame_ = {func = 0x555c8b6587bb ""ha_commit_trans"", file = 0x555c8b658080 ""/data/src/preview-10.10-online-alter-gcov/sql/handler.cc"", level = 2147483655, line = -1, prev = 0x7fa3f46be270}
#11 0x0000555c8a2ed6a9 in ha_commit_trans (thd=0x7fa3d8000db8, all=true) at /data/src/preview-10.10-online-alter-gcov/sql/handler.cc:1815
        error = 0
        cookie = 32675
        trans = 0x7fa3d8004770
        is_real_trans = true
        ha_info = 0x7fa3d80037e8
        need_prepare_ordered = false
        need_commit_ordered = false
        xid = 140341680278968
        run_wsrep_hooks = false
        _db_stack_frame_ = {func = 0x555c8b51032d ""trans_xa_commit"", file = 0x555c8b510018 ""/data/src/preview-10.10-online-alter-gcov/sql/xa.cc"", level = 2147483654, line = -1, prev = 0x7fa3f46beba0}
        __PRETTY_FUNCTION__ = ""int ha_commit_trans(THD*, bool)""
        rw_ha_count = 0
        rw_trans = false
        mdl_backup = {type = MDL_NOT_INITIALIZED, duration = MDL_STATEMENT, next_in_list = 0x7f00d80037e8, prev_in_list = 0x7fa3d8000db8, ticket = 0x0, key = {m_length = 0, m_db_name_length = 0, m_hash_value = 0, m_ptr = ""\320\067\000\330\000\000\000\000#0G\213\\U\000\000\000\000\000\000\000\000\000\000\360\342k\364\243\177\000\000\305\f(\213\000\000\001\000\020\343k\364\243\177\000\000\246\n(\213\\U\000\000\020\343k\364\243\177\000\000\305\f(\213\\U\000\000\340\f\000\330\243\177\000\000`\v\000\330\243\177\000\000\060\343k\364\243\177\000\000Zc,\213\\U\000\000\340\f\000\330\243\177\000\000\270\f\000\330\243\177\000\000`\343k\364\243\177\000\000\313\244,\213\\U\000\000C<G\213\\U\000\000\340\f\000\330&\006\000\000p\343k\364\243\177\000\000\000\236;0\212m>j\320\343k\364\243\177\000\000\313\256\310\211\\U\000\000\220\343k\364\243\177\000\000\030\000\000\000\000\000\000\000""...}, m_src_file = 0x7fa3d80037d0 """", m_src_line = 2334958086}
#12 0x0000555c8a162831 in trans_xa_commit (thd=0x7fa3d8000db8) at /data/src/preview-10.10-online-alter-gcov/sql/xa.cc:657
        r = 1
        res = true
        xid_state = @0x7fa3d80047a8: {xid_cache_element = 0x7fa3d8021a18}
        _db_stack_frame_ = {func = 0x555c8b466038 ""mysql_execute_command"", file = 0x555c8b4652e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483653, line = -1, prev = 0x7fa3f46bef30}
        __PRETTY_FUNCTION__ = ""bool trans_xa_commit(THD*)""
#13 0x0000555c89bfaeed in mysql_execute_command (thd=0x7fa3d8000db8, is_called_from_prepared_stmt=false) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:5862
        commit_failed = 32
        res = 0
        up_result = 0
        lex = 0x7fa3d8005100
        select_lex = 0x7fa3d80059d8
        first_table = 0x0
        all_tables = 0x0
        unit = 0x7fa3d80051d8
        have_table_map_for_update = false
        rpl_filter = 0x555c8bdbd250 <vtable for Internal_error_handler+16>
        _db_stack_frame_ = {func = 0x555c8b4673cf ""mysql_parse"", file = 0x555c8b4652e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483652, line = -1, prev = 0x7fa3f46bf380}
        __PRETTY_FUNCTION__ = ""int mysql_execute_command(THD*, bool)""
        ots = {ctx = 0x7fa3d8004d98, traceable = false}
        orig_binlog_format = BINLOG_FORMAT_MIXED
        orig_current_stmt_binlog_format = BINLOG_FORMAT_STMT
#14 0x0000555c89c07c10 in mysql_parse (thd=0x7fa3d8000db8, rawbuf=0x7fa3d8013fe0 ""XA COMMIT `xid` ONE PHASE"", length=25, parser_state=0x7fa3f46bf500) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:8036
        found_semicolon = 0x0
        error = 32675
        lex = 0x7fa3d8005100
        err = false
        _db_stack_frame_ = {func = 0x555c8b465879 ""dispatch_command"", file = 0x555c8b4652e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483651, line = -1, prev = 0x7fa3f46bf4e0}
        __PRETTY_FUNCTION__ = ""void mysql_parse(THD*, char*, uint, Parser_state*)""
#15 0x0000555c89bdef11 in dispatch_command (command=COM_QUERY, thd=0x7fa3d8000db8, packet=0x7fa3d800b9e9 ""XA COMMIT `xid` ONE PHASE"", packet_length=25, blocking=true) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:1894
        packet_end = 0x7fa3d8013ff9 """"
        parser_state = {m_lip = {lookahead_token = -1, lookahead_yylval = 0x0, m_thd = 0x7fa3d8000db8, m_ptr = 0x7fa3d8013ffa ""\004"", m_tok_start = 0x7fa3d8013ffa ""\004"", m_tok_end = 0x7fa3d8013ffa ""\004"", m_end_of_query = 0x7fa3d8013ff9 """", m_tok_start_prev = 0x7fa3d8013ff9 """", m_buf = 0x7fa3d8013fe0 ""XA COMMIT `xid` ONE PHASE"", m_buf_length = 25, m_echo = true, m_echo_saved = false, m_cpp_buf = 0x7fa3d8014050 ""XA COMMIT `xid` ONE PHASE"", m_cpp_ptr = 0x7fa3d8014069 """", m_cpp_tok_start = 0x7fa3d8014069 """", m_cpp_tok_start_prev = 0x7fa3d8014069 """", m_cpp_tok_end = 0x7fa3d8014069 """", m_body_utf8 = 0x0, m_body_utf8_ptr = 0x0, m_cpp_utf8_processed_ptr = 0x0, next_state = MY_LEX_END, found_semicolon = 0x0, ignore_space = false, stmt_prepare_mode = false, multi_statements = true, yylineno = 1, m_digest = 0x0, in_comment = NO_COMMENT, in_comment_saved = (PRESERVE_COMMENT | DISCARD_COMMENT | unknown: 0x7fa0), m_cpp_text_start = 0x7fa3d801405b ""xid` ONE PHASE"", m_cpp_text_end = 0x7fa3d801405e ""` ONE PHASE"", m_underscore_cs = 0x0}, m_yacc = {yacc_yyss = 0x0, yacc_yyvs = 0x0, m_set_signal_info = {m_item = {0x0 <repeats 13 times>}}, m_lock_type = TL_READ_DEFAULT, m_mdl_type = MDL_SHARED_READ}, m_digest_psi = 0x7fa3d8004b28}
        net = 0x7fa3d80010f0
        error = false
        do_end_of_statement = true
        _db_stack_frame_ = {func = 0x555c8b4654fd ""do_command"", file = 0x555c8b4652e0 ""/data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc"", level = 2147483650, line = -1, prev = 0x7fa3f46bfdc0}
        drop_more_results = false
        __PRETTY_FUNCTION__ = ""dispatch_command_return dispatch_command(enum_server_command, THD*, char*, uint, bool)""
        __FUNCTION__ = ""dispatch_command""
        res = <optimized out>
#16 0x0000555c89bdc0ea in do_command (thd=0x7fa3d8000db8, blocking=true) at /data/src/preview-10.10-online-alter-gcov/sql/sql_parse.cc:1407
        return_value = DISPATCH_COMMAND_SUCCESS
        packet = 0x7fa3d800b9e8 ""\003XA COMMIT `xid` ONE PHASE""
        packet_length = 26
        net = 0x7fa3d80010f0
        command = COM_QUERY
        _db_stack_frame_ = {func = 0x555c8b8dd50b ""?func"", file = 0x555c8b8dd511 ""?file"", level = 2147483649, line = -1, prev = 0x0}
        __PRETTY_FUNCTION__ = ""dispatch_command_return do_command(THD*, bool)""
        __FUNCTION__ = ""do_command""
#17 0x0000555c89f47ffd in do_handle_one_connection (connect=0x555c8e5af168, put_in_cache=true) at /data/src/preview-10.10-online-alter-gcov/sql/sql_connect.cc:1418
        create_user = true
        thr_create_utime = 2533157813198
        thd = 0x7fa3d8000db8
        __PRETTY_FUNCTION__ = ""void do_handle_one_connection(CONNECT*, bool)""
#18 0x0000555c89f47804 in handle_one_connection (arg=0x555c8e5af168) at /data/src/preview-10.10-online-alter-gcov/sql/sql_connect.cc:1312
        connect = 0x555c8e5af168
#19 0x0000555c8a855b95 in pfs_spawn_thread (arg=0x555c8e5af248) at /data/src/preview-10.10-online-alter-gcov/storage/perfschema/pfs.cc:2201
        typed_arg = 0x555c8e5af248
        user_arg = 0x555c8e5af168
        user_start_routine = 0x555c89f4774f <handle_one_connection(void*)>
        pfs = 0x7fa3f9657240
        klass = 0x555c8dfe7580
#20 0x00007fa3fa22aea7 in start_thread (arg=<optimized out>) at pthread_create.c:477
        ret = <optimized out>
        pd = <optimized out>
        unwind_buf = {cancel_jmp_buf = {{jmp_buf = {140342157117184, 9015443577906266516, 140737166056062, 140737166056063, 140342157115264, 311296, -9053744893697064556, -9053714719924026988}, mask_was_saved = 0}}, priv = {pad = {0x0, 0x0, 0x0, 0x0}, data = {prev = 0x0, cleanup = 0x0, canceltype = 0}}}
        not_first_call = 0
#21 0x00007fa3f9e29def in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95
Doesn`t fail with e.g. LOCK=SHARED in the ALTER.
NOWAIT is just to speed things up, it also fails upon a normal lock wait timeout.",In Testing,,-,-,2022/6/24,Critical,"CREATE TABLE t (a INT) ENGINE=MyISAM;
INSERT INTO t VALUES (1);
 
--connect (con1,localhost,root,,test)
XA START `xid`;
SELECT * FROM t;
 
--connection default
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t NOWAIT ADD KEY (a);
 
--connection con1
UPDATE t SET a = 2;
XA END `xid`;
XA ROLLBACK `xid`;
 
# Cleanup
DROP TABLE t;
--disconnect con1

Or, with XA COMMIT `xid` ONE PHASE; instead of ROLLBACK, otherwise identical test case:

CREATE TABLE t (a INT) ENGINE=MyISAM;
INSERT INTO t VALUES (1);
 
--connect (con1,localhost,root,,test)
XA START `xid`;
SELECT * FROM t;
 
--connection default
--error ER_LOCK_WAIT_TIMEOUT
ALTER TABLE t NOWAIT ADD KEY (a);
 
--connection con1
UPDATE t SET a = 2;
XA END `xid`;
XA COMMIT `xid` ONE PHASE;
 
# Cleanup
DROP TABLE t;
--disconnect con1
Due to the application of autocommit, the ROLLBACK statement should have no effect after deadlock in t2. The last select should return [(2, NULL), (3, 7)].",unspecified,Pessimistic,1,1,-,-,-,-,2,XA,5,auto,1,-,-,-,-,-,-,-,Yes,-,-,-,Yes,Yes,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,ENGINE=MyISAM;,-,-,-,-,-,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure, Critical,"No, unknown",-,-,-,-,-,-,-,-,191,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,MariaDB_MDEV-28944
MariaDB,MDEV-27992,https://jira.mariadb.org/browse/MDEV-27992,DELETE fails to delete record after blocking is released,"Isolation Level: Read Committed & Read Uncommitted
One transaction modifies a row, the other transaction concurrently deletes that row and is blocked. After blocking is released, the second transaction DELETE fails.

/* init */ DROP TABLE IF EXISTS t;
/* init */ CREATE TABLE t(c1 INT PRIMARY KEY, c2 INT);
/* init */ INSERT INTO t(c1) VALUES (8);
 
/* t1 */ BEGIN;
/* t2 */ BEGIN;
/* t1 */ UPDATE t SET c1 = 5, c2 = 5;
/* t2 */ DELETE FROM t; -- blocked
/* t1 */ UPDATE t SET c1 = 3;
/* t1 */ COMMIT; -- t2 unblocked
/* t2 */ SELECT * FROM t FOR UPDATE; -- [(3, 5)]
/* t2 */ ROLLBACK;",Fixed,"10.5.14, 10.6.6, 10.7.3","10.3.35, 10.4.25, 10.5.16",-,2022/3/3,Critical,"Isolation Level: Read Committed & Read Uncommitted
One transaction modifies a row, the other transaction concurrently deletes that row and is blocked. After blocking is released, the second transaction DELETE fails.

/* init */ DROP TABLE IF EXISTS t;
/* init */ CREATE TABLE t(c1 INT PRIMARY KEY, c2 INT);
/* init */ INSERT INTO t(c1) VALUES (8);
 
/* t1 */ BEGIN;
/* t2 */ BEGIN;
/* t1 */ UPDATE t SET c1 = 5, c2 = 5;
/* t2 */ DELETE FROM t; -- blocked
/* t1 */ UPDATE t SET c1 = 3;
/* t1 */ COMMIT; -- t2 unblocked
/* t2 */ SELECT * FROM t FOR UPDATE; -- [(3, 5)]
/* t2 */ COMMIT;",ALL,Pessimistic,1,1,-,-,-,-,2,explicit,4,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Incorrect database state,Consistency: application state,Critical,Yes,Code fix,-,-,-,-,-,-,4,-,"No, involve complex operations other than read(key) and write(key, value)",Yes,Yes,,,MariaDB_MDEV-27992
MariaDB,MDEV-29123,https://jira.mariadb.org/browse/MDEV-29123,Incorrect results of SELECT statement found by transaction comparison,"CREATE TABLE `t_4rbssc` (
  `wkey` int(11) DEFAULT NULL,
  `pkey` int(11) NOT NULL,
  `c_umaal` text DEFAULT NULL,
  `c_qrgwb` text DEFAULT NULL,
  `c_wzm9wc` int(11) DEFAULT NULL,
  `c_8u7ipc` double DEFAULT NULL,
  `c_mqgwfb` int(11) DEFAULT NULL,
  `c_sbxs3c` int(11) DEFAULT NULL,
  `c_kkizw` text DEFAULT NULL,
  `c_7j_zjb` int(11) DEFAULT NULL,
  PRIMARY KEY (`pkey`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;
INSERT INTO `t_4rbssc` VALUES
(3,27000,`vbaf_b`,NULL,51,15.8,53,NULL,NULL,18),
(3,28000,`zvemlb`,NULL,26,1.45,77,NULL,NULL,85),
(3,29000,`mn8zid`,NULL,20,2.97,33,NULL,NULL,14),
(3,30000,NULL,NULL,61,97.85,55,NULL,NULL,33),
(3,31000,NULL,NULL,25,31.81,13,NULL,NULL,17),
(3,32000,`m2ygwd`,NULL,42,NULL,14,NULL,NULL,40),
(3,33000,`zpct_`,NULL,89,26.12,26,NULL,NULL,55),
(4,34000,`4bquu`,`entwob`,87,84.64,93,5,`glalkc`,47),
(4,35000,`2w5lsc`,NULL,6,42.97,86,1,`evgzfc`,77),
(4,36000,`_wacsb`,`3_7us`,100,91.97,77,51,`mf8txb`,79),
(4,37000,`obkbfb`,`ku0pmd`,74,97.73,47,41,NULL,19),
(4,38000,`yzdmqb`,`sfxi_c`,66,22.93,79,96,`xjkqb`,56),
(5,39000,`svncqc`,`x9lbjb`,NULL,NULL,NULL,NULL,`cmelcb`,100),
(5,40000,`p5ehvd`,`gfk5jd`,NULL,77.27,NULL,NULL,`z0oy5c`,87),
(5,41000,`gr6lkb`,`ikaxgb`,NULL,NULL,NULL,NULL,`7hcrgc`,62),
(5,42000,`9bzwnb`,`noxkqb`,NULL,58.73,NULL,NULL,`gh3bvc`,49),
(5,43000,`fjr0qb`,`cfdwgc`,NULL,75.31,NULL,NULL,`54mc_d`,86),
(9,58000,`aufhb`,`pklph`,NULL,NULL,NULL,87,`mehz7d`,57),
(9,59000,`ukdszc`,NULL,NULL,NULL,NULL,48,NULL,46),
(9,60000,`tk4qsb`,`klkjp`,NULL,NULL,NULL,60,`q9qcd`,6),
(9,61000,`ovt4vc`,`lrv7gd`,NULL,NULL,NULL,35,NULL,7),
(9,62000,`lrp7a`,`oyt5n`,NULL,NULL,NULL,59,`wepgod`,51),
(9,63000,`wvvd9b`,`q9lupc`,NULL,NULL,NULL,4,`sy5icd`,43),
(9,64000,`o_ermc`,`jmhnad`,NULL,NULL,NULL,81,`vatd7d`,57),
(12,73000,`ghijhc`,NULL,38,NULL,88,10,NULL,23),
(12,74000,`1mtvgc`,NULL,17,NULL,54,37,`fmfmzc`,42),
(12,75000,NULL,NULL,81,NULL,84,15,`whfc8d`,9),
(12,76000,`3wxi9d`,NULL,10,NULL,69,26,`06azlb`,49);
/*!40000 ALTER TABLE `t_4rbssc` ENABLE KEYS */;
CREATE TABLE `t__w2gab` (
  `wkey` int(11) DEFAULT NULL,
  `pkey` int(11) NOT NULL,
  `c_ntsmbb` text DEFAULT NULL,
  `c_gt5hk` text DEFAULT NULL,
  `c_sjxrx` text DEFAULT NULL,
  `c_lba4ac` double DEFAULT NULL,
  `c_79u9mc` double DEFAULT NULL,
  `c_baxlp` int(11) DEFAULT NULL,
  `c_ckip3c` text DEFAULT NULL,
  `c_stq_eb` double DEFAULT NULL,
  PRIMARY KEY (`pkey`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;
INSERT INTO `t__w2gab` VALUES
(1,11000,NULL,`ymhvbc`,NULL,40.81,71.83,NULL,`bwsy_b`,48.32),
(1,12000,NULL,`9apidc`,NULL,NULL,87.3,NULL,`bwbmz`,96.72),
(1,13000,NULL,`ebszkd`,NULL,2147483648.1,10.26,NULL,`rzack`,79.77),
(1,14000,NULL,`jdw4db`,NULL,59.48,67.29,NULL,`ad5f8d`,5.14),
(1,15000,NULL,`lprka`,NULL,59.32,36.57,NULL,`jzjied`,31.65),
(1,16000,NULL,`tl6b9c`,NULL,70.46,85.26,NULL,NULL,33.42),
(1,17000,NULL,`ipcgb`,NULL,3.59,72.92,NULL,`fayt2b`,25.67),
(1,18000,NULL,`tmlkgd`,NULL,37.64,78.8,NULL,`ryd2rd`,94.17),
(6,44000,`j2nim`,`c5qcjd`,`ubeb1b`,98.54,96.85,1,`glc_d`,75.17),
(6,45000,`1nt3xd`,`odxgsb`,`mc0y9`,64.86,28.99,39,`xfm2fc`,73.88),
(6,46000,`uafrsb`,NULL,`5v3lic`,NULL,NULL,15,`3t_bg`,38.12),
(6,47000,`uwsxsc`,`ngfywd`,`af12rb`,47.74,86.4,24,`rxme8b`,37.43),
(6,48000,`kwrmr`,`wgb5cc`,`sjuqhc`,66.2,55.63,2,NULL,97.39),
(7,49000,`2njzac`,`emjut`,NULL,24.82,60.5,52,`i5dilc`,33.39),
(7,50000,`hiblxb`,`etjzyd`,NULL,59.91,58.16,89,`3iwybb`,33.52),
(7,51000,`w_mgob`,NULL,NULL,69.26,72.15,94,`dxbeub`,NULL),
(14,83000,`tu0x_`,`4xfdnb`,`7xzpvd`,45.91,NULL,NULL,`6w1ngd`,60.67),
(14,84000,`zq5pvc`,`mtg3_b`,`u7qhzd`,53.96,NULL,NULL,`au1kpc`,91.4),
(14,85000,`8tgkud`,`mxidgc`,`vv9mrd`,63.4,NULL,NULL,`kkwzzc`,64.93),
(14,86000,`sn_hoc`,`07bak`,`o7xnwd`,19.55,NULL,NULL,`vl0dbb`,87.65),
(14,87000,`n4hyx`,`3desx`,`q_wem`,72.75,NULL,NULL,`gyrqcc`,NULL),
(15,88000,`nr6k9`,`cmyid`,`n9g3b`,13.11,67.18,NULL,NULL,60.83),
(15,89000,`lay_tb`,`6ycncb`,`spcqvc`,7.5,64.83,NULL,NULL,60.98),
(15,90000,`7zolab`,`iaz8rc`,`uklyfd`,97.79,80.44,NULL,NULL,98.75),
(15,91000,`fxigec`,`d4bstc`,`wummmd`,69.2,84.87,NULL,NULL,52.18),
(15,92000,`o_cqib`,`j6fr4d`,`tg9esc`,12.93,60.2,NULL,NULL,23.87);
/*!40000 ALTER TABLE `t__w2gab` ENABLE KEYS */;

Testcase 1
/usr/local/mysql/bin/mysql -uroot -Dtestdb # set up for the transaction T0
/usr/local/mysql/bin/mysql -uroot -Dtestdb # set up for the transaction T1

Txn 1> START TRANSACTION;

Txn 0> START TRANSACTION;

Txn 1> insert into t_4rbssc (wkey, pkey, c_qrgwb, c_8u7ipc, c_mqgwfb, c_7j_zjb) values
(225, 489000, null, 11.49, 89, 63);

Txn 1> ROLLBACK;

Txn 0> select *
from
t_4rbssc
where t_4rbssc.wkey = 4 and t_4rbssc.c_sbxs3c not in (
select
count(ref_0.c_baxlp) over (partition by ref_0.c_lba4ac order by ref_0.c_baxlp) as c0
from
t__w2gab as ref_0);

Txn 0> COMMIT;

Output of SELECT statement:

+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
| wkey | pkey  | c_umaal | c_qrgwb | c_wzm9wc | c_8u7ipc | c_mqgwfb | c_sbxs3c | c_kkizw | c_7j_zjb |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
|    4 | 34000 | 4bquu   | entwob  |       87 |    84.64 |       93 |        5 | glalkc  |       47 |
|    4 | 36000 | _wacsb  | 3_7us   |      100 |    91.97 |       77 |       51 | mf8txb  |       79 |
|    4 | 37000 | obkbfb  | ku0pmd  |       74 |    97.73 |       47 |       41 | NULL    |       19 |
|    4 | 38000 | yzdmqb  | sfxi_c  |       66 |    22.93 |       79 |       96 | xjkqb   |       56 |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
4 rows in set (0.006 sec)
Testcase 2
/usr/local/mysql/bin/mysql -uroot -Dtestdb set up for the transaction T0

Txn 0> START TRANSACTION;

Txn 0> select *
from
t_4rbssc
where t_4rbssc.wkey = 4 and t_4rbssc.c_sbxs3c not in (
select
count(ref_0.c_baxlp) over (partition by ref_0.c_lba4ac order by ref_0.c_baxlp) as c0
from
t__w2gab as ref_0);

Txn 0> COMMIT;

Output of SELECT statement:

+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
| wkey | pkey  | c_umaal | c_qrgwb | c_wzm9wc | c_8u7ipc | c_mqgwfb | c_sbxs3c | c_kkizw | c_7j_zjb |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
|    4 | 35000 | 2w5lsc  | NULL    |        6 |    42.97 |       86 |        1 | evgzfc  |       77 |
|    4 | 36000 | _wacsb  | 3_7us   |      100 |    91.97 |       77 |       51 | mf8txb  |       79 |
|    4 | 37000 | obkbfb  | ku0pmd  |       74 |    97.73 |       47 |       41 | NULL    |       19 |
|    4 | 38000 | yzdmqb  | sfxi_c  |       66 |    22.93 |       79 |       96 | xjkqb   |       56 |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
4 rows in set (0.007 sec)
The SELECT statement in Testcase 1 and Testcase 2 should return the same results. However, they are different in their first row of output. The first row in Test case 1 is (4, 34000, `4bquu`, `entwob`, 87, 84.64, 93, 5, `glalkc`, 47), while the first row in Test case 2 is (4, 35000, `2w5lsc`, NULL, 6, 42.97, 86, 1, `evgzfc`, 77)",Confirmed,"10.8.3, 10.6, 10.7, 10.9, 10.10",-,-,2022/7/18,Major,"CREATE TABLE `t_4rbssc` (
  `wkey` int(11) DEFAULT NULL,
  `pkey` int(11) NOT NULL,
  `c_umaal` text DEFAULT NULL,
  `c_qrgwb` text DEFAULT NULL,
  `c_wzm9wc` int(11) DEFAULT NULL,
  `c_8u7ipc` double DEFAULT NULL,
  `c_mqgwfb` int(11) DEFAULT NULL,
  `c_sbxs3c` int(11) DEFAULT NULL,
  `c_kkizw` text DEFAULT NULL,
  `c_7j_zjb` int(11) DEFAULT NULL,
  PRIMARY KEY (`pkey`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;
INSERT INTO `t_4rbssc` VALUES
(3,27000,`vbaf_b`,NULL,51,15.8,53,NULL,NULL,18),
(3,28000,`zvemlb`,NULL,26,1.45,77,NULL,NULL,85),
(3,29000,`mn8zid`,NULL,20,2.97,33,NULL,NULL,14),
(3,30000,NULL,NULL,61,97.85,55,NULL,NULL,33),
(3,31000,NULL,NULL,25,31.81,13,NULL,NULL,17),
(3,32000,`m2ygwd`,NULL,42,NULL,14,NULL,NULL,40),
(3,33000,`zpct_`,NULL,89,26.12,26,NULL,NULL,55),
(4,34000,`4bquu`,`entwob`,87,84.64,93,5,`glalkc`,47),
(4,35000,`2w5lsc`,NULL,6,42.97,86,1,`evgzfc`,77),
(4,36000,`_wacsb`,`3_7us`,100,91.97,77,51,`mf8txb`,79),
(4,37000,`obkbfb`,`ku0pmd`,74,97.73,47,41,NULL,19),
(4,38000,`yzdmqb`,`sfxi_c`,66,22.93,79,96,`xjkqb`,56),
(5,39000,`svncqc`,`x9lbjb`,NULL,NULL,NULL,NULL,`cmelcb`,100),
(5,40000,`p5ehvd`,`gfk5jd`,NULL,77.27,NULL,NULL,`z0oy5c`,87),
(5,41000,`gr6lkb`,`ikaxgb`,NULL,NULL,NULL,NULL,`7hcrgc`,62),
(5,42000,`9bzwnb`,`noxkqb`,NULL,58.73,NULL,NULL,`gh3bvc`,49),
(5,43000,`fjr0qb`,`cfdwgc`,NULL,75.31,NULL,NULL,`54mc_d`,86),
(9,58000,`aufhb`,`pklph`,NULL,NULL,NULL,87,`mehz7d`,57),
(9,59000,`ukdszc`,NULL,NULL,NULL,NULL,48,NULL,46),
(9,60000,`tk4qsb`,`klkjp`,NULL,NULL,NULL,60,`q9qcd`,6),
(9,61000,`ovt4vc`,`lrv7gd`,NULL,NULL,NULL,35,NULL,7),
(9,62000,`lrp7a`,`oyt5n`,NULL,NULL,NULL,59,`wepgod`,51),
(9,63000,`wvvd9b`,`q9lupc`,NULL,NULL,NULL,4,`sy5icd`,43),
(9,64000,`o_ermc`,`jmhnad`,NULL,NULL,NULL,81,`vatd7d`,57),
(12,73000,`ghijhc`,NULL,38,NULL,88,10,NULL,23),
(12,74000,`1mtvgc`,NULL,17,NULL,54,37,`fmfmzc`,42),
(12,75000,NULL,NULL,81,NULL,84,15,`whfc8d`,9),
(12,76000,`3wxi9d`,NULL,10,NULL,69,26,`06azlb`,49);
/*!40000 ALTER TABLE `t_4rbssc` ENABLE KEYS */;
CREATE TABLE `t__w2gab` (
  `wkey` int(11) DEFAULT NULL,
  `pkey` int(11) NOT NULL,
  `c_ntsmbb` text DEFAULT NULL,
  `c_gt5hk` text DEFAULT NULL,
  `c_sjxrx` text DEFAULT NULL,
  `c_lba4ac` double DEFAULT NULL,
  `c_79u9mc` double DEFAULT NULL,
  `c_baxlp` int(11) DEFAULT NULL,
  `c_ckip3c` text DEFAULT NULL,
  `c_stq_eb` double DEFAULT NULL,
  PRIMARY KEY (`pkey`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;
INSERT INTO `t__w2gab` VALUES
(1,11000,NULL,`ymhvbc`,NULL,40.81,71.83,NULL,`bwsy_b`,48.32),
(1,12000,NULL,`9apidc`,NULL,NULL,87.3,NULL,`bwbmz`,96.72),
(1,13000,NULL,`ebszkd`,NULL,2147483648.1,10.26,NULL,`rzack`,79.77),
(1,14000,NULL,`jdw4db`,NULL,59.48,67.29,NULL,`ad5f8d`,5.14),
(1,15000,NULL,`lprka`,NULL,59.32,36.57,NULL,`jzjied`,31.65),
(1,16000,NULL,`tl6b9c`,NULL,70.46,85.26,NULL,NULL,33.42),
(1,17000,NULL,`ipcgb`,NULL,3.59,72.92,NULL,`fayt2b`,25.67),
(1,18000,NULL,`tmlkgd`,NULL,37.64,78.8,NULL,`ryd2rd`,94.17),
(6,44000,`j2nim`,`c5qcjd`,`ubeb1b`,98.54,96.85,1,`glc_d`,75.17),
(6,45000,`1nt3xd`,`odxgsb`,`mc0y9`,64.86,28.99,39,`xfm2fc`,73.88),
(6,46000,`uafrsb`,NULL,`5v3lic`,NULL,NULL,15,`3t_bg`,38.12),
(6,47000,`uwsxsc`,`ngfywd`,`af12rb`,47.74,86.4,24,`rxme8b`,37.43),
(6,48000,`kwrmr`,`wgb5cc`,`sjuqhc`,66.2,55.63,2,NULL,97.39),
(7,49000,`2njzac`,`emjut`,NULL,24.82,60.5,52,`i5dilc`,33.39),
(7,50000,`hiblxb`,`etjzyd`,NULL,59.91,58.16,89,`3iwybb`,33.52),
(7,51000,`w_mgob`,NULL,NULL,69.26,72.15,94,`dxbeub`,NULL),
(14,83000,`tu0x_`,`4xfdnb`,`7xzpvd`,45.91,NULL,NULL,`6w1ngd`,60.67),
(14,84000,`zq5pvc`,`mtg3_b`,`u7qhzd`,53.96,NULL,NULL,`au1kpc`,91.4),
(14,85000,`8tgkud`,`mxidgc`,`vv9mrd`,63.4,NULL,NULL,`kkwzzc`,64.93),
(14,86000,`sn_hoc`,`07bak`,`o7xnwd`,19.55,NULL,NULL,`vl0dbb`,87.65),
(14,87000,`n4hyx`,`3desx`,`q_wem`,72.75,NULL,NULL,`gyrqcc`,NULL),
(15,88000,`nr6k9`,`cmyid`,`n9g3b`,13.11,67.18,NULL,NULL,60.83),
(15,89000,`lay_tb`,`6ycncb`,`spcqvc`,7.5,64.83,NULL,NULL,60.98),
(15,90000,`7zolab`,`iaz8rc`,`uklyfd`,97.79,80.44,NULL,NULL,98.75),
(15,91000,`fxigec`,`d4bstc`,`wummmd`,69.2,84.87,NULL,NULL,52.18),
(15,92000,`o_cqib`,`j6fr4d`,`tg9esc`,12.93,60.2,NULL,NULL,23.87);
/*!40000 ALTER TABLE `t__w2gab` ENABLE KEYS */;

Testcase 1
/usr/local/mysql/bin/mysql -uroot -Dtestdb # set up for the transaction T0
/usr/local/mysql/bin/mysql -uroot -Dtestdb # set up for the transaction T1

Txn 1> START TRANSACTION;

Txn 0> START TRANSACTION;

Txn 1> insert into t_4rbssc (wkey, pkey, c_qrgwb, c_8u7ipc, c_mqgwfb, c_7j_zjb) values
(225, 489000, null, 11.49, 89, 63);

Txn 1> ROLLBACK;

Txn 0> select *
from
t_4rbssc
where t_4rbssc.wkey = 4 and t_4rbssc.c_sbxs3c not in (
select
count(ref_0.c_baxlp) over (partition by ref_0.c_lba4ac order by ref_0.c_baxlp) as c0
from
t__w2gab as ref_0);

Txn 0> COMMIT;

Output of SELECT statement:

+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
| wkey | pkey  | c_umaal | c_qrgwb | c_wzm9wc | c_8u7ipc | c_mqgwfb | c_sbxs3c | c_kkizw | c_7j_zjb |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
|    4 | 34000 | 4bquu   | entwob  |       87 |    84.64 |       93 |        5 | glalkc  |       47 |
|    4 | 36000 | _wacsb  | 3_7us   |      100 |    91.97 |       77 |       51 | mf8txb  |       79 |
|    4 | 37000 | obkbfb  | ku0pmd  |       74 |    97.73 |       47 |       41 | NULL    |       19 |
|    4 | 38000 | yzdmqb  | sfxi_c  |       66 |    22.93 |       79 |       96 | xjkqb   |       56 |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
4 rows in set (0.006 sec)
Testcase 2
/usr/local/mysql/bin/mysql -uroot -Dtestdb set up for the transaction T0

Txn 0> START TRANSACTION;

Txn 0> select *
from
t_4rbssc
where t_4rbssc.wkey = 4 and t_4rbssc.c_sbxs3c not in (
select
count(ref_0.c_baxlp) over (partition by ref_0.c_lba4ac order by ref_0.c_baxlp) as c0
from
t__w2gab as ref_0);

Txn 0> COMMIT;

Output of SELECT statement:

+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
| wkey | pkey  | c_umaal | c_qrgwb | c_wzm9wc | c_8u7ipc | c_mqgwfb | c_sbxs3c | c_kkizw | c_7j_zjb |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
|    4 | 35000 | 2w5lsc  | NULL    |        6 |    42.97 |       86 |        1 | evgzfc  |       77 |
|    4 | 36000 | _wacsb  | 3_7us   |      100 |    91.97 |       77 |       51 | mf8txb  |       79 |
|    4 | 37000 | obkbfb  | ku0pmd  |       74 |    97.73 |       47 |       41 | NULL    |       19 |
|    4 | 38000 | yzdmqb  | sfxi_c  |       66 |    22.93 |       79 |       96 | xjkqb   |       56 |
+------+-------+---------+---------+----------+----------+----------+----------+---------+----------+
4 rows in set (0.007 sec)
The SELECT statement in Testcase 1 and Testcase 2 should return the same results. However, they are different in their first row of output. The first row in Test case 1 is (4, 34000, `4bquu`, `entwob`, 87, 84.64, 93, 5, `glalkc`, 47), while the first row in Test case 2 is (4, 35000, `2w5lsc`, NULL, 6, 42.97, 86, 1, `evgzfc`, 77)",unspecified,Pessimistic,2,28,26,-,-,-,3,explicit,3,explicit,3,explicit,3,-,-,-,-,-,Yes,-,-,Yes,Yes,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,-,-,Yes,-,-,-,Yes,"NOT NULL
DEFAULT NULL",-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Major,"No, unknown",-,-,-,-,-,-,-,-,167,"No, not key-value data structures","No, same behavior","No, unsupported statements",,,MariaDB_MDEV-29123
TiDB,36581,https://github.com/pingcap/tidb/issues/36581,autocommit handles process issues,"set autocommit = ON;
begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from test.t1;
+-----+
| id |
+-----+
| 590 |
+-----+
1 row in set (0.01 sec)

mysql> update test.t1 set id = id+1;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1 Changed: 1 Warnings: 0

mysql> select * from test.t1;
+-----+
| id |
+-----+
| 591 |
+-----+
1 row in set (0.01 sec)

mysql> set autocommit = ON;
Query OK, 0 rows affected (0.01 sec)

mysql> rollback;

2. What did you expect to see? (Required)
consistent with mysql
select * from test.t1;
+-----+
| id |
+-----+
| 590 |
+-----+

3. What did you see instead (Required)
select * from test.t1;
+-----+
| id |
+-----+
| 591 |
+-----+
1 row in set (0.01 sec)",Fixed,"4.0, 5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2",-,https://github.com/pingcap/tidb/pull/36631,2022/7/26,Major,"set autocommit = ON;
begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from test.t1;
+-----+
| id |
+-----+
| 590 |
+-----+
1 row in set (0.01 sec)

mysql> update test.t1 set id = id+1;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1 Changed: 1 Warnings: 0

mysql> select * from test.t1;
+-----+
| id |
+-----+
| 591 |
+-----+
1 row in set (0.01 sec)

mysql> set autocommit = ON;
Query OK, 0 rows affected (0.01 sec)

mysql> rollback;

2. What did you expect to see? (Required)
consistent with mysql
select * from test.t1;
+-----+
| id |
+-----+
| 590 |
+-----+

3. What did you see instead (Required)
select * from test.t1;
+-----+
| id |
+-----+
| 591 |
+-----+
1 row in set (0.01 sec)",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,6,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,Yes,Yes,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect database state,Atomicity,Major,Yes,Code fix,"4 patches: 3 changed files with 47 additions and 11 deletions
",4,3,47,11,58,6,-,"No, not key-value data structures",Yes,Yes,,,TiDB_36581
TiDB,36438,https://github.com/pingcap/tidb/issues/36438,Unique key lock not consistent when row is changed or not,"mysql> show create table t;
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                         |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `i` varchar(20) NOT NULL,
  PRIMARY KEY (`i`) /*T![clustered_index] NONCLUSTERED */
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> insert into t values (`a`);
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t;
+---+
| i |
+---+
| a |
+---+
1 row in set (0.00 sec)

mysql> update t set i = `a`; -- insert into t values (`a`) in another session
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

mysql> update t set i = `b`; -- insert into t values (`b`) in another session
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> rollback;
Query OK, 0 rows affected (0.00 sec)
2. What did you expect to see? (Required)
The first insert in another session should wait lock.

3. What did you see instead (Required)
ERROR 1062 (23000): Duplicate entry `a` for key `PRIMARY`",Confirmed,7.6.0-alpha,-,-,2022/7/21,Moderate,"mysql> show create table t;
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                         |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `i` varchar(20) NOT NULL,
  PRIMARY KEY (`i`) /*T![clustered_index] NONCLUSTERED */
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> insert into t values (`a`);
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t;
+---+
| i |
+---+
| a |
+---+
1 row in set (0.00 sec)

mysql> update t set i = `a`; -- insert into t values (`a`) in another session
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

mysql> update t set i = `b`; -- insert into t values (`b`) in another session
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> rollback;
Query OK, 0 rows affected (0.00 sec)
2. What did you expect to see? (Required)
The first insert in another session should wait lock.

3. What did you see instead (Required)
ERROR 1062 (23000): Duplicate entry `a` for key `PRIMARY`",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,5,auto,2,-,-,-,-,-,-,Yes,-,-,-,-,Yes,Yes,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,Yes,Yes,-,-,Yes,NOT NULL,-,Yes,Missing blocking,Insufficient isolation: missing blocking,Moderate,"No, hard to fix",-,-,-,-,-,-,-,-,164,"No, not key-value data structures",Yes,Yes,,,TiDB_36438
TiDB,36235,https://github.com/pingcap/tidb/issues/36235,Pessimistic DML should not lock non-unique index keys,"create table t(id varchar(40), v int, PRIMARY KEY (`id`) clustered, key i2(v))
insert into t values (`123`, 1)
begin pessimistic
update t set v = v + 1 where id = `123`
commit
2. What did you expect to see? (Required)
The update statement is not supposed to lock the index key.

3. What did you see instead (Required)
The update statement acquires a pessimistic lock for the index key.",Fixed,"5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2",-,https://github.com/pingcap/tidb/pull/36229,2022/7/15,Major,"create table t(id varchar(40), v int, PRIMARY KEY (`id`) clustered, key i2(v))
insert into t values (`123`, 1)
begin pessimistic
update t set v = v + 1 where id = `123`
commit
2. What did you expect to see? (Required)
The update statement is not supposed to lock the index key.

3. What did you see instead (Required)
The update statement acquires a pessimistic lock for the index key.",unspecified,Pessimistic,1,1,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Low performance,Excessive isolation,Major,Yes,Code fix,"5 patches: 3 changed files with 33 additions and 14 deletions
",5,3,33,14,47,11,-,"No, history does not reflect the problem",Yes,"No, unnecessary blocking",,,TiDB_36235
TiDB,35682,https://github.com/pingcap/tidb/issues/35682,Pessimistic transaction may lock unused key as primary when the first DML fails,"/* init */ drop table if exists t, t2;
/* init */ create table t (id int primary key, v int, idx int unique);
/* init */ insert into t values (1, 10, 1), (2, 20, 2);

/* t1 */ begin;
/* t1 */ select @@tidb_current_ts;
/* t2 */ begin;
/* t2 */ update t set v = v + 1 where id = 1;
/* t1 */ set @@innodb_lock_wait_timeout = 3;
-- stmt1:
/* t1 */ select * from t where idx = 1 for update;
/* t1 */ select @@tidb_current_ts;
-- stmt2:
/* t1 */ select * from t where idx = 2 for update;
/* t2 */ commit;

/* t3 */ begin;
-- stmt3:
/* t3 */ select * from t where idx = 1 for update;
/* t3 */ rollback;

/* t1 */ rollback;
2. What did you expect to see? (Required)
In session t1: stmt1 fails due to lock wait timeout, so that the locks on row 1 (and its corresponding index key) should be unlocked.
In session t3: stmt3 should successfully read row1 since nobody should holding its lock.
3. What did you see instead (Required)
The index key (idx = 1) is still locked after stmt1 fails.
Transaction t1`s primary lock is always the index key (idx = 1), so that stmt2 locks the keys of row 2 with the locks` primary pointing to the key (idx = 1) (which can be found via the mvcc http api of TiDB).
stmt3 is blocked by t1 since t1 is still locking index key (idx = 1).
The full output of the above program (expand to view)

The problem doesn`t affect the correctness of the transaction result, However it makes the transaction locks unnecessary keys.",Confirmed,"6.2, 6.3, 6.4, 6.5",-,-,2022/6/23,Major,"/* init */ drop table if exists t, t2;
/* init */ create table t (id int primary key, v int, idx int unique);
/* init */ insert into t values (1, 10, 1), (2, 20, 2);

/* t1 */ begin;
/* t1 */ select @@tidb_current_ts;
/* t2 */ begin;
/* t2 */ update t set v = v + 1 where id = 1;
/* t1 */ set @@innodb_lock_wait_timeout = 3;
-- stmt1:
/* t1 */ select * from t where idx = 1 for update;
/* t1 */ select @@tidb_current_ts;
-- stmt2:
/* t1 */ select * from t where idx = 2 for update;
/* t2 */ commit;

/* t3 */ begin;
-- stmt3:
/* t3 */ select * from t where idx = 1 for update;
/* t3 */ rollback;

/* t1 */ rollback;",unspecified,Pessimistic,1,2,-,-,-,-,3,explicit,7,explicit,3,explicit,3,-,-,-,-,Yes,-,-,-,Yes,Yes,Yes,-,Yes,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,produce lock wait timeout,-,-,Yes,-,-,-,-,-,-,Yes,Low performance,Excessive isolation,Major,"No, unknown",-,-,-,-,-,-,-,-,192,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_35682
TiDB,34978,https://github.com/pingcap/tidb/issues/34978,Undesired error report when schema is changed (not null column is dropped) in rc or for-update-read,"create table t (id int primary key, c int not null)
insert into t values (1, 1), (2, 2)
session 1

begin
session 2

alter table t drop column c
insert into t values
session 1

select * from t for update  // error",Confirmed,"6.2, 6.3, 6.4, 6.5",-,-,2022/5/26,Major,"create table t (id int primary key, c int not null)
insert into t values (1, 1), (2, 2)
session 1

begin
session 2

alter table t drop column c
insert into t values
session 1

select * from t for update  // error",READ COMMITTED,Pessimistic,1,2,-,-,-,-,2,explicit,2,auto,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,NOT NULL,-,Yes,Operation error,Statement correctness: unexpected error,Major,"No, unknown",-,-,-,-,-,-,-,-,220,"No, history does not reflect the problem",Yes,"No, unsupported statements",,,TiDB_34978
TiDB,30361,https://github.com/pingcap/tidb/issues/30361,Unrepeatable read occurs when two transaction are executed,"https://objects.githubusercontent.com/github-production-repository-file-5c1aeb/41986369/7645221?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIWNJYAX4CSVEH53A%2F20220731%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20220731T072555Z&X-Amz-Expires=300&X-Amz-Signature=2209896457f9d97bcdb024b8e70708d856be27a46d3b8d96c448db71790a4a3d&X-Amz-SignedHeaders=host&actor_id=97219834&key_id=0&repo_id=41986369&response-content-disposition=attachment%3Bfilename%3Dmysql_bk.sql.txt&response-content-type=text%2Fplain

T1> start transaction;
T2> start transaction;
T2> select ref_14.c_qpjzzd as c1 from t_q_zw9c as ref_14 order by c1 desc;
T1> delete from t_q_zw9c;
T1> commit;
T2> select ref_14.c_qpjzzd as c1 from t_q_zw9c as ref_14 order by c1 desc;
T2> commit; ",Confirmed,5.4.0-alpha-133-g20b9a4d8c,-,-,2021/12/2,Moderate,"CREATE TABLE `t_q_zw9c` (
  `c_qpjzzd` int(11) NOT NULL,
  `c_1mp0eb` int(11) DEFAULT NULL,
  `c_3dcuc` double DEFAULT NULL,
  PRIMARY KEY (`c_qpjzzd`) /*T![clustered_index] CLUSTERED */
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;
INSERT INTO `t_q_zw9c` VALUES (0,100,38.34);
T1> start transaction;
T2> start transaction;
T2> select ref_14.c_qpjzzd as c1 from t_q_zw9c as ref_14 order by c1 desc;
T1> delete from t_q_zw9c;
T1> commit;
T2> select ref_14.c_qpjzzd as c1 from t_q_zw9c as ref_14 order by c1 desc;
T2> commit; ",REPEATABLE READ,Pessimistic,1,1,-,-,-,-,2,explicit,3,explicit,4,-,-,-,-,-,-,-,Yes,-,-,Yes,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,"using unistore
ENGINE=InnoDB",-,-,-,-,Yes,Yes,-,-,Yes,"NOT NULL
DEFAULT NULL",-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Moderate,"No, unknown",-,-,-,-,-,-,-,-,394,"No, not key-value data structures",Yes,Yes,,,TiDB_30361
TiDB,28212,https://github.com/pingcap/tidb/issues/28212,Weird SELECT view when a record is modified to the same value by two transactions,"/* init */ create table t(a int, b int);
/* init */ insert into t values (0, 0), (1, 1), (2, 2);

/* s1 */ begin;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s2 */ begin;
/* s2 */ update t set a = 10 where b = 1;
/* s2 */ commit;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s1 */ update t set a = 10 where true;
/* s1 */ select * from t;  -- [(10, 0), (1, 1), (10, 2)]
/* s1 */ commit;",Confirmed,5.2.1,-,-,2021/9/19,,"/* init */ create table t(a int, b int);
/* init */ insert into t values (0, 0), (1, 1), (2, 2);

/* s1 */ begin;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s2 */ begin;
/* s2 */ update t set a = 10 where b = 1;
/* s2 */ commit;
/* s1 */ select * from t; -- [(0, 0), (1, 1), (2, 2)]
/* s1 */ update t set a = 10 where true;
/* s1 */ select * from t;  -- [(10, 0), (1, 1), (10, 2)]
/* s1 */ commit;",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,2,explicit,6,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,,"No, undefined semantic",-,-,-,-,-,-,-,-,468,"No, not key-value data structures","No, same behavior",Yes,,,TiDB_28212
TiDB,28095,https://github.com/pingcap/tidb/issues/28095,UPDATE with CAST has inconsistent behaviors in transaction,"/* init */ drop table if exists t;
/* init */ create table t(a varchar(20));
/* init */ insert into t values (`abc`), (`def`);

-- not in transaction
/* s */ update t set a = `test` where cast(a as decimal); -- [1]

-- in transaction
/* s1 */ begin;
/* s1 */ update t set a = `test` where cast(a as decimal); -- [2]

-- in transaction
/* s1 */ begin;
/* s1 */ update t set a = `xyz`;
/* s1 */ update t set a = `test` where cast(a as decimal); -- [3]",Confirmed,5.2.1,-,-,2021/9/16,Minor,"/* init */ drop table if exists t;
/* init */ create table t(a varchar(20));
/* init */ insert into t values (`abc`), (`def`);

-- not in transaction
/* s */ update t set a = `test` where cast(a as decimal); -- [1]

-- in transaction
/* s1 */ begin;
/* s1 */ update t set a = `test` where cast(a as decimal); -- [2]

-- in transaction
/* s1 */ begin;
/* s1 */ update t set a = `xyz`;
/* s1 */ update t set a = `test` where cast(a as decimal); -- [3]",unspecified,Pessimistic,1,2,-,-,-,-,3,auto,1,explicit,2,explicit,3,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Missing error,Statement correctness: missing error,Minor,"No, unknown",-,-,-,-,-,-,-,-,472,"No, not key-value data structures",Yes,Yes,,,TiDB_28095
TiDB,27564,https://github.com/pingcap/tidb/issues/27564,Dangling delete record when deletes your own write in a transaction,"/* test */ drop table if exists t1;
/* test */ create table t1(c_int int, c_str varchar(40), unique key uk(c_int));
/* test */ insert into t1 (`c_int`, `c_str`) values (6, `relaxed chatelet`);
/* test */ begin;
/* test */ update t1 set c_int = c_int + 5, c_str = `dreamy taussig` where (c_int, c_str) in ((6, `frosty hopper`), (6, `funny sutherland`));
/* test */ select c_int from t1;
/* test */ select c_int, c_str from t1;
/* test */ commit;",Confirmed,"4.0, 5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2",-,-,2021/8/25,Moderate,"mysql root@127.0.0.1:test> create table t2 (id varchar(32) not null primary key, a int);
Query OK, 0 rows affected

mysql root@127.0.0.1:test> begin;
Query OK, 0 rows affected

mysql root@127.0.0.1:test> insert into t2 values (2,2);
Query OK, 1 row affected

mysql root@127.0.0.1:test> delete from t2 where id = 2;
Query OK, 1 row affected

mysql root@127.0.0.1:test> commit;
Query OK, 0 rows affected",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,NOT NULL,-,Yes,Incorrect DBMS state,Consistency: DBMS state,Moderate,"No, hard to fix",-,-,-,-,-,-,-,-,494,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, unsupported statements",,,TiDB_27564
TiDB,25176,https://github.com/pingcap/tidb/issues/25176,strange behavior when begin transaction when `tidb_snapshot` is set,"create table test.ttt (id int primary key, a int); 
insert into test.ttt values(1, 1); 
begin;
update test.ttt set a=2 where id=1; --ahother T
do sleep(1);set @@tidb_snapshot=TIMESTAMP(NOW());
select a from test.ttt where id=1;
select a from test.ttt where id=1 for update;
select a from test.ttt where id=1;",Confirmed,,-,-,2021/6/4,Moderate,"s1, and s2 are two tidb connections.

s1                         | s2
create table test.ttt (id int primary key, a int); |
insert into test.ttt values(1, 1);   |
                            | begin;
update test.ttt set a=2 where id=1;  | 
                            | do sleep(1);set @@tidb_snapshot=TIMESTAMP(NOW());
                            | select a from test.ttt where id=1;
                            | select a from test.ttt where id=1 for update;
                            | select a from test.ttt where id=1;",unspecified,Pessimistic,1,1,-,-,-,-,2,auto,1,explicit,5,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,do sleep(1),Yes,-,Yes,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: Incorrect SELECT,Moderate,"No, undefined semantic",-,-,-,-,-,-,-,-,576,Yes,"No, DBMS-specific","No, unsupported statements",,,TiDB_25176
TiDB,24195,https://github.com/pingcap/tidb/issues/24195,Query in transaction may return rows with same unique index column value,"drop table if exists t;
create table t (a int, b int, primary key (a, b) /*T![clustered_index] nonclustered */);
insert into t values (1, 10);
begin optimistic;
insert into t values (1, 10);
select * from t;
commit;",Confirmed,"5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2, 6.3, 6.4, 6.5",-,-,2021/4/22,Major,"drop table if exists t;
create table t (a int, b int, primary key (a, b) /*T![clustered_index] nonclustered */);
insert into t values (1, 10);
begin optimistic;
insert into t values (1, 10);
select * from t;
commit;",unspecified,Optimistic,1,1,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,Yes,Incorrect query result,Consistency: data constraint,Major,"No, hard to fix",-,-,-,-,-,-,-,-,619,"No, not key-value data structures","No, DBMS-specific","No, optimistic transaction mode",,,TiDB_24195
TiDB,22345,https://github.com/pingcap/tidb/issues/22345,Select For Update in decorrelated subquery return WriteConflictError in pessimistic mode,"create table t(id int primary key, v int);
insert into t values(1, 10), (2, 20);

-- txn1: begin pessimistic;
-- txn1: select * from t;
-- txn2: update t set v = v * 10;
-- txn1:  select (select v from t where id = 2 for update) from dual;",Confirmed,,-,-,2021/1/11,Minor,"create table t(id int primary key, v int);
insert into t values(1, 10), (2, 20);

-- txn1: begin pessimistic;
-- txn1: select * from t;
-- txn2: update t set v = v * 10;
-- txn1:  select (select v from t where id = 2 for update) from dual;
2. What did you expect to see? (Required)
last stmt return newest value --- 200, just as normal select v from t where id = 2 for update

3. What did you see instead (Required)
ERROR 9007 (HY000): Write conflict, txnStartTS=422143966855823360, conflictStartTS=422143970145468416, conflictCommitTS=422143970145730560, key={tableID=49, handle=2} primary=[]byte(nil) [try again later]
4. What is your TiDB version? (Required)
master",unspecified,Pessimistic,1,2,-,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Insufficient isolation: Incorrect SELECT,Minor,"No, unknown",-,-,-,-,-,-,-,-,720,Yes,Yes,"No, unsupported statements",,,TiDB_22345
TiDB,21688,https://github.com/pingcap/tidb/issues/21688,Point get may acquire unnecessary locks,"/* init */ drop table if exists t;
/* init */ create table t (k1 int, k2 int, v int, unique key (k1));
/* init */ insert into t values (1, 1, null), (2, 2, 2);

/* t0 */ begin;
/* t1 */ begin;
/* t0 */ update t set v = 10 where (k1, v) in ((1, null)); -- 0 row affected (point get)
/* t1 */ update t set v = 11 where (k1, v) in ((1, null)); -- blocked
/* t0 */ commit;
/* t1 */ commit;",Confirmed,release-4.0,-,-,2020/12/12,Moderate,"/* init */ drop table if exists t;
/* init */ create table t (k1 int, k2 int, v int, unique key (k1));
/* init */ insert into t values (1, 1, null), (2, 2, 2);

/* t0 */ begin;
/* t1 */ begin;
/* t0 */ update t set v = 10 where (k1, v) in ((1, null)); -- 0 row affected (point get)
/* t1 */ update t set v = 11 where (k1, v) in ((1, null)); -- blocked
/* t0 */ commit;
/* t1 */ commit;",unspecified,Pessimistic,1,2,-,-,-,-,2,explicit,3,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,Moderate,"No, undefined semantic",-,-,-,-,-,-,-,-,750,"No, not key-value data structures",Yes,"No, unnecessary blocking",,,TiDB_21688
TiDB,21506,https://github.com/pingcap/tidb/issues/21506, can read latest data even under RR level,"/* init */ drop table if exists t1, t2;
/* init */ create table t1 (id int primary key, v int);
/* init */ create table t2 (id int primary key, v int);
/* init */ insert into t1 values (1, 10), (2, 20);

/* t1 */ set session transaction isolation level repeatable read;
/* t1 */ begin;
/* t1 */ insert into t2 select * from t1;
/* t2 */ update t1 set id = id + 2;
/* t1 */ insert into t2 select * from t1; -- succeed
/* t1 */ select * from t2; -- (1, 10), (2, 20), (3, 10), (4, 20)
/* t1 */ commit;",Confirmed,release-4.0,-,-,2020/12/4,Moderate,"/* init */ drop table if exists t1, t2;
/* init */ create table t1 (id int primary key, v int);
/* init */ create table t2 (id int primary key, v int);
/* init */ insert into t1 values (1, 10), (2, 20);

/* t1 */ set session transaction isolation level repeatable read;
/* t1 */ begin;
/* t1 */ insert into t2 select * from t1;
/* t2 */ update t1 set id = id + 2;
/* t1 */ insert into t2 select * from t1; -- succeed
/* t1 */ select * from t2; -- (1, 10), (2, 20), (3, 10), (4, 20)
/* t1 */ commit;",REPEATABLE READ,Pessimistic,2,2,0,-,-,-,2,explicit,5,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Missing error,Statement correctness: missing error,Moderate,"No, undefined semantic",-,-,-,-,-,-,-,-,758,"No, history does not reflect the problem",Yes,"No, unsupported statements",,,TiDB_21506
TiDB,34289,https://github.com/pingcap/tidb/issues/34289,table schema is different for ,"create table t(id int primary key, v int);
insert into t values(1, 1);
prepare s from `select * from t where id=1 for update`;
begin;
             alter table t add column v2 int; -- in another session
select * from t where id=1 for update;
execute s;",Fixed,https://github.com/pingcap/tidb/commit/dce5064e9e15d0b17c36f73e21fc71bcaa419e90,-,https://github.com/pingcap/tidb/pull/34957,2022/4/27,Moderate,"create table t(id int primary key, v int);
insert into t values(1, 1);
prepare s from `select * from t where id=1 for update`;
begin;
             alter table t add column v2 int; -- in another session
select * from t where id=1 for update;
execute s;",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,PREPARE ...; EXECUTE ...;,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Incorrect query result,Consistency: application state,Moderate,Yes,Code fix,17 patches: 11 changed files with 239 additions and 81 deletions,17,11,239,81,320,30,-,"No, history does not reflect the problem",Yes,"No, unsupported statements",,,TiDB_34289
TiDB,31203,https://github.com/pingcap/tidb/issues/31203,txn: Unexpected transaction behavior when tidb connection got killed.,"# mysql client 1
begin;
update cjl.test set name=`111` where id=1;
# mysql client 2
begin;
update cjl.test set name=`222` where id=1;
# blocked
# mysql client 3
kill tidb <connection id of mysql client 1>;
# mysql client 1
begin;
# > ERROR 2013 (HY000): Lost connection to MySQL server during query
begin;
# > No connection. Trying to reconnect...
# > Connection id:    XXX
# > Current database: *** NONE ***
update cjl.test set name=`111` where id=1;",Fixed,"4.0, 5.0",-,https://github.com/tikv/client-go/pull/417 or https://github.com/pingcap/tidb/pull/33044,2021/12/31,Major,"# mysql client 1
begin;
update cjl.test set name=`111` where id=1;
# mysql client 2
begin;
update cjl.test set name=`222` where id=1;
# blocked
# mysql client 3
kill tidb <connection id of mysql client 1>;
# mysql client 1
begin;
# > ERROR 2013 (HY000): Lost connection to MySQL server during query
begin;
# > No connection. Trying to reconnect...
# > Connection id:    XXX
# > Current database: *** NONE ***
update cjl.test set name=`111` where id=1;",unspecified,Pessimistic,1,1,-,-,-,-,3,explicit,2,explicit,2,explicit,2,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,kill connection,-,-,-,-,-,-,-,-,-,-,Yes,Missing blocking,Insufficient isolation: missing blocking,Major,Yes,Code fix,13 patches: 4 changed files with 64 additions and 15 deletions,13,4,64,15,79,74,-,"No, history does not reflect the problem",Yes,"No, fault injection",,,TiDB_31203
TiDB,30410,https://github.com/pingcap/tidb/issues/30410,Lazy constraint check may cause data inconsistency,"/* t */ drop table if exists t;
/* t */ create table t (c0 int, c1 varchar(20), c2 varchar(20), unique key(c0), key(c2));
/* t */ insert into t (c0, c1, c2) values (1, null, `green`);

/* t */ set tidb_constraint_check_in_place=0;
/* t */ begin optimistic;
/* t */ insert into t (c0, c1, c2) values (1, `red`, `white`);
/* t */ delete from t where c1 is null;
/* t */ update t set c2 = `green` where c2 between `purple` and `white`;
/* t */ commit;
/* t */ admin check table t;",Fixed,"5.0, 5.1, 5.2, 5.3",-,https://github.com/pingcap/tidb/pull/30447,2021/12/4,Critical,"/* t */ drop table if exists t;
/* t */ create table t (c0 int, c1 varchar(20), c2 varchar(20), unique key(c0), key(c2));
/* t */ insert into t (c0, c1, c2) values (1, null, `green`);

/* t */ set tidb_constraint_check_in_place=0;
/* t */ begin optimistic;
/* t */ insert into t (c0, c1, c2) values (1, `red`, `white`);
/* t */ delete from t where c1 is null;
/* t */ update t set c2 = `green` where c2 between `purple` and `white`;
/* t */ commit;
/* t */ admin check table t;",unspecified,Optimistic,1,1,-,-,-,-,2,explicit,5,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Assertion failure,Consistency: DBMS state,Critical,Yes,Code fix,2 patches: 6 changed files with 63 additions and 10 deletions,2,6,63,10,73,17,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_30410
TiDB,29160,https://github.com/pingcap/tidb/issues/29160,Different behaviour among versions when optimistic transaction meets lock of pessimistic transaction,"session 1:

use test;
create table t(id int);
insert into t values (1);
begin; select * from t where id=1 for update;
session 2:

use test;
update t set id=2 where id=1;",Fixed,"5.1, 5.2",-,https://github.com/tikv/client-go/pull/271,2021/10/27,Moderate,"session 1:

use test;
create table t(id int);
insert into t values (1);
begin; select * from t where id=1 for update;
session 2:

use test;
update t set id=2 where id=1;",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,2,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Unnecessarily long blocking,Excessive isolation,Moderate,Yes,Code fix,1 patch: 12 changed files with 65 additions and 35 deletions,1,12,65,35,100,1,-,"No, not key-value data structures",Yes,"No, performance degradation",,,TiDB_29160
TiDB,28073,https://github.com/pingcap/tidb/issues/28073,Invalid keys may get locked,"/* test */ drop table if exists t1, t2;
/* test */ create table t1  (c_int int, c_str varchar(40), primary key (c_int, c_str) , key(c_int)) partition by hash (c_int) partitions 4;
/* test */ create table t2  like t1 ;
/* test */ insert into t1 values (1, `flamboyant mcclintock`);
/* test */ insert into t2 select * from t1 ;
/* test */ begin;
/* test */ insert into t2 (c_int, c_str) values (2, `romantic grothendieck`);
/* test */ select * from t2 left join t1 on t1.c_int = t2.c_int for update;
/* test */ commit;",Fixed,"6.0, 6.1",-,https://github.com/pingcap/tidb/pull/35732,2021/9/16,Moderate,"Execute the following SQL, then query the MVCC of an invalid key 7480000000000000005F728000000000000000.

/* test */ drop table if exists t1, t2;
/* test */ create table t1  (c_int int, c_str varchar(40), primary key (c_int, c_str) , key(c_int)) partition by hash (c_int) partitions 4;
/* test */ create table t2  like t1 ;
/* test */ insert into t1 values (1, `flamboyant mcclintock`);
/* test */ insert into t2 select * from t1 ;
/* test */ begin;
/* test */ insert into t2 (c_int, c_str) values (2, `romantic grothendieck`);
/* test */ select * from t2 left join t1 on t1.c_int = t2.c_int for update;
/* test */ commit;",unspecified,Pessimistic,2,1,1,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,Yes,Yes,Unnecessary blocking,Excessive isolation,Moderate,Yes,Code fix,2 patches: 2 changed files with 33 additions and 0 deletions,2,2,33,0,33,285,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_28073
TiDB,27156,https://github.com/pingcap/tidb/issues/27156,the default value of tidb_partition_prune_mode is set to dynamic,"create table t2(c1 int primary key, c2 int, c3 int, c4 int, key k2(c2), key k3(c3)) partition by hash(c1) partitions 10;
insert into t2 values (1,1,1,1),(2,2,2,2),(3,3,3,3),(4,4,4,4);
/* s1 */ set autocommit = 0;
/* s1 */ set innodb_lock_wait_timeout = 0;
/* s1 */ set tidb_txn_mode = pessimistic;

/* s2 */ set autocommit = 0;
/* s2 */ set innodb_lock_wait_timeout = 0;
/* s2 */ set tidb_txn_mode = pessimistic;

/* s3 */ set autocommit = 0;
/* s3 */ set tidb_txn_mode = optimistic;

/* s1 */ select * from t2 where c4 > 2 for update;

/* s2 */ insert into t2 values(5,5,5,5);
/* s2 */ update t2 set c4 = c4 + 1 where c3 = 3; 
/* s2 */ select c1, c3 from t2 where c3 = 4 for update nowait;

/* s3 */ update t2 set c4 = c4 * 10 where c4 = 4;
/* s1 */ commit; 
/* s3 */ commit; ---check",Fixed,5.2.0-alpha-597-g26237b35f,-,https://github.com/tikv/pd/pull/3999,2021/8/12,Major,"create table t2(c1 int primary key, c2 int, c3 int, c4 int, key k2(c2), key k3(c3)) partition by hash(c1) partitions 10;
insert into t2 values (1,1,1,1),(2,2,2,2),(3,3,3,3),(4,4,4,4);
/* s1 */ set autocommit = 0;
/* s1 */ set innodb_lock_wait_timeout = 0;
/* s1 */ set tidb_txn_mode = pessimistic;

/* s2 */ set autocommit = 0;
/* s2 */ set innodb_lock_wait_timeout = 0;
/* s2 */ set tidb_txn_mode = pessimistic;

/* s3 */ set autocommit = 0;
/* s3 */ set tidb_txn_mode = optimistic;

/* s1 */ select * from t2 where c4 > 2 for update;

/* s2 */ insert into t2 values(5,5,5,5);
/* s2 */ update t2 set c4 = c4 + 1 where c3 = 3; 
/* s2 */ select c1, c3 from t2 where c3 = 4 for update nowait;

/* s3 */ update t2 set c4 = c4 * 10 where c4 = 4;
/* s1 */ commit; 
/* s3 */ commit; ---check",unspecified,Both,1,4,-,-,-,-,3,explicit,5,explicit,6,explicit,4,-,-,-,-,-,-,-,Yes,Yes,-,-,-,Yes,Yes,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,Yes,Yes,Missing error,Statement correctness: missing error,Major,Yes,Code fix,8 patches: 11 changed files with 162 additions and 27 deletions,8,11,162,27,189,6,-,"No, not key-value data structures","No, DBMS-specific","No, more than two transactions",,,TiDB_27156
TiDB,26973,https://github.com/pingcap/tidb/issues/26973,key_info in DEADLOCKS table do not parse db_name and table_name when transaction use partition table ,"create table t (a int primary key, b int) partition by range(a) (PARTITION p0 VALUES LESS THAN (2), PARTITION p1 VALUES LESS THAN (4));
insert into t values (1, 10), (2, 20), (3, 30);
/* tx1 / begin;
/ tx2 / begin;
/ tx1 / update t set a=10 where a=1;
/ tx2 / update t set b=11 where a=2;
/ tx1 / update t set b=12 where a=2; --block
/ tx2 / update t set b=13 where a=1; --dead lock found
/ tx1 */ select * from DEADLOCKS\G ---check result",Fixed,5.2.0-alpha-529-g1a54708a7,-,https://github.com/pingcap/tidb/pull/27027,2021/8/6,Moderate,"create table t (a int primary key, b int) partition by range(a) (PARTITION p0 VALUES LESS THAN (2), PARTITION p1 VALUES LESS THAN (4));
insert into t values (1, 10), (2, 20), (3, 30);
/* tx1 / begin;
/ tx2 / begin;
/ tx1 / update t set a=10 where a=1;
/ tx2 / update t set b=11 where a=2;
/ tx1 / update t set b=12 where a=2; --block
/ tx2 / update t set b=13 where a=1; --dead lock found
/ tx1 */ select * from DEADLOCKS\G ---check result",unspecified,Pessimistic,1,3,-,-,-,-,3,explicit,3,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,Yes,Incorrect DBMS state,Consistency: DBMS state,Moderate,Yes,Code fix,5 patches: 2 changed files with 111 additions and 19 deletions,5,2,111,19,130,3,-,"No, history does not reflect the problem","No, DBMS-specific","No, unsupported statements",,,TiDB_26973
TiDB,26251,https://github.com/pingcap/tidb/issues/26251,Join partition table with normal table for update should lock normal table but not,"Prepare:

create table tp (id int primary key) partition by range (id) (partition p0 values less than (100));
create table tn (id int primary key);
insert into tp values(1),(2);
insert into tn values(1),(2);
Session1:

begin;
select * from tp,tn where tp.id=tn.id and tn.id<=1 for update;
Session2:

begin;
select * from tn where id=1 for update;",Fixed,,-,https://github.com/pingcap/tidb/pull/26380,2021/7/14,Critical,"Prepare:
create table tp (id int primary key) partition by range (id) (partition p0 values less than (100));
create table tn (id int primary key);
insert into tp values(1),(2);
insert into tn values(1),(2);

Session1:
begin;
select * from tp,tn where tp.id=tn.id and tn.id<=1 for update;

Session2:
begin;
select * from tn where id=1 for update;

Expected:
Session2 should be blocked util session1`s txn is committed or aborted.

Instead:
Session2 not blocked.
",unspecified,Pessimistic,2,2,2,-,-,-,2,explicit,2,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,Yes,Missing blocking,Insufficient isolation: missing blocking,Critical,Yes,Code fix,6 patches: 2 changed files with 35 additions and 2 deletions,6,2,35,2,37,7,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,TiDB_26251
TiDB,26203,https://github.com/pingcap/tidb/issues/26203,Data may be lost when changing column type with tidb_enable_amend_pessimistic_txn=on ,"set global tidb_enable_amend_pessimistic_txn=ON;
CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL
);

insert into t many rows (about 1 000 000)

                                    /* txn */ begin pessimistic;
                                    /* txn */ insert into t values (52000002, 502);
/* DDL */ alter table t change column b b smallint;
                                    /* txn  during DDL */  commit;
/* DDL */ finish DDL
mysql> select * from t where a=52000002;
+----------+------+
| a        | b    |
+----------+------+
| 52000002 | NULL |
+----------+------+
1 row in set (0.00 sec)",Fixed,,-,https://github.com/pingcap/tidb/pull/26269,2021/7/13,Critical,"set global tidb_enable_amend_pessimistic_txn=ON;
CREATE TABLE `t` (
  `a` int(11) DEFAULT NULL,
  `b` int(11) DEFAULT NULL
);

insert into t many rows (about 1 000 000)

                             /* txn */ begin pessimistic;
                            /* txn */ insert into t values (52000002, 502);
/* DDL */ alter table t change column b b smallint;
                            /* txn  during DDL */  commit;
/* DDL */ finish DDL
mysql> select * from t where a=52000002;
+----------+------+
| a        | b    |
+----------+------+
| 52000002 | NULL |
+----------+------+
1 row in set (0.00 sec)
b value should be 502",unspecified,Pessimistic,1,1000000,-,-,-,-,2,auto,2,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,set global tidb_enable_amend_pessimistic_txn=ON;,-,-,-,-,-,-,-,-,-,DEFAULT NULL,-,Yes,Incorrect database state,Consistency: application state,Critical,Yes,Code fix,4 patches: 2 changed files with 72 additions and 1 deletions,4,2,72,1,73,2,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_26203
TiDB,23380,https://github.com/pingcap/tidb/issues/23380,processlist.txnstart is missing when tidb_snapshot is set,"set tidb_snapshot=now();
begin;
select txnstart from information_schema.processlist; -- should not be empty",Fixed,https://github.com/pingcap/tidb/commit/9c48b24cb108d8239534730961a17aa66cfbf36b,-,https://github.com/pingcap/tidb/pull/23381,2021/3/17,Moderate,"set tidb_snapshot=now();
begin;
select txnstart from information_schema.processlist;

2. What did you expect to see? (Required)
mysql> set tidb_snapshot = now();
Query OK, 0 rows affected (0.02 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select txnstart from information_schema.processlist;
+----------------------------------------+
| txnstart                               |
+----------------------------------------+
| 03-17 20:04:30.000(423620161044480000) |
+----------------------------------------+
1 row in set (0.00 sec)
3. What did you see instead (Required)
mysql> set tidb_snapshot = now();
Query OK, 0 rows affected (0.07 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> select txnstart from information_schema.processlist;
+----------+
| txnstart |
+----------+
|          |
+----------+
1 row in set (0.00 sec)",unspecified,Pessimistic,0,-,-,-,-,-,1,explicit,2,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,set tidb_snapshot=now();,-,-,-,-,-,-,-,Yes,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,Moderate,Yes,Code fix,3 patches: 1 changed files with 5 additions and 0 deletions,3,1,5,0,5,1,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_23380
TiDB,23753,https://github.com/pingcap/tidb/issues/23753,panic in 2pc pessimisticLockMutations,"CREATE TABLE `t1` (   `col_27` double DEFAULT `759.3040284831991`,   `col_28` timestamp NOT NULL,   PRIMARY KEY (`col_28`) /*T![clustered_index] NONCLUSTERED */ ,   UNIQUE KEY `idx_19` (`col_28`) );
insert into t1(col_27, col_28) values(22, `2001-01-01 01:01:01`);
begin pessimistic;
update t1 set col_27 = `Alice` where col_28 in ( 949052690658455488 , 2766751491589624232 , 7802933885825354133 , 6855494379247880947 , 1920897000945502381 ) ;

2. What did you expect to see? (Required)
success

3. What did you see instead (Required)
paniced

""connection running loop panic""] [conn=5] [lastSQL=""update t1 set col_27 = `Alice` where col_28 in ( 949052690658455488 , 2766751491589624232 , 7802933885825354133 , 6855494379247880947 , 1920897000945502381 )""] [err=""runtime error: invalid memory address or nil pointer dereference""] [stack=""goroutine 552 [running]:\ngithub.com/pingcap/tidb/server.(*clientConn).Run.func1(0x10255d598, 0x1400fc107e0, 0x1400f832800)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/server/conn.go:734 +0xcc\npanic(0x10210d0c0, 0x103d816c0)\n\t/usr/local/go/src/runtime/panic.go:965 +0x14c\ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec.func1(0x1401089f6b0, 0x1401050eb30, 0x1401050eb10)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/adapter.go:301 +0x398\npanic(0x10210d0c0, 0x103d816c0)\n\t/usr/local/go/src/runtime/panic.go:965 +0x14c\ngithub.com/pingcap/tidb/store/tikv.(*memBufferMutations).GetKey(...)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:127\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).primary(0x140109da3c0, 0x3ff0000000000000, 0x14000551e60, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:430 +0x34\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).doActionOnGroupMutations(0x140109da3c0, 0x1401093f800, 0x102550dd0, 0x140108b0540, 0x14010954a20, 0x1, 0x1, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:552 +0xc4\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).doActionOnMutations(0x140109da3c0, 0x1401093f800, 0x102550dd0, 0x140108b0540, 0x102578728, 0x140109f2b40, 0x1020b4701, 0x140109f2b40)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:493 +0xdc\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).pessimisticLockMutations(0x140109da3c0, 0x1401093f800, 0x140108b0540, 0x102578728, 0x140109f2b40, 0x1, 0x140003b7300)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/pessimistic.go:254 +0x58\ngithub.com/pingcap/tidb/store/tikv.(*KVTxn).LockKeys(0x140109f6000, 0x10255d598, 0x140109549c0, 0x140108b0540, 0x140109c0f30, 0x1, 0x1, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/txn.go:455 +0x448\ngithub.com/pingcap/tidb/store/driver/txn.(*tikvTxn).LockKeys(0x140109d07e0, 0x10255d598, 0x140109549c0, 0x140108b0540, 0x140109c0f30, 0x1, 0x1, 0x1021229e0, 0x10210a420)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/driver/txn/txn_driver.go:56 +0x5c\ngithub.com/pingcap/tidb/executor.doLockKeys(0x10255d598, 0x14010954570, 0x102598bc8, 0x1400fa99e00, 0x140108b0540, 0x140109c0f30, 0x1, 0x1, 0x0, 0x140109d09e0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/executor.go:999 +0x18c\ngithub.com/pingcap/tidb/executor.LockKeys(0x10255d598, 0x14010954570, 0x102598bc8, 0x1400fa99e00, 0xc350, 0x140109c0f30, 0x1, 0x1, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/batch_point_get.go:407 +0xb8\ngithub.com/pingcap/tidb/executor.(*BatchPointGetExec).initialize(0x140009bf520, 0x10255d598, 0x14010954570, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/batch_point_get.go:351 +0xae0\ngithub.com/pingcap/tidb/executor.(*BatchPointGetExec).Next(0x140009bf520, 0x10255d598, 0x14010954570, 0x140109ecbe0, 0x1401050e318, 0x1009e611c)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/batch_point_get.go:160 +0x238\ngithub.com/pingcap/tidb/executor.Next(0x10255d598, 0x14010954570, 0x102561458, 0x140009bf520, 0x140109ecbe0, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/executor.go:277 +0x230\ngithub.com/pingcap/tidb/executor.(*UpdateExec).updateRows(0x1401099f380, 0x10255d598, 0x14010954570, 0x0, 0x0, 0x114cfc200)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/update.go:251 +0x5f8\ngithub.com/pingcap/tidb/executor.(*UpdateExec).Next(0x1401099f380, 0x10255d598, 0x14010954570, 0x140109ecb90, 0x14000581680, 0x1000fc4f8)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/update.go:219 +0x5c\ngithub.com/pingcap/tidb/executor.Next(0x10255d598, 0x14010954570, 0x102562558, 0x1401099f380, 0x140109ecb90, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/executor.go:277 +0x230\ngithub.com/pingcap/tidb/executor.(*ExecStmt).handleNoDelayExecutor(0x1401089f6b0, 0x10255d598, 0x14010954570, 0x102562558, 0x1401099f380, 0x0, 0x0, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/adapter.go:536 +0x240""]
",Fixed,,-,https://github.com/pingcap/tidb/pull/23774,2021/3/31,Major,"CREATE TABLE `t1` (   `col_27` double DEFAULT `759.3040284831991`,   `col_28` timestamp NOT NULL,   PRIMARY KEY (`col_28`) /*T![clustered_index] NONCLUSTERED */ ,   UNIQUE KEY `idx_19` (`col_28`) );
insert into t1(col_27, col_28) values(22, `2001-01-01 01:01:01`);
begin pessimistic;
update t1 set col_27 = `Alice` where col_28 in ( 949052690658455488 , 2766751491589624232 , 7802933885825354133 , 6855494379247880947 , 1920897000945502381 ) ;

2. What did you expect to see? (Required)
success

3. What did you see instead (Required)
paniced

""connection running loop panic""] [conn=5] [lastSQL=""update t1 set col_27 = `Alice` where col_28 in ( 949052690658455488 , 2766751491589624232 , 7802933885825354133 , 6855494379247880947 , 1920897000945502381 )""] [err=""runtime error: invalid memory address or nil pointer dereference""] [stack=""goroutine 552 [running]:\ngithub.com/pingcap/tidb/server.(*clientConn).Run.func1(0x10255d598, 0x1400fc107e0, 0x1400f832800)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/server/conn.go:734 +0xcc\npanic(0x10210d0c0, 0x103d816c0)\n\t/usr/local/go/src/runtime/panic.go:965 +0x14c\ngithub.com/pingcap/tidb/executor.(*ExecStmt).Exec.func1(0x1401089f6b0, 0x1401050eb30, 0x1401050eb10)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/adapter.go:301 +0x398\npanic(0x10210d0c0, 0x103d816c0)\n\t/usr/local/go/src/runtime/panic.go:965 +0x14c\ngithub.com/pingcap/tidb/store/tikv.(*memBufferMutations).GetKey(...)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:127\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).primary(0x140109da3c0, 0x3ff0000000000000, 0x14000551e60, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:430 +0x34\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).doActionOnGroupMutations(0x140109da3c0, 0x1401093f800, 0x102550dd0, 0x140108b0540, 0x14010954a20, 0x1, 0x1, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:552 +0xc4\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).doActionOnMutations(0x140109da3c0, 0x1401093f800, 0x102550dd0, 0x140108b0540, 0x102578728, 0x140109f2b40, 0x1020b4701, 0x140109f2b40)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/2pc.go:493 +0xdc\ngithub.com/pingcap/tidb/store/tikv.(*twoPhaseCommitter).pessimisticLockMutations(0x140109da3c0, 0x1401093f800, 0x140108b0540, 0x102578728, 0x140109f2b40, 0x1, 0x140003b7300)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/pessimistic.go:254 +0x58\ngithub.com/pingcap/tidb/store/tikv.(*KVTxn).LockKeys(0x140109f6000, 0x10255d598, 0x140109549c0, 0x140108b0540, 0x140109c0f30, 0x1, 0x1, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/tikv/txn.go:455 +0x448\ngithub.com/pingcap/tidb/store/driver/txn.(*tikvTxn).LockKeys(0x140109d07e0, 0x10255d598, 0x140109549c0, 0x140108b0540, 0x140109c0f30, 0x1, 0x1, 0x1021229e0, 0x10210a420)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/store/driver/txn/txn_driver.go:56 +0x5c\ngithub.com/pingcap/tidb/executor.doLockKeys(0x10255d598, 0x14010954570, 0x102598bc8, 0x1400fa99e00, 0x140108b0540, 0x140109c0f30, 0x1, 0x1, 0x0, 0x140109d09e0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/executor.go:999 +0x18c\ngithub.com/pingcap/tidb/executor.LockKeys(0x10255d598, 0x14010954570, 0x102598bc8, 0x1400fa99e00, 0xc350, 0x140109c0f30, 0x1, 0x1, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/batch_point_get.go:407 +0xb8\ngithub.com/pingcap/tidb/executor.(*BatchPointGetExec).initialize(0x140009bf520, 0x10255d598, 0x14010954570, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/batch_point_get.go:351 +0xae0\ngithub.com/pingcap/tidb/executor.(*BatchPointGetExec).Next(0x140009bf520, 0x10255d598, 0x14010954570, 0x140109ecbe0, 0x1401050e318, 0x1009e611c)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/batch_point_get.go:160 +0x238\ngithub.com/pingcap/tidb/executor.Next(0x10255d598, 0x14010954570, 0x102561458, 0x140009bf520, 0x140109ecbe0, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/executor.go:277 +0x230\ngithub.com/pingcap/tidb/executor.(*UpdateExec).updateRows(0x1401099f380, 0x10255d598, 0x14010954570, 0x0, 0x0, 0x114cfc200)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/update.go:251 +0x5f8\ngithub.com/pingcap/tidb/executor.(*UpdateExec).Next(0x1401099f380, 0x10255d598, 0x14010954570, 0x140109ecb90, 0x14000581680, 0x1000fc4f8)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/update.go:219 +0x5c\ngithub.com/pingcap/tidb/executor.Next(0x10255d598, 0x14010954570, 0x102562558, 0x1401099f380, 0x140109ecb90, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/executor.go:277 +0x230\ngithub.com/pingcap/tidb/executor.(*ExecStmt).handleNoDelayExecutor(0x1401089f6b0, 0x10255d598, 0x14010954570, 0x102562558, 0x1401099f380, 0x0, 0x0, 0x0, 0x0)\n\t/Users/robi/Code/go/src/github.com/pingcap/tidb/executor/adapter.go:536 +0x240""]
",unspecified,Pessimistic,1,1,-,-,-,-,1,explicit,2,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,"NOT NULL
DEFAULT `759.3040284831991`",-,Yes,Assertion failure,Statement correctness: unexpected error,Major,Yes,Code fix,6 patches: 2 changed files with 4 additions and 0 deletions,6,2,4,0,4,1,-,"No, history does not reflect the problem","No, DBMS-specific",Yes,,,TiDB_23753
TiDB,23363,https://github.com/pingcap/tidb/issues/23363,Risk of breaking consistency when changing column from null to not null,"Initial table:

CREATE TABLE t (id INT PRIMARY KEY, v INT);
INSERT INTO t VALUES (0, 0);
Change the value to NULL and change the value to not null concurrently.

-- Session 1
BEGIN;

-- Session 2 (Concurrently)
ALTER TABLE t MODIFY COLUMN v INT NOT NULL;

-- Session 1 (Concurrently)
UPDATE t SET v = NULL WHERE ID = 0;
COMMIT;

2. What did you expect to see? (Required)
Either the DDL or the transaction fails.

3. What did you see instead (Required)
I think it is possible that both the DDL and the transaction succeed. Because under async commit, there is no check after the not null flag is added.

Then, the table contains NULL, but the column schema is NOT NULL.",Fixed,5.0/nightly,-,https://github.com/pingcap/tidb/pull/23364,2021/3/17,Critical,"Initial table:

CREATE TABLE t (id INT PRIMARY KEY, v INT);
INSERT INTO t VALUES (0, 0);
Change the value to NULL and change the value to not null concurrently.

-- Session 1
BEGIN;

-- Session 2 (Concurrently)
ALTER TABLE t MODIFY COLUMN v INT NOT NULL;

-- Session 1 (Concurrently)
UPDATE t SET v = NULL WHERE ID = 0;
COMMIT;

2. What did you expect to see? (Required)
Either the DDL or the transaction fails.

3. What did you see instead (Required)
I think it is possible that both the DDL and the transaction succeed. Because under async commit, there is no check after the not null flag is added.

Then, the table contains NULL, but the column schema is NOT NULL.",unspecified,Pessimistic,1,1,-,-,-,-,2,auto,1,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,using async-commit,-,-,-,-,Yes,-,-,-,-,-,-,"No, need control",Missing error,Statement correctness: missing error,Critical,Yes,Code fix,13 patches: 4 changed files with 24 additions and 11 deletions,13,4,24,11,35,2,-,"No, history does not reflect the problem","No, DBMS-specific","No, unsupported statements",,,TiDB_23363
TiDB,23179,https://github.com/pingcap/tidb/issues/23179,point-get + pessimistic txn + overflow in secondary index may panic,"drop table if exists t;
create table t(pk int primary key nonclustered, v int);
begin pessimistic;
update t set v = 100 where pk = -6998312345957040127;

2. What did you expect to see? (Required)
update success

3. What did you see instead (Required)
ERROR 1105 (HY000): runtime error: invalid memory address or nil pointer dereference",Fixed,4.0.11-15-g5c1f32881,-,https://github.com/pingcap/tidb/pull/23188,2021/3/8,Critical,"drop table if exists t;
create table t(pk int primary key nonclustered, v int);
begin pessimistic;
update t set v = 100 where pk = -6998312345957040127;

2. What did you expect to see? (Required)
update success

3. What did you see instead (Required)
ERROR 1105 (HY000): runtime error: invalid memory address or nil pointer dereference",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,2,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,Critical,Yes,Code fix,11 patches: 2 changed files with 10 additions and 0 deletions,11,2,10,0,10,1,-,"No, history does not reflect the problem","No, DBMS-specific",Yes,,,TiDB_23179
TiDB,22658,https://github.com/pingcap/tidb/issues/22658,read only transactions are read/write,"drop table if exists t1;
CREATE TABLE t1 (a int);
start transaction read only;
insert into t1 values (1);

2. What did you expect to see? (Required)
..
mysql [localhost:8023] {msandbox} (test) > start transaction read only;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:8023] {msandbox} (test) > insert into t1 values (1);
ERROR 1792 (25006): Cannot execute statement in a READ ONLY transaction.
3. What did you see instead (Required)
..
mysql> start transaction read only;
Query OK, 0 rows affected (0.00 sec)

mysql> insert into t1 values (1);
Query OK, 1 row affected (0.00 sec)",Fixed,4.0.0-beta.2-2088-gf6a609f2f-dirty,-,https://github.com/pingcap/tidb/pull/23818,2021/2/2,Major,"drop table if exists t1;
CREATE TABLE t1 (a int);
start transaction read only;
insert into t1 values (1);

2. What did you expect to see? (Required)
..
mysql [localhost:8023] {msandbox} (test) > start transaction read only;
Query OK, 0 rows affected (0.00 sec)

mysql [localhost:8023] {msandbox} (test) > insert into t1 values (1);
ERROR 1792 (25006): Cannot execute statement in a READ ONLY transaction.
3. What did you see instead (Required)
..
mysql> start transaction read only;
Query OK, 0 rows affected (0.00 sec)

mysql> insert into t1 values (1);
Query OK, 1 row affected (0.00 sec)",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,2,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Missing error,Read-only constraint,Major,Yes,Code fix,20 patches: 7 changed files with 186 additions and 50 deletions,20,7,186,50,236,72,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,TiDB_22658
TiDB,21722,https://github.com/pingcap/tidb/issues/21722,execute DDL statement in transaction reports `invalid transaction`,"drop table if exists t;
create table t (c_int int, c_str varchar(40));
insert into t values (1, `quizzical hofstadter`);
begin;
select c_int from t where c_str is not null for update;
alter table t add index idx_4 (c_str);

2. What did you expect to see? (Required)
Query OK, 0 rows affected
3. What did you see instead (Required)
ERROR 8024 (HY000): invalid transaction",Fixed,https://github.com/pingcap/tidb/commit/49b926ede766b316cc42bdf40d9ada37deb67968,-,https://github.com/pingcap/tidb/pull/21837,2020/12/14,Moderate,"drop table if exists t;
create table t (c_int int, c_str varchar(40));
insert into t values (1, `quizzical hofstadter`);
begin;
select c_int from t where c_str is not null for update;
alter table t add index idx_4 (c_str);

2. What did you expect to see? (Required)
Query OK, 0 rows affected
3. What did you see instead (Required)
ERROR 8024 (HY000): invalid transaction",unspecified,Pessimistic,1,1,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,Moderate,Yes,Code fix,5 patches: 3 changed files with 27 additions and 15 deletions,5,3,27,15,42,3,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_21722
TiDB,21658,https://github.com/pingcap/tidb/issues/21658,Queries using batch point get plan may be blocked when encounters locks of another alive transaction,"create table t (id int primary key, v int);
insert into t values (0, 0), (1, 10), (2, 20), (3, 30);
set transaction isolation level read commited; begin pessimistic;  
select id, v from t where id = 1 or id = 2 or id = 3 order by id;
begin pessimistic;  --t2
update t set v = v + 1 where id = 0; --t2
update t set v = v + 1 where id > 0; --t2
commit --t2
select id, v from t where id = 1 or id = 2 or id = 3 order by id; 
2. What did you expect to see? (Required)
In the last step above, session 1`s transaction should push session2`s transaction`s min_commit_ts, and continue reading the old data bypassing the locks.

3. What did you see instead (Required)
Session 1 blocked and reports timeout error:",Fixed,https://github.com/pingcap/tidb/commit/ba9789eed17cc9351b71b3507a3f0e4c23efc28b,-,https://github.com/tikv/tikv/pull/9319,2020/12/11,Major,"create table t (id int primary key, v int);
insert into t values (0, 0), (1, 10), (2, 20), (3, 30);
set transaction isolation level read commited; 
begin pessimistic;  
select id, v from t where id = 1 or id = 2 or id = 3 order by id;
begin pessimistic;  --t2
update t set v = v + 1 where id = 0; --t2
update t set v = v + 1 where id > 0; --t2
commit --t2
select id, v from t where id = 1 or id = 2 or id = 3 order by id; 
2. What did you expect to see? (Required)
In the last step above, session 1`s transaction should push session2`s transaction`s min_commit_ts, and continue reading the old data bypassing the locks.

3. What did you see instead (Required)
Session 1 blocked and reports timeout error:",ALL,Pessimistic,1,4,-,-,-,-,2,explicit,3,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Enable failpoint,-,-,Yes,-,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,Major,Yes,Code fix,2 patches: 2 changed files with 17 additions and 17 deletions,2,2,17,17,34,13,-,"No, history does not reflect the problem","No, DBMS-specific","No, unnecessary blocking",,,TiDB_21658
TiDB,21618,https://github.com/pingcap/tidb/issues/21618,*: pessimistic lock doesn`t work on the partition for subquery/joins,"create table t (c_int int, d_int int, primary key (c_int), key(d_int)) partition by hash (c_int) partitions 4 ;
insert into t values (1, 2);

(session 1)
begin pessimistic;
select * from t where d_int in (select d_int from t where c_int = 1) for update;

(session 2)
begin pessimistic;
select * from t where d_int = 2 for update;
2. What did you expect to see? (Required)
Session 1 and session 2 tries to acquire the lock for the same record, so one of them should be blocked and waited for the lock.

3. What did you see instead (Required)
Neither select ... for update is blocked.",Fixed,,-,https://github.com/pingcap/tidb/pull/21148,2020/12/9,Major,"create table t (c_int int, d_int int, primary key (c_int), key(d_int)) partition by hash (c_int) partitions 4 ;
insert into t values (1, 2);

(session 1)
begin pessimistic;
select * from t where d_int in (select d_int from t where c_int = 1) for update;

(session 2)
begin pessimistic;
select * from t where d_int = 2 for update;
2. What did you expect to see? (Required)
Session 1 and session 2 tries to acquire the lock for the same record, so one of them should be blocked and waited for the lock.

3. What did you see instead (Required)
Neither select ... for update is blocked.",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,2,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,Yes,Yes,Missing blocking,Insufficient isolation: missing blocking,Major,Yes,Code fix,20 patches: 13 changed files and 370 additions and 45 deletions,20,13,370,45,415,189,-,"No, history does not reflect the problem",Yes,"No, unsupported statements",,,TiDB_21618
TiDB,21498,https://github.com/pingcap/tidb/issues/21498,RC transactions may see inconsistent data when there are concurrent DDLs,"create table t (id int primary key, v int, index iv (v));
insert into t values (1, 10), (2, 20), (3, 30), (4, 40);
set transaction isolation level read committed; begin;
explain select * from t where v = 10;
select * from t where v = 10;
 alter table t drop index iv; -- s2
 update t set v = 11 where id = 1; -- s2
explain select * from t where v = 10;
select * from t where v = 10;
select * from t where id = 1; --  (1, 11)
select * from t where v = 10; should return empty result;",Fixed,https://github.com/pingcap/tidb/commit/3a32bd2df58d3f85504b8f928c70787ced75333a,-,https://github.com/pingcap/tidb/pull/22152,2020/12/4,Critical,"create table t (id int primary key, v int, index iv (v));
insert into t values (1, 10), (2, 20), (3, 30), (4, 40);
set transaction isolation level read committed; 
begin;
explain select * from t where v = 10;
select * from t where v = 10;
 alter table t drop index iv; -- s2
 update t set v = 11 where id = 1; -- s2
explain select * from t where v = 10;
select * from t where v = 10;
select * from t where id = 1; --  (1, 11)
select * from t where v = 10; should return empty result;",ALL,Pessimistic,1,4,-,-,-,-,2,auto,2,explicit,6,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Critical,Yes,Code fix,9 patches: 6 changed files with 292 additions and 9 deletions,9,6,292,9,301,39,-,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, unsupported statements",,,TiDB_21498
TiDB,21470,https://github.com/pingcap/tidb/issues/21470,Amending transaction accepts DDLs that changes column types but gives wrong result,"set @@global.tidb_enable_change_column_type=true;
create table t (id int primary key, v varchar(10));
begin;  
insert into t values (1, ""123456789"");
alter table t modify column v varchar(5);  -- s2
commit;  
select * from t;
2. What did you expect to see? (Required)
Transaction on session 1 fails, either because not support by amend txn or value of v too long.

3. What did you see instead (Required)
v = NULL in the final result.",Fixed,https://github.com/pingcap/tidb/commit/c9288d246c99073ff04304363dc7234d9caa5090,-,https://github.com/pingcap/tidb/pull/22150,2020/12/3,Major,"set @@global.tidb_enable_change_column_type=true;
create table t (id int primary key, v varchar(10));
begin;  
insert into t values (1, ""123456789"");
alter table t modify column v varchar(5);  -- s2
commit;  
select * from t;
2. What did you expect to see? (Required)
Transaction on session 1 fails, either because not support by amend txn or value of v too long.

3. What did you see instead (Required)
v = NULL in the final result.",unspecified,Pessimistic,1,0,-,-,-,-,3,auto,1,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,set @@global.tidb_enable_change_column_type=true;,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Missing error,Statement correctness: missing error,Major,Yes,Code fix,4 patches: 2 changed files with 30 additions and 2 deletions,4,2,30,2,32,34,-,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, unsupported statements",,,TiDB_21470
TiDB,21447,https://github.com/pingcap/tidb/issues/21447,txn: read using different executors in transaction result in different results,"/* init */ drop table if exists t1;
/* init */ CREATE TABLE `t1` ( `id` int(11) primary key, `name` varchar(20) DEFAULT NULL );
/* init */ insert into t1 values(1,`abc`);

/* t1 */ begin;
/* t2 */ begin;
/* t2 */ select * from t1 where id  = 1; -- the result is ""1 abc"" before the update commit in t1
/* t1 */ UPDATE t1 SET name=`xyz` ;
/* t1 */ commit;
/* t2 */ UPDATE t1 SET name=`xyz` ; -- update the same row with same value using table scan
/* t2 */ select * from t1;               -- the result is ""1, abc""
/* t2 */ select * from t1 where id = 1 ; -- the result is ""1, abc"", same with previous result, should be incorrect
/* t2 */ commit;",Fixed,release-4.0,-,https://github.com/pingcap/tidb/pull/21529,2020/12/3,Critical,"/* init */ drop table if exists t1;
/* init */ CREATE TABLE `t1` ( `id` int(11) primary key, `name` varchar(20) DEFAULT NULL );
/* init */ insert into t1 values(1,`abc`);

/* t1 */ begin;
/* t2 */ begin;
/* t2 */ select * from t1 where id  = 1; -- the result is ""1 abc"" before the update commit in t1
/* t1 */ UPDATE t1 SET name=`xyz` ;
/* t1 */ commit;
/* t2 */ UPDATE t1 SET name=`xyz` ; -- update the same row with same value using table scan
/* t2 */ select * from t1;               -- the result is ""1, abc""
/* t2 */ select * from t1 where id = 1 ; -- the result is ""1, abc"", same with previous result, should be incorrect
/* t2 */ commit;",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,3,explicit,6,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,DEFAULT NULL,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Critical,Yes,Code fix,5 patches: 3 changed files with 35 additions and 5 deletions,5,3,35,5,40,4,-,Yes,Yes,Yes,,,TiDB_21447
TiDB,21284,https://github.com/pingcap/tidb/issues/21284,transaction retry may cause panic,"/*txn1*/drop table if exists t;
/*txn1*/create table t (a int);
/*txn1*/insert into t values (1);
/*txn1*/set @@tidb_disable_txn_auto_retry=0;
/*txn1*/set autocommit=0;
/*txn1*/select * from t;
/*txn1*/SET SQL_SELECT_LIMIT=DEFAULT;
/*txn2*/update t set a=2;
/*txn1*/update t set a=3;
/*txn1*/commit;
2. What did you expect to see? (Required)
Commit successfully.

3. What did you see instead (Required)
ERROR 1105 (HY000): runtime error: invalid memory address or nil pointer dereference",Fixed,4,-,https://github.com/pingcap/tidb/pull/21285,2020/11/25,Major,"/*txn1*/drop table if exists t;
/*txn1*/create table t (a int);
/*txn1*/insert into t values (1);
/*txn1*/set @@tidb_disable_txn_auto_retry=0;
/*txn1*/set autocommit=0;
/*txn1*/select * from t;
/*txn1*/SET SQL_SELECT_LIMIT=DEFAULT;
/*txn2*/update t set a=2;
/*txn1*/update t set a=3;
/*txn1*/commit;
2. What did you expect to see? (Required)
Commit successfully.

3. What did you see instead (Required)
ERROR 1105 (HY000): runtime error: invalid memory address or nil pointer dereference",unspecified,Pessimistic,1,1,-,-,-,-,2,auto,1,explicit,5,-,-,-,-,-,-,-,-,-,Yes,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,-,-,set @@tidb_disable_txn_auto_retry=0;,-,-,-,-,-,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,Major,Yes,Code fix,3 patches: 2 changed files with 24 additions and 1 deletions,3,2,24,1,25,1,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_21284
TiDB,21274,https://github.com/pingcap/tidb/issues/21274,Schema change not working when an async-commit txn updates an old row,"create table t (c1 int primary key, c2 int) 
insert into t values (1, 1) 
begin 
update t set c2 = 2 where c1 = 1 
alter table t add index k(c2) --another T
commit 

2. What did you expect to see? (Required)
Session 1 commits successfully. After that, the add index DDL of Session 2 finishes.

3. What did you see instead (Required)
Add index DDL hangs forever and commit returns error:",Fixed,,-,https://github.com/pingcap/tidb/pull/21281,2020/11/25,Major,"create table t (c1 int primary key, c2 int) 
insert into t values (1, 1) 
begin 
update t set c2 = 2 where c1 = 1 
alter table t add index k(c2) --another T
commit 

2. What did you expect to see? (Required)
Session 1 commits successfully. After that, the add index DDL of Session 2 finishes.

3. What did you see instead (Required)
Add index DDL hangs forever and commit returns error:",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,Major,Yes,Code fix,3 patches: 2 changed files with 46 additions and 13 deletions,3,2,46,13,59,1,-,"No, involve complex operations other than read(key) and write(key, value)",Yes,"No, unsupported statements",,,TiDB_21274
TiDB,21218,https://github.com/pingcap/tidb/issues/21218,txn: select for update does not lock multi column pk,"/* init */ set session tidb_enable_clustered_index = 0;
/* init */ drop table if exists t;
/* init */ create table t(id int, v int, val int, primary key(id, v));
/* init */ insert into t values(1, 1, 1);

/* t1 */ begin pessimistic;
/* t2 */ begin pessimistic;

/* t1 */ select * from t where id = 1 and v = 1 for update;
/* t2 */ insert into t values(1, 1, 2);
/* t1 */ update t set v = 2 where id = 1 and v = 1;

/* t1 */ commit;
/* t2 */ commit;

/* init */ select * from t;
2. What did you expect to see? (Required)
Insert in t2 wait for t1 commit and execute success.

3. What did you see instead (Required)
Insert in t2 failed with error E1062: Duplicate entry `1-1` for key `PRIMARY`.",Fixed,"4.0.0-beta.2-1607-g93c3e6bec, 4.0",-,https://github.com/pingcap/tidb/pull/21229,2020/11/23,Major,"/* init */ set session tidb_enable_clustered_index = 0;
/* init */ drop table if exists t;
/* init */ create table t(id int, v int, val int, primary key(id, v));
/* init */ insert into t values(1, 1, 1);

/* t1 */ begin pessimistic;
/* t2 */ begin pessimistic;

/* t1 */ select * from t where id = 1 and v = 1 for update;
/* t2 */ insert into t values(1, 1, 2);
/* t1 */ update t set v = 2 where id = 1 and v = 1;

/* t1 */ commit;
/* t2 */ commit;

/* init */ select * from t;
2. What did you expect to see? (Required)
Insert in t2 wait for t1 commit and execute success.

3. What did you see instead (Required)
Insert in t2 failed with error E1062: Duplicate entry `1-1` for key `PRIMARY`.",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,3,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,set session tidb_enable_clustered_index = 0;,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Insufficient isolation: missing blocking,Major,Yes,Code fix,17 patches: 7 changed files with 355 additions and 31 deletions,17,7,355,31,386,10,-,"No, not key-value data structures","No, DBMS-specific",Yes,,,TiDB_21218
TiDB,21151,https://github.com/pingcap/tidb/issues/21151,buildIndexMergeReader doesn`t refresh for update ts in RC isolation level,"create table t (id int primary key, value int, a int not null, b int not null,
    index ia (a),  index ib (b));

insert into t values (1, 10, 2, 0), (2, 10, 4, 4), (3, 10, 0, 2), (4, 10, 0, 0);
set transaction isolation level read committed; begin;  
select /*+ NO_INDEX_MERGE() */ * from t where a > 3 or b > 3;  Returns (2, 10, 4, 4)
select /*+ USE_INDEX_MERGE(t, ia, ib) */ * from t where a > 3 or b > 3;  Returns (2, 10, 4, 4)
update t set value = 11 where id = 2; -- snother T
select /*+ NO_INDEX_MERGE() */ * from t where a > 3 or b > 3;  Returns (2, 11, 4, 4)
select /*+ USE_INDEX_MERGE(t, ia, ib) */ * from t where a > 3 or b > 3;
2. What did you expect to see? (Required)
The last statement above in session 1 should returns (2, 11, 4, 4), because value = 11 is set by session 2 and session 1 is in a RC transaction.

3. What did you see instead (Required)
The last write in session 2 is invisible to the last statement in session 1. ",Fixed,https://github.com/pingcap/tidb/commit/f9f44d0a492a85a9200d9ae476eedfd505db5d7e,-,https://github.com/pingcap/tidb/pull/21208,2020/11/19,Critical,"create table t (id int primary key, value int, a int not null, b int not null,
    index ia (a),  index ib (b));

insert into t values (1, 10, 2, 0), (2, 10, 4, 4), (3, 10, 0, 2), (4, 10, 0, 0);
set transaction isolation level read committed; 
begin;  
select /*+ NO_INDEX_MERGE() */ * from t where a > 3 or b > 3;  Returns (2, 10, 4, 4)
select /*+ USE_INDEX_MERGE(t, ia, ib) */ * from t where a > 3 or b > 3;  Returns (2, 10, 4, 4)
update t set value = 11 where id = 2; -- snother T
select /*+ NO_INDEX_MERGE() */ * from t where a > 3 or b > 3;  Returns (2, 11, 4, 4)
select /*+ USE_INDEX_MERGE(t, ia, ib) */ * from t where a > 3 or b > 3;
2. What did you expect to see? (Required)
The last statement above in session 1 should returns (2, 11, 4, 4), because value = 11 is set by session 2 and session 1 is in a RC transaction.

3. What did you see instead (Required)
The last write in session 2 is invisible to the last statement in session 1. ",READ COMMITTED,Pessimistic,1,4,-,-,-,-,2,auto,1,explicit,5,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,NOT NULL,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,Critical,Yes,Code fix,5 patches: 3 changed files with 54 additions and 35 deletions,5,3,54,35,89,5,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_21151
TiDB,20975,https://github.com/pingcap/tidb/issues/20975,"Unexpected ""Information schema is changed"" when commits","mysql> drop table t2, t1;
Query OK, 0 rows affected (0.04 sec)

mysql> create table t1(a int);
Query OK, 0 rows affected (0.01 sec)

mysql> insert into t1 values (1);
Query OK, 1 row affected (0.00 sec)

mysql> begin pessimistic;
Query OK, 0 rows affected (0.00 sec)

mysql> update t1 set a=a;
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

/* session 2 */ mysql> create table t2(a int);
Query OK, 0 rows affected (0.00 sec)

mysql> commit;
ERROR 8028 (HY000): Information schema is changed during the execution of the statement(for example, table definition may be updated by other DDL ran in parallel). If you see this error often, try increasing `tidb_max_delta_schema_count`. [try again later]",Fixed,4,-,https://github.com/pingcap/tidb/pull/20982,2020/11/11,Major,"mysql> drop table t2, t1;
mysql> create table t1(a int);
mysql> insert into t1 values (1);
mysql> begin pessimistic;
mysql> update t1 set a=a;
/* session 2 */ mysql> create table t2(a int);
mysql> commit;
ERROR 8028 (HY000): Information schema is changed during the execution of the statement(for example, table definition may be updated by other DDL ran in parallel). If you see this error often, try increasing `tidb_max_delta_schema_count`. [try again later]

2. What did you expect to see? (Required)
Commit successfully.

3. What did you see instead (Required)
Information schema is changed during the execution of the statement",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,Major,Yes,Code fix,20 patches: 5 changed files with 188  additions and 1 deletions,20,5,188,1,189,8,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,TiDB_20975
TiDB,20910,https://github.com/pingcap/tidb/issues/20910,Amend transaction may still lead to data inconsistency when adding unique index,"/* init */ drop table if exists t;
/* init */ create table t (id int auto_increment primary key, c int);
/* init */ insert into t (id, c) values (1, 2), (3, 4);

/* txn */ begin;
/* ddl */ alter table t add unique index uk(c);
/* txn */ update t set c = 2 where id = 3;
/* txn */ commit;

/* ddl */ admin check table t;",Fixed,release-4.0,-,https://github.com/pingcap/tidb/pull/20904,2020/11/6,Critical,"/* init */ drop table if exists t;
/* init */ create table t (id int auto_increment primary key, c int);
/* init */ insert into t (id, c) values (1, 2), (3, 4);
/* txn */ begin;
/* ddl */ alter table t add unique index uk(c);
/* txn */ update t set c = 2 where id = 3;
/* txn */ commit;
/* ddl */ admin check table t;
-- ddl >> E8003: t err:[admin:8223]index:&admin.RecordData{Handle:3, Values:[]types.Datum{types.Datum{k:0x1, collation:"""", decimal:0x0, length:0x0, i:2, b:[]uint8(nil), x:interface {}(nil)}}} != record:&admin.RecordData{Handle:1, Values:[]types.Datum{types.Datum{k:0x1, collation:"""", decimal:0x0, length:0x0, i:2, b:[]uint8(nil), x:interface {}(nil)}}}

expected: No error reported by admin check table",unspecified,Pessimistic,1,2,-,-,-,-,2,auto,1,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,AUTO_INCREMENT,-,Yes,Assertion failure,Consistency: DBMS state,Critical,Yes,Code fix,9 patches: 4 changed files with 313 additions and 166 deletions,9,4,313,166,479,10,-,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, unsupported statements",,,TiDB_20910
TiDB,20899,https://github.com/pingcap/tidb/issues/20899,amend txn: inconsistency when update and add/drop index parallel,"/* init */ DROP TABLE IF EXISTS t;
/* init */ CREATE TABLE `t` (`col_0` char(211) NOT NULL, `col_1` int(11) DEFAULT NULL, `col_2` timestamp NULL DEFAULT NULL, `col_3` int(11) NOT NULL, `col_4` tinyint(4) DEFAULT NULL, `col_5` varchar(362) NOT NULL, `col_6` date DEFAULT NULL, `col_7` date DEFAULT NULL, `col_8` varchar(315) NOT NULL, `col_9` char(184) DEFAULT NULL, `col_10` date NOT NULL, PRIMARY KEY (`col_0`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/* dml */ INSERT INTO t VALUES(""dazzling_nobel7"", 539895813, ""1993-11-21 01:08:25"", 1984174257, -97, ""elastic_pare6"", ""2233-12-12"", ""6608-12-20"", ""elated_bardeen5"", ""trusting_spence2"", ""2944-11-29""), (""boring_mccarthy9"", -256662476, ""1989-04-08 01:21:59"", -1433347228, 88, ""objective_curie4"", ""5327-02-08"", ""1078-05-27"", ""wizardly_bardeen3"", ""hardcore_albattani0"", ""5997-03-11""), (""admiring_hugle4"", 244200099, ""2033-10-26 06:46:43"", -1909581650, 20, ""cocky_bardeen1"", ""4356-05-02"", ""6385-06-29"", ""nostalgic_wiles0"", ""youthful_heisenberg3"", ""7355-08-06""), (""gracious_bell3"", 917714001, ""1980-12-25 08:42:47"", 41220933, -53, ""zealous_leavitt7"", ""6177-05-24"", ""7040-09-23"", ""eloquent_swanson7"", ""pensive_beaver2"", ""1236-06-18""), (""quirky_kilby3"", 1322725985, ""1972-12-11 04:44:22"", 1034160028, 63, ""ecstatic_tesla1"", ""3777-09-29"", ""6856-05-14"", ""trusting_almeida6"", ""suspicious_yonath7"", ""6672-12-20""), (""elated_wescoff0"", -1094114262, ""2021-05-04 03:08:38"", 1658419520, 42, ""lucid_sammet7"", ""2918-06-26"", ""5820-09-08"", ""cocky_brattain5"", ""festive_stallman6"", ""1003-07-26""), (""suspicious_yalow3"", 1950630030, ""2017-10-21 07:43:04"", 1365059358, -59, ""quirky_shannon2"", ""5458-02-08"", ""2132-07-18"", ""blissful_poincare2"", ""goofy_bohr8"", ""2915-06-03""), (""festive_goldberg7"", -770450532, ""2002-11-06 09:48:26"", 1764693836, 86, ""determined_murdock7"", ""8863-08-02"", ""4086-11-11"", ""nostalgic_wing6"", ""trusting_mccarthy4"", ""8459-05-02""), (""trusting_montalcini7"", -1688646008, ""1974-05-31 07:39:33"", 207568759, 124, ""compassionate_mcnulty6"", ""2554-05-10"", ""5112-12-31"", ""mystifying_noyce1"", ""zealous_bardeen0"", ""2013-09-24""), (""kind_rosalind5"", 1185943781, ""1999-09-11 20:10:45"", -282379877, 101, ""modest_franklin4"", ""4935-08-06"", ""4596-10-12"", ""vibrant_lamport2"", ""kind_swanson6"", ""4004-03-01"");
/* dml */ INSERT INTO t VALUES(""reverent_newton6"", 908600411, ""2015-10-15 02:02:47"", 186382233, -25, ""relaxed_swanson7"", ""9333-07-31"", ""4171-09-05"", ""ecstatic_swanson5"", ""stoic_yonath6"", ""3820-12-06""), (""wonderful_beaver0"", 242920315, ""2011-10-31 14:40:11"", 1934108618, -79, ""pedantic_pike0"", ""7541-11-07"", ""1675-12-09"", ""competent_kirch4"", ""eloquent_euler9"", ""8677-06-19""), (""unruffled_jennings4"", 201046701, ""1972-03-09 12:36:50"", -881592412, -2, ""youthful_hamilton6"", ""8965-02-01"", ""6245-10-07"", ""festive_shirley2"", ""kickass_darwin0"", ""1580-07-17""), (""eloquent_varahamihira3"", -1948248542, ""2032-06-17 15:28:17"", 839319749, 15, ""nervous_sammet0"", ""4006-03-15"", ""3962-10-06"", ""admiring_allen7"", ""kickass_wozniak4"", ""9544-08-24""), (""distracted_dijkstra9"", -1730694250, ""2015-03-06 08:27:54"", 1054744029, 92, ""practical_bardeen0"", ""9877-09-18"", ""3891-10-23"", ""competent_franklin1"", ""awesome_snyder4"", ""1171-02-27""), (""infallible_montalcini1"", 737365637, ""2025-04-18 01:33:44"", 1464778649, 63, ""distracted_brahmagupta3"", ""3494-09-10"", ""1767-01-24"", ""pensive_minsky1"", ""cranky_darwin8"", ""5874-02-06""), (""determined_cori1"", 724357898, ""2028-05-02 00:07:51"", 1311310948, 91, ""happy_visvesvaraya3"", ""8817-09-14"", ""8580-03-30"", ""laughing_pasteur9"", ""clever_bassi1"", ""8835-09-29""), (""kind_fermat7"", -1539377315, ""1978-09-28 05:27:02"", 1571175918, 13, ""laughing_mccarthy5"", ""7189-09-17"", ""4634-11-27"", ""ecstatic_northcutt1"", ""trusting_bhabha7"", ""2855-07-25""), (""naughty_hoover9"", 1194058339, ""2033-12-01 00:38:25"", 1256763506, 59, ""wonderful_swanson6"", ""9584-08-11"", ""7253-08-19"", ""clever_mclean9"", ""nervous_meninsky0"", ""6086-03-02""), (""gracious_mcnulty1"", 857107021, ""2024-03-01 01:46:22"", -1133417383, 64, ""goofy_keller0"", ""4399-04-24"", ""3618-01-09"", ""objective_euclid4"", ""admiring_ptolemy6"", ""8190-05-31"");
/* dml */ INSERT INTO t VALUES(""friendly_goldstine7"", -1465925783, ""2029-03-28 08:17:13"", -119755107, -3, ""awesome_joliot2"", ""5442-01-31"", ""1551-11-04"", ""clever_lalande4"", ""naughty_engelbart5"", ""7820-08-18""), (""dazzling_euclid6"", -1556751580, ""2029-08-17 05:06:52"", 1848295678, 13, ""brave_aryabhata0"", ""9917-01-04"", ""4239-08-18"", ""clever_hamilton2"", ""competent_thompson9"", ""3237-08-20""), (""cranky_knuth4"", 1254096770, ""1995-02-10 11:34:03"", 37960317, 48, ""jolly_edison3"", ""5245-01-30"", ""2671-10-18"", ""zen_leakey7"", ""infallible_kare0"", ""6914-07-03""), (""nifty_newton0"", -1593741644, ""2030-05-08 00:50:36"", -266256525, 89, ""optimistic_noether4"", ""4923-03-30"", ""1098-03-10"", ""cranky_cori4"", ""wonderful_spence5"", ""7295-04-28""), (""distracted_albattani9"", -355479480, ""2019-11-03 13:16:46"", -1963832452, 126, ""admiring_swanson9"", ""9295-01-14"", ""1745-04-16"", ""tender_franklin9"", ""festive_hodgkin8"", ""6158-01-22""), (""happy_albattani0"", -1877500008, ""2036-11-07 20:20:43"", -418567172, 16, ""confident_thompson6"", ""4494-05-17"", ""7457-08-19"", ""quirky_hodgkin3"", ""sad_wozniak2"", ""3636-09-14""), (""inspiring_mahavira8"", 1311611577, ""2001-01-22 14:46:48"", -1493289412, 14, ""condescending_mclean1"", ""3298-04-19"", ""1885-03-10"", ""affectionate_euclid1"", ""objective_mayer7"", ""5388-12-02""), (""goofy_goodall4"", -1898427195, ""2037-01-20 20:11:45"", -1316182616, -18, ""frosty_bhabha9"", ""6313-10-09"", ""7023-11-09"", ""sleepy_gates4"", ""wonderful_joliot9"", ""9658-06-19""), (""sleepy_kirch9"", -1610361045, ""2028-04-17 14:19:14"", -795373350, 11, ""naughty_mestorf7"", ""4561-12-07"", ""5246-12-27"", ""gallant_wilson7"", ""quirky_hoover3"", ""6826-10-06""), (""pensive_wilson3"", 318848968, ""2033-01-16 09:56:57"", 1653224178, -21, ""zen_lovelace2"", ""1730-12-26"", ""1356-12-04"", ""ecstatic_ptolemy9"", ""gallant_shockley9"", ""1181-11-20"");
/* dml */ INSERT INTO t VALUES(""compassionate_albattani5"", -859925921, ""2028-03-01 09:30:13"", 407714885, -120, ""gallant_lamarr8"", ""7599-02-28"", ""8032-12-05"", ""naughty_kare5"", ""nifty_hopper6"", ""9483-08-29""), (""silly_bohr6"", -552288278, ""2036-08-01 03:46:14"", -1104652390, -38, ""relaxed_ramanujan0"", ""9678-02-01"", ""6254-01-05"", ""priceless_aryabhata9"", ""zen_leavitt0"", ""8058-11-03""), (""flamboyant_knuth0"", -1393106350, ""1996-02-23 14:08:30"", 2041305463, -62, ""determined_liskov0"", ""6170-08-13"", ""7383-01-23"", ""ecstatic_lumiere1"", ""hopeful_austin4"", ""1269-02-15""), (""competent_cori8"", 858747476, ""1977-08-13 00:16:35"", -1148457100, -33, ""practical_kirch3"", ""4928-01-05"", ""1742-05-03"", ""fervent_archimedes4"", ""gifted_franklin4"", ""5140-07-12""), (""laughing_kirch1"", -1536795165, ""1998-05-05 14:55:45"", 60731746, 40, ""gifted_northcutt0"", ""6870-02-04"", ""6356-12-16"", ""affectionate_dijkstra9"", ""sleepy_chandrasekhar0"", ""2678-06-03""), (""festive_goodall3"", -908520479, ""2011-01-01 10:55:24"", -1286372365, 13, ""fervent_davinci3"", ""5547-11-17"", ""8901-02-19"", ""wonderful_ardinghelli8"", ""festive_mirzakhani5"", ""2549-03-20""), (""nervous_payne3"", 133440765, ""2015-09-30 09:28:46"", -19954446, -81, ""trusting_jones2"", ""5935-10-19"", ""8953-07-02"", ""optimistic_poitras5"", ""sleepy_mcclintock0"", ""6795-02-23""), (""priceless_hodgkin5"", 1949117976, ""1996-06-30 03:07:09"", 3145939, 25, ""relaxed_ptolemy6"", ""3166-04-22"", ""3347-02-05"", ""reverent_meitner3"", ""zen_visvesvaraya0"", ""8381-10-05""), (""sharp_boyd9"", 1216404568, ""2002-03-10 07:48:38"", 1711067426, 89, ""stoic_jepsen5"", ""5835-11-13"", ""3771-03-07"", ""dazzling_cray2"", ""hardcore_rosalind4"", ""1354-04-17""), (""goofy_spence4"", 1490843963, ""1992-12-17 07:17:46"", 631629487, 96, ""blissful_jepsen0"", ""4744-12-24"", ""8285-01-31"", ""adoring_fermi2"", ""ecstatic_poincare8"", ""9836-03-06"");
/* dml */ INSERT INTO t VALUES(""hardcore_tesla9"", -117962729, ""2035-09-04 13:27:37"", 370034570, 81, ""eager_mccarthy0"", ""8221-01-03"", ""4820-03-04"", ""condescending_goldberg2"", ""boring_banach2"", ""3618-05-05""), (""upbeat_turing4"", 944746969, ""2013-02-17 09:51:54"", -157303637, 87, ""elated_austin3"", ""2946-09-16"", ""3440-07-18"", ""wonderful_minsky8"", ""relaxed_mirzakhani0"", ""3849-02-01""), (""dazzling_hawking9"", 110346069, ""2004-09-11 16:15:21"", -1625907153, 58, ""determined_golick5"", ""2970-01-25"", ""5809-08-19"", ""vibrant_wiles6"", ""serene_kare1"", ""9462-06-05""), (""quizzical_ptolemy5"", -1833219427, ""2035-08-19 12:48:50"", -1275172909, -85, ""vibrant_perlman5"", ""6087-05-04"", ""5918-03-13"", ""serene_hopper6"", ""heuristic_wilson6"", ""8891-08-03""), (""loving_ptolemy9"", -658056473, ""2005-03-17 11:41:18"", -666566475, -101, ""zealous_goldberg7"", ""5895-08-30"", ""9220-10-19"", ""eager_mayer8"", ""practical_colden3"", ""8047-02-10""), (""brave_euclid0"", -164340498, ""1988-08-10 09:21:57"", -2077016810, 35, ""nostalgic_pike8"", ""3600-05-19"", ""5010-11-07"", ""ecstatic_banach2"", ""wonderful_dijkstra6"", ""4699-02-18""), (""frosty_torvalds3"", -464983606, ""1988-02-06 16:33:07"", 1301224835, 76, ""determined_kirch9"", ""3532-01-08"", ""1235-05-13"", ""jolly_snyder0"", ""pedantic_jones9"", ""9369-02-17""), (""zen_kalam5"", -1287084318, ""2020-01-04 21:48:18"", -924784297, 51, ""xenodochial_montalcini5"", ""7129-10-25"", ""1644-05-22"", ""inspiring_shockley6"", ""lucid_dubinsky5"", ""3073-05-26""), (""trusting_austin3"", -1834194346, ""1976-05-25 13:55:49"", -1242610466, -93, ""boring_wright9"", ""4596-08-17"", ""9839-11-22"", ""cranky_mestorf0"", ""quizzical_austin6"", ""2946-04-17""), (""wizardly_banach8"", 2116482546, ""2012-07-07 12:55:31"", 1462290966, 119, ""vibrant_tesla5"", ""9663-11-15"", ""9046-06-05"", ""naughty_darwin7"", ""confident_colden2"", ""3251-03-08"");
/* dml */ INSERT INTO t VALUES(""inspiring_golick7"", 817095506, ""1992-11-09 23:06:33"", 2045684635, 53, ""heuristic_kowalevski3"", ""4419-07-26"", ""1533-02-16"", ""awesome_lamport6"", ""thirsty_spence9"", ""3856-07-27""), (""boring_visvesvaraya1"", 1387434398, ""1987-08-06 01:39:03"", -360371676, -4, ""wizardly_cray5"", ""2437-09-15"", ""5183-01-21"", ""serene_bose9"", ""dreamy_haibt2"", ""4153-10-05""), (""nervous_kalam7"", -62962874, ""2017-04-20 00:09:34"", 401392615, 10, ""distracted_mayer9"", ""5853-05-25"", ""8256-03-10"", ""hungry_wing1"", ""eloquent_clarke5"", ""9056-04-04""), (""kind_beaver9"", -1837221008, ""2033-08-19 09:34:19"", -1629816812, 36, ""eloquent_nightingale2"", ""9179-05-23"", ""7745-02-13"", ""cocky_kilby4"", ""elegant_hypatia2"", ""2131-10-20""), (""admiring_edison6"", 612417839, ""2030-10-07 03:30:41"", -144947301, 86, ""trusting_nightingale5"", ""7269-11-25"", ""2672-11-15"", ""elastic_borg8"", ""amazing_galileo1"", ""2868-05-09""), (""peaceful_volhard1"", -2098143618, ""2030-08-24 13:10:53"", 636173883, -33, ""youthful_williams4"", ""6939-07-25"", ""7266-08-23"", ""gifted_jennings5"", ""stoic_hugle2"", ""7745-06-26""), (""dazzling_poincare5"", 1281776927, ""2012-06-17 14:35:55"", -10410411, 105, ""serene_cori6"", ""4164-01-27"", ""7779-04-10"", ""adoring_ramanujan4"", ""priceless_cray9"", ""1067-06-29""), (""upbeat_heisenberg2"", -340448991, ""2026-04-30 09:56:17"", -1715980909, -27, ""gracious_yonath6"", ""7356-10-03"", ""6966-03-31"", ""epic_lamport9"", ""agitated_minsky2"", ""9374-07-29""), (""hardcore_hugle8"", 667160615, ""1992-12-02 02:12:19"", -1315288205, 125, ""gallant_stallman7"", ""5680-08-22"", ""4821-02-08"", ""silly_bartik4"", ""eager_keller7"", ""6982-04-25""), (""tender_minsky7"", 2089133212, ""2036-09-19 10:14:19"", -1327069034, 121, ""lucid_morse3"", ""7313-11-19"", ""7492-09-16"", ""youthful_bohr2"", ""wizardly_archimedes6"", ""8184-03-15"");
/* dml */ INSERT INTO t VALUES(""elated_goodall8"", -1612548846, ""2014-12-29 04:21:29"", 817795920, -35, ""hardcore_poincare8"", ""4013-08-11"", ""8091-11-07"", ""awesome_wing7"", ""xenodochial_wiles0"", ""9833-09-03""), (""angry_wilson8"", -968822612, ""2030-09-14 16:59:14"", -2028720218, -126, ""happy_tesla3"", ""5392-08-28"", ""2373-07-05"", ""amazing_jang0"", ""affectionate_brattain5"", ""3857-05-04""), (""clever_stonebraker3"", -2028650192, ""1972-09-15 21:08:59"", -1489842561, -13, ""epic_yonath4"", ""8708-05-23"", ""4216-07-22"", ""kind_payne1"", ""flamboyant_kowalevski5"", ""2088-05-13""), (""agitated_meninsky5"", -342893450, ""1979-02-03 05:31:52"", -1788476670, -70, ""determined_yalow4"", ""7732-12-24"", ""6140-05-03"", ""hopeful_brown4"", ""heuristic_darwin3"", ""6950-05-16""), (""nifty_einstein2"", -940356759, ""1990-04-02 21:14:09"", 1492051527, -16, ""focused_dijkstra2"", ""3071-01-13"", ""3459-06-15"", ""zen_albattani8"", ""vibrant_tesla7"", ""5005-10-25""), (""tender_goldstine7"", 1073560802, ""1977-07-02 07:30:32"", -489388053, 16, ""jovial_almeida8"", ""1358-04-05"", ""7910-09-05"", ""nifty_colden4"", ""tender_curran5"", ""4097-10-04""), (""affectionate_mahavira0"", -1599479712, ""2004-02-18 11:10:13"", 911591372, -66, ""compassionate_agnesi4"", ""7737-12-08"", ""8218-07-22"", ""eloquent_franklin9"", ""lucid_minsky3"", ""3646-11-24""), (""confident_shirley3"", 587064755, ""2028-05-21 12:35:37"", -1193527428, -59, ""affectionate_newton8"", ""8997-03-02"", ""8947-12-17"", ""naughty_perlman7"", ""vibrant_elion2"", ""4393-09-17""), (""elastic_euclid4"", -1590516963, ""2020-11-26 09:53:09"", -698494111, -62, ""angry_fermi5"", ""4491-04-10"", ""7324-12-10"", ""quirky_archimedes0"", ""confident_meninsky8"", ""7204-07-09""), (""priceless_kare3"", 2079208482, ""1978-07-07 00:12:33"", -1708464740, -78, ""modest_heisenberg5"", ""8560-11-29"", ""8152-09-14"", ""thirsty_cray1"", ""pedantic_newton4"", ""7805-05-20"");
/* dml */ INSERT INTO t VALUES(""xenodochial_leavitt3"", 2058017242, ""2007-10-07 08:55:01"", -765946141, 119, ""festive_volhard4"", ""3200-08-10"", ""7031-08-08"", ""vibrant_carson9"", ""gallant_keller3"", ""3280-06-02""), (""sleepy_kowalevski1"", -246341532, ""1991-03-10 04:11:23"", -942996472, 63, ""serene_shockley9"", ""9823-01-03"", ""1430-07-27"", ""jovial_bohr1"", ""eloquent_banach6"", ""2733-07-07""), (""angry_curie0"", 950650933, ""2005-04-07 03:21:52"", 1601876657, -10, ""determined_volhard7"", ""4784-01-01"", ""8639-03-13"", ""youthful_curran5"", ""gifted_hypatia6"", ""7042-11-10""), (""awesome_panini4"", -277273502, ""2036-04-02 15:20:30"", -1328323542, 0, ""clever_williams1"", ""6184-10-02"", ""8905-06-30"", ""tender_jones5"", ""awesome_aryabhata7"", ""5550-08-09""), (""epic_colden2"", 1465974354, ""2009-07-29 02:10:08"", -1240853949, -119, ""pensive_kowalevski7"", ""6739-01-01"", ""3918-03-04"", ""reverent_liskov8"", ""hungry_bhaskara7"", ""8955-03-20""), (""gifted_meninsky8"", -1133744126, ""2037-04-30 03:23:13"", 1113196807, -46, ""loving_fermat3"", ""4587-08-25"", ""6988-06-13"", ""nifty_shaw3"", ""stupefied_meninsky5"", ""3381-04-16""), (""flamboyant_meninsky5"", 1945987768, ""1982-11-15 07:48:21"", 1079576210, -79, ""amazing_feynman3"", ""9711-11-15"", ""1778-09-11"", ""boring_banach1"", ""elegant_engelbart1"", ""1326-12-03""), (""stoic_wescoff2"", 959307944, ""2015-08-27 21:58:10"", -1678519734, -93, ""nervous_volhard0"", ""7763-12-20"", ""6273-03-08"", ""lucid_leavitt6"", ""kickass_roentgen7"", ""5554-09-25""), (""wonderful_aryabhata"", 1348847059, ""1994-04-08 12:02:11"", -215796667, -78, ""serene_agnesi3"", ""6458-05-04"", ""1704-09-28"", ""friendly_austin8"", ""flamboyant_noether8"", ""1381-02-27""), (""gracious_babbage6"", 377597026, ""1982-12-01 14:22:20"", 1427784655, -88, ""kind_ritchie3"", ""5444-01-07"", ""1129-03-14"", ""musing_brown4"", ""focused_jennings8"", ""7665-10-20"");

/* dml_17 */ BEGIN;
/* create_index */ CREATE INDEX k0 on t(`col_10`, `col_0`);
/* create_index */ CREATE INDEX k1 on t(`col_2`, `col_3`);
/* drop_index */ ALTER TABLE t DROP INDEX k0;
/* create_index */ CREATE INDEX k2 on t(`col_3`, `col_1`);
/* drop_index */ ALTER TABLE t DROP INDEX k1;
/* create_index */ CREATE INDEX k3 on t(`col_1`, `col_0`);
/* drop_index */ ALTER TABLE t DROP INDEX k2;
/* create_index */ CREATE INDEX k4 on t(`col_4`, `col_3`, `col_1`);
/* drop_index */ ALTER TABLE t DROP INDEX k3;
/* create_index */ CREATE INDEX k5 on t(`col_4`, `col_10`);
/* drop_index */ ALTER TABLE t DROP INDEX k4;
/* create_index */ CREATE INDEX k6 on t(`col_10`);
/* create_index */ CREATE INDEX k7 on t(`col_9`, `col_8`, `col_7`);
/* create_index */ CREATE INDEX k8 on t(`col_0`, `col_10`);
/* create_index */ CREATE INDEX k9 on t(`col_2`, `col_1`);
/* dml_17 */ SELECT SLEEP(1);
/* dml_17 */ UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY), col_1=col_1/2 WHERE col_4<68;
/* dml_17 */ UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY) WHERE col_3<-529739127;
/* dml_17 */ UPDATE t SET col_0 = CONCAT(col_0, ""-p""), col_8 = CONCAT(col_8, ""-p"") WHERE col_1<1951319788 AND col_5<""blissful_mcnulty6"" AND col_9<""confident_fermat5"" AND col_7<""8912-07-02"";
/* dml_17 */ UPDATE t SET col_10 = ADDDATE(col_10, INTERVAL 1 DAY), col_5 = CONCAT(col_5, ""-p"") WHERE col_7<""4430-01-24"";
/* dml_17 */ UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY) WHERE col_5<""sharp_euclid6"" AND col_3<-1883486410;
/* dml_17 */ UPDATE t SET col_5 = CONCAT(col_5, ""-p""), col_7 = ADDDATE(col_7, INTERVAL 1 DAY) WHERE col_7<""6043-09-24"" AND col_10<""7657-09-06"" AND col_4<26;
/* dml_17 */ UPDATE t SET col_4=col_4/2, col_7 = ADDDATE(col_7, INTERVAL 1 DAY), col_4=col_4/2 WHERE col_4<-121 AND col_3<-62203872 AND col_8<""gallant_minsky3"";
/* dml_17 */ UPDATE t SET col_8 = CONCAT(col_8, ""-p""), col_2 = ADDDATE(col_2, INTERVAL 1 DAY) WHERE col_1<259276311 AND col_7<""9675-10-13"" AND col_4<24;
/* dml_17 */ UPDATE t SET col_3=col_3/2 WHERE col_10<""5930-08-21"";
/* dml_17 */ UPDATE t SET col_4=col_4/2, col_9 = CONCAT(col_9, ""-p"") WHERE col_5<""pedantic_agnesi7"" AND col_7<""6992-10-20"";
/* dml_17 */ COMMIT;

/* done */ ADMIN CHECK TABLE t;",Fixed,4.0.8-19-g0b0c41b43,-,https://github.com/pingcap/tidb/pull/20904,2020/11/6,Critical,"/* init */ DROP TABLE IF EXISTS t;
/* init */ CREATE TABLE `t` (`col_0` char(211) NOT NULL, `col_1` int(11) DEFAULT NULL, `col_2` timestamp NULL DEFAULT NULL, `col_3` int(11) NOT NULL, `col_4` tinyint(4) DEFAULT NULL, `col_5` varchar(362) NOT NULL, `col_6` date DEFAULT NULL, `col_7` date DEFAULT NULL, `col_8` varchar(315) NOT NULL, `col_9` char(184) DEFAULT NULL, `col_10` date NOT NULL, PRIMARY KEY (`col_0`)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin;

/* dml */ INSERT INTO t VALUES(""dazzling_nobel7"", 539895813, ""1993-11-21 01:08:25"", 1984174257, -97, ""elastic_pare6"", ""2233-12-12"", ""6608-12-20"", ""elated_bardeen5"", ""trusting_spence2"", ""2944-11-29""), (""boring_mccarthy9"", -256662476, ""1989-04-08 01:21:59"", -1433347228, 88, ""objective_curie4"", ""5327-02-08"", ""1078-05-27"", ""wizardly_bardeen3"", ""hardcore_albattani0"", ""5997-03-11""), (""admiring_hugle4"", 244200099, ""2033-10-26 06:46:43"", -1909581650, 20, ""cocky_bardeen1"", ""4356-05-02"", ""6385-06-29"", ""nostalgic_wiles0"", ""youthful_heisenberg3"", ""7355-08-06""), (""gracious_bell3"", 917714001, ""1980-12-25 08:42:47"", 41220933, -53, ""zealous_leavitt7"", ""6177-05-24"", ""7040-09-23"", ""eloquent_swanson7"", ""pensive_beaver2"", ""1236-06-18""), (""quirky_kilby3"", 1322725985, ""1972-12-11 04:44:22"", 1034160028, 63, ""ecstatic_tesla1"", ""3777-09-29"", ""6856-05-14"", ""trusting_almeida6"", ""suspicious_yonath7"", ""6672-12-20""), (""elated_wescoff0"", -1094114262, ""2021-05-04 03:08:38"", 1658419520, 42, ""lucid_sammet7"", ""2918-06-26"", ""5820-09-08"", ""cocky_brattain5"", ""festive_stallman6"", ""1003-07-26""), (""suspicious_yalow3"", 1950630030, ""2017-10-21 07:43:04"", 1365059358, -59, ""quirky_shannon2"", ""5458-02-08"", ""2132-07-18"", ""blissful_poincare2"", ""goofy_bohr8"", ""2915-06-03""), (""festive_goldberg7"", -770450532, ""2002-11-06 09:48:26"", 1764693836, 86, ""determined_murdock7"", ""8863-08-02"", ""4086-11-11"", ""nostalgic_wing6"", ""trusting_mccarthy4"", ""8459-05-02""), (""trusting_montalcini7"", -1688646008, ""1974-05-31 07:39:33"", 207568759, 124, ""compassionate_mcnulty6"", ""2554-05-10"", ""5112-12-31"", ""mystifying_noyce1"", ""zealous_bardeen0"", ""2013-09-24""), (""kind_rosalind5"", 1185943781, ""1999-09-11 20:10:45"", -282379877, 101, ""modest_franklin4"", ""4935-08-06"", ""4596-10-12"", ""vibrant_lamport2"", ""kind_swanson6"", ""4004-03-01"");
/* dml */ INSERT INTO t VALUES(""reverent_newton6"", 908600411, ""2015-10-15 02:02:47"", 186382233, -25, ""relaxed_swanson7"", ""9333-07-31"", ""4171-09-05"", ""ecstatic_swanson5"", ""stoic_yonath6"", ""3820-12-06""), (""wonderful_beaver0"", 242920315, ""2011-10-31 14:40:11"", 1934108618, -79, ""pedantic_pike0"", ""7541-11-07"", ""1675-12-09"", ""competent_kirch4"", ""eloquent_euler9"", ""8677-06-19""), (""unruffled_jennings4"", 201046701, ""1972-03-09 12:36:50"", -881592412, -2, ""youthful_hamilton6"", ""8965-02-01"", ""6245-10-07"", ""festive_shirley2"", ""kickass_darwin0"", ""1580-07-17""), (""eloquent_varahamihira3"", -1948248542, ""2032-06-17 15:28:17"", 839319749, 15, ""nervous_sammet0"", ""4006-03-15"", ""3962-10-06"", ""admiring_allen7"", ""kickass_wozniak4"", ""9544-08-24""), (""distracted_dijkstra9"", -1730694250, ""2015-03-06 08:27:54"", 1054744029, 92, ""practical_bardeen0"", ""9877-09-18"", ""3891-10-23"", ""competent_franklin1"", ""awesome_snyder4"", ""1171-02-27""), (""infallible_montalcini1"", 737365637, ""2025-04-18 01:33:44"", 1464778649, 63, ""distracted_brahmagupta3"", ""3494-09-10"", ""1767-01-24"", ""pensive_minsky1"", ""cranky_darwin8"", ""5874-02-06""), (""determined_cori1"", 724357898, ""2028-05-02 00:07:51"", 1311310948, 91, ""happy_visvesvaraya3"", ""8817-09-14"", ""8580-03-30"", ""laughing_pasteur9"", ""clever_bassi1"", ""8835-09-29""), (""kind_fermat7"", -1539377315, ""1978-09-28 05:27:02"", 1571175918, 13, ""laughing_mccarthy5"", ""7189-09-17"", ""4634-11-27"", ""ecstatic_northcutt1"", ""trusting_bhabha7"", ""2855-07-25""), (""naughty_hoover9"", 1194058339, ""2033-12-01 00:38:25"", 1256763506, 59, ""wonderful_swanson6"", ""9584-08-11"", ""7253-08-19"", ""clever_mclean9"", ""nervous_meninsky0"", ""6086-03-02""), (""gracious_mcnulty1"", 857107021, ""2024-03-01 01:46:22"", -1133417383, 64, ""goofy_keller0"", ""4399-04-24"", ""3618-01-09"", ""objective_euclid4"", ""admiring_ptolemy6"", ""8190-05-31"");
/* dml */ INSERT INTO t VALUES(""friendly_goldstine7"", -1465925783, ""2029-03-28 08:17:13"", -119755107, -3, ""awesome_joliot2"", ""5442-01-31"", ""1551-11-04"", ""clever_lalande4"", ""naughty_engelbart5"", ""7820-08-18""), (""dazzling_euclid6"", -1556751580, ""2029-08-17 05:06:52"", 1848295678, 13, ""brave_aryabhata0"", ""9917-01-04"", ""4239-08-18"", ""clever_hamilton2"", ""competent_thompson9"", ""3237-08-20""), (""cranky_knuth4"", 1254096770, ""1995-02-10 11:34:03"", 37960317, 48, ""jolly_edison3"", ""5245-01-30"", ""2671-10-18"", ""zen_leakey7"", ""infallible_kare0"", ""6914-07-03""), (""nifty_newton0"", -1593741644, ""2030-05-08 00:50:36"", -266256525, 89, ""optimistic_noether4"", ""4923-03-30"", ""1098-03-10"", ""cranky_cori4"", ""wonderful_spence5"", ""7295-04-28""), (""distracted_albattani9"", -355479480, ""2019-11-03 13:16:46"", -1963832452, 126, ""admiring_swanson9"", ""9295-01-14"", ""1745-04-16"", ""tender_franklin9"", ""festive_hodgkin8"", ""6158-01-22""), (""happy_albattani0"", -1877500008, ""2036-11-07 20:20:43"", -418567172, 16, ""confident_thompson6"", ""4494-05-17"", ""7457-08-19"", ""quirky_hodgkin3"", ""sad_wozniak2"", ""3636-09-14""), (""inspiring_mahavira8"", 1311611577, ""2001-01-22 14:46:48"", -1493289412, 14, ""condescending_mclean1"", ""3298-04-19"", ""1885-03-10"", ""affectionate_euclid1"", ""objective_mayer7"", ""5388-12-02""), (""goofy_goodall4"", -1898427195, ""2037-01-20 20:11:45"", -1316182616, -18, ""frosty_bhabha9"", ""6313-10-09"", ""7023-11-09"", ""sleepy_gates4"", ""wonderful_joliot9"", ""9658-06-19""), (""sleepy_kirch9"", -1610361045, ""2028-04-17 14:19:14"", -795373350, 11, ""naughty_mestorf7"", ""4561-12-07"", ""5246-12-27"", ""gallant_wilson7"", ""quirky_hoover3"", ""6826-10-06""), (""pensive_wilson3"", 318848968, ""2033-01-16 09:56:57"", 1653224178, -21, ""zen_lovelace2"", ""1730-12-26"", ""1356-12-04"", ""ecstatic_ptolemy9"", ""gallant_shockley9"", ""1181-11-20"");
/* dml */ INSERT INTO t VALUES(""compassionate_albattani5"", -859925921, ""2028-03-01 09:30:13"", 407714885, -120, ""gallant_lamarr8"", ""7599-02-28"", ""8032-12-05"", ""naughty_kare5"", ""nifty_hopper6"", ""9483-08-29""), (""silly_bohr6"", -552288278, ""2036-08-01 03:46:14"", -1104652390, -38, ""relaxed_ramanujan0"", ""9678-02-01"", ""6254-01-05"", ""priceless_aryabhata9"", ""zen_leavitt0"", ""8058-11-03""), (""flamboyant_knuth0"", -1393106350, ""1996-02-23 14:08:30"", 2041305463, -62, ""determined_liskov0"", ""6170-08-13"", ""7383-01-23"", ""ecstatic_lumiere1"", ""hopeful_austin4"", ""1269-02-15""), (""competent_cori8"", 858747476, ""1977-08-13 00:16:35"", -1148457100, -33, ""practical_kirch3"", ""4928-01-05"", ""1742-05-03"", ""fervent_archimedes4"", ""gifted_franklin4"", ""5140-07-12""), (""laughing_kirch1"", -1536795165, ""1998-05-05 14:55:45"", 60731746, 40, ""gifted_northcutt0"", ""6870-02-04"", ""6356-12-16"", ""affectionate_dijkstra9"", ""sleepy_chandrasekhar0"", ""2678-06-03""), (""festive_goodall3"", -908520479, ""2011-01-01 10:55:24"", -1286372365, 13, ""fervent_davinci3"", ""5547-11-17"", ""8901-02-19"", ""wonderful_ardinghelli8"", ""festive_mirzakhani5"", ""2549-03-20""), (""nervous_payne3"", 133440765, ""2015-09-30 09:28:46"", -19954446, -81, ""trusting_jones2"", ""5935-10-19"", ""8953-07-02"", ""optimistic_poitras5"", ""sleepy_mcclintock0"", ""6795-02-23""), (""priceless_hodgkin5"", 1949117976, ""1996-06-30 03:07:09"", 3145939, 25, ""relaxed_ptolemy6"", ""3166-04-22"", ""3347-02-05"", ""reverent_meitner3"", ""zen_visvesvaraya0"", ""8381-10-05""), (""sharp_boyd9"", 1216404568, ""2002-03-10 07:48:38"", 1711067426, 89, ""stoic_jepsen5"", ""5835-11-13"", ""3771-03-07"", ""dazzling_cray2"", ""hardcore_rosalind4"", ""1354-04-17""), (""goofy_spence4"", 1490843963, ""1992-12-17 07:17:46"", 631629487, 96, ""blissful_jepsen0"", ""4744-12-24"", ""8285-01-31"", ""adoring_fermi2"", ""ecstatic_poincare8"", ""9836-03-06"");
/* dml */ INSERT INTO t VALUES(""hardcore_tesla9"", -117962729, ""2035-09-04 13:27:37"", 370034570, 81, ""eager_mccarthy0"", ""8221-01-03"", ""4820-03-04"", ""condescending_goldberg2"", ""boring_banach2"", ""3618-05-05""), (""upbeat_turing4"", 944746969, ""2013-02-17 09:51:54"", -157303637, 87, ""elated_austin3"", ""2946-09-16"", ""3440-07-18"", ""wonderful_minsky8"", ""relaxed_mirzakhani0"", ""3849-02-01""), (""dazzling_hawking9"", 110346069, ""2004-09-11 16:15:21"", -1625907153, 58, ""determined_golick5"", ""2970-01-25"", ""5809-08-19"", ""vibrant_wiles6"", ""serene_kare1"", ""9462-06-05""), (""quizzical_ptolemy5"", -1833219427, ""2035-08-19 12:48:50"", -1275172909, -85, ""vibrant_perlman5"", ""6087-05-04"", ""5918-03-13"", ""serene_hopper6"", ""heuristic_wilson6"", ""8891-08-03""), (""loving_ptolemy9"", -658056473, ""2005-03-17 11:41:18"", -666566475, -101, ""zealous_goldberg7"", ""5895-08-30"", ""9220-10-19"", ""eager_mayer8"", ""practical_colden3"", ""8047-02-10""), (""brave_euclid0"", -164340498, ""1988-08-10 09:21:57"", -2077016810, 35, ""nostalgic_pike8"", ""3600-05-19"", ""5010-11-07"", ""ecstatic_banach2"", ""wonderful_dijkstra6"", ""4699-02-18""), (""frosty_torvalds3"", -464983606, ""1988-02-06 16:33:07"", 1301224835, 76, ""determined_kirch9"", ""3532-01-08"", ""1235-05-13"", ""jolly_snyder0"", ""pedantic_jones9"", ""9369-02-17""), (""zen_kalam5"", -1287084318, ""2020-01-04 21:48:18"", -924784297, 51, ""xenodochial_montalcini5"", ""7129-10-25"", ""1644-05-22"", ""inspiring_shockley6"", ""lucid_dubinsky5"", ""3073-05-26""), (""trusting_austin3"", -1834194346, ""1976-05-25 13:55:49"", -1242610466, -93, ""boring_wright9"", ""4596-08-17"", ""9839-11-22"", ""cranky_mestorf0"", ""quizzical_austin6"", ""2946-04-17""), (""wizardly_banach8"", 2116482546, ""2012-07-07 12:55:31"", 1462290966, 119, ""vibrant_tesla5"", ""9663-11-15"", ""9046-06-05"", ""naughty_darwin7"", ""confident_colden2"", ""3251-03-08"");
/* dml */ INSERT INTO t VALUES(""inspiring_golick7"", 817095506, ""1992-11-09 23:06:33"", 2045684635, 53, ""heuristic_kowalevski3"", ""4419-07-26"", ""1533-02-16"", ""awesome_lamport6"", ""thirsty_spence9"", ""3856-07-27""), (""boring_visvesvaraya1"", 1387434398, ""1987-08-06 01:39:03"", -360371676, -4, ""wizardly_cray5"", ""2437-09-15"", ""5183-01-21"", ""serene_bose9"", ""dreamy_haibt2"", ""4153-10-05""), (""nervous_kalam7"", -62962874, ""2017-04-20 00:09:34"", 401392615, 10, ""distracted_mayer9"", ""5853-05-25"", ""8256-03-10"", ""hungry_wing1"", ""eloquent_clarke5"", ""9056-04-04""), (""kind_beaver9"", -1837221008, ""2033-08-19 09:34:19"", -1629816812, 36, ""eloquent_nightingale2"", ""9179-05-23"", ""7745-02-13"", ""cocky_kilby4"", ""elegant_hypatia2"", ""2131-10-20""), (""admiring_edison6"", 612417839, ""2030-10-07 03:30:41"", -144947301, 86, ""trusting_nightingale5"", ""7269-11-25"", ""2672-11-15"", ""elastic_borg8"", ""amazing_galileo1"", ""2868-05-09""), (""peaceful_volhard1"", -2098143618, ""2030-08-24 13:10:53"", 636173883, -33, ""youthful_williams4"", ""6939-07-25"", ""7266-08-23"", ""gifted_jennings5"", ""stoic_hugle2"", ""7745-06-26""), (""dazzling_poincare5"", 1281776927, ""2012-06-17 14:35:55"", -10410411, 105, ""serene_cori6"", ""4164-01-27"", ""7779-04-10"", ""adoring_ramanujan4"", ""priceless_cray9"", ""1067-06-29""), (""upbeat_heisenberg2"", -340448991, ""2026-04-30 09:56:17"", -1715980909, -27, ""gracious_yonath6"", ""7356-10-03"", ""6966-03-31"", ""epic_lamport9"", ""agitated_minsky2"", ""9374-07-29""), (""hardcore_hugle8"", 667160615, ""1992-12-02 02:12:19"", -1315288205, 125, ""gallant_stallman7"", ""5680-08-22"", ""4821-02-08"", ""silly_bartik4"", ""eager_keller7"", ""6982-04-25""), (""tender_minsky7"", 2089133212, ""2036-09-19 10:14:19"", -1327069034, 121, ""lucid_morse3"", ""7313-11-19"", ""7492-09-16"", ""youthful_bohr2"", ""wizardly_archimedes6"", ""8184-03-15"");
/* dml */ INSERT INTO t VALUES(""elated_goodall8"", -1612548846, ""2014-12-29 04:21:29"", 817795920, -35, ""hardcore_poincare8"", ""4013-08-11"", ""8091-11-07"", ""awesome_wing7"", ""xenodochial_wiles0"", ""9833-09-03""), (""angry_wilson8"", -968822612, ""2030-09-14 16:59:14"", -2028720218, -126, ""happy_tesla3"", ""5392-08-28"", ""2373-07-05"", ""amazing_jang0"", ""affectionate_brattain5"", ""3857-05-04""), (""clever_stonebraker3"", -2028650192, ""1972-09-15 21:08:59"", -1489842561, -13, ""epic_yonath4"", ""8708-05-23"", ""4216-07-22"", ""kind_payne1"", ""flamboyant_kowalevski5"", ""2088-05-13""), (""agitated_meninsky5"", -342893450, ""1979-02-03 05:31:52"", -1788476670, -70, ""determined_yalow4"", ""7732-12-24"", ""6140-05-03"", ""hopeful_brown4"", ""heuristic_darwin3"", ""6950-05-16""), (""nifty_einstein2"", -940356759, ""1990-04-02 21:14:09"", 1492051527, -16, ""focused_dijkstra2"", ""3071-01-13"", ""3459-06-15"", ""zen_albattani8"", ""vibrant_tesla7"", ""5005-10-25""), (""tender_goldstine7"", 1073560802, ""1977-07-02 07:30:32"", -489388053, 16, ""jovial_almeida8"", ""1358-04-05"", ""7910-09-05"", ""nifty_colden4"", ""tender_curran5"", ""4097-10-04""), (""affectionate_mahavira0"", -1599479712, ""2004-02-18 11:10:13"", 911591372, -66, ""compassionate_agnesi4"", ""7737-12-08"", ""8218-07-22"", ""eloquent_franklin9"", ""lucid_minsky3"", ""3646-11-24""), (""confident_shirley3"", 587064755, ""2028-05-21 12:35:37"", -1193527428, -59, ""affectionate_newton8"", ""8997-03-02"", ""8947-12-17"", ""naughty_perlman7"", ""vibrant_elion2"", ""4393-09-17""), (""elastic_euclid4"", -1590516963, ""2020-11-26 09:53:09"", -698494111, -62, ""angry_fermi5"", ""4491-04-10"", ""7324-12-10"", ""quirky_archimedes0"", ""confident_meninsky8"", ""7204-07-09""), (""priceless_kare3"", 2079208482, ""1978-07-07 00:12:33"", -1708464740, -78, ""modest_heisenberg5"", ""8560-11-29"", ""8152-09-14"", ""thirsty_cray1"", ""pedantic_newton4"", ""7805-05-20"");
/* dml */ INSERT INTO t VALUES(""xenodochial_leavitt3"", 2058017242, ""2007-10-07 08:55:01"", -765946141, 119, ""festive_volhard4"", ""3200-08-10"", ""7031-08-08"", ""vibrant_carson9"", ""gallant_keller3"", ""3280-06-02""), (""sleepy_kowalevski1"", -246341532, ""1991-03-10 04:11:23"", -942996472, 63, ""serene_shockley9"", ""9823-01-03"", ""1430-07-27"", ""jovial_bohr1"", ""eloquent_banach6"", ""2733-07-07""), (""angry_curie0"", 950650933, ""2005-04-07 03:21:52"", 1601876657, -10, ""determined_volhard7"", ""4784-01-01"", ""8639-03-13"", ""youthful_curran5"", ""gifted_hypatia6"", ""7042-11-10""), (""awesome_panini4"", -277273502, ""2036-04-02 15:20:30"", -1328323542, 0, ""clever_williams1"", ""6184-10-02"", ""8905-06-30"", ""tender_jones5"", ""awesome_aryabhata7"", ""5550-08-09""), (""epic_colden2"", 1465974354, ""2009-07-29 02:10:08"", -1240853949, -119, ""pensive_kowalevski7"", ""6739-01-01"", ""3918-03-04"", ""reverent_liskov8"", ""hungry_bhaskara7"", ""8955-03-20""), (""gifted_meninsky8"", -1133744126, ""2037-04-30 03:23:13"", 1113196807, -46, ""loving_fermat3"", ""4587-08-25"", ""6988-06-13"", ""nifty_shaw3"", ""stupefied_meninsky5"", ""3381-04-16""), (""flamboyant_meninsky5"", 1945987768, ""1982-11-15 07:48:21"", 1079576210, -79, ""amazing_feynman3"", ""9711-11-15"", ""1778-09-11"", ""boring_banach1"", ""elegant_engelbart1"", ""1326-12-03""), (""stoic_wescoff2"", 959307944, ""2015-08-27 21:58:10"", -1678519734, -93, ""nervous_volhard0"", ""7763-12-20"", ""6273-03-08"", ""lucid_leavitt6"", ""kickass_roentgen7"", ""5554-09-25""), (""wonderful_aryabhata"", 1348847059, ""1994-04-08 12:02:11"", -215796667, -78, ""serene_agnesi3"", ""6458-05-04"", ""1704-09-28"", ""friendly_austin8"", ""flamboyant_noether8"", ""1381-02-27""), (""gracious_babbage6"", 377597026, ""1982-12-01 14:22:20"", 1427784655, -88, ""kind_ritchie3"", ""5444-01-07"", ""1129-03-14"", ""musing_brown4"", ""focused_jennings8"", ""7665-10-20"");

/* dml_17 */ BEGIN;
/* create_index */ CREATE INDEX k0 on t(`col_10`, `col_0`);
/* create_index */ CREATE INDEX k1 on t(`col_2`, `col_3`);
/* drop_index */ ALTER TABLE t DROP INDEX k0;
/* create_index */ CREATE INDEX k2 on t(`col_3`, `col_1`);
/* drop_index */ ALTER TABLE t DROP INDEX k1;
/* create_index */ CREATE INDEX k3 on t(`col_1`, `col_0`);
/* drop_index */ ALTER TABLE t DROP INDEX k2;
/* create_index */ CREATE INDEX k4 on t(`col_4`, `col_3`, `col_1`);
/* drop_index */ ALTER TABLE t DROP INDEX k3;
/* create_index */ CREATE INDEX k5 on t(`col_4`, `col_10`);
/* drop_index */ ALTER TABLE t DROP INDEX k4;
/* create_index */ CREATE INDEX k6 on t(`col_10`);
/* create_index */ CREATE INDEX k7 on t(`col_9`, `col_8`, `col_7`);
/* create_index */ CREATE INDEX k8 on t(`col_0`, `col_10`);
/* create_index */ CREATE INDEX k9 on t(`col_2`, `col_1`);
/* dml_17 */ SELECT SLEEP(1);
/* dml_17 */ UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY), col_1=col_1/2 WHERE col_4<68;
/* dml_17 */ UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY) WHERE col_3<-529739127;
/* dml_17 */ UPDATE t SET col_0 = CONCAT(col_0, ""-p""), col_8 = CONCAT(col_8, ""-p"") WHERE col_1<1951319788 AND col_5<""blissful_mcnulty6"" AND col_9<""confident_fermat5"" AND col_7<""8912-07-02"";
/* dml_17 */ UPDATE t SET col_10 = ADDDATE(col_10, INTERVAL 1 DAY), col_5 = CONCAT(col_5, ""-p"") WHERE col_7<""4430-01-24"";
/* dml_17 */ UPDATE t SET col_6 = ADDDATE(col_6, INTERVAL 1 DAY) WHERE col_5<""sharp_euclid6"" AND col_3<-1883486410;
/* dml_17 */ UPDATE t SET col_5 = CONCAT(col_5, ""-p""), col_7 = ADDDATE(col_7, INTERVAL 1 DAY) WHERE col_7<""6043-09-24"" AND col_10<""7657-09-06"" AND col_4<26;
/* dml_17 */ UPDATE t SET col_4=col_4/2, col_7 = ADDDATE(col_7, INTERVAL 1 DAY), col_4=col_4/2 WHERE col_4<-121 AND col_3<-62203872 AND col_8<""gallant_minsky3"";
/* dml_17 */ UPDATE t SET col_8 = CONCAT(col_8, ""-p""), col_2 = ADDDATE(col_2, INTERVAL 1 DAY) WHERE col_1<259276311 AND col_7<""9675-10-13"" AND col_4<24;
/* dml_17 */ UPDATE t SET col_3=col_3/2 WHERE col_10<""5930-08-21"";
/* dml_17 */ UPDATE t SET col_4=col_4/2, col_9 = CONCAT(col_9, ""-p"") WHERE col_5<""pedantic_agnesi7"" AND col_7<""6992-10-20"";
/* dml_17 */ COMMIT;

/* done */ ADMIN CHECK TABLE t;
-- done >> Error 8003: t err:[admin:8223]index:<nil> != record:&admin.RecordData{Handle:4, Values:[]types.Datum{types.Datum{k:0x5, collation:""utf8mb4_bin"", decimal:0x0, length:0x0, i:0, b:[]uint8{0x70, 0x65, 0x6e, 0x73, 0x69, 0x76, 0x65, 0x5f, 0x62, 0x65, 0x61, 0x76, 0x65, 0x72, 0x32}, x:interface {}(nil)}, types.Datum{k:0x5, collation:""utf8mb4_bin"", decimal:0x0, length:0x0, i:0, b:[]uint8{0x65, 0x6c, 0x6f, 0x71, 0x75, 0x65, 0x6e, 0x74, 0x5f, 0x73, 0x77, 0x61, 0x6e, 0x73, 0x6f, 0x6e, 0x37}, x:interface {}(nil)}, types.Datum{k:0xd, collation:"""", decimal:0x0, length:0x0, i:0, b:[]uint8(nil), x:types.Time{coreTime:0x6e026e000000000e}}}}

expect: Admin check table got no error.",unspecified,Pessimistic,1,80,-,-,-,-,2,auto,1,explicit,28,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,-,-,Yes,-,Set ENGINE=InnoDB,-,-,-,-,Yes,-,-,-,Yes,"NOT NULL
DEFAULT NULL",-,"No, need repeat",Assertion failure,Consistency: DBMS state,Critical,Yes,Code fix,9 patches: 4 changed files with 313 additions and 166 deletions (fixed with #20910),9,4,313,166,479,10,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_20899
TiDB,20881,https://github.com/pingcap/tidb/issues/20881,"clustered index + new collation + transaction, ","mysql> show create table t;
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                                                                 |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `a` char(10) COLLATE utf8mb4_unicode_ci NOT NULL,
  `b` char(21) COLLATE utf8mb4_general_ci NOT NULL,
  `c` int(11) NOT NULL,
  PRIMARY KEY (`a`,`b`,`c`),
  KEY `idx` (`a`),
  KEY `idx1` (`a`,`b`),
  KEY `idx2` (`a`(1))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
mysql> select * from t;
+----+----+---+
| a  | b  | c |
+----+----+---+
| a5 | b5 | 3 |
+----+----+---+
1 row in set (0.00 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> insert into t values(""a6"", ""b6"", 3);
Query OK, 1 row affected (0.00 sec)

mysql> delete from t;
Query OK, 2 rows affected (0.00 sec)

mysql> select * from t;
+------+------+---+
| a    | b    | c |
+------+------+---+
| 3/ |  B 6 | 3 |
+------+------+---+
1 row in set (0.01 sec)

mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t;
+----+----+---+
| a  | b  | c |
+----+----+---+
| a6 | b6 | 3 |
+----+----+---+
1 row in set (0.00 sec)",Fixed,,-,https://github.com/pingcap/tidb/pull/20934,2020/11/5,Critical,"mysql> show create table t;
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                                                                                 |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `a` char(10) COLLATE utf8mb4_unicode_ci NOT NULL,
  `b` char(21) COLLATE utf8mb4_general_ci NOT NULL,
  `c` int(11) NOT NULL,
  PRIMARY KEY (`a`,`b`,`c`),
  KEY `idx` (`a`),
  KEY `idx1` (`a`,`b`),
  KEY `idx2` (`a`(1))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin |
+-------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
mysql> select * from t;
+----+----+---+
| a  | b  | c |
+----+----+---+
| a5 | b5 | 3 |
+----+----+---+
1 row in set (0.00 sec)

mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> insert into t values(""a6"", ""b6"", 3);
Query OK, 1 row affected (0.00 sec)

mysql> delete from t;
Query OK, 2 rows affected (0.00 sec)

mysql> select * from t;
+------+------+---+
| a    | b    | c |
+------+------+---+
| 3/ |  B 6 | 3 |
+------+------+---+
1 row in set (0.01 sec)

mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t;
+----+----+---+
| a  | b  | c |
+----+----+---+
| a6 | b6 | 3 |
+----+----+---+
1 row in set (0.00 sec)

(Expect all rows are removed, but one row left)",unspecified,Pessimistic,1,1,-,-,-,-,2,auto,1,explicit,5,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,Set ENGINE=InnoDB,-,-,-,-,Yes,Yes,-,-,Yes,NOT NULL,-,Yes,Incorrect database state,Consistency: application state,Critical,Yes,Code fix, 6 patches: 6 changed files with 53 additions and 8 deletions (fixed together with #20856),6,6,53,8,61,7,-,"No, not key-value data structures",Yes,Yes,,,TiDB_20881
TiDB,20773,https://github.com/pingcap/tidb/issues/20773,Transaction amender will cause failure of drainer,"/* INIT */ drop table if exists t;
/* INIT */ create table t (id int primary key, c_str varchar(20));
/* INIT */ insert into t values (1, `0001`), (2, `0002`), (3, null), (4, `0003`), (5, null);
/* TXN */ begin;
/* TXN */ insert into t values (6, `0004`);
/* TXN */ insert into t values (7, null);
/* DDL */ alter table t add c_str_new varchar(20);
/* TXN */ update t set c_str = `0005` where id = 1;
/* TXN */ update t set c_str = null where id = 2;
/* TXN */ update t set c_str = `0006` where id = 3;
/* TXN */ delete from t where id = 4;
/* TXN */ delete from t where id = 5;
/* TXN */ commit;",Fixed,4.0.8,-,https://github.com/pingcap/tidb-binlog/pull/1006,2020/11/2,Major,"/* INIT */ drop table if exists t;
/* INIT */ create table t (id int primary key, c_str varchar(20));
/* INIT */ insert into t values (1, `0001`), (2, `0002`), (3, null), (4, `0003`), (5, null);
/* TXN */ begin;
/* TXN */ insert into t values (6, `0004`);
/* TXN */ insert into t values (7, null);
/* DDL */ alter table t add c_str_new varchar(20);
/* TXN */ update t set c_str = `0005` where id = 1;
/* TXN */ update t set c_str = null where id = 2;
/* TXN */ update t set c_str = `0006` where id = 3;
/* TXN */ delete from t where id = 4;
/* TXN */ delete from t where id = 5;
/* TXN */ commit;

What did you expect to see? (Required)
No error reported by drainer and data is synced to downstream.

What did you see instead (Required)
Drainer exited unexpectedly with error.",unspecified,Pessimistic,1,5,-,-,-,-,2,explicit,9,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,Yes,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Crash,Consistency: DBMS state,Major,Yes,Code fix,11 patches: 29 changed files with 742 additions and 146 deletions,11,29,742,146,888,17,-,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, unsupported statements",,,TiDB_20773
TiDB,20692,https://github.com/pingcap/tidb/issues/20692,Update statement not blocked by primary or unique lock,"create table t (id int primary key, v int, vv int, vvv int, unique key u0(id, v, vv));
insert into t values(1, 1, 1, 1);
begin; begin; begin;
delete from t where id = 1 and v = 1 and vv = 1; -- t1  
insert into t values(1, 2, 3, 4); -- block --t2
update t set id = 10, v = 20, vv = 30, vvv = 40 where id = 1 and v = 2 and vv = 3; -- will not block , 0 rows affected --t3
commit;  --t1 
commit; --t3
commit; --t2",Fixed,4.0.0-beta.2-1419-g974c5fa78,-,https://github.com/pingcap/tidb/pull/20842,2020/10/28,Major,"Prepare table.

create table t (id int primary key, v int, vv int, vvv int, unique key u0(id, v, vv));
insert into t values(1, 1, 1, 1);
In RR isolation level.

(t1, t2, t3) begin;
(t1) delete from t where id = 1 and v = 1 and vv = 1;
(t2) insert into t values(1, 2, 3, 4); -- block
(t3) update t set id = 10, v = 20, vv = 30, vvv = 40 where id = 1 and v = 2 and vv = 3; -- will not block, 0 rows affected
(t1) commit;
(t2) execute success here   |  (t3) commit;
(t2) commit;

The final result is

MySQL [test]> select * from t;
+----+------+------+------+
| id | v    | vv   | vvv  |
+----+------+------+------+
|  1 |    2 |    3 |    4 |
+----+------+------+------+
1 row in set (0.002 sec)
There is a little difference in RC isolation level. Since the insert statement is executed successful when txn1 is committed, we can commit txn2 before txn3, but the final result is same as before.

(t1, t2, t3) begin;
(t1) delete from t where id = 1 and v = 1 and vv = 1;
(t2) insert into t values(1, 2, 3, 4); -- block
(t3) update t set id = 10, v = 20, vv = 30, vvv = 40 where id = 1 and v = 2 and vv = 3; -- will not block, 0 rows affected
(t1) commit;
(t2) execute success here 
(t2) commit;
(t3) commit;

2. What did you expect to see? (Required)
The update statement should be blocked.

3. What did you see instead (Required)
The update statement is not blocked and executed immediately without any affected rows.",REPEATABLE READ,Pessimistic,1,1,-,-,-,-,3,explicit,3,explicit,3,explicit,3,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Missing blocking,Insufficient isolation: missing blocking,Major,Yes,Code fix,10 patches: 4 changed files with 91 additions and 3 deletions.,10,4,65,5,70,12,-,"No, not key-value data structures",Yes,Yes,,,TiDB_20692
TiDB,20535,https://github.com/pingcap/tidb/issues/20535,Delete and insert on multi column index got unexpected ,"create table t2(k int, kk int, val int, primary key(k, kk));
insert into t2 values(1, 1, 1);

begin; -- txn1
begin; -- txn2
delete from t2 where k = 1; -- txn1
insert into t2 values(1, 1, 2); --txn2, got ERROR 1062 (23000): Duplicate entry `1-1` for key `PRIMARY`",Fixed,4.0.7,-,https://github.com/pingcap/tidb/pull/19220,2020/10/20,Critical,"create table t2(k int, kk int, val int, primary key(k, kk));
insert into t2 values(1, 1, 1);

begin; -- txn1
begin; -- txn2
delete from t2 where k = 1; -- txn1
insert into t2 values(1, 1, 2); --txn2, got ERROR 1062 (23000): Duplicate entry `1-1` for key `PRIMARY`

 What did you expect to see? (Required)
insert in txn2 blocked by txn1`s delete.

What did you see instead (Required)
insert in txn2 got Duplicate entry directly.",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,2,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Insufficient isolation: missing blocking,Critical,Yes,Code fix,14 patches: 14 changed files with 153 additions and 45 deletions.,14,14,153,45,198,9,-,"No, not key-value data structures",Yes,Yes,,,TiDB_20535
TiDB,20002,https://github.com/pingcap/tidb/issues/20002,Index data inconsistency after a transaction with cluster-index enabled,"set @@tidb_enable_clustered_index = 1;
drop table if exists t;
-- init
create table t ( c_int int, c_str varchar(40), c_datetime datetime, primary key(c_str) , unique key(c_int), unique key(c_datetime)  );
insert into t values (1, `laughing hertz`, `2020-04-27 20:29:30`), (2, `sharp yalow`, `2020-04-01 05:53:36`), (3, `pedantic hoover`, `2020-03-10 11:49:00`);
-- txn
begin;
update t set c_str = `amazing herschel` where c_int = 3;
select c_int, c_str, c_datetime from t where c_datetime between `2020-01-09 22:00:28` and `2020-04-08 15:12:37`;
commit;
-- check
admin check table t; -- ERROR 8003 (HY000): ...
select * from t where c_datetime = `2020-03-10 11:49:00`;",Fixed,https://github.com/pingcap/tidb/commit/fa6baa9f5321d88f81a99e56af00526643e7bcaa,-,https://github.com/pingcap/tidb/pull/20063,2020/9/15,Major,"set @@tidb_enable_clustered_index = 1;
drop table if exists t;
-- init
create table t ( c_int int, c_str varchar(40), c_datetime datetime, primary key(c_str) , unique key(c_int), unique key(c_datetime)  );
insert into t values (1, `laughing hertz`, `2020-04-27 20:29:30`), (2, `sharp yalow`, `2020-04-01 05:53:36`), (3, `pedantic hoover`, `2020-03-10 11:49:00`);
-- txn
begin;
update t set c_str = `amazing herschel` where c_int = 3;
select c_int, c_str, c_datetime from t where c_datetime between `2020-01-09 22:00:28` and `2020-04-08 15:12:37`;
commit;
-- check
admin check table t; -- ERROR 8003 (HY000): ...
select * from t where c_datetime = `2020-03-10 11:49:00`;

What did you expect to see? (Required)
admin check table is ok and the last select statement has one row returned.

What did you see instead (Required)
mysql> admin check table t; -- ERROR 8003 (HY000): ...
ERROR 8003 (HY000): t err:[admin:8223]index:<nil> != record:&admin.RecordData{Handle:(*kv.CommonHandle)(0xc0018b8270), Values:[]types.Datum{types.Datum{k:0xd, decimal:0x0, length:0x0, i:0, collation:"""", b:[]uint8(nil), x:types.Time{coreTime:0x1f90d4bc40000000}}}}
mysql> select * from t where c_datetime = `2020-03-10 11:49:00`;
Empty set (0.06 sec)",unspecified,Pessimistic,1,3,-,-,-,-,2,auto,2,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,Yes,-,set @@tidb_enable_clustered_index = 1;,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Incorrect database state,Consistency: DBMS state,Major,Yes,Code fix, 2 patches: 3 changed files with 14 additions and 2 deletions.,2,3,14,2,16,2,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_20002
TiDB,19585,https://github.com/pingcap/tidb/issues/19585,A row got updated twice by one update statement,"drop table if exists t1;
create table t1  (c_int int, primary key (c_int)) partition by range (c_int) (partition p0 values less than (10), partition p1 values less than maxvalue) ;
insert into t1 (c_int) values (1);

begin;
insert into t1 values (10);
update t1 set c_int = c_int + 10 where c_int in (1, 11);
commit;
select * from t1 order by c_int;",Fixed,https://github.com/pingcap/tidb/commit/b0c3fe7ba3acf8864709c825af681e5b35a111f2,-,https://github.com/pingcap/tidb/pull/19042,2020/8/28,Critical,"drop table if exists t1;
create table t1  (c_int int, primary key (c_int)) partition by range (c_int) (partition p0 values less than (10), partition p1 values less than maxvalue) ;
insert into t1 (c_int) values (1);

begin;
insert into t1 values (10);
update t1 set c_int = c_int + 10 where c_int in (1, 11);
commit;
select * from t1 order by c_int;

What did you expect to see? (Required)
+-------+
| c_int |
+-------+
|    10 |
|    11 |
+-------+
What did you see instead (Required)
+-------+
| c_int |
+-------+
|    10 |
|    21 |
+-------+",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,Yes,Yes,Incorrect database state,Consistency: application state,Critical,Yes,Code fix,6 patches: 12 changed files with 204 additions and 144 deletions.,6,12,204,144,348,21,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,TiDB_19585
TiDB,19194,https://github.com/pingcap/tidb/issues/19194,Failed to replace after failure of insertion in a transaction,"drop table if exists t;
create table t (c_int int, c_str varchar(40), primary key (c_int));
insert into t values (1, `Alice`);
begin;
insert into t values (1, `Bob`), (1, `Carol`);
replace into t values (1, `Dave`); -- failed with error 1062
commit;
replace into t values (1, `Dave`);",Fixed,release-4.0,-,https://github.com/pingcap/tidb/pull/20042,2020/8/14,Major,"drop table if exists t;
create table t (c_int int, c_str varchar(40), primary key (c_int));
insert into t values (1, `Alice`);
mysql> begin;
Query OK, 0 rows affected (0.06 sec)

mysql> insert into t values (1, `Bob`), (1, `Carol`);
ERROR 1062 (23000): Duplicate entry `1` for key `PRIMARY`

mysql> replace into t values (1, `Dave`);
ERROR 1062 (23000): Duplicate entry `1` for key `PRIMARY`  (The replace in the transaction shouldn`t fail.)

mysql> commit;
Query OK, 0 rows affected (0.05 sec)

mysql> replace into t values (1, `Dave`);
Query OK, 2 rows affected (0.08 sec)

What did you expect to see? (Required)
The replace in the transaction shouldn`t fail.",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,Major,Yes,Code fix,8 patches: 6 changed files with 75 additions and 6 deletions.(fixed together with  #18956),8,6,75,6,81,42,-,"No, involve complex operations other than read(key) and write(key, value)",Yes,"No, unsupported statements",,,TiDB_19194
TiDB,19136,https://github.com/pingcap/tidb/issues/19136,Result of an in-transaction query is incorrect,"drop table if exists t;
-- init
create table t ( c_int int, c_str varchar(40), primary key(c_int, c_str) );
-- txn
begin;
insert into t values (1, `amazing almeida`), (2, `boring bardeen`), (3, `busy wescoff`);
select c_int, (select t1.c_int from t t1 where t1.c_int = 3 and t1.c_int > t.c_int order by t1.c_int limit 1) x from t;
commit;
select c_int, (select t1.c_int from t t1 where t1.c_int = 3 and t1.c_int > t.c_int order by t1.c_int limit 1) x from t;",Fixed,release-4.0,-,https://github.com/pingcap/tidb/pull/19300,2020/8/11,Critical,"drop table if exists t;
-- init
create table t ( c_int int, c_str varchar(40), primary key(c_int, c_str) );
-- txn
begin;
insert into t values (1, `amazing almeida`), (2, `boring bardeen`), (3, `busy wescoff`);
mysql> select c_int, (select t1.c_int from t t1 where t1.c_int = 3 and t1.c_int > t.c_int order by t1.c_int limit 1) x from t;
+-------+------+
| c_int | x    |
+-------+------+
|     1 |    3 |
|     2 | NULL |
|     3 | NULL |
+-------+------+
3 rows in set (0.05 sec)

mysql> commit;
Query OK, 0 rows affected (0.05 sec)

mysql> select c_int, (select t1.c_int from t t1 where t1.c_int = 3 and t1.c_int > t.c_int order by t1.c_int limit 1) x from t;
+-------+------+
| c_int | x    |
+-------+------+
|     1 |    3 |
|     2 |    3 |
|     3 | NULL |
+-------+------+
3 rows in set (0.06 sec)

Both selection should return:

+-------+------+
| c_int | x    |
+-------+------+
|     1 |    3 |
|     2 |    3 |
|     3 | NULL |
+-------+------+  
",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Incorrect query result,Consistency: application state,Critical,Yes,Code fix,7 patches: 3 changed files with 32 additions and 0 deletions.,7,3,32,0,32,14,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,TiDB_19136
TiDB,19104,https://github.com/pingcap/tidb/issues/19104,Selection in a transaction returns wrong result after an on-duplicate-update insert.,"drop table if exists t;
-- init
create table t ( c_int int, c_str varchar(40), c_datetime datetime, c_timestamp timestamp, c_double double, c_decimal decimal(12, 6) , primary key(c_int, c_str) , unique key(c_int) , unique key(c_str) , unique key(c_decimal) , unique key(c_datetime) , key(c_timestamp) );
insert into t values (1, `zen ardinghelli`, `2020-02-03 18:15:17`, `2020-03-11 05:47:11`, 36.226534, 3.763), (2, `suspicious joliot`, `2020-01-01 22:56:37`, `2020-04-07 06:19:07`, 62.756537, 5.567), (3, `keen zhukovsky`, `2020-01-21 04:09:20`, `2020-06-06 08:32:14`, 33.115065, 1.381), (4, `crazy newton`, `2020-02-14 21:37:56`, `2020-04-28 08:33:48`, 44.146318, 4.249), (5, `happy black`, `2020-03-12 16:04:14`, `2020-01-18 09:17:37`, 41.962653, 5.959);
insert into t values (6, `vigilant swartz`, `2020-06-01 07:37:44`, `2020-05-25 01:26:43`, 56.352233, 2.202), (7, `suspicious germain`, `2020-04-16 23:25:23`, `2020-03-17 05:06:57`, 55.897698, 3.460), (8, `festive chandrasekhar`, `2020-02-11 23:40:29`, `2020-04-08 10:13:04`, 77.565691, 0.540), (9, `vigorous meninsky`, `2020-02-17 10:03:17`, `2020-01-02 15:02:02`, 6.484815, 6.292), (10, `heuristic moser`, `2020-04-20 12:18:49`, `2020-06-20 20:20:18`, 28.023822, 2.765);
insert into t values (11, `sharp carver`, `2020-03-01 11:23:41`, `2020-03-23 17:59:05`, 40.842442, 6.345), (12, `trusting noether`, `2020-03-28 06:42:34`, `2020-01-27 15:33:40`, 49.544658, 4.811), (13, `objective ishizaka`, `2020-01-28 17:30:55`, `2020-04-02 17:45:39`, 59.523930, 5.015), (14, `sad rhodes`, `2020-03-30 21:43:37`, `2020-06-09 06:53:53`, 87.295753, 2.413), (15, `wonderful shockley`, `2020-04-29 09:17:11`, `2020-03-14 04:36:51`, 6.778588, 8.497);
-- txn
begin;
insert into t values (13, `vibrant yalow`, `2020-05-15 06:59:05`, `2020-05-03 05:58:45`, 43.721929, 8.066), (14, `xenodochial spence`, `2020-02-13 17:28:07`, `2020-04-01 12:18:30`, 19.981331, 5.774), (22, `eloquent neumann`, `2020-02-10 16:00:20`, `2020-03-28 00:24:42`, 10.702532, 7.618) on duplicate key update c_int=values(c_int), c_str=values(c_str), c_double=values(c_double), c_timestamp=values(c_timestamp);
select sum((select t1.c_str from t t1 where t1.c_int = 11 and t1.c_str > t.c_str order by t1.c_decimal limit 1) is null) nulls from t order by c_str;
+-------+
| nulls |
+-------+
|     0 |
+-------+
1 row in set (0.07 sec)

expect see:
+-------+
| nulls |
+-------+
|    10 |
+-------+

commit;
select sum((select t1.c_str from t t1 where t1.c_int = 11 and t1.c_str > t.c_str order by t1.c_decimal limit 1) is null) nulls from t order by c_str;
+-------+
| nulls |
+-------+
|    10 |
+-------+
1 row in set (0.07 sec)",Fixed,release-4.0,-,https://github.com/pingcap/tidb/pull/19128,2020/8/10,Critical,"drop table if exists t;
-- init
create table t ( c_int int, c_str varchar(40), c_datetime datetime, c_timestamp timestamp, c_double double, c_decimal decimal(12, 6) , primary key(c_int, c_str) , unique key(c_int) , unique key(c_str) , unique key(c_decimal) , unique key(c_datetime) , key(c_timestamp) );
insert into t values (1, `zen ardinghelli`, `2020-02-03 18:15:17`, `2020-03-11 05:47:11`, 36.226534, 3.763), (2, `suspicious joliot`, `2020-01-01 22:56:37`, `2020-04-07 06:19:07`, 62.756537, 5.567), (3, `keen zhukovsky`, `2020-01-21 04:09:20`, `2020-06-06 08:32:14`, 33.115065, 1.381), (4, `crazy newton`, `2020-02-14 21:37:56`, `2020-04-28 08:33:48`, 44.146318, 4.249), (5, `happy black`, `2020-03-12 16:04:14`, `2020-01-18 09:17:37`, 41.962653, 5.959);
insert into t values (6, `vigilant swartz`, `2020-06-01 07:37:44`, `2020-05-25 01:26:43`, 56.352233, 2.202), (7, `suspicious germain`, `2020-04-16 23:25:23`, `2020-03-17 05:06:57`, 55.897698, 3.460), (8, `festive chandrasekhar`, `2020-02-11 23:40:29`, `2020-04-08 10:13:04`, 77.565691, 0.540), (9, `vigorous meninsky`, `2020-02-17 10:03:17`, `2020-01-02 15:02:02`, 6.484815, 6.292), (10, `heuristic moser`, `2020-04-20 12:18:49`, `2020-06-20 20:20:18`, 28.023822, 2.765);
insert into t values (11, `sharp carver`, `2020-03-01 11:23:41`, `2020-03-23 17:59:05`, 40.842442, 6.345), (12, `trusting noether`, `2020-03-28 06:42:34`, `2020-01-27 15:33:40`, 49.544658, 4.811), (13, `objective ishizaka`, `2020-01-28 17:30:55`, `2020-04-02 17:45:39`, 59.523930, 5.015), (14, `sad rhodes`, `2020-03-30 21:43:37`, `2020-06-09 06:53:53`, 87.295753, 2.413), (15, `wonderful shockley`, `2020-04-29 09:17:11`, `2020-03-14 04:36:51`, 6.778588, 8.497);
-- txn
mysql> begin;
Query OK, 0 rows affected (0.05 sec)

mysql> insert into t values (13, `vibrant yalow`, `2020-05-15 06:59:05`, `2020-05-03 05:58:45`, 43.721929, 8.066), (14, `xenodochial spence`, `2020-02-13 17:28:07`, `2020-04-01 12:18:30`, 19.981331, 5.774), (22, `eloquent neumann`, `2020-02-10 16:00:20`, `2020-03-28 00:24:42`, 10.702532, 7.618) on duplicate key update c_int=values(c_int), c_str=values(c_str), c_double=values(c_double), c_timestamp=values(c_timestamp);
Query OK, 5 rows affected (0.05 sec)
Records: 3  Duplicates: 2  Warnings: 0

mysql> select sum((select t1.c_str from t t1 where t1.c_int = 11 and t1.c_str > t.c_str order by t1.c_decimal limit 1) is null) nulls from t order by c_str;
+-------+
| nulls |
+-------+
|     0 |
+-------+
1 row in set (0.07 sec)

mysql> commit;
Query OK, 0 rows affected (0.06 sec)

mysql> select sum((select t1.c_str from t t1 where t1.c_int = 11 and t1.c_str > t.c_str order by t1.c_decimal limit 1) is null) nulls from t order by c_str;
+-------+
| nulls |
+-------+
|    10 |
+-------+
1 row in set (0.07 sec)",unspecified,Pessimistic,1,15,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Incorrect query result,Consistency: application state,Critical,Yes,Code fix,4 patches: 5 changed files with 75 additions and 1 deletion.,4,5,75,1,76,2,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,TiDB_19104
TiDB,19063,https://github.com/pingcap/tidb/issues/19063,Insert on duplicate key update does not return error when there is conflict,"create table t ( c_int int, c_string varchar(40) collate utf8mb4_bin , primary key (c_string), unique key (c_int));

begin;
replace into t values (22, `gold witch`), (24, `gray singer`), (21, `silver sight`);
commit;
begin;
insert into t values (21,`black warlock`), (22, `dark sloth`), (21,  `cyan song`) on duplicate key update c_int = c_int + 1, c_string = concat(c_int, `:`, c_string);
commit;
select * from t;
drop table t;",Fixed,4.0.0-beta.2-913-gceff1fcaf,-,https://github.com/pingcap/tidb/pull/19071,2020/8/7,Critical,"create table t ( c_int int, c_string varchar(40) collate utf8mb4_bin , primary key (c_string), unique key (c_int));

begin;
replace into t values (22, `gold witch`), (24, `gray singer`), (21, `silver sight`);
commit;
begin;
insert into t values (21,`black warlock`), (22, `dark sloth`), (21,  `cyan song`) on duplicate key update c_int = c_int + 1, c_string = concat(c_int, `:`, c_string);
commit;
select * from t;
drop table t;

For the insert statement, it should return:

ERROR 1062 (23000): Duplicate entry `22` for key `t.c_int`
The select statement should return:

mysql> select * from t;
+-------+--------------+
| c_int | c_string     |
+-------+--------------+
|    21 | silver sight |
|    22 | gold witch   |
|    24 | gray singer  |
+-------+--------------+
3 rows in set (0.00 sec)
3. What did you see instead (Required)
The insert statement returns:

Query OK, 5 rows affected (0.00 sec)
Records: 3  Duplicates: 2  Warnings: 0
The select statement returns:

mysql> select * from t;
+-------+--------------------+
| c_int | c_string           |
+-------+--------------------+
|    22 | gold witch         |
|    24 | gray singer        |
|    23 | 23:22:silver sight |
|    21 | cyan song          |
+-------+--------------------+
4 rows in set (0.00 sec)",unspecified,Pessimistic,1,0,-,-,-,-,3,explicit,3,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,Yes,-,-,Yes,Missing error,Statement correctness: missing error,Critical,Yes,Code fix,3 patches: 3 changed files with 20 additions and 3 deletions,3,3,20,3,23,2,-,"No, involve complex operations other than read(key) and write(key, value)",Yes,"No, unsupported statements",,,TiDB_19063
TiDB,18958,https://github.com/pingcap/tidb/issues/18958,An insert statement which violate key constraint can be committed successfully,"drop table if exists t;
-- init
create table t (
    c_int       int auto_increment,
    c_double    double,
    c_decimal   decimal(12, 6),
    c_string    varchar(40) collate utf8_general_ci,
    c_datetime  datetime,
    c_timestamp timestamp,
    c_enum      enum (`a`, `b`, `c`, `d`, `e`),
    c_set       set (`1`, `2`, `3`, `4`, `5`),
    c_json      json,
    primary key (c_int),
    unique key (c_string),
    key (c_enum),
    key (c_set),
    key (c_timestamp),
    key (c_datetime),
    key (c_decimal)
);
insert into t (`c_int`, `c_double`, `c_decimal`, `c_string`, `c_datetime`, `c_timestamp`, `c_enum`, `c_set`, `c_json`) values
  (1, 0.718657, 91.150000, `red curtain`, `2020-01-02 02:00:00`, `2020-01-03 21:11:41`, `d`, `1`, `{\""datetime\"": \""2019-12-27 05:00:00\"", \""enum\"": \""a\"", \""int\"": 20, \""set\"": \""1,2,3\"", \""str\"": \""ivory crest\""}`)
, (2, 0.070684, 74.820000, `gold sloth`, `2019-12-26 03:00:00`, `2019-12-26 18:02:54`, `e`, `2`, `{\""datetime\"": \""2020-01-04 02:00:00\"", \""enum\"": \""a\"", \""int\"": 16, \""set\"": \""5\"", \""str\"": \""cream spider\""}`)
, (3, 0.490952, 85.290000, `blue roach`, `2020-01-03 14:00:00`, `2019-12-25 03:47:00`, `d`, `1,4`, `{\""datetime\"": \""2020-01-04 12:00:00\"", \""enum\"": \""c\"", \""int\"": 18, \""set\"": \""2\"", \""str\"": \""light seer\""}`)
, (4, 0.427215, 55.340000, `cerulean ant`, `2020-01-03 18:00:00`, `2019-12-29 17:11:56`, `a`, `1,2,5`, `{\""datetime\"": \""2019-12-25 21:00:00\"", \""enum\"": \""d\"", \""int\"": 11, \""set\"": \""4,5\"", \""str\"": \""orange cat\""}`)
, (5, 0.88423, 80.510000, `black seer`, `2020-01-07 06:00:00`, `2020-01-06 09:41:17`, `e`, `1,3`, `{\""datetime\"": \""2020-01-04 04:00:00\"", \""enum\"": \""c\"", \""int\"": 8, \""set\"": \""4,5\"", \""str\"": \""light bard\""}`)
, (6, 0.263039, 6.790000, `orange crest`, `2020-01-04 12:00:00`, `2019-12-27 05:27:06`, `e`, `1,4`, `{\""datetime\"": \""2020-01-03 20:00:00\"", \""enum\"": \""b\"", \""int\"": 3, \""set\"": \""2,5\"", \""str\"": \""gray warrior\""}`)
, (7, 0.444086, 47.430000, `cyan bard`, `2020-01-06 06:00:00`, `2020-01-04 04:39:49`, `d`, `5`, `{\""datetime\"": \""2020-01-03 06:00:00\"", \""enum\"": \""e\"", \""int\"": 16, \""set\"": \""1,4\"", \""str\"": \""light fly\""}`)
, (8, 0.709668, 94.560000, `yellow speaker`, `2020-01-04 04:00:00`, `2020-01-02 19:24:03`, `d`, `2,3,4,5`, `{\""datetime\"": \""2019-12-30 13:00:00\"", \""enum\"": \""e\"", \""int\"": 4, \""set\"": \""1,2,3\"", \""str\"": \""green vulture\""}`)
, (9, 0.899852, 80.660000, `pink warrior`, `2020-01-04 16:00:00`, `2020-01-02 15:02:03`, `d`, `1,3,5`, `{\""datetime\"": \""2019-12-27 13:00:00\"", \""enum\"": \""e\"", \""int\"": 14, \""set\"": \""1,4,5\"", \""str\"": \""dark kangaroo\""}`)
, (10, 0.277686, 24.880000, `black cat`, `2020-01-06 14:00:00`, `2020-01-06 03:57:43`, `d`, `1,3`, `{\""datetime\"": \""2020-01-06 10:00:00\"", \""enum\"": \""c\"", \""int\"": 6, \""set\"": \""2\"", \""str\"": \""gray carpet\""}`)
, (11, 0.365868, 97.450000, `azure bard`, `2019-12-29 03:00:00`, `2019-12-31 09:48:56`, `a`, `4,5`, `{\""datetime\"": \""2019-12-25 19:00:00\"", \""enum\"": \""c\"", \""int\"": 3, \""set\"": \""1,2,4,5\"", \""str\"": \""white singer\""}`)
, (12, 0.136982, 14.990000, `green seer`, `2019-12-29 07:00:00`, `2019-12-25 03:56:42`, `c`, `1,3,4`, `{\""datetime\"": \""2019-12-27 05:00:00\"", \""enum\"": \""d\"", \""int\"": 6, \""set\"": \""4\"", \""str\"": \""navy witch\""}`)
, (13, 0.716163, 85.410000, `gray scourge`, `2020-01-03 06:00:00`, `2019-12-29 17:30:24`, `e`, `3,5`, `{\""datetime\"": \""2019-12-29 21:00:00\"", \""enum\"": \""b\"", \""int\"": 18, \""set\"": \""1,2,3,4\"", \""str\"": \""silver sloth\""}`)
, (14, 0.319057, 73.440000, `dark fly`, `2020-01-06 04:00:00`, `2020-01-05 02:16:03`, `b`, `3,4,5`, `{\""datetime\"": \""2019-12-26 05:00:00\"", \""enum\"": \""e\"", \""int\"": 2, \""set\"": \""1,2,3,4\"", \""str\"": \""ivory fly\""}`)
, (15, 0.45908, 77.550000, `silver vulture`, `2019-12-29 09:00:00`, `2019-12-30 16:06:20`, `d`, `3`, `{\""datetime\"": \""2019-12-31 07:00:00\"", \""enum\"": \""a\"", \""int\"": 20, \""set\"": \""2,3,4\"", \""str\"": \""dark sloth\""}`)
, (16, 0.846275, 6.020000, `red kangaroo`, `2019-12-30 03:00:00`, `2020-01-02 15:00:37`, `a`, `3,5`, `{\""datetime\"": \""2020-01-05 20:00:00\"", \""enum\"": \""b\"", \""int\"": 6, \""set\"": \""1,5\"", \""str\"": \""white vulture\""}`)
, (20, 0.939371, 47.980000, `gray mistress`, `2020-01-07 02:00:00`, `2019-12-28 12:00:28`, `d`, `1`, `{\""datetime\"": \""2020-01-05 02:00:00\"", \""enum\"": \""b\"", \""int\"": 6, \""set\"": \""2,4\"", \""str\"": \""cerulean curtain\""}`)
;
-- txn
begin;
update t set c_string = `gray mistress` where c_int = 10;
insert into t values (10, 0.133544, 0.39, `cyan fly`, `2020-01-05 20:00:00`, `2020-01-02 14:21:55`, `c`, `1,2,5`, `{""int"":18,""str"":""cyan trader"",""datetime"":""2020-01-07 08:00:00"",""enum"":""b"",""set"":""2,3""}`);
commit;
select * from t where c_int = 10;",Fixed,4.0.4,-,https://github.com/pingcap/tidb/pull/19004,2020/8/4,Critical,"The last insert statement of the transaction should failed with ERROR 1062 (23000): Duplicate entry `10` for key `PRIMARY`.
row where c_int = 10 has been updated by the transaction unexpectly.
A minimal case to reproduce this problem
drop table if exists t1;
create table t1(c1 int primary key, c2 int, c3 int, unique key uk(c2));
insert into t1 values(1, 2, 3);
insert into t1 values(10, 20, 30);



TiDB
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> update t1 set c2 = 20 where c1 = 1;
ERROR 1062 (23000): Duplicate entry `20` for key `uk`
mysql> insert into t1 values(1, 15, 300); 
Query OK, 1 row affected (0.00 sec)

mysql> commit; 

mysql> select * from t1;
+----+------+------+
| c1 | c2   | c3   |
+----+------+------+
|  1 |   15 |  300 |
| 10 |   20 |   30 |
+----+------+------+
2 rows in set (0.00 sec)


MySQL 
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> update t1 set c2 = 20 where c1 = 1;
ERROR 1062 (23000): Duplicate entry `20` for key `uk`
mysql> insert into t1 values(1, 15, 300);
ERROR 1062 (23000): Duplicate entry `1` for key `PRIMARY`
mysql> commit;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from t1;
+----+------+------+
| c1 | c2   | c3   |
+----+------+------+
|  1 |    2 |    3 |
| 10 |   20 |   30 |
+----+------+------+
2 rows in set (0.00 sec)",unspecified,Pessimistic,1,2,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Missing error,Statement correctness: missing error,Critical,Yes,Code fix,2 patches: 7 changed files with 212 additions and 7 deletions.,2,7,212,7,219,2,-,"No, not key-value data structures",Yes,Yes,,,TiDB_18958
TiDB,18956,https://github.com/pingcap/tidb/issues/18956,Delete statement reports ,"create table t (
    c_int       int,
    c_double    double,
    c_decimal   decimal(12, 6),
    c_string    varchar(40),
    c_datetime  datetime,
    c_timestamp timestamp,
    c_enum      enum (`a`, `b`, `c`, `d`, `e`),
    c_set       set (`1`, `2`, `3`, `4`, `5`),
    c_json      json,
    primary key (c_int),
    unique key (c_string),
    key (c_enum),
    key (c_set),
    key (c_timestamp),
    key (c_datetime),
    key (c_decimal)
);
insert into t (`c_int`, `c_double`, `c_decimal`, `c_string`, `c_datetime`, `c_timestamp`, `c_enum`, `c_set`, `c_json`) values
  (2, 0.029523, 74.040000, `gold mistress`, `2020-01-02 00:00:00`, `2019-12-25 03:24:58`, `c`, `1,3,5`, `{\""datetime\"": \""2019-12-26 13:00:00\"", \""enum\"": \""d\"", \""int\"": 3, \""set\"": \""1,4,5\"", \""str\"": \""gray koala\""}`)
, (4, 0.924873, 35.020000, `gray witch`, `2019-12-26 17:00:00`, `2020-01-05 13:01:59`, `d`, `1`, `{\""datetime\"": \""2019-12-30 19:00:00\"", \""enum\"": \""d\"", \""int\"": 4, \""set\"": \""1,5\"", \""str\"": \""violet head\""}`)
, (5, 0.268598, 59.660000, `pink fly`, `2020-01-04 12:00:00`, `2020-01-06 05:33:43`, `d`, `1,3,4,5`, `{\""datetime\"": \""2020-01-04 06:00:00\"", \""enum\"": \""c\"", \""int\"": 10, \""set\"": \""\"", \""str\"": \""gold fly\""}`)
, (6, 0.551611, 70.960000, `azure bard`, `2020-01-06 02:00:00`, `2020-01-07 13:20:29`, `d`, `3,4,5`, `{\""datetime\"": \""2019-12-30 21:00:00\"", \""enum\"": \""b\"", \""int\"": 4, \""set\"": \""2,5\"", \""str\"": \""dark kangaroo\""}`)
, (7, 0.197616, 9.090000, `dark curtain`, `2020-01-06 02:00:00`, `2019-12-30 05:50:54`, `e`, `1,2,4`, `{\""datetime\"": \""2019-12-31 05:00:00\"", \""enum\"": \""b\"", \""int\"": 17, \""set\"": \""3\"", \""str\"": \""dark jester\""}`)
, (8, 0.515967, 28.090000, `cyan crown`, `2019-12-29 09:00:00`, `2019-12-30 00:17:50`, `e`, `1,2,3,4,5`, `{\""datetime\"": \""2020-01-02 22:00:00\"", \""enum\"": \""d\"", \""int\"": 19, \""set\"": \""4\"", \""str\"": \""black seer\""}`)
, (9, 0.688223, 5.000000, `gold bard`, `2020-01-01 06:00:00`, `2019-12-26 14:17:18`, `e`, `3`, `{\""datetime\"": \""2019-12-27 11:00:00\"", \""enum\"": \""c\"", \""int\"": 9, \""set\"": \""2\"", \""str\"": \""ivory paladin\""}`)
, (10, 0.460531, 11.080000, `brown cat`, `2020-01-01 08:00:00`, `2019-12-31 16:51:26`, `d`, `2`, `{\""datetime\"": \""2019-12-28 11:00:00\"", \""enum\"": \""c\"", \""int\"": 20, \""set\"": \""3\"", \""str\"": \""crimson tooth\""}`)
, (11, 0.360937, 4.630000, `yellow master`, `2019-12-31 15:00:00`, `2019-12-31 06:12:42`, `c`, ``, `{\""datetime\"": \""2019-12-29 13:00:00\"", \""enum\"": \""d\"", \""int\"": 17, \""set\"": \""2,5\"", \""str\"": \""cyan spider\""}`)
, (12, 0.745632, 58.540000, `yellow kangaroo`, `2020-01-01 18:00:00`, `2020-01-02 15:50:29`, `b`, `1,3`, `{\""datetime\"": \""2019-12-31 17:00:00\"", \""enum\"": \""a\"", \""int\"": 20, \""set\"": \""3,4\"", \""str\"": \""light song\""}`)
, (13, 0.203077, 4.870000, `light fly`, `2020-01-03 10:00:00`, `2020-01-01 03:05:33`, `c`, `1,5`, `{\""datetime\"": \""2020-01-02 12:00:00\"", \""enum\"": \""c\"", \""int\"": 15, \""set\"": \""1,3,4,5\"", \""str\"": \""navy carpet\""}`)
, (14, 0.622945, 99.270000, `white kangaroo`, `2019-12-29 13:00:00`, `2019-12-26 22:21:32`, `a`, `1,2,3,5`, `{\""datetime\"": \""2019-12-28 03:00:00\"", \""enum\"": \""b\"", \""int\"": 18, \""set\"": \""2,4,5\"", \""str\"": \""carnelian kangaroo\""}`)
, (15, 0.663324, 17.760000, `orange kangaroo`, `2020-01-01 00:00:00`, `2019-12-28 12:57:30`, `c`, `1`, `{\""datetime\"": \""2019-12-25 19:00:00\"", \""enum\"": \""d\"", \""int\"": 1, \""set\"": \""2,3\"", \""str\"": \""cream roach\""}`)
, (16, 0.218067, 25.030000, `cyan watcher`, `2020-01-01 10:00:00`, `2019-12-31 10:36:08`, `d`, `3,4,5`, `{\""datetime\"": \""2019-12-30 03:00:00\"", \""enum\"": \""d\"", \""int\"": 3, \""set\"": \""4\"", \""str\"": \""green trader\""}`);

begin;
update t set c_decimal = c_decimal + 5 where c_decimal <= 20;
insert into t values (5, 0.157960, 67.26, `brown cat`, `2019-12-28 15:00:00`, `2020-01-07 07:22:43`, `c`, `1`, `{""int"":13,""str"":""ivory vulture"",""datetime"":""2019-12-31 05:00:00"",""enum"":""b"",""set"":""3,5""}`);
delete from t where c_int = 5;
rollback;",Fixed,4.0.4,-,https://github.com/pingcap/tidb/pull/20042,2020/8/3,Major,"CREATE TABLE `t1` (
  `c1` int(11) NOT NULL,
  `c2` int(11) DEFAULT NULL,
  `c3` int(11) DEFAULT NULL,
  PRIMARY KEY (`c1`),
  UNIQUE KEY `k1` (`c2`)
)

mysql> select * from t1;
+----+------+------+
| c1 | c2   | c3   |
+----+------+------+
|  1 |    2 |    3 |
| 10 |   20 |   30 |
+----+------+------+


steps:
mysql> begin;
Query OK, 0 rows affected (0.00 sec)

mysql> update t1 set c3 = c3 + 1 where c3 > 10;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> insert into t1 values(1, 20, 100);
ERROR 1062 (23000): DupNolicate entry `20` for key `k1`
mysql> delete from t1 where c1 = 1;
ERROR 1062 (23000): Duplicate entry `1` for key `PRIMARY`
mysql> rollback;
Query OK, 0 rows affected (0.01 sec)

The insert statement should report ERROR 1062: Duplicate entry, but the last delete statement shouldn`t.",unspecified,Pessimistic,1,2,-,-,-,-,1,explicit,5,-,-,-,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,Yes,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,"NOT NULL
DEFAULT NULL",-,Yes,Unexpected error,Statement correctness: unexpected error,Major,Yes,Code fix,8 patches: 6 changed files with 75 additions and 6 deletions.,8,6,75,6,81,91,-,"No, not key-value data structures",Yes,Yes,,,TiDB_18956
TiDB,17851,https://github.com/pingcap/tidb/issues/17851,TiDB doesn`t lock non-existent unique-key when select for update from TiFlash,"create table:
create table if not exists txn0 (id int not null primary key, val text);

create tiflash replica and wait for the replica become available:
alter table txn0 set tiflash replica 1;

in the first terminal, type the following sql:
set @@session.tidb_isolation_read_engines = ""tiflash"";
begin pessimistic;
select val from txn0 where id = 25 for update;

in the second terminal, type the following sql:
insert into txn0 (id, val) values (25, `5`);",Fixed,"3.1.0, 4.0.0",-,https://github.com/pingcap/tidb/pull/18458,2020/6/8,Critical,"1. Minimal reproduce step (Required)
create table:
create table if not exists txn0 (id int not null primary key, val text);

create tiflash replica and wait for the replica become available:
alter table txn0 set tiflash replica 1;

in the first terminal, type the following sql:
set @@session.tidb_isolation_read_engines = ""tiflash"";
begin pessimistic;
select val from txn0 where id = 25 for update;

in the second terminal, type the following sql:
insert into txn0 (id, val) values (25, `5`);

2. What did you expect to see? (Required)
The insert statement will get stuck.

3. What did you see instead (Required)
The insert statement succeed.
",unspecified,Pessimistic,1,0,-,-,-,-,2,auto,1,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,"set @@session.tidb_isolation_read_engines = ""tiflash"";",-,create tiflash replica,-,-,Yes,-,-,-,-,NOT NULL,-,Yes,Missing blocking,Insufficient isolation: missing blocking,Critical,Yes,Code fix,4 patches: 5 changed files with 87 additions and 33 deletions.,4,5,87,33,120,36,-,"No, history does not reflect the problem","No, DBMS-specific","No, unsupported statements",,,TiDB_17851
TiDB,17797,https://github.com/pingcap/tidb/issues/17797,P2-[4.0-bug-hunting]-[Pessimistic Transaction]-Lock Wait Timeout Error Incompatible,"DROP TABLE t1;
CREATE TABLE t1 (
 id int not null primary key auto_increment,
 t varchar(100)
);
INSERT INTO t1 VALUES (1, `acdc`), (2, `afddfdc`);

# session 1
START TRANSACTION;
UPDATE t1 SET t=`new...` WHERE id = 1;

# session 2
START TRANSACTION;
UPDATE t1 SET t=`newval` WHERE id = 1;",Closed,4.0.0-beta.2-290-ga0c740784,-,-,2020/6/5,Moderate,"1. What did you do?
DROP TABLE t1;
CREATE TABLE t1 (
 id int not null primary key auto_increment,
 t varchar(100)
);
INSERT INTO t1 VALUES (1, `acdc`), (2, `afddfdc`);

# session 1
START TRANSACTION;
UPDATE t1 SET t=`new...` WHERE id = 1;

# session 2
START TRANSACTION;
UPDATE t1 SET t=`newval` WHERE id = 1;
2. What did you expect to see?
After a while in session 2 you should get:

mysql> UPDATE t1 SET t=`newval` WHERE id = 1;
ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
3. What did you see instead?
The TiDB error code and error message are not strictly compatible:

mysql> update t1 set t=`newval` where id = 1;
ERROR 9004 (HY000): Resolve lock timeout",unspecified,Pessimistic,1,2,-,-,-,-,2,explicit,2,explicit,2,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,"NOT NULL
AUTO_INCREMENT",-,Yes,Wrong error message,Statement correctness: wrong error message,Moderate,Yes,Code fix,-,-,-,-,-,-,381,-,"No, history does not reflect the problem","No, DBMS-specific","No, wrong error message",,,TiDB_17797
TiDB,8393,https://github.com/pingcap/tidb/issues/8393,Some statement is troublesome on retry or rollback,"begin;
set variable = xxx;
// do something meet transaction conflict
rollback",Confirmed,4.0.0-beta.2-838-gb249dc578-dirty,-,-,2018/11/22,Major,"Confirmed that user variables are not reverted back in TiDB:

create a table:

drop table if exists t;
create table t(a bigint, b bigint);
begin a transaction, modify a variable and insert a record, but revert it:

begin;
set @a = 100;
insert into t values(1, 1);
rollback;
check the variable and the table, you can see the user variable has been changed:

TiDB(root@127.0.0.1:test) > select @a;
+------+
| @a   |
+------+
| 100  |
+------+
1 row in set (0.00 sec)

TiDB(root@127.0.0.1:test) > select * from t;
Empty set (0.00 sec)",unspecified,Pessimistic,1,0,-,-,-,-,2,explicit,4,auto,2,-,-,-,-,-,-,Yes,-,-,-,-,Yes,Yes,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect DBMS state,Atomicity,Major,"No, hard to fix",-,-,-,-,-,-,-,-,729,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_8393
TiDB,37653,https://github.com/pingcap/tidb/issues/37653,TiDB locks the record which is filtered by the non-index condition in point-get plan at RC isolation,"RC isolation

1. Minimal reproduce step (Required)
create table t1(id1 int, id2 int, id3 int, PRIMARY KEY(id1), UNIQUE KEY udx_id2 (id2));
INSERT INTO t1 VALUES(1,1,1);
-- session1
begin;
select * from t1 where id1 = 1 and id2 = 2 for update;
-- session2
begin
select * from t1 where id1 = 1 for update;

2. What did you expect to see? (Required)
session2 returns the result immediately.

3. What did you see instead (Required)
session2 was blocked by the lock of the key whose values is ```

4. What is your TiDB version? (Required)
Release Version: v6.2.0
Edition: Community
Git Commit Hash: daf2b17",Confirmed,"5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2, 6.3, 6.4, 6.5",-,-,2022/9/7,Major,"create table t1(id1 int, id2 int, id3 int, PRIMARY KEY(id1), UNIQUE KEY udx_id2 (id2));
INSERT INTO t1 VALUES(1,1,1);
-- session1
begin;
select * from t1 where id1 = 1 and id2 = 2 for update;
-- session2
begin
select * from t1 where id1 = 1 for update;

2. What did you expect to see? (Required)
session2 returns the result immediately.

3. What did you see instead (Required)
session2 was blocked by the lock of the key whose values is ```",READ COMMITTED,Pessimistic,1,1,-,-,-,-,2,explicit,2,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unnecessary blocking,Excessive isolation,Major,"No, unknown",-,-,-,-,-,-,-,-,116,"No, not key-value data structures",Yes,"No, unnecessary blocking",,,TiDB_37653
TiDB,37925,https://github.com/pingcap/tidb/issues/37925,"Select can return duplicate values in primary key column, whereas the transaction can still commit","1. Minimal reproduce step (Required)
drop table if exists tbl_4;
create table tbl_4 ( col_16 decimal ( 38 , 4 )   not null ,col_17 time    default `23:52:24.00` ,col_18 char ( 235 ) collate utf8_bin ,col_19 tinyint  unsigned not null default 151 ,col_20 smallint    default 9203 , primary key  ( col_20 ) /*T![clustered_index] nonclustered */ ,key idx_8 ( col_18 ( 1 ) ) ) charset utf8mb4 collate utf8mb4_bin ;

insert into tbl_4 values ( 661,`17:22:57.00`,`^0`,155,-31298 );
insert into tbl_4 values ( 3579.0326,null,`n~KgM`,220,-31136 );
insert into tbl_4 values ( 1.4,`05:06:55.00`,`Q+~(AUo!36S2OD9`,35,-12681 );
insert into tbl_4 values ( 66.9,`10:04:39.00`,`_9ILR!QJ`,145,-15820 );
insert into tbl_4 values ( 29082.6117,`00:37:01.00`,`mdTuS((uApbUxJIAO`,196,-30900 );
insert into tbl_4 values ( 57,`11:09:40.00`,`=@%~n@w+9q`,77,30926 );
insert into tbl_4 values ( 308382.06,null,`~Ewt)Z+1mlLzafKu`,195,15880 );
insert into tbl_4 values ( 0.26,`03:32:16.00`,`_$lL2m0AFK9fQQs`,178,-29720 );
insert into tbl_4 values ( 993.7,`10:14:55.00`,`m~a1nM(Xsf_#h7*`,4,26689 );
insert into tbl_4 values ( 0.998,`19:57:45.00`,`I5Q8Xx1`,66,-10830 );

begin pessimistic;
update tbl_4 set tbl_4.col_17 = `11:16:44.00` ,tbl_4.col_17 = `03:51:50.00` ,tbl_4.col_16 = 9 where tbl_4.col_20 in ( -31298 ,-10876 ,-31136 ,-29720 ) and not( tbl_4.col_18 != `n~KgM` ) ;
select col_20 from tbl_4 order by col_20;
commit;
2. What did you expect to see? (Required)
The select returns duplicated values on col_20 which is the primary key. I suppose the transaction should not be allowed to commit.

3. What did you see instead (Required)
The select result is

select col_20 from tbl_4 order by col_20;
+--------+
| col_20 |
+--------+
| -31298 |
| -31298 |
| -31136 |
| -30900 |
| -29720 |
| -29720 |
| -15820 |
| -12681 |
| -10830 |
| 15880  |
| 26689  |
| 30926  |
+--------+
And the commit succeeds.

Also note that if we select * from tbl_4 the result is fine.

4. What is your TiDB version? (Required)
Master nightly.

Release Version: v6.3.0-alpha
Edition: Community
Git Commit Hash: 29f83a0b25926390c757f71a84baa2322a289f78
Git Branch: heads/refs/tags/v6.3.0-alpha
UTC Build Time: 2022-09-18 14:25:30
GoVersion: go1.19
Race Enabled: false
TiKV Min Version: 6.2.0-alpha
Check Table Before Drop: false
Store: tikv",Confirmed,"5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2, 6.3, 6.4, 6.5",-,-,2022/9/19,Major,"drop table if exists tbl_4;
create table tbl_4 ( col_16 decimal ( 38 , 4 )   not null ,col_17 time    default `23:52:24.00` ,col_18 char ( 235 ) collate utf8_bin ,col_19 tinyint  unsigned not null default 151 ,col_20 smallint    default 9203 , primary key  ( col_20 ) /*T![clustered_index] nonclustered */ ,key idx_8 ( col_18 ( 1 ) ) ) charset utf8mb4 collate utf8mb4_bin ;

insert into tbl_4 values ( 661,`17:22:57.00`,`^0`,155,-31298 );
insert into tbl_4 values ( 3579.0326,null,`n~KgM`,220,-31136 );
insert into tbl_4 values ( 1.4,`05:06:55.00`,`Q+~(AUo!36S2OD9`,35,-12681 );
insert into tbl_4 values ( 66.9,`10:04:39.00`,`_9ILR!QJ`,145,-15820 );
insert into tbl_4 values ( 29082.6117,`00:37:01.00`,`mdTuS((uApbUxJIAO`,196,-30900 );
insert into tbl_4 values ( 57,`11:09:40.00`,`=@%~n@w+9q`,77,30926 );
insert into tbl_4 values ( 308382.06,null,`~Ewt)Z+1mlLzafKu`,195,15880 );
insert into tbl_4 values ( 0.26,`03:32:16.00`,`_$lL2m0AFK9fQQs`,178,-29720 );
insert into tbl_4 values ( 993.7,`10:14:55.00`,`m~a1nM(Xsf_#h7*`,4,26689 );
insert into tbl_4 values ( 0.998,`19:57:45.00`,`I5Q8Xx1`,66,-10830 );

begin pessimistic;
update tbl_4 set tbl_4.col_17 = `11:16:44.00` ,tbl_4.col_17 = `03:51:50.00` ,tbl_4.col_16 = 9 where tbl_4.col_20 in ( -31298 ,-10876 ,-31136 ,-29720 ) and not( tbl_4.col_18 != `n~KgM` ) ;
select col_20 from tbl_4 order by col_20;
commit;
2. What did you expect to see? (Required)
The select returns duplicated values on col_20 which is the primary key. I suppose the transaction should not be allowed to commit.

3. What did you see instead (Required)
The select result is

select col_20 from tbl_4 order by col_20;
+--------+
| col_20 |
+--------+
| -31298 |
| -31298 |
| -31136 |
| -30900 |
| -29720 |
| -29720 |
| -15820 |
| -12681 |
| -10830 |
| 15880  |
| 26689  |
| 30926  |
+--------+
And the commit succeeds.

Also note that if we select * from tbl_4 the result is fine.",unspecified,Pessimistic,1,10,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,Yes,"NOT NULL
DEFAULT ...",-,Yes,Incorrect query result,Consistency: data constraint,Major,"No, unknown",-,-,-,-,-,-,-,-,104,"No, not key-value data structures","No, DBMS-specific",Yes,,,TiDB_37925
TiDB,39851,https://github.com/pingcap/tidb/issues/39851,Released SELECT statement does not report warning,"1. Minimal reproduce step (Required)
/* init */ CREATE TABLE t (c1 INT, c2 INT);
/* init */ INSERT INTO t VALUES (1, 1);

/* tx1 */ BEGIN;
/* tx2 */ BEGIN;
/* tx1 */ SELECT c1 FROM t WHERE c2 FOR UPDATE;
/* tx2 */ SELECT /*+ INL_JOIN(t)*/c1 FROM t WHERE c2<=c1 FOR UPDATE; -- blocked
/* tx1 */ COMMIT; -- tx2 released
/* tx2 */ COMMIT;
2. What did you expect to see? (Required)
SELECT statement in tx2 reports warning:

tidb> SELECT /*+ INL_JOIN(t)*/c1 FROM t WHERE c2<=c1 FOR UPDATE;
Warning[1815] There are no matching table names for (t) in optimizer hint /*+ INL_JOIN(t) */ or /*+ TIDB_INLJ(t) */. Maybe you can use the table alias name

tidb> BEGIN;
tidb> SELECT /*+ INL_JOIN(t)*/c1 FROM t WHERE c2<=c1 FOR UPDATE;
Warning[1815] There are no matching table names for (t) in optimizer hint /*+ INL_JOIN(t) */ or /*+ TIDB_INLJ(t) */. Maybe you can use the table alias name
3. What did you see instead (Required)
SELECT statement in tx2 does not report warning.",Confirmed,6.4.0,-,-,2022/12/13,Moderate,"/* init */ CREATE TABLE t (c1 INT, c2 INT);
/* init */ INSERT INTO t VALUES (1, 1);

/* tx1 */ BEGIN;
/* tx2 */ BEGIN;
/* tx1 */ SELECT c1 FROM t WHERE c2 FOR UPDATE;
/* tx2 */ SELECT /*+ INL_JOIN(t)*/c1 FROM t WHERE c2<=c1 FOR UPDATE; -- blocked
/* tx1 */ COMMIT; -- tx2 released
/* tx2 */ COMMIT;
2. What did you expect to see? (Required)
SELECT statement in tx2 reports warning:

tidb> SELECT /*+ INL_JOIN(t)*/c1 FROM t WHERE c2<=c1 FOR UPDATE;
Warning[1815] There are no matching table names for (t) in optimizer hint /*+ INL_JOIN(t) */ or /*+ TIDB_INLJ(t) */. Maybe you can use the table alias name

tidb> BEGIN;
tidb> SELECT /*+ INL_JOIN(t)*/c1 FROM t WHERE c2<=c1 FOR UPDATE;
Warning[1815] There are no matching table names for (t) in optimizer hint /*+ INL_JOIN(t) */ or /*+ TIDB_INLJ(t) */. Maybe you can use the table alias name
3. What did you see instead (Required)
SELECT statement in tx2 does not report warning.",ALL,Pessimistic,1,1,-,-,-,-,3,explicit,3,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Missing error,Statement correctness: missing error,Moderate,"No, unknown",-,-,-,-,-,-,-,-,19,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_39851
TiDB,39972,https://github.com/pingcap/tidb/issues/39972,UPDATE statement with CAST() reports an error in the transaction,"1. Minimal reproduce step (Required)
/* init */ CREATE TABLE t(c0 INT);
/* init */ INSERT IGNORE INTO t VALUES (2);

/* tx */ BEGIN;
/* tx */ DELETE FROM t WHERE TRUE;
/* tx */ UPDATE t SET c0=0 WHERE (CAST(`a` AS SIGNED)); -- report an error
/* tx */ COMMIT;
2. What did you expect to see? (Required)
UPDATE statement does not report error:

tidb> DELETE FROM t WHERE TRUE;
Query OK, 1 row affected (0.01 sec)

tidb> UPDATE t SET c0=0 WHERE (CAST(`a` AS SIGNED));
Query OK, 0 rows affected (0.00 sec)
Rows matched: 0  Changed: 0  Warnings: 0
3. What did you see instead (Required)
Executing UPDATE statement after the DELETE statement in tx reports an error:

tidb> UPDATE t SET c0=0 WHERE (CAST(`a` AS SIGNED));
ERROR 1292 (22007): Truncated incorrect INTEGER value: `a`",Confirmed,"may affects 4.0, 5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2 ,6.3, 6.4",-,-,2022/12/15,Moderate,"/* init */ CREATE TABLE t(c0 INT);
/* init */ INSERT IGNORE INTO t VALUES (2);

/* tx */ BEGIN;
/* tx */ DELETE FROM t WHERE TRUE;
/* tx */ UPDATE t SET c0=0 WHERE (CAST(`a` AS SIGNED)); -- report an error
/* tx */ COMMIT;
2. What did you expect to see? (Required)
UPDATE statement does not report error:

tidb> DELETE FROM t WHERE TRUE;
Query OK, 1 row affected (0.01 sec)

tidb> UPDATE t SET c0=0 WHERE (CAST(`a` AS SIGNED));
Query OK, 0 rows affected (0.00 sec)
Rows matched: 0  Changed: 0  Warnings: 0
3. What did you see instead (Required)
Executing UPDATE statement after the DELETE statement in tx reports an error:

tidb> UPDATE t SET c0=0 WHERE (CAST(`a` AS SIGNED));
ERROR 1292 (22007): Truncated incorrect INTEGER value: `a`",ALL,Pessimistic,1,1,-,-,-,-,2,explicit,4,auto,2,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,Moderate,"No, undefined semantic",-,-,-,-,-,-,-,-,17,"No, not key-value data structures",Yes,Yes,,,TiDB_39972
TiDB,39976,https://github.com/pingcap/tidb/issues/39976,DELETE statement execution results are inconsistent within and outside a transaction,"1. Minimal reproduce step (Required)
/* init */ CREATE TABLE t(c0 TEXT(284));

/* tx */ BEGIN;
/* tx */ REPLACE INTO t VALUES (`G6y*k]88]`);
/* tx */ DELETE FROM t WHERE CAST(TIDB_VERSION() AS DATE); -- report an error
/* tx */ COMMIT;
2. What did you expect to see? (Required)
DELETE statement only reports a warning:

tidb> REPLACE INTO t VALUES (`G6y*k]88]`);
Query OK, 1 row affected (0.01 sec)

tidb> DELETE FROM t WHERE CAST(TIDB_VERSION() AS DATE);
Query OK, 0 rows affected, 1 warning (0.00 sec)
Warning[1292] evaluation failed: Incorrect datetime value: `Release Version: v6.4.0
Edition: Community
Git Commit Hash: cf36a9ce2fe1039db3cf3444d51930b887df18a1
Git Branch: heads/refs/tags/v6.4.0
UTC Build Time: 2022-11-13 05:25:30
GoVersion: go1.19.2
Race Enabled: false
TiKV Min Version: 6.2.0-alpha
Check Table Before Drop: false
Store: tikv`
3. What did you see instead (Required)
DELETE statement in tx reports an error:

/* tx */ DELETE FROM t WHERE CAST(TIDB_VERSION() AS DATE);
ERROR 1292 (22007): Incorrect datetime value: `Release Version: v6.4.0
Edition: Community
Git Commit Hash: cf36a9ce2fe1039db3cf3444d51930b887df18a1
Git Branch: heads/refs/tags`",Confirmed,"may affects 4.0, 5.0, 5.1, 5.2, 5.3, 5.4, 6.0, 6.1, 6.2 ,6.3, 6.4",-,-,2022/12/15,Minor,"/* init */ CREATE TABLE t(c0 TEXT(284));

/* tx */ BEGIN;
/* tx */ REPLACE INTO t VALUES (`G6y*k]88]`);
/* tx */ DELETE FROM t WHERE CAST(TIDB_VERSION() AS DATE); -- report an error
/* tx */ COMMIT;
2. What did you expect to see? (Required)
DELETE statement only reports a warning:

tidb> REPLACE INTO t VALUES (`G6y*k]88]`);
Query OK, 1 row affected (0.01 sec)

tidb> DELETE FROM t WHERE CAST(TIDB_VERSION() AS DATE);
Query OK, 0 rows affected, 1 warning (0.00 sec)
Warning[1292] evaluation failed: Incorrect datetime value: `Release Version: v6.4.0
Edition: Community
Git Commit Hash: cf36a9ce2fe1039db3cf3444d51930b887df18a1
Git Branch: heads/refs/tags/v6.4.0
UTC Build Time: 2022-11-13 05:25:30
GoVersion: go1.19.2
Race Enabled: false
TiKV Min Version: 6.2.0-alpha
Check Table Before Drop: false
Store: tikv`
3. What did you see instead (Required)
DELETE statement in tx reports an error:

/* tx */ DELETE FROM t WHERE CAST(TIDB_VERSION() AS DATE);
ERROR 1292 (22007): Incorrect datetime value: `Release Version: v6.4.0
Edition: Community
Git Commit Hash: cf36a9ce2fe1039db3cf3444d51930b887df18a1
Git Branch: heads/refs/tags`",ALL,Pessimistic,1,0,-,-,-,-,2,explicit,4,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Wrong error message,Statement correctness: wrong error message,Minor,"No, unknown",-,-,-,-,-,-,-,-,17,"No, not key-value data structures",Yes,"No, wrong error message",,,TiDB_39976
TiDB,39977,https://github.com/pingcap/tidb/issues/39977,Executing SELECT statement on an empty table reports warnings in the transaction,"1. Minimal reproduce step (Required)
/* init */ CREATE TABLE t(c0 DECIMAL, c1 BLOB(79));
/* init */ INSERT INTO t(c0, c1) VALUES (NULL, ` `), (-2, `oCK`);

/* tx */ BEGIN;
/* tx */ DELETE FROM t;
/* tx */ SELECT /*+ STREAM_AGG()*/c0 FROM t WHERE c1 FOR UPDATE; -- Warning
/* tx */ COMMIT;
2. What did you expect to see? (Required)
SELECT statement does not report warnings:

tidb> DELETE FROM t;
Query OK, 2 rows affected (0.00 sec)

tidb> SELECT /*+ STREAM_AGG()*/c0 FROM t WHERE c1 FOR UPDATE;
Empty set (0.00 sec)
3. What did you see instead (Required)
Executing SELECT statement after the DELETE statement in tx reports warnings:

/* tx */ SELECT /*+ STREAM_AGG()*/c0 FROM t WHERE c1 FOR UPDATE;
Empty set, 2 warnings (0.00 sec)
+---------+------+----------------------------------------------------------------+
| Level   | Code | Message                                                        |
+---------+------+----------------------------------------------------------------+
| Warning | 1292 | evaluation failed: Truncated incorrect INTEGER value: ``       |
| Warning | 1292 | evaluation failed: Truncated incorrect INTEGER value: `oCK`   |
+---------+------+----------------------------------------------------------------+",Confirmed,6.4.0,-,-,2022/12/15,Moderate,"/* init */ CREATE TABLE t(c0 DECIMAL, c1 BLOB(79));
/* init */ INSERT INTO t(c0, c1) VALUES (NULL, ` `), (-2, `oCK`);

/* tx */ BEGIN;
/* tx */ DELETE FROM t;
/* tx */ SELECT /*+ STREAM_AGG()*/c0 FROM t WHERE c1 FOR UPDATE; -- Warning
/* tx */ COMMIT;
2. What did you expect to see? (Required)
SELECT statement does not report warnings:

tidb> DELETE FROM t;
Query OK, 2 rows affected (0.00 sec)

tidb> SELECT /*+ STREAM_AGG()*/c0 FROM t WHERE c1 FOR UPDATE;
Empty set (0.00 sec)
3. What did you see instead (Required)
Executing SELECT statement after the DELETE statement in tx reports warnings:

/* tx */ SELECT /*+ STREAM_AGG()*/c0 FROM t WHERE c1 FOR UPDATE;
Empty set, 2 warnings (0.00 sec)
+---------+------+----------------------------------------------------------------+
| Level   | Code | Message                                                        |
+---------+------+----------------------------------------------------------------+
| Warning | 1292 | evaluation failed: Truncated incorrect INTEGER value: ``       |
| Warning | 1292 | evaluation failed: Truncated incorrect INTEGER value: `oCK`   |
+---------+------+----------------------------------------------------------------+",ALL,Pessimistic,1,2,-,-,-,-,2,explicit,4,auto,2,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,Moderate,"No, unknown",-,-,-,-,-,-,-,-,17,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,TiDB_39977
SQLite,b5ca442af9,https://www.sqlite.org/src/tktview?name=b5ca442af9,"""Malformed database schema"" when creating a failing index within a transaction","CREATE TABLE IF NOT EXISTS t0(c0);
INSERT INTO t0(c0) VALUES (-9223372036854775808);
TXN1:
BEGIN TRANSACTION;
CREATE INDEX i0 ON t0(ABS(c0)); -- integer overflow (expected)
COMMIT; -- unexpected: the index is still created
TXN2:
CREATE INDEX i0 ON t0(1); -- malformed database schema (i0) - index i0 already exists",Fixed,"	3.28",-,"https://www.sqlite.org/src/info/a3e77c7776ab01da
https://www.sqlite.org/src/info/b8071d10cba8f6c1",2019/5/21,Cosmetic,"CREATE TABLE IF NOT EXISTS t0(c0);
INSERT INTO t0(c0) VALUES (-9223372036854775808);
BEGIN TRANSACTION;
CREATE INDEX i0 ON t0(ABS(c0)); -- integer overflow (expected)
COMMIT; -- unexpected: the index is still created
CREATE INDEX i0 ON t0(1); -- malformed database schema (i0) - index i0 already exists",unspecified,Pessimistic,1,1,-,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,Immediate,Yes,Code fix,"2 patches: 3 changed files with 27 additions and 1 deletions; 3 changed files with 18 additions and 8 deletions
",2,3,45,11,56,1,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,SQLite_b5ca442af9
SQLite,596d059af7,https://www.sqlite.org/src/tktview?name=596d059af7,Committing a transaction with a failed ALTER TABLE may subtly corrupt schema,"CREATE TABLE t1(a, b);
CREATE TABLE t3(e, f);
CREATE TRIGGER tr1 AFTER INSERT ON t1 BEGIN
    INSERT INTO t2 VALUES(new.a, new.b);
  END;
BEGIN;
    ALTER TABLE t3 RENAME TO t4;
COMMIT;
SELECT * FROM sqlite_master WHERE type=`table` AND name!=`t1`;",Fixed,,-,https://www.sqlite.org/src/info/0f2129f59f7df929,2019/3/15,Critical,"CREATE TABLE t1(a, b);
CREATE TABLE t3(e, f);
CREATE TRIGGER tr1 AFTER INSERT ON t1 BEGIN
    INSERT INTO t2 VALUES(new.a, new.b);
  END;
BEGIN;
    ALTER TABLE t3 RENAME TO t4;
COMMIT;
SELECT * FROM sqlite_master WHERE type=`table` AND name!=`t1`; -----table|t3|t3|3|CREATE TABLE ""t4""(e, f)
The schema is now corrupt - as the table name in the SQL does not match the table names in the ""name"" and ""tbl_name"" columns",unspecified,Pessimistic,2,0,0,-,-,-,2,explicit,3,auto,1,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Incorrect DBMS state,Consistency: DBMS state,Immediate,Yes,Code fix,"3 changed files with 39 additions and 7 deletions
",1,3,39,7,46,1,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,SQLite_596d059af7
SQLite,167b2aac34,https://www.sqlite.org/src/tktview?name=167b2aac34,Debug assertion fts5CheckTransactionState: Assertion `iSavepoint<=p->ts.iSavepoint` failed,"CREATE VIRTUAL TABLE vt0 USING fts5(c0);
CREATE VIRTUAL TABLE vt1 USING fts4(c0);
INSERT INTO vt1(c0) VALUES(0);
BEGIN;
UPDATE vt1 SET c0 = 0;
INSERT INTO vt1(c0) VALUES (0), (0);
UPDATE vt0 SET c0 = 0;
INSERT INTO vt1(c0) VALUES (0);
UPDATE vt1 SET c0 = 0;
INSERT INTO vt1(vt1) VALUES(`automerge=1`);
UPDATE vt1 SET c0 = 0;
DROP TABLE vt1; -- sqlite3.c:219981: fts5CheckTransactionState: Assertion `iSavepoint<=p->ts.iSavepoint` failed
When compiling with -DSQLITE_DEBUG, the DROP TABLE triggers an assertion error.",Fixed,3.30.0,-,https://www.sqlite.org/src/info/a5d7f5d24a239f72,2019/12/24,Minor,"CREATE VIRTUAL TABLE vt0 USING fts5(c0);
CREATE VIRTUAL TABLE vt1 USING fts4(c0);
INSERT INTO vt1(c0) VALUES(0);
BEGIN;
UPDATE vt1 SET c0 = 0;
INSERT INTO vt1(c0) VALUES (0), (0);
UPDATE vt0 SET c0 = 0;
INSERT INTO vt1(c0) VALUES (0);
UPDATE vt1 SET c0 = 0;
INSERT INTO vt1(vt1) VALUES(`automerge=1`);
UPDATE vt1 SET c0 = 0;
DROP TABLE vt1; -- sqlite3.c:219981: fts5CheckTransactionState: Assertion `iSavepoint<=p->ts.iSavepoint` failed
When compiling with -DSQLITE_DEBUG, the DROP TABLE triggers an assertion error.",unspecified,Pessimistic,2,1,0,-,-,-,1,explicit,9,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,Low,Yes,Code fix,2 changed files with 89 additions and 1 deletions,1,2,89,1,90,2,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,SQLite_167b2aac34
SQLite,745f1abcdc,https://www.sqlite.org/src/tktview?name=745f1abcdc,FTS integrity-check malfunctions for transaction and the prefix option,"CREATE VIRTUAL TABLE vt0 USING fts4(c0, prefix=1);
BEGIN;
INSERT INTO vt0 VALUES (0);
INSERT INTO vt0(vt0) VALUES(`optimize`);
INSERT INTO vt0(vt0) VALUES(`integrity-check`); -- database disk image is malformed",Fixed,3.30.0,-,https://www.sqlite.org/src/info/4ed905b18847d4db,2019/10/10,Critical,"CREATE VIRTUAL TABLE vt0 USING fts4(c0, prefix=1);
BEGIN;
INSERT INTO vt0 VALUES (0);
INSERT INTO vt0(vt0) VALUES(`optimize`);
INSERT INTO vt0(vt0) VALUES(`integrity-check`); -- database disk image is malformed
Unexpectedly, the integrity check results in an error ""database disk image is malformed"".",unspecified,Pessimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,Operation error,Statement correctness: unexpected error,Immediate,Yes,Code fix,"2 changed files with 22 additions and 5 deletions
",1,2,22,5,27,1,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,SQLite_745f1abcdc
SQLite,e258f008ce,https://www.sqlite.org/src/tktview?name=e258f008ce,FTS rebuild in transaction causes integrity-check to fail,"CREATE VIRTUAL TABLE vt0 USING fts5(c0);
INSERT INTO vt0(c0) VALUES (NULL);
BEGIN TRANSACTION;
INSERT INTO vt0(vt0) VALUES(`rebuild`);
INSERT INTO vt0(vt0) VALUES(`rebuild`);
INSERT INTO vt0(vt0) VALUES(`integrity-check`); -- database disk image is malformed",Fixed,3.30.0,-,https://www.sqlite.org/src/info/238e0835714696ab,2019/10/7,Critical,"CREATE VIRTUAL TABLE vt0 USING fts5(c0);
INSERT INTO vt0(c0) VALUES (NULL);
BEGIN TRANSACTION;
INSERT INTO vt0(vt0) VALUES(`rebuild`);
INSERT INTO vt0(vt0) VALUES(`rebuild`);
INSERT INTO vt0(vt0) VALUES(`integrity-check`); -- database disk image is malformed
Unexpectedly, the integrity check results in an error ""database disk image is malformed"".",unspecified,Pessimistic,1,1,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,Yes,Operation error,Statement correctness: unexpected error,Immediate,Yes,Code fix,3 changed files with 32 additions and 0 deletions,1,3,32,0,32,1,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,SQLite_e258f008ce
SQLite,810dc80388,https://www.sqlite.org/src/tktview?name=810dc80388,COMMIT command succeeds even though it didn`t commit.,"From theforum discussion, in rollback mode, if a COMMIT command fails with SQLITE_BUSY, but is retried repeatedly, it will eventually appear to succeed, when it fact it is still busy and the transaction never committed.",Fixed,3.32.1,-,https://www.sqlite.org/src/info/9cfefef591dc555e,2020/6/3,Critical,"#include <stdio.h>
#include ""sqlite3.h""
#include <assert.h>
#include <stdlib.h>

extern int unlink(const char*);

int main(int argc, char **argv){
  sqlite3 *db1;
  sqlite3 *db2;
  sqlite3_stmt *pStmt1;
  sqlite3_stmt *pStmt2;
  int i;
  int rc;

  unlink(""test.db"");
  rc = sqlite3_open(""test.db"", &db1);
  assert( rc==SQLITE_OK );
  rc = sqlite3_exec(db1, 
     ""CREATE TABLE t1(a,b,c);\n""
     ""INSERT INTO t1 VALUES(1,2,3),(`a`,`b`,`c`),(9,8,7);\n"",
     0, 0, 0);
  assert( rc==SQLITE_OK );
  rc = sqlite3_open(""test.db"", &db2);
  assert( rc==SQLITE_OK );
  rc = sqlite3_prepare_v2(db2, ""SELECT * FROM t1;"", -1, &pStmt2, 0);
  assert( rc==SQLITE_OK );
  rc = sqlite3_prepare_v2(db1, ""COMMIT"", -1, &pStmt1, 0);
  assert( rc==SQLITE_OK );

  /* Thread2 starts reading the database */
  printf(""T2 reading....\n""); fflush(stdout);
  rc = sqlite3_step(pStmt2);
  assert( rc==SQLITE_ROW );

  /* Thread1 tries to update.  Should get blocked */
  printf(""T1 writes\n""); fflush(stdout);
  rc = sqlite3_exec(db1, ""BEGIN; INSERT INTO t1 VALUES(99,88,77)"", 0, 0, 0);
  for(i=0; i<10; i++){
    rc = sqlite3_step(pStmt1);
    if( rc!=SQLITE_BUSY ) break;
    printf(""  .... busy %d\n"", i+1);
  }
  printf(""return code from the COMMIT: %d\n"", rc);
  rc = sqlite3_finalize(pStmt1);
  printf(""return code from sqlite3_finalize(): %d\n"", rc);
  printf(""Database content after COMMIT:\n"");
  rc = sqlite3_prepare_v2(db1, ""SELECT * FROM t1;"", -1, &pStmt1, 0);
  assert( rc==SQLITE_OK );
  while( sqlite3_step(pStmt1)==SQLITE_ROW ){
    printf(""Row:"");
    for(i=0; i<sqlite3_column_count(pStmt1); i++){
      printf("" c[%d]=`%s`"", i, sqlite3_column_text(pStmt1,i));
    }
    printf(""\n"");
  }
  sqlite3_finalize(pStmt1);
  sqlite3_finalize(pStmt2);
  sqlite3_close(db1);
  sqlite3_close(db2);
  return 0;
}",SERIALIZABLE,Pessimistic,1,3,-,-,-,-,3,auto,1,explicit,3,auto,1,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,fflush(stdout),-,-,-,-,-,-,-,-,-,"No, need repeat",Incorrect database state,Consistency: application state,High,Yes,Code fix,"1 changed files with 2 additions and 0 deletions
",1,1,2,0,2,1,-,"No, not key-value data structures",Yes,"No, nondeterministic",,,SQLite_810dc80388
CockroachDB,83593,https://github.com/cockroachdb/cockroach/issues/83593,Cannot ALTER add a column and create partial index on that column in the same transaction,"CREATE TABLE myusers(id UUID PRIMARY KEY, username TEXT); 
BEGIN; 
ALTER TABLE myusers ADD COLUMN active BOOL; 
CREATE UNIQUE INDEX myusers_only_one_active ON myusers (username) WHERE active = true; 
COMMIT;

ERROR: cannot create partial index on column ""active"" (3) which is not public
SQLSTATE: 0A000",Open,22.1.2,-,-,2022/6/30,,"CREATE TABLE myusers(id UUID PRIMARY KEY, username TEXT); 
BEGIN; 
ALTER TABLE myusers ADD COLUMN active BOOL; 
CREATE UNIQUE INDEX myusers_only_one_active ON myusers (username) WHERE active = true; 
COMMIT;

ERROR: cannot create partial index on column ""active"" (3) which is not public
SQLSTATE: 0A000",SERIALIZABLE,Optimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,-,"No, hard to diagnose",-,-,-,-,-,-,-,-,185,"No, involve complex operations other than read(key) and write(key, value)",Yes,"No, unsupported statements",,,CockroachDB_83593
CockroachDB,81069,https://github.com/cockroachdb/cockroach/issues/81069,later statements in the same transaction won`t see the newly added index during statement phase,"create table t (a int);

SET use_declarative_schema_changer = `unsafe_always`;

begin;
create index t_idx_a on t(a);
comment on index t@t_idx_a is `hello`; -- this will complain about index not found
commit;
The comment on statement cannot find an index to comment on. ",Open,,-,-,2022/5/6,,"create table t (a int);

SET use_declarative_schema_changer = `unsafe_always`;

begin;
create index t_idx_a on t(a);
comment on index t@t_idx_a is `hello`; -- this will complain about index not found
commit;
The comment on statement cannot find an index to comment on. ",SERIALIZABLE,Optimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,SET use_declarative_schema_changer = `unsafe_always`;,-,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,-,"No, unknown",-,-,-,-,-,-,-,-,240,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,CockroachDB_81069
CockroachDB,79784,https://github.com/cockroachdb/cockroach/issues/79784,server: adding and dropping column default in same transaction fails,"CREATE TABLE

demo@127.0.0.1:26257/movr> INSERT INTO test VALUES (123);
INSERT 1

demo@127.0.0.1:26257/movr> BEGIN;
BEGIN

demo@127.0.0.1:26257/movr  OPEN> ALTER TABLE test ADD COLUMN y int NOT NULL DEFAULT 5;
ALTER TABLE

demo@127.0.0.1:26257/movr  OPEN> ALTER TABLE test ALTER COLUMN y DROP DEFAULT;
ALTER TABLE

demo@127.0.0.1:26257/movr  OPEN> COMMIT;
ERROR: transaction committed but schema change aborted with error: (23502): null value in column ""y"" violates not-null constraint
SQLSTATE: XXA00",Open,21.2.5,-,-,2022/4/12,,"CREATE TABLE test (x int NOT NULL);

demo@127.0.0.1:26257/movr> INSERT INTO test VALUES (123);
INSERT 1

demo@127.0.0.1:26257/movr> BEGIN;
BEGIN

demo@127.0.0.1:26257/movr  OPEN> ALTER TABLE test ADD COLUMN y int NOT NULL DEFAULT 5;
ALTER TABLE

demo@127.0.0.1:26257/movr  OPEN> ALTER TABLE test ALTER COLUMN y DROP DEFAULT;
ALTER TABLE

demo@127.0.0.1:26257/movr  OPEN> COMMIT;
ERROR: transaction committed but schema change aborted with error: (23502): null value in column ""y"" violates not-null constraint
SQLSTATE: XXA00",SERIALIZABLE,Optimistic,1,1,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,NOT NULL,-,Yes,Unexpected error,Statement correctness: unexpected error,-,"No, hard to fix",-,-,-,-,-,-,-,-,264,"No, not key-value data structures",Yes,"No, unsupported statements",,,CockroachDB_79784
CockroachDB,79613,https://github.com/cockroachdb/cockroach/issues/79613,sql: partial predicate evaluation fails for newly added columns,"create table t (i int primary key);
set cluster setting jobs.debug.pausepoints = `schemachanger.before.exec`;
begin;
    alter table t add column z timestamp;
    create index idx2 on t(z) where z IS NOT NULL;
commit;
select * from t;
ERROR: internal error: unexpected error during partial index predicate type resolution: column ""z"" does not exist",Open,,-,-,2022/4/8,,"create table t (i int primary key);
set cluster setting jobs.debug.pausepoints = `schemachanger.before.exec`;
begin;
    alter table t add column z timestamp;
    create index idx2 on t(z) where z IS NOT NULL;
commit;
select * from t;
ERROR: internal error: unexpected error during partial index predicate type resolution: column ""z"" does not exist",SERIALIZABLE,Optimistic,1,0,-,-,-,-,2,auto,1,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,set cluster setting jobs.debug.pausepoints = `schemachanger.before.exec`;,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,-,"No, unknown",-,-,-,-,-,-,-,-,268,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,CockroachDB_79613
CockroachDB,55184,https://github.com/cockroachdb/cockroach/issues/55184,sql: can`t transactionally drop a constraint and add another with the same name,"CREATE TABLE users (
    id INT PRIMARY KEY
);

CREATE TABLE items (
    id INT PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users
);

BEGIN;
ALTER TABLE items DROP CONSTRAINT fk_user_id_ref_users;
ALTER TABLE items ADD CONSTRAINT fk_user_id_ref_users FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE;
COMMIT;
ERROR: duplicate constraint name
I expected the constraint to be successfully dropped and added again.",Open,20.1.6,-,-,2020/10/3,,"CREATE TABLE users (
    id INT PRIMARY KEY
);

CREATE TABLE items (
    id INT PRIMARY KEY,
    user_id INT NOT NULL REFERENCES users
);

BEGIN;
ALTER TABLE items DROP CONSTRAINT fk_user_id_ref_users;
ALTER TABLE items ADD CONSTRAINT fk_user_id_ref_users FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE;
COMMIT;
ERROR: duplicate constraint name
I expected the constraint to be successfully dropped and added again.",SERIALIZABLE,Optimistic,2,0,0,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,NOT NULL,-,Yes,Unexpected error,Statement correctness: unexpected error,-,"No, hard to fix",-,-,-,-,-,-,-,-,820,"No, not key-value data structures",Yes,"No, unsupported statements",,,CockroachDB_55184
CockroachDB,46276,https://github.com/cockroachdb/cockroach/issues/46276,"schema: Unexpected error when dropping an index + column, then inserting/upserting"," CREATE TABLE t (
  a INT PRIMARY KEY,
  b DECIMAL(10,1) NOT NULL DEFAULT(0),
  UNIQUE INDEX t_secondary (b),
  FAMILY (a, b)
);
INSERT INTO t VALUES (100, 500.5);

BEGIN;
DROP INDEX t_secondary CASCADE;
ALTER TABLE t DROP COLUMN b;
INSERT INTO t SELECT a + 1 FROM t;
UPSERT INTO t SELECT a + 1 FROM t;
ERROR: column-id ""2"" does not exist
EXPECTED: No error.",Open,,-,-,2020/3/19,," CREATE TABLE t (
  a INT PRIMARY KEY,
  b DECIMAL(10,1) NOT NULL DEFAULT(0),
  UNIQUE INDEX t_secondary (b),
  FAMILY (a, b)
);
INSERT INTO t VALUES (100, 500.5);

BEGIN;
DROP INDEX t_secondary CASCADE;
ALTER TABLE t DROP COLUMN b;
INSERT INTO t SELECT a + 1 FROM t;
UPSERT INTO t SELECT a + 1 FROM t;
ERROR: column-id ""2"" does not exist
EXPECTED: No error.",SERIALIZABLE,Optimistic,1,1,-,-,-,-,1,explicit,5,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,Yes,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,"NOT NULL
DEFAULT 0",-,Yes,Unexpected error,Statement correctness: unexpected error,-,"No, unknown",-,-,-,-,-,-,-,-,1018,"No, involve complex operations other than read(key) and write(key, value)","No, DBMS-specific","No, unsupported statements",,,CockroachDB_46276
CockroachDB,22868,https://github.com/cockroachdb/cockroach/issues/22868,sql: Can`t replace a table with a view in a transaction (SQL docs),"-- setup
CREATE DATABASE bank;
CREATE TABLE bank.user_accounts (email STRING PRIMARY KEY, type STRING);

-- transaction with error
BEGIN;
ALTER TABLE bank.user_accounts RENAME TO bank.client_accounts;
CREATE VIEW bank.user_accounts
  AS SELECT type, email
  FROM bank.client_accounts;
COMMIT;
pq: relation ""user_accounts"" already exists",Fixed,CCL v1.1.5,-,-,2018/2/21,,"-- setup
CREATE DATABASE bank;
CREATE TABLE bank.user_accounts (email STRING PRIMARY KEY, type STRING);

-- transaction with error
BEGIN;
ALTER TABLE bank.user_accounts RENAME TO bank.client_accounts;
CREATE VIEW bank.user_accounts
  AS SELECT type, email
  FROM bank.client_accounts;
COMMIT;
pq: relation ""user_accounts"" already exists",SERIALIZABLE,Optimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,-,Yes,Code fix,-,-,-,-,-,-,1779,-,"No, involve complex operations other than read(key) and write(key, value)",Yes,"No, unsupported statements",,,CockroachDB_22868
CockroachDB,88251,https://github.com/cockroachdb/cockroach/issues/88251,SELECT FOR UPDATE from a secondary index has no effect,"If a SELECT ... FOR UPDATE statement happens to scan a secondary index, it does not block other updates.

To Reproduce
In one SQL session:

CREATE TABLE t1 (a int PRIMARY KEY, b int, c int, INDEX c_idx(c));
INSERT INTO t1 SELECT g,g,g FROM generate_series(1,10000) g(g);
ANALYZE t1;

BEGIN;
SELECT * FROM t1 WHERE c = 1 FOR UPDATE;
In another SQL session:

UPDATE t1 SET c=-1 WHERE c = 1;
SELECT * FROM t1 WHERE c = -1;
  a | b | c
----+---+-----
  1 | 1 | -1
Expected behavior
The update statement should block until the first SQL session commits or rolls back. The predicate WHERE c = 1 causes a scan of index c_idx, but if the primary index is scanned, the update blocks.",Open,,-,-,2022/9/20,,"If a SELECT ... FOR UPDATE statement happens to scan a secondary index, it does not block other updates.

To Reproduce
In one SQL session:

CREATE TABLE t1 (a int PRIMARY KEY, b int, c int, INDEX c_idx(c));
INSERT INTO t1 SELECT g,g,g FROM generate_series(1,10000) g(g);
ANALYZE t1;

BEGIN;
SELECT * FROM t1 WHERE c = 1 FOR UPDATE;
In another SQL session:

UPDATE t1 SET c=-1 WHERE c = 1;
SELECT * FROM t1 WHERE c = -1;
  a | b | c
----+---+-----
  1 | 1 | -1
Expected behavior
The update statement should block until the first SQL session commits or rolls back. The predicate WHERE c = 1 causes a scan of index c_idx, but if the primary index is scanned, the update blocks.",SERIALIZABLE,Optimistic,1,10,-,-,-,-,2,explicit,2,auto,2,-,-,-,-,-,-,Yes,-,-,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Yes,-,-,-,-,-,Yes,Missing blocking,Insufficient isolation: missing blocking,-,"No, unknown",-,-,-,-,-,-,-,-,103,"No, not key-value data structures",Yes,"No, unsupported statements",,,CockroachDB_88251
CockroachDB,93372,https://github.com/cockroachdb/cockroach/issues/93372,sql: ANALYZE hangs forever if run within a transaction that modifies the table it is analyzing,"The following sequence hangs forever. I guess we should ban ANALYZE in open transactions, or otherwise solve this, though it doesn`t seem hugely important...

demo@127.0.0.1:26257/defaultdb> create table a (a int);
demo@127.0.0.1:26257/defaultdb> begin;
demo@127.0.0.1:26257/defaultdb  OPEN> insert into a values(1);
demo@127.0.0.1:26257/defaultdb  OPEN> analyze a;",Open,,-,-,2022/12/10,,"The following sequence hangs forever. I guess we should ban ANALYZE in open transactions, or otherwise solve this, though it doesn`t seem hugely important...

demo@127.0.0.1:26257/defaultdb> create table a (a int);
demo@127.0.0.1:26257/defaultdb> begin;
demo@127.0.0.1:26257/defaultdb  OPEN> insert into a values(1);
demo@127.0.0.1:26257/defaultdb  OPEN> analyze a;",SERIALIZABLE,Optimistic,1,0,-,-,-,-,1,explicit,3,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,DBMS hang,Consistency: DBMS state,-,"No, unknown",-,-,-,-,-,-,-,-,22,"No, not key-value data structures",Yes,"No, unsupported statements",,,CockroachDB_93372
PostgreSQL,16771,https://www.postgresql.org/message-id/16771-cbef7d97ba93f4b9@postgresql.org,"Server process killed by signal 9, after recovery drop tablespace failed","The following bug has been logged on the website:

Bug reference:      16771
Logged by:          Bo Chen
Email address:      bchen90@163.com
PostgreSQL version: 11.8
Operating system:   euleros v2r7 x86_64
Description:        

hi 

I encounter a problem of  drop tablespace failed for reasion `tablespace is
not empty`. The problem occurs  in the following scenarios:

I start a transaction to create some table located in an alreaedy created
tablespace, before the transaction commits, the process of creating data is
killed by somebady with signal 9. when the database recoveried I try to drop
the tablesapce, it failed for `tablespace is not empty`.

Does this bug need to be resolved ?  



regards,  ChenBo 


Following  is the scenarios:

postgres=# start transaction;
START TRANSACTION
postgres=# create table test1(id text) tablespace test;
create table test2(id text) tablespace test;
create table test3(id text) tablespace test;
create table test4(id text) tablespace test;
create table test5(id text) tablespace test;
create table test6(id text) tablespace test;
create table test7(id text) tablespace test;
create table test8(id text) tablespace test;
create table test9(id text) tablespace test;CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# 
CREATE TABLE
postgres=# 2020-12-11 19:10:54.408 UTC [2909] LOG:  server process (PID
2921) was terminated by signal 9: Killed



[postgres@host-192-168-0-7 data]$ psql -d postgres -U postgres -p 5432
psql (11.8)
Type ""help"" for help.

postgres=# drop tablespace test;
2020-12-11 19:11:36.518 UTC [3299] ERROR:  tablespace ""test"" is not empty
2020-12-11 19:11:36.518 UTC [3299] STATEMENT:  drop tablespace test;
ERROR:  tablespace ""test"" is not empty
postgres=# select * from test1;
2020-12-11 19:11:48.684 UTC [3299] ERROR:  relation ""test1"" does not exist
at character 15
2020-12-11 19:11:48.684 UTC [3299] STATEMENT:  select * from test1;
ERROR:  relation ""test1"" does not exist
LINE 1: select * from test1;
                      ^
postgres=#



Hello.

At Fri, 11 Dec 2020 11:34:47 +0000, PG Bug reporting form <noreply@postgresql.org> wrote in 
> The following bug has been logged on the website:
>
> Bug reference:      16771
> Logged by:          Bo Chen
> Email address:      bchen90@163.com
> PostgreSQL version: 11.8
> Operating system:   euleros v2r7 x86_64
> Description:        
>
> hi 
>
> I encounter a problem of  drop tablespace failed for reasion `tablespace is
> not empty`. The problem occurs  in the following scenarios:
>
> I start a transaction to create some table located in an alreaedy created
> tablespace, before the transaction commits, the process of creating data is
> killed by somebady with signal 9. when the database recoveried I try to drop
> the tablesapce, it failed for `tablespace is not empty`.
>
> Does this bug need to be resolved ?  

It seems to be a known behavior that hasn`t been fixed for a long time.

It comes from a mechanism in PostgreSQL called ""pending deletes"", by
which deletion of underlynig files is delayed until commit/abort
time. Since the ""to-be-deleted at abort"" infomation is not persistent,
it should be lost if the server crashed before the transaction ends.

I happend to be proposing a patch [*1] for another issue and I
realized that the approach could solve this issue as well.

*1: https://www.postgresql.org/message-id/20201225.091252.53717619425847881.horikyota.ntt%40gmail.com

regards.

-- 
Kyotaro Horiguchi
NTT Open Source Software Center


",Fixed,11.8,-,"https://www.postgresql.org/message-id/attachment/117346/v2-0002-New-command-ALTER-TABLE-ALL-IN-TABLESPACE-SET-LOG.patch
https://www.postgresql.org/message-id/attachment/117345/v2-0001-In-place-table-persistence-change.patch",2020/12/11,,"I start a transaction to create some table located in an alreaedy created tablespace, before the transaction commits, the process of creating data is killed by somebady with signal 9. when the database recoveried I try to drop the tablesapce, it failed for `tablespace is not empty`.
postgres=# start transaction;
START TRANSACTION
postgres=# create table test1(id text) tablespace test;
create table test2(id text) tablespace test;
create table test3(id text) tablespace test;
create table test4(id text) tablespace test;
create table test5(id text) tablespace test;
create table test6(id text) tablespace test;
create table test7(id text) tablespace test;
create table test8(id text) tablespace test;
create table test9(id text) tablespace test;CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# CREATE TABLE
postgres=# 
CREATE TABLE
postgres=# 2020-12-11 19:10:54.408 UTC [2909] LOG:  server process (PID 2921) was terminated by signal 9: Killed
[postgres@host-192-168-0-7 data]$ psql -d postgres -U postgres -p 5432
psql (11.8)
Type ""help"" for help.

postgres=# drop tablespace test;
2020-12-11 19:11:36.518 UTC [3299] ERROR:  tablespace ""test"" is not empty
2020-12-11 19:11:36.518 UTC [3299] STATEMENT:  drop tablespace test;
ERROR:  tablespace ""test"" is not empty
postgres=# select * from test1;
2020-12-11 19:11:48.684 UTC [3299] ERROR:  relation ""test1"" does not exist at character 15
2020-12-11 19:11:48.684 UTC [3299] STATEMENT:  select * from test1;
ERROR:  relation ""test1"" does not exist
LINE 1: select * from test1;
                      ^",unspecified,Unspecified,0,-,-,-,-,-,2,explicit,10,auto,2,-,-,-,-,-,-,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,inject crash,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,,Yes,Code fix,2 patches: 22 changed files with 1014 additions and 137 deletions,2,22,1014,137,1151,14,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,PostgreSQL_16771
PostgreSQL,17116,https://www.postgresql.org/message-id/17116-d6ca217acc180e30@postgresql.org,Assert failed in SerialSetActiveSerXmin() on commit of parallelized serializable transaction,"The following bug has been logged on the website:

Bug reference:      17116
Logged by:          Alexander Lakhin
Email address:      exclusion@gmail.com
PostgreSQL version: 13.3
Operating system:   Ubuntu 20.04
Description:        

The isolation test ""serializable-parallel-2"" modified as follows:
# Exercise the case where a read-only serializable transaction has
# SXACT_FLAG_RO_SAFE set in a parallel query.

setup
{
    CREATE TABLE foo AS SELECT generate_series(1, 10)::int a;
    ALTER TABLE foo SET (parallel_workers = 2);
}

teardown
{
    DROP TABLE foo;
}

session s1
setup   { BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE; }
step s1r { SELECT * FROM foo; }
step s1c { COMMIT; }

session s2
setup  {
     BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY;
     SET parallel_setup_cost = 0;
     SET parallel_tuple_cost = 0;
   }
step s2r1 { SELECT * FROM foo; }
step s2r2 { SELECT * FROM foo; }
step s2c { COMMIT; }

session s3
setup   { BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE; }
step s3r { SELECT * FROM foo; }
step s3c { COMMIT; }

session s4
setup  {
     BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY;
     SET parallel_setup_cost = 0;
     SET parallel_tuple_cost = 0;
   }
step s4r1 { SELECT * FROM foo; }
step s4r2 { SELECT * FROM foo; }
step s4c { COMMIT; }

permutation s1r s3r s2r1 s4r1 s1c s2r2 s3c s4r2 s4c s2c

leads to a failed assertion with the following stacktrace:
Core was generated by `postgres: law isolation_regression [local] COMMIT    
                        `.
Program terminated with signal SIGABRT, Aborted.
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1  0x00007f21de1dd859 in __GI_abort () at abort.c:79
#2  0x0000555e1740b1ac in ExceptionalCondition (
    conditionName=conditionName@entry=0x555e17581ce8
""!TransactionIdIsValid(serialControl->tailXid) || TransactionIdFollows(xid,
serialControl->tailXid)"", errorType=errorType@entry=0x555e17466028
""FailedAssertion"", 
    fileName=fileName@entry=0x555e17581789 ""predicate.c"",
lineNumber=lineNumber@entry=1056) at assert.c:67
#3  0x0000555e172d3c5c in SerialSetActiveSerXmin (xid=6187) at
predicate.c:1056
#4  0x0000555e172d3ecf in SetNewSxactGlobalXmin () at predicate.c:3309
#5  0x0000555e172d811c in ReleasePredicateLocks (isCommit=false,
isCommit@entry=true, 
    isReadOnlySafe=isReadOnlySafe@entry=false) at predicate.c:3697
#6  0x0000555e1743fbb0 in ResourceOwnerReleaseInternal (owner=<optimized
out>, 
    phase=phase@entry=RESOURCE_RELEASE_LOCKS, isCommit=isCommit@entry=true,
isTopLevel=isTopLevel@entry=true)
    at resowner.c:569
#7  0x0000555e17440166 in ResourceOwnerRelease (owner=<optimized out>,
phase=phase@entry=RESOURCE_RELEASE_LOCKS, 
    isCommit=isCommit@entry=true, isTopLevel=isTopLevel@entry=true) at
resowner.c:484
#8  0x0000555e1700a156 in CommitTransaction () at xact.c:2227
#9  0x0000555e1700af28 in CommitTransactionCommand () at xact.c:2974
#10 0x0000555e172e319d in finish_xact_command () at postgres.c:2662
#11 0x0000555e172e5972 in exec_simple_query
(query_string=query_string@entry=0x555e18e17350 ""COMMIT;"")
    at postgres.c:1264
#12 0x0000555e172e7b06 in PostgresMain (argc=<optimized out>,
argv=argv@entry=0x555e18e42ad8, dbname=<optimized out>, 
    username=<optimized out>) at postgres.c:4339
#13 0x0000555e17253165 in BackendRun (port=port@entry=0x555e18e3bb10) at
postmaster.c:4526
#14 0x0000555e172562c0 in BackendStartup (port=port@entry=0x555e18e3bb10) at
postmaster.c:4210
#15 0x0000555e17256507 in ServerLoop () at postmaster.c:1739
#16 0x0000555e17257a30 in PostmasterMain (argc=8, argv=<optimized out>) at
postmaster.c:1412
#17 0x0000555e171a0a4f in main (argc=8, argv=0x555e18e119e0) at main.c:210

(Discovered by running multiple installcheck-world`s in parallel.)
Reproduced on REL_12_STABLE..master. It looks like the offending commit is
47a338cf.



On Thu, Jul 22, 2021 at 11:23 PM PG Bug reporting form
<noreply@postgresql.org> wrote:           `.
> Program terminated with signal SIGABRT, Aborted.
> #0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
> 50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
> (gdb) bt
> #0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
> #1  0x00007f21de1dd859 in __GI_abort () at abort.c:79
> #2  0x0000555e1740b1ac in ExceptionalCondition (
>     conditionName=conditionName@entry=0x555e17581ce8
> ""!TransactionIdIsValid(serialControl->tailXid) || TransactionIdFollows(xid,
> serialControl->tailXid)"", errorType=errorType@entry=0x555e17466028
> ""FailedAssertion"",
>     fileName=fileName@entry=0x555e17581789 ""predicate.c"",
> lineNumber=lineNumber@entry=1056) at assert.c:67

Thanks.  Repro`d here.  Not immediately sure what`s happening here,
but I will look into it next week.




On Sat, Jul 24, 2021 at 12:56 AM Thomas Munro <thomas.munro@gmail.com> wrote:
> On Thu, Jul 22, 2021 at 11:23 PM PG Bug reporting form
> <noreply@postgresql.org> wrote:           `.
>> #2  0x0000555e1740b1ac in ExceptionalCondition (
>>     conditionName=conditionName@entry=0x555e17581ce8
>> ""!TransactionIdIsValid(serialControl->tailXid) || TransactionIdFollows(xid,
>> serialControl->tailXid)"", errorType=errorType@entry=0x555e17466028
>> ""FailedAssertion"",
>>     fileName=fileName@entry=0x555e17581789 ""predicate.c"",
>> lineNumber=lineNumber@entry=1056) at assert.c:67
>
> Thanks.  Repro`d here.  Not immediately sure what`s happening here,
> but I will look into it next week.

Yeah, I goofed commit 47a338cf.  It could double-release a sort of
reference count.  I think the reason I didn`t notice and nothing bad
happened is that the global xmin tracking is effectively
self-correcting in this rare case.  Once the count reaches zero, we
recompute the count by linear search for the new oldest xmin
(something on my list of things to try to improve, but in this case
the saving grace).

Here`s a draft patch that includes your test spec.  Without the
included change to predicate.c, it hits the assertion.  With it, it
doesn`t, and pg_locks shows no leaked locks after the isolation checks
run (that was the problem 47a338cf fixed before 12 was released, but
it fixed it a little too far in the opposite direction, fortunately
without ill effect AFAICS besides wasted CPU cycles).

I`ll see if I can think of some more ways to test this logic, and some
way to make the coding a little clearer.



Hello Thomas,

26.07.2021 10:36, Thomas Munro wrote:
> On Sat, Jul 24, 2021 at 12:56 AM Thomas Munro <thomas.munro@gmail.com> wrote:
>> On Thu, Jul 22, 2021 at 11:23 PM PG Bug reporting form
>> <noreply@postgresql.org> wrote:           `.
>>> #2  0x0000555e1740b1ac in ExceptionalCondition (
>>>     conditionName=conditionName@entry=0x555e17581ce8
>>> ""!TransactionIdIsValid(serialControl->tailXid) || TransactionIdFollows(xid,
>>> serialControl->tailXid)"", errorType=errorType@entry=0x555e17466028
>>> ""FailedAssertion"",
>>>     fileName=fileName@entry=0x555e17581789 ""predicate.c"",
>>> lineNumber=lineNumber@entry=1056) at assert.c:67
>> Thanks.  Repro`d here.  Not immediately sure what`s happening here,
>> but I will look into it next week.
> Here`s a draft patch that includes your test spec.  Without the
> included change to predicate.c, it hits the assertion.  With it, it
> doesn`t, and pg_locks shows no leaked locks after the isolation checks
> run (that was the problem 47a338cf fixed before 12 was released, but
> it fixed it a little too far in the opposite direction, fortunately
> without ill effect AFAICS besides wasted CPU cycles).

Thanks! I`m not sure, whether this is related to the fix, but my
parallel installcheck script (attached) catches another assert with the
patch applied:

Core was generated by `postgres: postgres regress33 127.0.0.1(48582) COM`.
Program terminated with signal SIGABRT, Aborted.
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1  0x00007ff5251c7535 in __GI_abort () at abort.c:79
#2  0x000055b16d72aa32 in ExceptionalCondition (
    conditionName=conditionName@entry=0x55b16d89ccd0
""!SxactIsPartiallyReleased(MySerializableXact)"",
    errorType=errorType@entry=0x55b16d78301d ""FailedAssertion"",
fileName=fileName@entry=0x55b16d89bbc9 ""predicate.c"",
    lineNumber=lineNumber@entry=4859) at assert.c:67
#3  0x000055b16d5f8a3a in PreCommit_CheckForSerializationFailure () at
predicate.c:4859
#4  0x000055b16d34227d in CommitTransaction () at xact.c:2140
#5  0x000055b16d3435b5 in CommitTransactionCommand () at xact.c:3085
#6  0x000055b16d602369 in finish_xact_command () at postgres.c:2662
#7  0x000055b16d604a23 in finish_xact_command () at postgres.c:2660
#8  exec_simple_query (query_string=0x55b16e9c6980 ""COMMIT;"") at
postgres.c:1264
#9  0x000055b16d6060d9 in PostgresMain (argc=<optimized out>,
argv=argv@entry=0x55b16e9f66a8, dbname=<optimized out>,
    username=<optimized out>) at postgres.c:4339
#10 0x000055b16d57936f in BackendRun (port=0x55b16e9f40b0,
port=0x55b16e9f40b0) at postmaster.c:4526
#11 BackendStartup (port=0x55b16e9f40b0) at postmaster.c:4210
#12 ServerLoop () at postmaster.c:1739
#13 0x000055b16d57a36c in PostmasterMain (argc=3, argv=0x55b16e9c1320)
at postmaster.c:1412
#14 0x000055b16d28bf5b in main (argc=3, argv=0x55b16e9c1320) at main.c:210

---
/tmp/t/ic01-33/src/test/isolation/expected/serializable-parallel-2.out
2021-07-26 22:04:06.206541268 +0300
+++
/tmp/t/ic01-33/src/test/isolation/output_iso/results/serializable-parallel-2.out      
2021-07-26 22:08:04.883339810 +0300
@@ -47,4 +47,6 @@
 10
 (10 rows)

-step s2c: COMMIT;
+lock wait query failed: server closed the connection unexpectedly
+       This probably means the server terminated abnormally
+       before or while processing the request.

If time permits, I will compose (till the weekend) yet another isolation
test to demonstrate this fail. But maybe the script can be useful as is.
(To simplify things I left only serializable-parallel* tests in
isolation_schedule.)

Best regards,
Alexander



On Tue, Jul 27, 2021 at 8:00 AM Alexander Lakhin <exclusion@gmail.com> wrote:
> Thanks! I`m not sure, whether this is related to the fix, but my
> parallel installcheck script (attached) catches another assert with the
> patch applied:

> #2  0x000055b16d72aa32 in ExceptionalCondition (
>     conditionName=conditionName@entry=0x55b16d89ccd0
> ""!SxactIsPartiallyReleased(MySerializableXact)"",
>     errorType=errorType@entry=0x55b16d78301d ""FailedAssertion"",
> fileName=fileName@entry=0x55b16d89bbc9 ""predicate.c"",
>     lineNumber=lineNumber@entry=4859) at assert.c:67

Reproduced here using a similar approach.  It doesn`t fail with this
new draft patch.  The main thing I have learned is that
serializable-parallel-2.sql isn`t really testing a very interesting
code path.  I`ll try to come up with a better test.



Hello Thomas,
27.07.2021 14:17, Thomas Munro wrote:
> Reproduced here using a similar approach.  It doesn`t fail with this
> new draft patch.  The main thing I have learned is that
> serializable-parallel-2.sql isn`t really testing a very interesting
> code path.  I`ll try to come up with a better test.
Thanks! With the new fix applied, my multiple installcheck test survives
100+ iterations. (Except for read-only-anomaly-3, that causes another
assertion fail but I believe that it`s not related to the initial issue
and deserves another bug report.)

Best regards,
Alexander




On Wed, Jul 28, 2021 at 9:00 AM Alexander Lakhin <exclusion@gmail.com> wrote:
> Thanks! With the new fix applied, my multiple installcheck test survives
> 100+ iterations.

Thanks.

Here`s an updated version.  No code change, but now with a change to
serializable-parallel-2.sql so that the second assertion you mentioned
fails on unpatched master.  The intention of that test was to exercise
the SXACT_FLAG_RO_SAFE optimisation in a parallel query, and it did
that, but in a sort of degenerate way: sequential scans acquire
predicate locks *before entering parallel mode*, so the optimisation
is triggered immediately.  This version triggers the optimisation in a
parallel worker, and then the final cleanup happens in the leader,
which is the interesting case.

> (Except for read-only-anomaly-3, that causes another
> assertion fail but I believe that it`s not related to the initial issue
> and deserves another bug report.)

Huh.  I tried and failed to find that one with concurrent runs.  I`ll
wait for your next report before I do anything, just in case there`s a
connection.



On Wed, Jul 28, 2021 at 5:02 PM Thomas Munro <thomas.munro@gmail.com> wrote:
> On Wed, Jul 28, 2021 at 9:00 AM Alexander Lakhin <exclusion@gmail.com> wrote:
>> (Except for read-only-anomaly-3, that causes another
>> assertion fail but I believe that it`s not related to the initial issue
>> and deserves another bug report.)
>
> Huh.  I tried and failed to find that one with concurrent runs.  I`ll
> wait for your next report before I do anything, just in case there`s a
> connection.

This is indeed an unrelated issue, and much older.  After many
kilowatt hours, I reproduced it here and worked out that it comes from
GetSafeSnapshot() not expecting possibleUnsafeConflicts to be empty
when WritableSxactCount == 0.  More soon.




On Fri, Jul 30, 2021 at 9:41 AM Thomas Munro <thomas.munro@gmail.com> wrote:
> On Wed, Jul 28, 2021 at 5:02 PM Thomas Munro <thomas.munro@gmail.com> wrote:
>> On Wed, Jul 28, 2021 at 9:00 AM Alexander Lakhin <exclusion@gmail.com> wrote:
>>> (Except for read-only-anomaly-3, that causes another
>>> assertion fail but I believe that it`s not related to the initial issue
>>> and deserves another bug report.)

The problem is that if we don`t take the fast exit here:

    if (XactReadOnly && PredXact->WritableSxactCount == 0)
    {
        ReleasePredXact(sxact);
        LWLockRelease(SerializableXactHashLock);
        return snapshot;
    }

... then we search for writable SSI transactions here:

        for (othersxact = FirstPredXact();
             othersxact != NULL;
             othersxact = NextPredXact(othersxact))
        {
            if (!SxactIsCommitted(othersxact)
                && !SxactIsDoomed(othersxact)
                && !SxactIsReadOnly(othersxact))
            {
                SetPossibleUnsafeConflict(sxact, othersxact);
            }
        }

... but that can find nothing if all writers happen to be doomed.
WritableSxactCount doesn`t count read-only or committed transactions
so we don`t have to worry about those confusing us, but it does count
doomed transactions.  Having an empty list here is mostly fine, except
that nobody will ever set our RO_SAFE flag, and in the case of
DEFERRABLE, the assertion that someone has set it will fail.  This is
the case since:

===
commit bdaabb9b22caa71021754d3967b4032b194d9880
Author: Heikki Linnakangas <heikki.linnakangas@iki.fi>
Date:   Fri Jul 8 00:36:30 2011 +0300

    There`s a small window wherein a transaction is committed but not yet
    on the finished list, and we shouldn`t flag it as a potential conflict
    if so. We can also skip adding a doomed transaction to the list of
    possible conflicts because we know it won`t commit.

    Dan Ports and Kevin Grittner.
===

I see three fixes:

1.  Check if the list is empty, and if so, set our own
SXACT_FLAG_RO_SAFE.  Then the assertion in GetSafeSnapshot() will
pass, and also non-DEFERRABLE callers will eventually see the flag and
opt out.

2.  Check if the list is empty, and if so, opt out immediately (as we
do when WriteableSxactCount == 0).  This would be strictly better than
#1, because it happens sooner while we still have the lock.  On the
other hand, we`d have to undo more effects, and that involves writing
more fragile and very rarely run code.

3.  Just delete the assertion in GetSafeSnapshot().  This is
attractively simple but it means that READ ONLY non-DEFERRABLE
transactions arbitrarily miss out on the RO_SAFE optimisation in this
(admittedly rare) case.

The attached 0002 has idea #1, which I prefer for back-patching.  I
think #2 might be a good idea if we take the filtering logic further
so that it becomes more likely that you get an empty list (for
example, why don`t we skip transactions that are running in a
different database?), but then that`d be new code, not something we
back-patch.  Thoughts?

If someone is wanting to reproduce this case, try removing everything
from isolation_schedule except read-only-anomaly* and
read-write-unique*, and then run something like this while you go out
for lunch.  It should work as far back as 11 (before that, those tests
didn`t exist and the isolation tester couldn`t run them due to lack of
handling for DEFERRABLE blocking):

rounds=1000
concurrency=100
output=/tmp/junk
for i in `seq $rounds` ; do
  echo ""=== round $i ===""
  for c in `seq $concurrency` ; do
    mkdir -p $output/results_${i}_${c}
    (make -C src/test/isolation installcheck \
       EXTRA_REGRESS_OPTS=""--dbname=regress_${c}
--outputdir=$output/results_${i}_${c}"" || echo FAIL) \
         > junk/out.${i}.${c}.log 2>&1 &
     pids[${c}]=$!
  done
  for c in `seq $concurrency` ; do
    wait ${pids[${c}]}
  done
done



Hello Thomas,
30.07.2021 08:48, Thomas Munro wrote:
>>>> (Except for read-only-anomaly-3, that causes another
>>>> assertion fail but I believe that it`s not related to the initial issue
>>>> and deserves another bug report.)
> The problem is that if we don`t take the fast exit here:
You wouldn`t mind if I file a separate bug report regarding the last
problem (not related to the initial bug report)?
Now I can propose a minimal reproduction for it, that can ease testing
and choosing the most appropriate fix.
As to v4-0001-Fix-assert-failures-in-parallel-SERIALIZABLE-READ.patch
you posted before, I believe it fixes the issues as expected and may be
committed at least to allow for advanced testing.

Best regards,
Alexander




On Mon, Jan 10, 2022 at 6:00 AM Alexander Lakhin <exclusion@gmail.com> wrote:
> You wouldn`t mind if I file a separate bug report regarding the last
> problem (not related to the initial bug report)?
> Now I can propose a minimal reproduction for it, that can ease testing
> and choosing the most appropriate fix.

Thanks!  Yeah, please go ahead.

> As to v4-0001-Fix-assert-failures-in-parallel-SERIALIZABLE-READ.patch
> you posted before, I believe it fixes the issues as expected and may be
> committed at least to allow for advanced testing.

Cool, I`ll do that in the next few days.  Need to swap SERIALIZABLE
back into my neurons after some time away...




15.01.2022 08:41, Thomas Munro wrote:
> On Mon, Jan 10, 2022 at 6:00 AM Alexander Lakhin <exclusion@gmail.com> wrote:
>> You wouldn`t mind if I file a separate bug report regarding the last
>> problem (not related to the initial bug report)?
>> Now I can propose a minimal reproduction for it, that can ease testing
>> and choosing the most appropriate fix.
> Thanks!  Yeah, please go ahead.
Thank you! Done:
https://www.postgresql.org/message-id/17368-98a4f99e8e4b4402%40postgresql.org

Best regards,
Alexander



",Fixed,13.3,-,"https://www.postgresql.org/message-id/attachment/125052/v4-0001-Fix-assert-failures-in-parallel-SERIALIZABLE-READ.patch
https://www.postgresql.org/message-id/attachment/125053/v4-0002-Fix-race-in-SERIALIZABLE-READ-ONLY.patch",2021/7/21,,"The isolation test ""serializable-parallel-2"" modified as follows:
# Exercise the case where a read-only serializable transaction has
# SXACT_FLAG_RO_SAFE set in a parallel query.

setup
{
    CREATE TABLE foo AS SELECT generate_series(1, 10)::int a;
    ALTER TABLE foo SET (parallel_workers = 2);
}

teardown
{
    DROP TABLE foo;
}

session s1
setup   { BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE; }
step s1r { SELECT * FROM foo; }
step s1c { COMMIT; }

session s2
setup  {
     BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY;
     SET parallel_setup_cost = 0;
     SET parallel_tuple_cost = 0;
   }
step s2r1 { SELECT * FROM foo; }
step s2r2 { SELECT * FROM foo; }
step s2c { COMMIT; }

session s3
setup   { BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE; }
step s3r { SELECT * FROM foo; }
step s3c { COMMIT; }

session s4
setup  {
     BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE READ ONLY;
     SET parallel_setup_cost = 0;
     SET parallel_tuple_cost = 0;
   }
step s4r1 { SELECT * FROM foo; }
step s4r2 { SELECT * FROM foo; }
step s4c { COMMIT; }

permutation s1r s3r s2r1 s4r1 s1c s2r2 s3c s4r2 s4c s2c

leads to a failed assertion with the following stacktrace:
Core was generated by `postgres: law isolation_regression [local] COMMIT    
                        `.
Program terminated with signal SIGABRT, Aborted.
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1  0x00007f21de1dd859 in __GI_abort () at abort.c:79
#2  0x0000555e1740b1ac in ExceptionalCondition (
    conditionName=conditionName@entry=0x555e17581ce8
""!TransactionIdIsValid(serialControl->tailXid) || TransactionIdFollows(xid,
serialControl->tailXid)"", errorType=errorType@entry=0x555e17466028
""FailedAssertion"", 
    fileName=fileName@entry=0x555e17581789 ""predicate.c"",
lineNumber=lineNumber@entry=1056) at assert.c:67
#3  0x0000555e172d3c5c in SerialSetActiveSerXmin (xid=6187) at
predicate.c:1056
#4  0x0000555e172d3ecf in SetNewSxactGlobalXmin () at predicate.c:3309
#5  0x0000555e172d811c in ReleasePredicateLocks (isCommit=false,
isCommit@entry=true, 
    isReadOnlySafe=isReadOnlySafe@entry=false) at predicate.c:3697
#6  0x0000555e1743fbb0 in ResourceOwnerReleaseInternal (owner=<optimized
out>, 
    phase=phase@entry=RESOURCE_RELEASE_LOCKS, isCommit=isCommit@entry=true,
isTopLevel=isTopLevel@entry=true)
    at resowner.c:569
#7  0x0000555e17440166 in ResourceOwnerRelease (owner=<optimized out>,
phase=phase@entry=RESOURCE_RELEASE_LOCKS, 
    isCommit=isCommit@entry=true, isTopLevel=isTopLevel@entry=true) at
resowner.c:484
#8  0x0000555e1700a156 in CommitTransaction () at xact.c:2227
#9  0x0000555e1700af28 in CommitTransactionCommand () at xact.c:2974
#10 0x0000555e172e319d in finish_xact_command () at postgres.c:2662
#11 0x0000555e172e5972 in exec_simple_query
(query_string=query_string@entry=0x555e18e17350 ""COMMIT;"")
    at postgres.c:1264
#12 0x0000555e172e7b06 in PostgresMain (argc=<optimized out>,
argv=argv@entry=0x555e18e42ad8, dbname=<optimized out>, 
    username=<optimized out>) at postgres.c:4339
#13 0x0000555e17253165 in BackendRun (port=port@entry=0x555e18e3bb10) at
postmaster.c:4526
#14 0x0000555e172562c0 in BackendStartup (port=port@entry=0x555e18e3bb10) at
postmaster.c:4210
#15 0x0000555e17256507 in ServerLoop () at postmaster.c:1739
#16 0x0000555e17257a30 in PostmasterMain (argc=8, argv=<optimized out>) at
postmaster.c:1412
#17 0x0000555e171a0a4f in main (argc=8, argv=0x555e18e119e0) at main.c:210

(Discovered by running multiple installcheck-world`s in parallel.)
Reproduced on REL_12_STABLE..master. It looks like the offending commit is
47a338cf.",SERIALIZABLE,Optimistic,1,10,-,-,-,-,5,auto,1,explicit,3,explicit,6,explicit,3,explicit,6,Yes,-,Yes,-,Yes,-,Yes,-,-,-,-,-,-,Yes,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,,Yes,Code fix,2 patches: 7 changed files with 191 additions and 50 deletions,2,7,191,50,241,9,-,"No, not key-value data structures","No, DBMS-specific","No, more than two transactions",,,PostgreSQL_17116
PostgreSQL,16676,https://www.postgresql.org/message-id/16676-fd62c3c835880da6@postgresql.org,SELECT ... FETCH FIRST ROW WITH TIES FOR UPDATE SKIP LOCKED locks rows it doesn`t return,"est case (found when demonstrating a queue mechanism for batches):



create table queue (id int generated always as identity, batch_id int not
null);



insert into queue (batch_id) values (1),(1),(2),(3);



postgres=# select * from queue;
 id | batch_id 
----+----------
  1 |        1
  2 |        1
  3 |        2
  4 |        3
(4 rows)



-- backend 1:



postgres=# begin;
BEGIN
postgres=*# select * from queue order by batch_id fetch first row with ties
for update skip locked;
 id | batch_id 
----+----------
  1 |        1
  2 |        1
(2 rows)



-- backend 2:



postgres=# select * from queue order by batch_id fetch first row with ties
for update skip locked;       
 id | batch_id 
----+----------
  4 |        3
(1 row)



-- QED



As you can see, the row id 3 with batch_id 2 is not returned as would be
implied by the strict ordering and the skipped locks.  The working theory
here is the FETCH FIRST ROW WITH TIES locks the rows before deciding if they
should be included or not.",Confirmed,13,-,-,2020/10/17,,"Test case (found when demonstrating a queue mechanism for batches):

create table queue (id int generated always as identity, batch_id int not
null);

insert into queue (batch_id) values (1),(1),(2),(3);

postgres=# select * from queue;
 id | batch_id 
----+----------
  1 |        1
  2 |        1
  3 |        2
  4 |        3
(4 rows)

-- backend 1:

postgres=# begin;
BEGIN
postgres=*# select * from queue order by batch_id fetch first row with ties
for update skip locked;
 id | batch_id 
----+----------
  1 |        1
  2 |        1
(2 rows)

-- backend 2:

postgres=# select * from queue order by batch_id fetch first row with ties
for update skip locked;       
 id | batch_id 
----+----------
  4 |        3
(1 row)

-- QED

As you can see, the row id 3 with batch_id 2 is not returned as would be implied by the strict ordering and the skipped locks.  The working theory here is the FETCH FIRST ROW WITH TIES locks the rows before deciding if they should be included or not.",unspecified,Unspecified,1,4,-,-,-,-,2,explicit,2,auto,1,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,"generated always as identity
NOT NULL",-,Yes,Incorrect query result,Consistency: application state,,"No, hard to fix",-,-,-,-,-,-,-,-,806,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,PostgreSQL_16676
PostgreSQL,17385,https://www.postgresql.org/message-id/17385-9ee529fb091f0ce5@postgresql.org,"""RESET transaction_isolation"" inside serializable transaction causes Assert at the transaction end","""RESET transaction_isolation"" inside serializable transaction causes Assert
at the transaction end.
For example (on REL_10_STABLE) the following query:
CREATE TABLE abc (a int);
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
        SELECT * FROM abc;
        RESET transaction_isolation;
END;

causes an assertion failure with the following stack:

[New LWP 839017]
[Thread debugging using libthread_db enabled]
Using host libthread_db library ""/lib/x86_64-linux-gnu/libthread_db.so.1"".
Core was generated by `postgres: andrew regression [local] COMMIT           
                        `.
Program terminated with signal SIGABRT, Aborted.
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1  0x00007f14b7f59859 in __GI_abort () at abort.c:79
#2  0x00005586da82c4d2 in ExceptionalCondition (conditionName=0x5586daa01e42
""IsolationIsSerializable()"", errorType=0x5586daa0195c ""FailedAssertion"",
fileName=0x5586daa01950 ""predicate.c"", lineNumber=4838) at assert.c:69
#3  0x00005586da659b2f in PreCommit_CheckForSerializationFailure () at
predicate.c:4838
#4  0x00005586da20f32e in CommitTransaction () at xact.c:2168
#5  0x00005586da21020c in CommitTransactionCommand () at xact.c:3015
#6  0x00005586da66afcb in finish_xact_command () at postgres.c:2721
#7  0x00005586da668643 in exec_simple_query (query_string=0x5586dada1020
""END;"") at postgres.c:1239
#8  0x00005586da66d4db in PostgresMain (argc=1, argv=0x7fffefd1c050,
dbname=0x5586dadcc168 ""regression"", username=0x5586dadcc148 ""andrew"") at
postgres.c:4486
#9  0x00005586da591be3 in BackendRun (port=0x5586dadc2010) at
postmaster.c:4530
#10 0x00005586da59143e in BackendStartup (port=0x5586dadc2010) at
postmaster.c:4252
#11 0x00005586da58d233 in ServerLoop () at postmaster.c:1745
#12 0x00005586da58c990 in PostmasterMain (argc=3, argv=0x5586dad9b240) at
postmaster.c:1417
#13 0x00005586da47be9d in main (argc=3, argv=0x5586dad9b240) at main.c:209

Reproduced on REL_10_STABLE..master.
However SET transaction_isolation=`read committed` inside transaction just
emits
""ERROR:  SET TRANSACTION ISOLATION LEVEL must be called before any query"".\",Fixed,14.1,-,https://www.postgresql.org/message-id/attachment/134809/v4-0001-Introduce-GUC_NOT_RESET-flag.patch,2022/1/28,,"""RESET transaction_isolation"" inside serializable transaction causes Assert
at the transaction end.
For example (on REL_10_STABLE) the following query:
CREATE TABLE abc (a int);
BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
        SELECT * FROM abc;
        RESET transaction_isolation;
END;

causes an assertion failure with the following stack:

[New LWP 839017]
[Thread debugging using libthread_db enabled]
Using host libthread_db library ""/lib/x86_64-linux-gnu/libthread_db.so.1"".
Core was generated by `postgres: andrew regression [local] COMMIT           
                        `.
Program terminated with signal SIGABRT, Aborted.
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
50      ../sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) bt
#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:50
#1  0x00007f14b7f59859 in __GI_abort () at abort.c:79
#2  0x00005586da82c4d2 in ExceptionalCondition (conditionName=0x5586daa01e42
""IsolationIsSerializable()"", errorType=0x5586daa0195c ""FailedAssertion"",
fileName=0x5586daa01950 ""predicate.c"", lineNumber=4838) at assert.c:69
#3  0x00005586da659b2f in PreCommit_CheckForSerializationFailure () at
predicate.c:4838
#4  0x00005586da20f32e in CommitTransaction () at xact.c:2168
#5  0x00005586da21020c in CommitTransactionCommand () at xact.c:3015
#6  0x00005586da66afcb in finish_xact_command () at postgres.c:2721
#7  0x00005586da668643 in exec_simple_query (query_string=0x5586dada1020
""END;"") at postgres.c:1239
#8  0x00005586da66d4db in PostgresMain (argc=1, argv=0x7fffefd1c050,
dbname=0x5586dadcc168 ""regression"", username=0x5586dadcc148 ""andrew"") at
postgres.c:4486
#9  0x00005586da591be3 in BackendRun (port=0x5586dadc2010) at
postmaster.c:4530
#10 0x00005586da59143e in BackendStartup (port=0x5586dadc2010) at
postmaster.c:4252
#11 0x00005586da58d233 in ServerLoop () at postmaster.c:1745
#12 0x00005586da58c990 in PostmasterMain (argc=3, argv=0x5586dad9b240) at
postmaster.c:1417
#13 0x00005586da47be9d in main (argc=3, argv=0x5586dad9b240) at main.c:209

Reproduced on REL_10_STABLE..master.
However SET transaction_isolation=`read committed` inside transaction just
emits
""ERROR:  SET TRANSACTION ISOLATION LEVEL must be called before any query"".",SERIALIZABLE,Optimistic,1,0,-,-,-,-,1,explicit,4,-,-,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Assertion failure,Statement correctness: assertion failure,,Yes,Code fix,9 changed files with 89 additions and 15 deletions,1,9,89,15,104,154,-,"No, not key-value data structures","No, DBMS-specific","No, unsupported statements",,,PostgreSQL_17385
PostgreSQL,15946,https://postgr.es/m/15946-5c7570a2884a26cf@postgresql.org,"""duplicate key"" error on ANALYZE of table partitions in transaction","regression=# create table t as select generate_series(1,10) x;
SELECT 10
regression=# begin;
BEGIN
regression=# analyze t, t;
ERROR:  duplicate key value violates unique constraint ""pg_statistic_relid_att_inh_index""
DETAIL:  Key (starelid, staattnum, stainherit)=(35836, 1, f) already exists.

It appears to work fine without the BEGIN:

regression=# analyze t, t;
ANALYZE

but then

regression=# begin;
BEGIN
regression=# analyze t, t;
ERROR:  tuple already updated by self

I think the conclusion is that if we aren`t using per-table
transactions we`d better do a CommandCounterIncrement between
tables in vacuum()`s loop.",Fixed,11.5,-,https://git.postgresql.org/gitweb/?p=postgresql.git%3Ba%3Dcommitdiff%3Bh%3Dcabe0f298ea7efade11d8171c617e668934d0d09,2019/8/10,,"regression=# create table t as select generate_series(1,10) x;
SELECT 10
regression=# begin;
BEGIN
regression=# analyze t, t;
ERROR:  duplicate key value violates unique constraint ""pg_statistic_relid_att_inh_index""
DETAIL:  Key (starelid, staattnum, stainherit)=(35836, 1, f) already exists.

It appears to work fine without the BEGIN:

regression=# analyze t, t;
ANALYZE

but then

regression=# begin;
BEGIN
regression=# analyze t, t;
ERROR:  tuple already updated by self

I think the conclusion is that if we aren`t using per-table
transactions we`d better do a CommandCounterIncrement between
tables in vacuum()`s loop.",unspecified,Unspecified,1,10,-,-,-,-,2,auto,1,explicit,2,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,,Yes,Code fix,3 changed files with 17 additions and 0 deletions,1,3,17,0,17,1,-,"No, not key-value data structures",Yes,"No, unsupported statements",,,PostgreSQL_15946
PostgreSQL,15875,https://www.postgresql.org/message-id/15875-76bf5472863f6ce3@postgresql.org,Unexpected serializable isolation error when INSERTing into a table,"When running the SQL below we get a serialisation error at the end of
Transaction 2. Because of the presence of the primary key PG isn`t doing a
seq scan to perform the selects and manual inspection of pg_locks would seem
to imply it`s not a page lock issue either. Can anyone shed some light on
why this query causes an isolation issue? The exact isolation error is:



```
ERROR:  could not serialize access due to read/write dependencies among
transactions
DETAIL:  Reason code: Canceled on identification as a pivot, during write.
HINT:  The transaction might succeed if retried.
```



Obviously in this case a retry will probably succeed, as per the docs - but
i`m not sure it should be necessary?



Thanks in advance for your attention



Henri



Steps to recreate:



```
DROP TABLE IF EXISTS foo;
CREATE TABLE foo(id int PRIMARY KEY);
INSERT INTO foo (id) VALUES (44);
INSERT INTO foo (id) VALUES (33);
```
-- Transaction 1:
    ```
    BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    SELECT id FROM foo WHERE id = 44;
    ```
-- Transaction 2:
    ```
    BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    SELECT id FROM foo WHERE id = 33;
    INSERT INTO foo (id) VALUES (1);
    COMMIT;
    ```



-- Transaction 1:
   ```
    INSERT INTO foo (id) VALUES (2);
     <observe serialisation error>",Confirmed,10.6,-,-,2019/6/26,,"teps to recreate:



```
DROP TABLE IF EXISTS foo;
CREATE TABLE foo(id int PRIMARY KEY);
INSERT INTO foo (id) VALUES (44);
INSERT INTO foo (id) VALUES (33);
```
-- Transaction 1:
    ```
    BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    SELECT id FROM foo WHERE id = 44;
    ```
-- Transaction 2:
    ```
    BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    SELECT id FROM foo WHERE id = 33;
    INSERT INTO foo (id) VALUES (1);
    COMMIT;
    ```



-- Transaction 1:
   ```
    INSERT INTO foo (id) VALUES (2);
     <observe serialisation error>

ERROR:  could not serialize access due to read/write dependencies among
transactions
DETAIL:  Reason code: Canceled on identification as a pivot, during write.
HINT:  The transaction might succeed if retried.",SERIALIZABLE,Optimistic,1,2,-,-,-,-,2,explicit,3,explicit,4,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,Yes,-,-,-,-,-,-,Yes,Unexpected error,Statement correctness: unexpected error,,"No, hard to fix",-,-,-,-,-,-,-,-,1285,"No, not key-value data structures",Yes,Yes,,,PostgreSQL_15875
MySQL,113228,https://bugs.mysql.com/bug.php?id=100328,Phantom rows caused by update statements which changes value of the primary key,"Isolation Level: REPEATABLE READ & REPEATABLE READ.
An UPDATE statement which update the value of primary key caused phantom rows in another transaction.

How to repeat:
/* init */ CREATE TABLE t(a INT PRIMARY KEY, b INT);
/* init */ INSERT INTO t VALUES (1, 1);
/* init */ INSERT INTO t VALUES (2, 2);
/* t1 */ SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
/* t2 */ SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;

/* t1 */ BEGIN;
/* t1 */ SELECT * FROM t LOCK IN SHARE MODE;
/* t2 */ BEGIN;
/* t2 */ SELECT * FROM t;  -- [(1, 1), (2, 2)]
/* t1 */ UPDATE t SET a=3 WHERE b = 2;
/* t1 */ COMMIT;
/* t2 */ UPDATE t SET b=3;
/* t2 */ SELECT * FROM t; -- [(1, 3), (2, 2), (3, 3)] 
/* t2 */ COMMIT;

It appears that a phantom row (2, 2) showed up in the second consistent read of T2. I`m not sure whether this is a new bug or a duplicate one. From the user`s perspective, I haven`t inserted a new row. I`ve only updated existing rows. Phantom rows shouldn`t occur.",Verified,"5.6, 5.7, 8.0",-,-,2020/7/27,S2 (Serious),"The following simple test case for MTR framework shows that the problem is repeatable without binary log enabled and without additional changes to code to adjust the read-set bitmap:

--enable_connect_log
create table t(a int, b int) engine=innodb;
insert into t values (1, 0), (2, 1), (3, 2);

set transaction isolation level repeatable read;
begin;
select * from t;

connect (addconroot1, localhost, root,,);
begin;
update t set a = 10 where b = 1;
commit;

connection default;
select * from t;
update t set a = 10 where a;
select * from t;
# The above returns (which is wrong!)
# a      b
# 10     0
# 2      1
# 10     2

commit;

In fact with this test case the problem is repeatable even in 5.5 tree (for 5.5.65-git to be exact).",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,2,explicit,6,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,ENGINE=InnoDB,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, hard to diagnose",-,-,-,-,-,-,-,-,888,"No, not key-value data structures","No, same behavior",Yes,,,MySQL_113228
TiDB,36718,https://bugs.mysql.com/bug.php?id=100328,Inconsistent behavior with isolation levels,"SELECT under repeatable read isolation level returns stale version of data

Description
In the beginning, v of Key<1> is 1.
+---+------+
| k | v    |
+---+------+
| 1 |    1 |
+---+------+
Then Session-1001 updates v of Key<1> to 2.
Note that it successfully changes that value, because the query result is:
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0
When Session-1002 trys updating v of Key<1> to 2.
It fails to change that value because the vlaue is already 2:
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0
Thers is no wrong execution results so far.
Next, Session-1002 executes
select k, v from t where k = 1
As we known, latest v of Key<1> is 2
However, the query result is:
+---+------+
| k | v    |
+---+------+
| 1 |    1 |
+---+------+
1 row in set (0.01 sec)
The database returns a stale version of data for Key<1>",Verified,"5.6, 5.7, 8.0",-,-,2020/7/27,S2 (Serious),"create table if not exists t (k integer, v integer, primary key(k));

delete from t;

insert into t(k, v) values (1, 1);

Session Operation
1001 SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
1002 SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
1001 start transaction
1001 update t set v = 2 where k = 1
1001 commit
1002 start transaction
1002 select k, v from t where v = 88
1002 update t set v = 2 where k = 1
1002 select k, v from t where k = 1
1002 commit",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,2,explicit,6,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, hard to diagnose",-,-,-,-,-,-,-,-,888,"No, not key-value data structures","No, same behavior",Yes,,,TiDB_36718
TiDB,42487,https://bugs.mysql.com/bug.php?id=100328,Inconsistent behavior with isolation levels,"Transaction can`t read its own update in repeatable read.session1 > set session transaction isolation level repeatable read;

session2 > set session transaction isolation level repeatable read;

session2 > start transaction;

session1 > start transaction;

session2 > update table1 set coAttr0_0 = 2 where pkAttr0=1 and pkAttr1=1 and pkAttr2=1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0
session2 > commit;

session1 > update table1 set coAttr0_0 = 2 where pkAttr0=1 and pkAttr1=1 and pkAttr2=1;
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

session1 > select * from table1 where pkAttr0=1 and pkAttr1=1 and pkAttr2=1;The last query returns:

+------+---------+---------+---------+-----------+
| pkId | pkAttr0 | pkAttr1 | pkAttr2 | coAttr0_0 |
+------+---------+---------+---------+-----------+
|    1 |       1 |       1 |       1 |         2 |
+------+---------+---------+---------+-----------+
while coAttr0_0 should be updated by its own update operation, which set coAttr0_0 as 2.",Verified,"5.6, 5.7, 8.0",-,-,2020/7/27,S2 (Serious),"create table table1 (pkId integer, pkAttr0 integer, pkAttr1 integer, pkAttr2 integer, coAttr0_0 integer, primary key(pkAttr0, pkAttr1, pkAttr2) NONCLUSTERED);
insert into table1 values (1,1,1,1,1);

session1 > set session transaction isolation level repeatable read;

session2 > set session transaction isolation level repeatable read;

session2 > start transaction;

session1 > start transaction;

session2 > update table1 set coAttr0_0 = 2 where pkAttr0=1 and pkAttr1=1 and pkAttr2=1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0
session2 > commit;

session1 > update table1 set coAttr0_0 = 2 where pkAttr0=1 and pkAttr1=1 and pkAttr2=1;
Query OK, 0 rows affected (0.00 sec)
Rows matched: 1  Changed: 0  Warnings: 0

session1 > select * from table1 where pkAttr0=1 and pkAttr1=1 and pkAttr2=1;",REPEATABLE READ,Pessimistic,1,3,-,-,-,-,2,explicit,6,explicit,3,-,-,-,-,-,-,Yes,-,-,-,Yes,-,Yes,-,-,-,-,Yes,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,Yes,-,-,-,-,-,-,-,-,Yes,Incorrect query result,Insufficient isolation: incorrect SELECT,S2 (Serious),"No, hard to diagnose",-,-,-,-,-,-,-,-,888,"No, not key-value data structures","No, same behavior",Yes,,,TiDB_42487
